<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kho Học Liệu</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <!-- Thêm CDN Bootstrap và icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="shortcut icon" href="../static/logo.png" type="image/x-icon">
  <link rel="stylesheet" href="../static/css/index.css">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f4f6f9;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }
    .list-group-item :hover{
      cursor: pointer;
      color: red;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      margin: 0;
      padding-top: 60px;
    }
    
    .compact-container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .card-custom {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .nav-tabs .nav-link {
      font-weight: 500;
      color: var(--secondary-color);
      border: none;
      padding: 0.75rem 1rem;
      transition: color 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 3px solid var(--primary-color);
    }
    
    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
    }
    
    .breadcrumb {
      background: transparent;
      padding: 0.75rem 1rem;
      margin-bottom: 0;
    }
    
    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }
    
    .breadcrumb-item a:hover {
      color: #0056b3;
    }
    
    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
      background: #fff;
    }
    
    .file-item:hover {
      background-color: #f8f9fa;
      transform: translateX(5px);
    }
    
    .file-icon {
      font-size: 24px;
      margin-right: 15px;
      width: 30px;
    }
    
    .file-icon.folder {
      color: #ffc107;
    }
    
    .file-icon.pdf {
      color: #dc3545;
    }
    
    .file-icon.word {
      color: #2b579a;
    }
    
    .file-name {
      flex-grow: 1;
      font-size: 1rem;
    }
    
    .file-info {
      font-size: 0.8rem;
      color: var(--secondary-color);
    }
    
    /* CSS cho gợi ý tìm kiếm (autocomplete) */
    .suggestions {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .suggestions .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    
    .suggestions .suggestion-item:hover {
      background-color: #f8f9fa;
      opacity: 1;
    }
    
    /* Modern Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      background: #ffffff;
      animation: fadeInScale 0.4s ease;
    }
    
    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: #fff;
      border-bottom: none;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-header .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    .modal-header .btn-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }
    
    .modal-header .btn-close:hover {
      opacity: 1;
    }
    
    .modal-body {
      padding: 1.5rem;
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
    }
    
    .modal-footer {
      background: #f5f5f5;
      border-top: none;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    .modal-footer .btn {
      min-width: 120px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    
    .modal-footer .btn-primary {
      background: #2575fc;
      border: none;
    }
    
    .modal-footer .btn-primary:hover {
      background: #1a5bb8;
      transform: translateY(-2px);
    }
    
    .modal-footer .btn-secondary {
      background: #e0e0e0;
      border: none;
      color: #555;
    }
    
    .modal-footer .btn-secondary:hover {
      background: #cfcfcf;
      transform: translateY(-2px);
    }
    
    .modal-footer .btn-info {
      background: #17a2b8;
      border: none;
      color: #fff;
    }
    
    .modal-footer .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }
    
    @media (max-width: 576px) {
      .modal-header, .modal-body, .modal-footer {
        padding: 1rem;
      }
      .modal-header .modal-title {
        font-size: 1.5rem;
      }
    }
    
    /* Modal Resume Header màu xanh lá */
    #resumeModal .modal-header {
      background: linear-gradient(135deg, #28a745, #70db70);
    }
    .about-links {
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 20px 0;
}

.about-links h3 {
  font-size: 20px;
  color: #333;
  margin-bottom: 15px;
}

.about-links ul {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
}

.about-links li {
  display: flex;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.about-links li:last-child {
  border-bottom: none;
}

.about-links .label {
  flex: 0 0 150px;
  font-weight: 600;
  color: #007bff;
}

.about-links .desc {
  flex: 1;
  font-size: 16px;
  color: #555;
}

/* Footer style */
.custom-footer {
  border-top: 1px solid #ddd;
  padding-top: 15px;
  text-align: center;
}

.custom-footer .footer-item {
  margin-bottom: 10px;
  font-size: 16px;
  color: #333;
}

.custom-footer .footer-item span {
  display: block;
  line-height: 1.5;
}

/* Social links style */
.social-links {
  margin-top: 10px;
}

.social-links a {
  margin: 0 10px;
  font-size: 24px;
  color: #007bff;
  text-decoration: none;
  transition: color 0.3s;
}

.social-links a:hover {
  color: #0056b3;
}
/* Custom CSS for Modern and Elegant Modal */
.modal-content {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.modal-header {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    border-bottom: none;
    padding: 20px;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
}

.modal-body {
    padding: 20px;
    background-color: #f9f9f9;
}

.modal-footer {
    border-top: none;
    padding: 15px 20px;
    background-color: #f9f9f9;
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
}

.btn-close {
    filter: invert(1);
}

.btn-secondary {
    background-color: #6c757d;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    transition: background-color 0.3s ease;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.list-group-item {
    border: none;
    margin-bottom: 10px;
    border-radius: 8px;
    padding: 15px;
    background-color: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.list-group-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

/* Animation for modal */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal.fade .modal-dialog {
    animation: fadeIn 0.3s ease-out;
}
.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border-left-color: #09f;
  animation: spin 1s linear infinite;
  margin: 20px auto; /* canh giữa */
  text-indent: -9999px; /* ẩn text Loading... nếu không muốn hiển thị */
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
#subjectSearchModal .modal-dialog {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#subjectSearchModal .modal-content {
    height: 70%;
}
.suggestions {
    position: absolute;
    width: 100%;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050; /* Đảm bảo hiển thị trên modal */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background: #f8f9fa;
}
.suggestions {
    position: absolute;
    top: calc(100% + 2px); /* Nằm ngay dưới ô input, cách 2px để không dính liền */
    left: 0;
    width: 100%;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050; /* Đảm bảo hiển thị trên modal */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background: #f8f9fa;
}


/* Trên mobile (chiều rộng nhỏ hơn 576px), tăng padding-top để bù navbar */
@media (max-width: 576px) {
  body {
    padding-top: 100px; /* Tăng khoảng cách để tránh bị đè nội dung */
  }
}

  </style>

</head>
<body>
<!-- Thêm navbar vào trước phần content chính -->
<nav id="navbar" class="navbar navbar-expand-lg navbar-light border-bottom py-3 fixed-top" style="display: none;">
  <div class="container-fluid">
    <!-- Tên trang web bên trái -->
    <a class="navbar-brand me-5" href="#">
      <span class="text-primary fw-bold fs-4">StudyHub</span>
    </a>

    <!-- Các chức năng bên phải -->
    <div class="d-flex align-items-center gap-3">      
      <!-- Nút chức năng với icons -->
<button id="openModalBtn" class="btn btn-light rounded-pill px-3">
  <i class="bi bi-person-circle me-2"></i>
</button>
      
      <button class="btn btn-light rounded-pill px-3">
        <i class="bi bi-bell me-2"></i>
      </button>
      
      <button class="btn btn-light rounded-pill px-3">
        <i class="bi bi-gear me-2"></i>
      </button>

      <!-- Nút đăng xuất -->
      <button class="btn btn-outline-danger rounded-pill px-3" id="logoutBtn">
        <i class="bi bi-box-arrow-right me-2"></i>
        Đăng xuất
      </button>
    </div>
  </div>
</nav>
<script>
    document.addEventListener("DOMContentLoaded", function () {
  fetch("/api/check-login")
    .then(response => response.json())
    .then(data => {
      if (data.loggedIn) {
        document.getElementById("navbar").style.display = "block"; // Hiển thị navbar nếu đã đăng nhập
      }
    })
    .catch(error => console.error("Lỗi kiểm tra đăng nhập:", error));
});

</script>

<div class="compact-container my-4">
  <div class="card card-custom">
    <div class="card-body">
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="de-thi-tab" data-bs-toggle="tab" data-bs-target="#de-thi" type="button" role="tab">Đề Thi</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="de-cuong-tab" data-bs-toggle="tab" data-bs-target="#de-cuong" type="button" role="tab">Đề Cương</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ve-chung-toi-tab" data-bs-toggle="tab" data-bs-target="#ve-chung-toi" type="button" role="tab">Về Chúng Tôi</button>
        </li>
      </ul>
      <div class="tab-content mt-3">
        <!-- Tab Đề Thi -->
        <div class="tab-pane fade show active" id="de-thi" role="tabpanel" aria-labelledby="de-thi-tab">
          <div id="exam-drive-container"></div>
        </div>
        <!-- Tab Đề Cương -->
        <div class="tab-pane fade" id="de-cuong" role="tabpanel" aria-labelledby="de-cuong-tab">
          <div id="syllabus-drive-container"></div>
        </div>
        <!-- Tab Về Chúng Tôi -->
        <div class="tab-pane fade" id="ve-chung-toi" role="tabpanel" aria-labelledby="ve-chung-toi-tab">
          <!-- Sử dụng position-relative để định vị phần "Phiên bản" -->
          <div class="p-3 position-relative">
            <p>
              Các đề thi và tài liệu trên website này đều được đóng góp bởi các cựu sinh viên, mang lại sự gần gũi và trải nghiệm thực tế trong học tập.
            </p>

            <!-- Nút "Hoạt động gần đây" chỉ hiển thị trong tab Về Chúng Tôi -->
            <button type="button" class="btn btn-primary recent-activity-btn" data-bs-toggle="modal" data-bs-target="#recentActivityModal">
              Hoạt động gần đây
            </button>

            <div class="about-links mt-3">
              <footer class="custom-footer mt-4">
                <div class="footer-item">
                  <span>Design by Nguyen Ngoc Truong</span>
                </div>
                <div class="social-links">
                  <a href="https://www.facebook.com/nntruong05" target="_blank" aria-label="Facebook">
                    <i class="bi bi-facebook"></i>
                  </a>
                  <a href="https://github.com/truongqb05x" target="_blank" aria-label="GitHub">
                    <i class="bi bi-github"></i>
                  </a>
                </div>
              </footer>
            </div>

            <!-- Chữ "Phiên bản 0" được đặt ở góc dưới bên phải, có hiệu ứng nhấn để mở modal lịch sử cập nhật -->
            <div class="version-info" style="position: absolute; bottom: 0; right: 0; padding: 5px; font-size: 0.9rem; color: #666; cursor: pointer;"
                 data-bs-toggle="modal" data-bs-target="#updateHistoryModal">
              Version 2.0.1
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Nút đóng góp đề thi -->
<button type="button" class="btn btn-primary contribute-btn" 
        style="position: fixed; bottom: 0; right: 0; margin: 10px; z-index: 1050;"
        data-bs-toggle="modal" data-bs-target="#contributeExamModal">
  <i class="bi bi-pencil-square"></i> Đóng góp đề thi
</button>
<!-- Modal Đóng góp Đề thi -->
<div class="modal fade" id="contributeExamModal" tabindex="-1" aria-labelledby="contributeExamModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contributeExamModalLabel">Đóng góp đề thi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <!-- Thông báo thành công, ẩn mặc định -->
        <div id="successAlert" class="alert alert-success" role="alert" style="display: none;">
          Upload thành công!
        </div>
        <!-- Form upload -->
        <form id="contributeExamForm" action="/api/upload_exam" method="POST" enctype="multipart/form-data">
          <!-- Chọn trường -->
          <div class="mb-3">
            <label for="fieldSelect" class="form-label">Chọn trường</label>
            <select class="form-select" id="fieldSelect" name="field">
              <option selected>Đang tải...</option>
            </select>
          </div>
          <!-- Tải file đề thi -->
          <div id="fileInputsContainer">
            <div class="file-input-group mb-3">
              <label class="form-label">Tải file</label>
              <input type="file" class="form-control" name="examFile[]" accept="*/*">
              <p class="form-text mt-2">
                Bạn có thể chọn file đề thi hoặc đề cương!
              </p>
            </div>
          </div>
          <button type="button" class="btn btn-outline-primary" id="addFileInput">
            <i class="bi bi-plus-circle"></i> Thêm file
          </button>
        </form>
      </div>
      <div class="modal-footer">
        <!-- Nút gửi và nút đóng được đặt trong modal footer như cũ -->
        <button type="submit" form="contributeExamForm" class="btn btn-primary">Gửi đóng góp</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script>
// Load danh sách trường từ API /api/schools
document.addEventListener('DOMContentLoaded', function(){
  var fieldSelect = document.getElementById('fieldSelect');
  fetch('/api/schools')
    .then(response => response.json())
    .then(data => {
      fieldSelect.innerHTML = '';
      if (data.error) {
        let errorOption = document.createElement('option');
        errorOption.text = 'Lỗi khi tải trường';
        fieldSelect.appendChild(errorOption);
      } else {
        let defaultOption = document.createElement('option');
        defaultOption.text = 'Chọn trường của bạn';
        defaultOption.selected = true;
        fieldSelect.appendChild(defaultOption);
        data.forEach(function(school) {
          let option = document.createElement('option');
          option.value = school.id;
          option.text = school.name + " (" + school.count + ")";
          fieldSelect.appendChild(option);
        });
      }
    })
    .catch(err => {
      console.error(err);
      fieldSelect.innerHTML = '<option>Lỗi khi tải trường</option>';
    });
});

// Script thêm file upload mới không kèm ghi chú
document.getElementById('addFileInput').addEventListener('click', function() {
  var fileGroup = document.createElement('div');
  fileGroup.className = 'file-input-group mb-3';

  var fileLabel = document.createElement('label');
  fileLabel.className = 'form-label';
  fileLabel.innerText = 'Tải file đề thi';
  fileGroup.appendChild(fileLabel);

  var fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.className = 'form-control';
  fileInput.name = 'examFile[]';
  fileInput.accept = '*/*';
  fileGroup.appendChild(fileInput);

  document.getElementById('fileInputsContainer').appendChild(fileGroup);
});

// Xử lý submit form bằng AJAX để hiển thị thông báo thành công trong modal
document.getElementById('contributeExamForm').addEventListener('submit', function(e) {
  e.preventDefault(); // Ngăn form submit mặc định
  let form = this;
  let formData = new FormData(form);

  fetch(form.action, {
      method: 'POST',
      body: formData
  })
  .then(response => response.json())
  .then(data => {
      if (data.message) {
          // Hiển thị thông báo thành công
          document.getElementById('successAlert').style.display = 'block';
          // Reset form sau khi upload thành công
          form.reset();
          // Cập nhật lại container file với một input mặc định
          document.getElementById('fileInputsContainer').innerHTML = `
            <div class="file-input-group mb-3">
              <label class="form-label">Tải file</label>
              <input type="file" class="form-control" name="examFile[]" accept="*/*">
              <p class="form-text mt-2">
                Bạn có thể chọn file đề thi hoặc đề cương!
              </p>
            </div>
          `;
      } else if (data.error) {
          // Thông báo lỗi nếu có
          alert("Lỗi: " + data.error);
      }
  })
  .catch(error => {
      console.error(error);
      alert("Có lỗi xảy ra khi upload.");
  });
});
</script>

<!-- Modal Lịch sử cập nhật -->
<!-- Modal -->
<div class="modal fade" id="updateHistoryModal" tabindex="-1" aria-labelledby="updateHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="updateHistoryModalLabel">Lịch sử Cập nhật</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="timeline">
          <!-- Update Item 1 -->
          <div class="timeline-item" style="position: relative; padding-left: 30px; margin-bottom: 20px;">
            <div style="content: ''; position: absolute; left: 0; top: 5px; width: 15px; height: 15px; background: #0d6efd; border-radius: 50%;"></div>
            <div class="timeline-header d-flex justify-content-between align-items-center">
              <span class="badge bg-success">v2.0.1</span>
              <small class="text-muted">2024-03-5</small>
            </div>
            <div class="timeline-body" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-left: 20px;">
              <p class="mb-0">
                <i class="fas fa-plus-circle text-success me-2"></i>
                Thêm tính năng quản lý hồ sơ người dùng
              </p>
              <ul style="margin-bottom: 0; padding-left: 20px;">
                <li>Cải tiến giao diện người dùng</li>
              </ul>
            </div>
          </div>

          <!-- Update Item 2 -->
          <div class="timeline-item" style="position: relative; padding-left: 30px; margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
            <div style="content: ''; position: absolute; left: 0; top: 5px; width: 15px; height: 15px; background: #0d6efd; border-radius: 50%;"></div>
            <div class="timeline-header d-flex justify-content-between align-items-center">
              <span class="badge bg-info">v2.0.3</span>
              <small class="text-muted">2024-02-28</small>
            </div>
            <div class="timeline-body" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-left: 20px;">
              <p class="mb-0">
                <i class="fas fa-bug text-danger me-2"></i>
                Sửa lỗi và cải tiến hiệu năng
              </p>
              <ul style="margin-bottom: 0; padding-left: 20px;">
                <li>Sửa lỗi đăng nhập không xác thực</li>
                <li>Tối ưu hóa tốc độ tải trang</li>
              </ul>
            </div>
          </div>

          <!-- Update Item 3 -->
          <div class="timeline-item" style="position: relative; padding-left: 30px; margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
            <div style="content: ''; position: absolute; left: 0; top: 5px; width: 15px; height: 15px; background: #0d6efd; border-radius: 50%;"></div>
            <div class="timeline-header d-flex justify-content-between align-items-center">
              <span class="badge bg-warning text-dark">v1.9.5</span>
              <small class="text-muted">2024-01-10</small>
            </div>
            <div class="timeline-body" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-left: 20px;">
              <p class="mb-0">
                <i class="fas fa-shield-alt text-primary me-2"></i>
                Nâng cấp bảo mật hệ thống
              </p>
              <ul style="margin-bottom: 0; padding-left: 20px;">
                <li>Thêm xác thực 2 yếu tố</li>
                <li>Cập nhật chính sách bảo mật mới</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
    <style>
        .modal-dialog-v3 { 
            max-width: 420px; 
        }
        .modal-content-v3 { 
            background: #f8f9fa; /* Nền modal sáng nhẹ */
            border: 1px solid #e0e0e0; /* Viền sáng hơn */
            border-radius: 15px; 
            transform: perspective(1000px) rotateX(5deg); 
            transition: transform 0.3s; 
            animation: popIn-v3 0.5s ease-out; 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* Bóng nhẹ */
        }
        .modal-content-v3:hover { 
            transform: perspective(1000px) rotateX(0deg); 
        }
        .modal-header-v3 { 
            border-bottom: none; 
            padding: 2rem 2rem 0; 
        }
        .modal-title-v3 { 
            font-family: 'Montserrat', sans-serif; 
            font-weight: 700; 
            color: #333; /* Màu chữ tối để nổi trên nền sáng */
        }
        .modal-body-v3 { 
            padding: 1.5rem 2rem 2rem; 
            text-align: center; 
            color: #555; /* Màu chữ nhạt hơn cho nội dung */
            font-family: 'Montserrat', sans-serif; 
        }
        .btn-custom-v3 { 
            padding: 12px 30px; 
            border-radius: 8px; 
            font-weight: 700; 
            transition: all 0.3s; 
        }
        .btn-login-v3 { 
            background: #007bff; /* Màu xanh dương tươi sáng */
            color: #fff; 
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3); 
        }
        .btn-register-v3 { 
            background: #ff4d4d; /* Màu đỏ nhẹ nhàng */
            color: #fff; 
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3); 
        }
        .btn-custom-v3:hover { 
            transform: translateZ(10px); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); /* Bóng đậm hơn khi hover */
        }
        @keyframes popIn-v3 { 
            from { opacity: 0; transform: perspective(1000px) rotateX(20deg); } 
            to { opacity: 1; transform: perspective(1000px) rotateX(5deg); } 
        }
    </style>

<div class="modal fade" id="loginModal-v3" tabindex="-1" aria-labelledby="loginModalLabel-v3" aria-hidden="true">
    <div class="modal-dialog modal-dialog-v3 modal-dialog-centered">
        <div class="modal-content modal-content-v3">
            <div class="modal-header modal-header-v3">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-v3">
                <p class="fs-5 mb-3">Hình như bạn chưa đăng nhập!</p>
                <p class="fs-6 mb-4">Vui lòng đăng nhập hoặc đăng ký để tiếp tục.</p>
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-custom-v3 btn-login-v3" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#authModal" onclick="toggleForm('loginForm')">Đăng nhập</button>
                    <button type="button" class="btn btn-custom-v3 btn-register-v3" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#authModal" onclick="toggleForm('registerForm')">Đăng ký</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding-bottom: 1rem;">

            <!-- Đăng Nhập -->
            <div id="loginForm" style="display: block;">
                <div class="modal-header text-center" style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
<h5 class="modal-title" id="authModalLabel" style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Đăng Nhập</h5>
                </div>
                <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                    <form id="formLogin">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="loginUsername" placeholder="Nhập tên đăng nhập" required>
                        </div>
                        <div class="mb-4">
                            <label for="loginPassword" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="loginPassword" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="btn" style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
                            Đăng Nhập
                        </button>
                    </form>
                    <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
                        <span class="text-muted" style="margin-right: 5px;">Chưa có tài khoản?</span>
                        <button onclick="toggleForm('registerForm')" class="btn btn-link p-0" 
                            style="text-decoration: none; color: #007bff; font-weight: 500;">
                            Đăng ký ngay
                        </button>
                    </div>
                                    </div>
            </div>

            <!-- Đăng Ký -->
            <div id="registerForm" style="display: none;">
                <div class="modal-header text-center" style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
<h5 class="modal-title" style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Đăng Ký</h5>
                </div>
                <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                    <form id="formRegister">
                        <div class="mb-3">
                            <label for="registerFullname" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="registerFullname" placeholder="Nguyễn Văn A" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="registerUsername" placeholder="Tên đăng nhập" required>
                        </div>
                        <div class="mb-4">
                            <label for="registerPassword" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="registerPassword" placeholder="••••••••" required>
                        </div>
<div class="mb-3">
    <label for="registerUniversity" class="form-label">Trường Đại Học</label>
    <select class="form-control" id="registerUniversity" required>
        <option value="" disabled selected>Chọn trường đại học</option>
    </select>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    fetch("/api/schools")
        .then(response => response.json())
        .then(data => {
            const selectElement = document.getElementById("registerUniversity");
            data.forEach(school => {
                const option = document.createElement("option");
                option.value = school.id;  // Giá trị là ID của trường
                option.textContent = school.name;  // Hiển thị tên trường
                selectElement.appendChild(option);
            });
        })
        .catch(error => console.error("Lỗi khi tải danh sách trường:", error));
});

</script>
                        <button type="submit" class="btn" style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
                            Đăng Ký
                        </button>
                    </form>
                    <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
                        <span class="text-muted" style="margin-right: 5px;">Đã có tài khoản?</span>
                        <button onclick="toggleForm('loginForm')" class="btn btn-link p-0" 
                            style="text-decoration: none; color: #007bff; font-weight: 500;">
                            Đăng nhập ngay
                        </button>
                    </div>
                                    </div>
            </div>

            <!-- Footer chứa nút Đóng -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Hàm toggleForm để chuyển đổi giữa loginForm và registerForm
    function toggleForm(formId) {
        document.getElementById('loginForm').style.display = formId === 'loginForm' ? 'block' : 'none';
        document.getElementById('registerForm').style.display = formId === 'registerForm' ? 'block' : 'none';
    }

    // Reset form và hiển thị loginForm khi modal đóng
    document.getElementById('authModal').addEventListener('hidden.bs.modal', function () {
        toggleForm('loginForm');
        document.getElementById('formLogin').reset();
        document.getElementById('formRegister').reset();
    });

// Xử lý form đăng nhập
document.getElementById('formLogin').addEventListener('submit', function (e) {
  e.preventDefault();

  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  // Kiểm tra username: chỉ cho phép chữ (không dấu) và số, không khoảng trắng
  const usernameRegex = /^[a-zA-Z0-9]+$/;
  if (!usernameRegex.test(username)) {
    alert("Vui lòng tuân thủ quy tắc đặt user name: không dấu, không cách.");
    return;
  }

  fetch('/api/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ username, password })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
    } else {
      alert(data.message);
      // Đóng modal sau khi đăng nhập thành công
      const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
      authModal.hide();
      // Load lại trang sau khi đăng nhập thành công
      location.reload();
    }
  })
  .catch(error => {
    console.error('Lỗi:', error);
    alert('Đã xảy ra lỗi khi đăng nhập');
  });
});

// Xử lý form đăng ký
document.getElementById('formRegister').addEventListener('submit', function (e) {
  e.preventDefault();

  const fullname = document.getElementById('registerFullname').value;
  const username = document.getElementById('registerUsername').value;
  const password = document.getElementById('registerPassword').value;
  const university = document.getElementById('registerUniversity').value;

  // Kiểm tra username: chỉ cho phép chữ (không dấu) và số, không khoảng trắng
  const usernameRegex = /^[a-zA-Z0-9]+$/;
  if (!usernameRegex.test(username)) {
    alert("Vui lòng tuân thủ quy tắc đặt user name: không dấu, không cách.");
    return;
  }

  fetch('/api/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ fullname, username, password, university })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
    } else {
      alert(data.message);
      // Chuyển sang tab đăng nhập sau khi đăng ký thành công
      toggleForm('loginForm');
      // Reset form đăng ký
      document.getElementById('formRegister').reset();
    }
  })
  .catch(error => {
    console.error('Lỗi:', error);
    alert('Đã xảy ra lỗi khi đăng ký');
  });
});

    document.getElementById("logoutBtn").addEventListener("click", function () {
  fetch("/api/logout", {
    method: "POST",
    credentials: "same-origin",
    headers: {
      "Content-Type": "application/json"
    }
  })
    .then(response => response.json())
    .then(data => {
      alert(data.message);  // Hiển thị thông báo đăng xuất thành công
      window.location.href = "/";  // Chuyển hướng về trang chủ
    })
    .catch(error => console.error("Lỗi:", error));
});

</script>

<!-- Modal Xác thực -->
<div class="modal fade" id="verificationModal-v2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <!-- Header sử dụng Shadow DOM với hậu tố _v2 -->
      <modal-header-v2></modal-header-v2>
      
      <!-- Body -->
      <div class="modal-body pt-0">
        <p class="text-muted mb-4">
          Tài khoản của bạn chưa được xác thực. Bạn cần chọn 1 trong 2 cách sau nhé! 😊
        </p>

        <!-- Phương thức 1: Đóng góp ảnh đề thi -->
        <div class="card mb-3 border-primary card-method-v2">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-cloud-upload fs-3 text-primary me-2"></i>
              <div>
                <h6 class="mb-1">Đóng góp ảnh đề thi</h6>
                <p class="text-muted small mb-0">
                  Chia sẻ ảnh đề thi bất kỳ để cộng đồng cùng học tập
                </p>
              </div>
            </div>
            <div class="position-relative">
              <!-- File input cho ảnh đề thi -->
              <input type="file" 
                     id="examImageUpload_v2" 
                     accept="image/*" 
                     class="d-none"
                     data-container="fileNameExamImage_v2"
                     onchange="handleFileUpload_v2(event, 'exam')">
              <label for="examImageUpload_v2" 
                     class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                <i class="bi bi-upload me-2"></i>Chọn ảnh đề thi
              </label>
              <div id="fileNameExamImage_v2" class="text-muted small mt-2"></div>
            </div>
            <!-- Nút gửi file -->
            <button class="btn btn-success btn-sm mt-2" onclick="submitExamImage_v2()">
              <i class="bi bi-send me-2"></i>Gửi ảnh đề thi
            </button>
          </div>
        </div>

        <!-- Phương thức 2: Chia sẻ với bạn bè -->
        <div class="card border-success card-method-v2">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <i class="bi bi-share fs-3 text-success me-2"></i>
              <div>
                <h6 class="mb-1">Chia sẻ với bạn bè</h6>
                <p class="text-muted small mb-0">
                  Share trang web cho 2 người bạn để xác thực
                </p>
              </div>
            </div>
            
            <div class="input-group mb-3">
              <div id="copyContent_v2" class="form-control bg-light">
                Kho lưu trữ đề thi và đề cương qua các năm, tại: huehub.fun
              </div>
              <button class="btn btn-success btn-copy-v2" onclick="copyText_v2()">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
            <div id="copySuccess_v2" class="text-success small mt-2" style="display:none;">
              <i class="bi bi-check2"></i> Đã sao chép!
            </div>

            <!-- Ghi chú hướng dẫn chụp màn hình -->
            <div class="mt-2">
              <small class="text-muted">
                Ghi chú: Vui lòng coppy rồi gửi cho bạn bè rồi chụp lại màn hình sau khi chia sẻ, sau đó ấn "Xác nhận đã chia sẻ".
              </small>
            </div>
            <div class="position-relative">
              <!-- File input cho ảnh chụp màn hình -->
              <input type="file" 
                     id="shareScreenshotUpload_v2" 
                     accept="image/*" 
                     class="d-none"
                     data-container="fileNameShareScreenshot_v2"
                     onchange="handleFileUpload_v2(event, 'share')">
              <label for="shareScreenshotUpload_v2" 
                     class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                <i class="bi bi-upload me-2"></i>Chọn ảnh màn hình
              </label>
              <div id="fileNameShareScreenshot_v2" class="text-muted small mt-2"></div>
            </div>
            
            <!-- Nút xác nhận đã chia sẻ -->
            <button class="btn btn-outline-success w-100 btn-confirm-share-v2 mt-2" onclick="confirmShare_v2()">
              <i class="bi bi-check-circle me-2"></i>Xác nhận đã chia sẻ
            </button>
            <div id="confirmSuccess_v2" class="text-success small mt-2 text-center" style="display:none;">
              <i class="bi bi-check2-circle"></i> Đã xác nhận chia sẻ!
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary btn-close-v2" data-bs-dismiss="modal">
          Để sau đi
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Định nghĩa custom element sử dụng Shadow DOM cho header, với tên có hậu tố _v2 -->
<script>
  class ModalHeaderV2 extends HTMLElement {
    constructor() {
      super();
      const shadow = this.attachShadow({ mode: 'open' });
      shadow.innerHTML = `
        <style>
          .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 0;
            padding: 1rem;
            padding-bottom: 0;
            background-color: transparent;
          }
          .header h5 {
            color: #0d6efd;
            margin: 0;
            font-size: 1.25rem;
          }
          .header button {
            background: transparent;
            border: none;
            cursor: pointer;
          }
        </style>
        <div class="header">
          <h5 class="modal-title">
            <i class="bi bi-patch-exclamation me-2"></i> Xác thực tài khoản
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      `;
    }
  }
  customElements.define('modal-header-v2', ModalHeaderV2);
</script>

<script>
  // Biến toàn cục lưu file ảnh đề thi (hậu tố _v2)
  let examFile_v2 = null;

  // Hàm xử lý khi chọn file (hậu tố _v2)
  function handleFileUpload_v2(event, type) {
    const file = event.target.files[0];
    if (file) {
      const containerId = event.target.getAttribute('data-container');
      document.getElementById(containerId).innerHTML = 
        `<i class="bi bi-file-image"></i> Đã chọn: ${file.name}`;

      if (type === 'exam') {
        examFile_v2 = file;
      } else if (type === 'share') {
        // Gọi hàm uploadFile_v2 trực tiếp đối với file share
        uploadFile_v2(file, type);
      }
    }
  }

  // Hàm gửi ảnh đề thi khi người dùng nhấn nút "Gửi ảnh đề thi" (hậu tố _v2)
  function submitExamImage_v2() {
    if (!examFile_v2) {
      alert("Vui lòng chọn ảnh đề thi trước khi gửi.");
      return;
    }
    uploadFile_v2(examFile_v2, 'exam');
    examFile_v2 = null;
    document.getElementById('fileNameExamImage_v2').innerHTML = "";
  }

  // Hàm upload file lên server với route /upload_v2 (hậu tố _v2)
// Hàm upload file lên server với route /upload_v2 (hậu tố _v2)
// Hàm upload file lên server với route /upload_v2 (hậu tố _v2)
function uploadFile_v2(file, type) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('type', type);
  
  fetch('/upload_v2', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    console.log('Upload thành công:', data);
    // Sau khi upload file thành công, gọi route cập nhật trạng thái tài khoản
    fetch('/update_account_status_v2', {
      method: 'POST',
      credentials: 'include'
    })
    .then(response => response.json())
    .then(statusData => {
      // Đóng modal verification nếu đang mở
      const modalEl = document.getElementById('verificationModal-v2');
      const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modalInstance.hide();
      // Hiển thị thông báo cho người dùng
      alert("Tài khoản của bạn đang được xét duyệt, vui lòng đợi");
    })
    .catch(err => {
      console.error("Error updating account status:", err);
      alert("Đã upload file, nhưng không thể cập nhật trạng thái tài khoản.");
    });
  })
  .catch(error => {
    console.error('Lỗi khi upload file:', error);
  });
}

  function copyText_v2() {
    const text = document.getElementById('copyContent_v2').innerText;
    navigator.clipboard.writeText(text);
    
    const successMsg = document.getElementById('copySuccess_v2');
    successMsg.style.display = 'block';
    setTimeout(() => successMsg.style.display = 'none', 2000);
  }

  function confirmShare_v2() {
    const confirmMsg = document.getElementById('confirmSuccess_v2');
    confirmMsg.style.display = 'block';
    setTimeout(() => confirmMsg.style.display = 'none', 2000);
  }
</script>

<style>
  .cursor-pointer {
    cursor: pointer;
  }
  .modal-content {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
  }
  .card-method-v2 {
    transition: transform 0.2s;
  }
  .btn-success {
    background: #28a745;
    border-color: #28a745;
  }
  .btn-confirm-share-v2 {
    transition: background-color 0.2s, color 0.2s;
  }
  .btn-confirm-share-v2:hover {
    background-color: #28a745;
    color: white;
  }
</style>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* CSS cho thiết bị di động */
@media (max-width: 576px) {
  /* Điều chỉnh kích thước modal */
  .modal-dialog {
    max-width: 95%;
    margin: 1rem auto;
  }

  /* Điều chỉnh padding cho modal */
  .modal-header,
  .modal-body,
  .modal-footer {
    padding: 1rem;
  }

  /* Điều chỉnh tiêu đề modal */
  .modal-title {
    font-size: 1.25rem;
  }

  /* Sắp xếp lại các cột hoạt động theo dạng dọc */
  .activity-container {
    display: flex;
    flex-direction: column;
  }

  /* Cho mỗi hộp hoạt động chiếm toàn bộ chiều rộng */
  .activity-box {
    width: 100%;
    margin-bottom: 1rem;
  }
}

</style>
<!-- Modal "Hoạt động gần đây" -->
<div class="modal fade" id="recentActivityModal" tabindex="-1" aria-labelledby="recentActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="recentActivityModalLabel">Hoạt động gần đây</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <!-- Modal Body -->
      <div class="modal-body">
        <div class="activity-container">
          <!-- Cột hoạt động của User -->
          <div class="activity-box user-activity">
            <h3><i class="fas fa-user"></i> Hoạt động của người dùng</h3>
            <ul class="list-group" id="userActivityList">
              <!-- Log hoạt động của người dùng sẽ được chèn vào đây -->
            </ul>
          </div>
          <!-- Cột hoạt động của Hệ thống -->
          <div class="activity-box system-activity">
            <h3><i class="fas fa-cogs"></i> Hoạt động của hệ thống</h3>
            <ul class="list-group">
              <li class="list-group-item">
                <span class="activity-text">Hệ thống đã upload đề thi mới: <strong>Tiếng Anh</strong></span>
                <span class="activity-time">3 giờ trước</span>
              </li>
              <li class="list-group-item">
                <span class="activity-text">Hệ thống đã upload đề thi mới: <strong>Sinh học</strong></span>
                <span class="activity-time">4 giờ trước</span>
              </li>
              <li class="list-group-item">
                <span class="activity-text">Hệ thống đã upload đề thi mới: <strong>Lịch sử</strong></span>
                <span class="activity-time">5 giờ trước</span>
              </li>
              <!-- Nút đăng ký nhận thông báo chỉ hiển thị trong modal này -->
              <li class="list-group-item text-center">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#subscribeModal" data-bs-dismiss="modal">
                  Đăng ký nhận thông báo
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Đăng ký nhận thông báo -->
<div class="modal fade" id="subscribeModal" tabindex="-1" aria-labelledby="subscribeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="subscribeModalLabel">Đăng ký nhận thông báo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <!-- Modal Body -->
      <div class="modal-body">
        <form id="subscribeForm">
          <div class="mb-3">
            <label for="selectSchool" class="form-label">Chọn Trường</label>
            <select class="form-select" id="selectSchool" required>
              <option value="">Chọn trường</option>
              <!-- Các option sẽ được đổ từ API -->
            </select>
          </div>
          <div class="mb-3">
            <label for="selectDepartment" class="form-label">Chọn Khoa</label>
            <select class="form-select" id="selectDepartment" required>
              <option value="">Chọn khoa</option>
              <!-- Các option sẽ được đổ khi chọn trường -->
            </select>
          </div>
          <div class="mb-3">
            <label for="emailInput" class="form-label">Email</label>
            <input type="email" class="form-control" id="emailInput" placeholder="Nhập email của bạn" required>
          </div>
          <button type="submit" class="btn btn-primary">Xác nhận</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Tải danh sách trường khi modal mở (hoặc khi trang load)
  fetch('/api/get_schools_v2')
    .then(response => response.json())
    .then(schools => {
      const selectSchool = document.getElementById('selectSchool');
      schools.forEach(school => {
        const option = document.createElement('option');
        option.value = school.id;
        option.textContent = school.school_name;
        selectSchool.appendChild(option);
      });
    })
    .catch(err => console.error('Lỗi load schools:', err));

  // Khi chọn trường, tải danh sách khoa tương ứng
  const selectSchool = document.getElementById('selectSchool');
  selectSchool.addEventListener('change', function() {
    const schoolId = this.value;
    const selectFaculty = document.getElementById('selectDepartment');
    // Xóa các option cũ, giữ lại option mặc định
    selectFaculty.innerHTML = '<option value="">Chọn khoa</option>';
    if (schoolId) {
      fetch(`/api/faculties_v2/${schoolId}`)
        .then(response => response.json())
        .then(faculties => {
          faculties.forEach(faculty => {
            const option = document.createElement('option');
            option.value = faculty.id;
            option.textContent = faculty.faculty_name;
            selectFaculty.appendChild(option);
          });
        })
        .catch(err => console.error('Lỗi load faculties:', err));
    }
  });

  // Xử lý submit form đăng ký nhận thông báo
  const subscribeForm = document.getElementById('subscribeForm');
  subscribeForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const schoolId = document.getElementById('selectSchool').value;
    const facultyId = document.getElementById('selectDepartment').value;
    const email = document.getElementById('emailInput').value;
    
    if (!schoolId || !facultyId || !email) {
      alert("Vui lòng điền đầy đủ thông tin.");
      return;
    }
    
    const data = { school_id: schoolId, faculty_id: facultyId, email: email };

    fetch('/api/register_notification', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      alert(result.message || "Đăng ký thành công!");
      subscribeForm.reset();
      // Đóng modal (với Bootstrap 5)
      const subscribeModalEl = document.getElementById('subscribeModal');
      const modalInstance = bootstrap.Modal.getInstance(subscribeModalEl);
      if (modalInstance) modalInstance.hide();
    })
    .catch(err => {
      console.error('Lỗi khi đăng ký:', err);
      alert("Đã có lỗi xảy ra. Vui lòng thử lại.");
    });
  });
});

// Hàm tính thời gian tương đối từ thời điểm hiện tại (ví dụ: "10 phút trước")
function timeSince(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return interval + " năm trước";
  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return interval + " tháng trước";
  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return interval + " ngày trước";
  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return interval + " giờ trước";
  interval = Math.floor(seconds / 60);
  if (interval >= 1) return interval + " phút trước";
  return Math.floor(seconds) + " giây trước";
}

// Hàm tải và hiển thị 3 log hoạt động người dùng
function loadUserActivity() {
  fetch('/api/user-activity')
    .then(response => response.json())
    .then(data => {
      const userActivityList = document.getElementById('userActivityList');
      userActivityList.innerHTML = ''; // Xóa nội dung cũ
      data.forEach(activity => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `
          <span class="activity-text">Người dùng nào đó đã mở đề thi <strong>${activity.file_name}</strong></span>
          <span class="activity-time">${timeSince(activity.opened_at)}</span>
        `;
        userActivityList.appendChild(li);
      });
    })
    .catch(error => {
      console.error('Error loading user activity:', error);
    });
}

// Gọi loadUserActivity mỗi khi modal được hiển thị
var recentActivityModal = document.getElementById('recentActivityModal');
recentActivityModal.addEventListener('shown.bs.modal', function () {
  loadUserActivity();
});
document.addEventListener("DOMContentLoaded", function () {
    fetch("/api/check-login")
        .then(response => response.json())
        .then(data => {
            if (data.loggedIn) {
                console.log("Đã đăng nhập:", data.username);
                document.getElementById("navBar").style.display = "block"; // Hiển thị navbar
                document.getElementById("loginForm").style.display = "none"; // Ẩn form đăng nhập nếu có
            } else {
                console.log("Chưa đăng nhập");
                document.getElementById("navBar").style.display = "none"; // Ẩn navbar nếu chưa đăng nhập
                document.getElementById("loginForm").style.display = "block"; // Hiển thị form đăng nhập
            }
        })
        .catch(error => console.error("Lỗi kiểm tra đăng nhập:", error));
});

</script>

<style>
    /* Container chứa 2 cột */
.activity-container {
  display: flex;
  gap: 20px;
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Khung thông báo của mỗi cột */
.activity-box {
  flex: 1;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  opacity: 0;
  animation: fadeIn 0.6s forwards;
}

/* Hiệu ứng fade-in */
@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

/* Tiêu đề mỗi cột */
.activity-box h3 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: #333;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  border-bottom: 2px solid;
  padding-bottom: 10px;
}

/* Phân biệt tiêu đề từng cột */
.user-activity h3 {
  border-color: #007bff;
  color: #007bff;
}

.system-activity h3 {
  border-color: #28a745;
  color: #28a745;
}

/* Các mục trong danh sách */
.list-group-item {
  border: none;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
  background-color: transparent !important;
}


.list-group-item:last-child {
  border-bottom: none;
}
.list-group-item {
  background-color: transparent !important;
  backdrop-filter: none !important;
  box-shadow: none !important;
}
.list-group-item:hover,
.list-group-item:focus,
.list-group-item:active {
  background-color: transparent !important;
}

/* Nội dung hoạt động */
.activity-text {
  display: block;
  font-size: 1rem;
  color: #555;
}

/* Thời gian hoạt động */
.activity-time {
  font-size: 0.9rem;
  color: #888;
  font-style: italic;
  margin-top: 5px;
}


</style>
</div>
      </div>
    </div>
  </div>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
<style>
/* Container chứa cả hai cột */
.activity-container {
  display: flex;
  gap: 20px;
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Cột hoạt động của người dùng và hệ thống */
.user-activity,
.system-activity {
  flex: 1;
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Tiêu đề mỗi cột */
.user-activity h3,
.system-activity h3 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: #333;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
}

/* Phân biệt tiêu đề cột người dùng và hệ thống */
.user-activity h3 {
  color: #007bff; /* Màu xanh dương cho người dùng */
}

.system-activity h3 {
  color: #28a745; /* Màu xanh lá cho hệ thống */
}

/* Khung hoạt động */
.activity-box {
  background: #f9f9f9;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.activity-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Nội dung trong khung hoạt động */
.activity-box p {
  margin: 0;
  font-size: 1rem;
  color: #555;
}

.activity-box strong {
  color: #333;
}

/* Thời gian hoạt động */
.activity-time {
  display: block;
  margin-top: 10px;
  font-size: 0.9rem;
  color: #888;
  font-style: italic;
} 

</style>
<p>Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?</p>
          <p id="resumePathDisplay"></p>

        </div>
        <div class="modal-footer">

          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal Lịch sử xem -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" >
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">Lịch sử xem</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <div id="historyMessage" class="mb-3"></div>
          <ul id="historyList" class="list-group">
            <!-- Danh sách lịch sử sẽ được chèn vào đây -->
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal quảng cáo -->
<div class="modal fade" id="adModal" tabindex="-1" aria-labelledby="adModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adModalLabel">Quảng cáo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Iframe cho quảng cáo thứ nhất -->
          <div class="col-md-6">
            <iframe id="adIframe1" src="about:blank" title="Advertisement 1" width="100%" height="400" frameborder="0"></iframe>
          </div>
          <!-- Iframe cho quảng cáo thứ hai -->
          <div class="col-md-6">
            <iframe id="adIframe2" src="about:blank" title="Advertisement 2" width="100%" height="400" frameborder="0"></iframe>
          </div>
        </div>
        <div class="countdown-overlay">
          Quảng cáo sẽ tắt sau <span id="countdown">10</span> giây
        </div>
        <button class="skip-ad" id="skipAdBtn">Bỏ qua quảng cáo</button>
      </div>
    </div>
  </div>
</div>


  <!-- Modal xem trước file (cho ảnh) -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filePreviewModalLabel">Xem Trước File</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body text-center">
<img id="imgPreview" src="" alt="Preview" class="img-fluid d-none">
          <div id="rotateControls" class="my-3 d-none">
            <button id="rotateLeft" class="btn btn-secondary"><i class="bi bi-arrow-counterclockwise"></i></button>
            <button id="rotateRight" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- CSS bổ sung -->
<style>
  /* Tùy chỉnh giao diện Modal */
  .modal-content {
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: none;
  }
  .modal-header, .modal-footer {
    border: none;
  }
  .modal-title {
    font-weight: 600;
    font-size: 1.5rem;
  }
  .btn-close {
    font-size: 1.25rem;
  }
  .modal-body p {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #333;
  }
  #resumePathDisplay {
    font-size: 0.9rem;
    color: #6c757d;
  }
  .btn-primary {
    background-color: #007bff;
    border: none;
    transition: background-color 0.3s ease;
  }
  .btn-primary:hover {
    background-color: #0056b3;
  }
  .btn-secondary {
    background-color: #6c757d;
    border: none;
    transition: background-color 0.3s ease;
  }
  .btn-secondary:hover {
    background-color: #565e64;
  }
</style>

<!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
<div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?
        </p>
        <p id="resumePathDisplay" class="text-muted"></p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu mới</button>
        <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>
      </div>
    </div>
  </div>
</div>


<!-- CSS bổ sung -->
<style>
  /* Tùy chỉnh giao diện Modal chung */
  .modal-content {
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    border: none;
  }
  .modal-header {
    border: none;
  }
  .modal-title {
    font-weight: 600;
    font-size: 1.5rem;
  }
  .btn-close {
    font-size: 1.25rem;
  }
  .modal-body {
    position: relative;
    padding: 1.5rem;
  }

  /* CSS dành riêng cho quảng cáo */
  .ad-container {
    position: relative;
  }
  .ad-container iframe {
    border-radius: 0.5rem;
  }
  .countdown-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 1rem;
  }
  .skip-ad {
    display: block;
    margin: 1rem auto 0;
    padding: 0.5rem 2rem;
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: background-color 0.3s ease;
  }
  .skip-ad:hover {
    background-color: #c82333;
  }
  @keyframes combinedGlow {
  0%, 100% {
    filter: brightness(1.3);
    text-shadow: 0 0 8px #ffc107, 0 0 16px #ffc107;
  }
  50% {
    filter: brightness(0.9);
    text-shadow: none;
  }
}
.icon-combined {
  animation: combinedGlow 2s infinite;
}

</style>

<!-- Modal quảng cáo -->
<div class="modal fade" id="adModal" tabindex="-1" aria-labelledby="adModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="adModalLabel">Quảng cáo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="ad-container">
          <iframe src="about:blank" title="Advertisement" width="100%" height="400" frameborder="0"></iframe>
          <div class="countdown-overlay">Quảng cáo sẽ tắt sau <span id="countdown">10</span> giây</div>
        </div>
        <button class="skip-ad" id="skipAdBtn">Bỏ qua quảng cáo</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal Tìm kiếm Môn học -->
<div class="modal fade" id="customSearchModal" tabindex="-1" aria-labelledby="customSearchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
      <!-- Modal Header -->
      <div class="custom-modal-header" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 16px;">
        <h5 class="custom-modal-title" id="customSearchModalLabel" style="font-size: 1.25rem; font-weight: 600; color: #0d6efd;">
          <i class="fas fa-book-open me-2"></i>Tìm kiếm Môn học
        </h5>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Search Input Group -->
        <div class="custom-search-input-group" style="position: relative; margin-bottom: 1rem;">
          <input type="text" id="subjectSearchInput" class="form-control form-control-lg" 
                 placeholder="Nhập tên môn học..." aria-label="Search input"
                 style="border-radius: 8px; padding-right: 50px; border: 1px solid #ced4da;">
          <button type="button" 
                  style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 8px 8px 0; background-color: #0d6efd; border: none; color: #fff;"
                  onmouseover="this.style.backgroundColor='#0b5ed7'" 
                  onmouseout="this.style.backgroundColor='#0d6efd'">
            <i class="fas fa-search"></i>
          </button>
        </div>

        <!-- Tip Text (Thông báo chọn trường) -->
<div id="schoolSelectionNotice" class="custom-tip-text d-none" 
     style="display: flex; align-items: center; padding: 10px 15px; background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%); border-radius: 4px; font-size: 0.9em; color: #333; margin-top: 8px; margin-bottom: 16px;">
<i class="fas fa-lightbulb icon-combined" style="font-size: 1em; margin-right: 10px;"></i>
  Mẹo nhỏ: Chọn trường rồi tìm kiếm để chỉ hiển thị dữ liệu của trường đó.
</div>

        <!-- Kết quả tìm kiếm -->
        <h6 id="searchResultCount" class="text-muted mb-3">Kết quả tìm kiếm (0)</h6>
        <div id="subjectSearchSuggestions" class="custom-scrollable-results" 
             style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
          <!-- Các kết quả tìm kiếm sẽ được chèn vào đây qua JS -->
        </div>
      </div>

      <!-- Modal Footer -->
<div class="custom-modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #e9ecef; padding: 16px; display: flex; justify-content: flex-end;">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
</div>
    </div>
  </div>
</div>  

<!-- Bootstrap JS (bao gồm Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS để mở modal khi nhấn nút -->
<script>

  document.addEventListener("DOMContentLoaded", function() {
    // Tạo instance modal từ phần tử có id "modernProfileModal"
    const modalElement = document.getElementById("modernProfileModal");
    const modernModal = new bootstrap.Modal(modalElement);
    
    // Thêm sự kiện click cho nút mở modal
    document.getElementById("openModalBtn").addEventListener("click", function() {
      modernModal.show();
    });
  });

  // Các hàm liên quan tới chỉnh sửa trong modal (đã có sẵn)
  function modernToggleEdit() {
    const textElement = document.getElementById('modernUniversityText');
    const selectElement = document.getElementById('modernUniversitySelect');
    const saveButton = document.getElementById('modernSaveBtn');

    if (selectElement.style.display === 'none' || selectElement.style.display === '') {
      textElement.style.display = 'none';
      selectElement.style.display = 'block';
      selectElement.focus();
      saveButton.style.display = 'inline-block';
    } else {
      textElement.style.display = 'block';
      selectElement.style.display = 'none';
      saveButton.style.display = 'none';
      selectElement.value = textElement.innerText;
    }
  }

  function modernSaveChanges() {
    const textElement = document.getElementById('modernUniversityText');
    const selectElement = document.getElementById('modernUniversitySelect');
    
    textElement.innerText = selectElement.value;
    modernToggleEdit();
    console.log('Đã cập nhật trường đại học:', selectElement.value);
  }
</script>

<!-- HTML Imports -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Cấu hình PDF.js worker (chỉ cần khai báo một lần)
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';

  /*=======================
    Biến toàn cục
  =======================*/
  let examCurrentPath = [];
  let syllabusCurrentPath = [];
  let currentRotation = 0;
  let adTimer = null;
  let currentFile = null;

  /*=======================
    Hàm hiển thị Drive
  =======================*/
  async function renderDrive(containerId, path, updatePathCallback) {
    const documentType = containerId.includes('exam') ? 'exam' : 'syllabus';
    const container = document.getElementById(containerId);
    if (!container) {
      console.error(`Không tìm thấy container với ID: ${containerId}`);
      return;
    }
    container.innerHTML = '';

    // Hiển thị spinner khi tải dữ liệu
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    spinner.textContent = 'Loading...';
    container.appendChild(spinner);

    // Lấy dữ liệu từ backend
    let data = [];
    try {
      if (path.length === 0) {
        data = await (await fetch('/api/schools')).json();
      } else if (path.length === 1) {
        const schoolId = path[0].id;
        data = await (await fetch(`/api/schools/${schoolId}/faculties`)).json();
      } else if (path.length === 2) {
        const facultyId = path[1].id;
        data = await (await fetch(`/api/faculties/${facultyId}/subjects?type=${documentType}`)).json();
      } else if (path.length === 3) {
        const subjectId = path[2].id;
        const response = await fetch(`/api/subjects/${subjectId}/documents_by_year?type=${documentType}`);
        const groupedData = await response.json();
        data = Object.keys(groupedData)
          .map(year => ({
            id: parseInt(year),
            name: year,
            count: groupedData[year].length,
            documents: groupedData[year]
          }))
          .sort((a, b) => b.id - a.id);
      } else if (path.length === 4) {
        const subjectId = path[2].id;
        const year = path[3].id;
        data = await (await fetch(`/api/subjects/${subjectId}/documents/${year}?type=${documentType}`)).json();
      }
    } catch (error) {
      console.error('Lỗi khi lấy dữ liệu:', error);
    }

    container.innerHTML = ''; // Xóa spinner sau khi tải xong

    // Hiển thị breadcrumb
    renderBreadcrumb(container, path, updatePathCallback);

    // Thanh tìm kiếm inline
    const inlineSearchContainer = document.createElement('div');
    inlineSearchContainer.className = 'input-group mb-3';
    inlineSearchContainer.style.position = 'relative';
    inlineSearchContainer.innerHTML = `
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="search" class="form-control" placeholder="Tìm kiếm trong thư mục...">
    `;
    container.appendChild(inlineSearchContainer);

    const inlineSuggestions = document.createElement('div');
    inlineSuggestions.className = 'suggestions';
    inlineSuggestions.style.display = 'none';
    inlineSearchContainer.appendChild(inlineSuggestions);

    // Nút tìm kiếm nâng cao
    const advancedSearchBtn = document.createElement('button');
    advancedSearchBtn.className = 'btn btn-outline-primary mb-3';
    advancedSearchBtn.textContent = 'Tìm kiếm theo tên môn học';
advancedSearchBtn.addEventListener('click', () => {
  const subjectSearchModal = new bootstrap.Modal(document.getElementById('customSearchModal'));
  subjectSearchModal.show();
  
});
    container.appendChild(advancedSearchBtn);

    // Danh sách file/folder
    const list = document.createElement('ul');
    list.className = 'file-list';
    if (Array.isArray(data)) {
      data.forEach(item => {
        if ((path.length < 3 || path.length === 3) && item.count > 0) {
          renderFolderItem(list, item.name, path, updatePathCallback, item.count, item.id);
        } else if (path.length === 4) {
          renderFileItem(list, item, documentType);
        }
      });
    }
    container.appendChild(list);

    // Xử lý tìm kiếm inline
    const inlineSearchInput = inlineSearchContainer.querySelector('input');
    inlineSearchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const suggestions = [];
      Array.from(list.children).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(term) ? 'flex' : 'none';
        if (item.style.display !== 'none') {
          const name = item.querySelector('.file-name').textContent;
          if (!suggestions.includes(name)) suggestions.push(name);
        }
      });

      inlineSuggestions.innerHTML = '';
      if (term && suggestions.length > 0) {
        suggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.textContent = suggestion;
          div.addEventListener('click', () => {
            inlineSearchInput.value = suggestion;
            inlineSearchInput.dispatchEvent(new Event('input'));
            inlineSuggestions.style.display = 'none';
          });
          inlineSuggestions.appendChild(div);
        });
        inlineSuggestions.style.display = 'block';
      } else {
        inlineSuggestions.style.display = 'none';
      }
    });
  }

  /*=======================
    Hàm phụ trợ
  =======================*/
  function renderBreadcrumb(container, path, callback) {
    if (path.length === 0) return;
    const breadcrumb = document.createElement('nav');
    let html = `
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#" id="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
        </li>
    `;
    path.forEach((segment, index) => {
      html += index === path.length - 1
        ? `<li class="breadcrumb-item active">${segment.name}</li>`
        : `<li class="breadcrumb-item"><a href="#" class="breadcrumb-link" data-index="${index}">${segment.name}</a></li>`;
    });
    breadcrumb.innerHTML = html + '</ol>';

    breadcrumb.querySelector('#back-button').addEventListener('click', (e) => {
      e.preventDefault();
      callback(path.slice(0, -1));
    });

    breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const index = parseInt(link.getAttribute('data-index'));
        callback(path.slice(0, index + 1));
      });
    });

    container.prepend(breadcrumb);
  }

  function renderFolderItem(list, name, currentPath, callback, count, itemId) {
    const li = document.createElement('li');
    li.className = 'file-item';
    li.innerHTML = `
      <i class="bi bi-folder-fill file-icon folder"></i>
      <span class="file-name">${name}</span>
      <span class="file-count">${count}</span>
    `;
    li.addEventListener('click', () => callback([...currentPath, { id: itemId, name }]));
    list.appendChild(li);
  }

function renderFileItem(list, file, documentType) {
  if (!file.file_path) {
    console.warn('File không có đường dẫn hợp lệ:', file);
    return;
  }

  const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
  const ext = filePath.split('.').pop().toLowerCase();
  const iconClass = {
    pdf: 'bi-file-pdf pdf',
    doc: 'bi-file-earmark-word word',
    docx: 'bi-file-earmark-word word',
    jpg: 'bi-file-image',
    jpeg: 'bi-file-image',
    png: 'bi-file-image',
    gif: 'bi-file-image'
  }[ext] || 'bi-file-earmark';

  const li = document.createElement('li');
  li.className = 'file-item';
  const typeLabel = documentType === 'exam' ? 'Đề Thi' : 'Đề Cương';
  li.innerHTML = `
    <i class="bi ${iconClass} file-icon"></i>
    <div>
      <div class="file-name">${typeLabel} ${file.file_name}</div>
      <div class="file-info">${file.file_info || ''}</div>
    </div>
  `;

  li.addEventListener('click', () => {
    fetch('/api/check-login', {
      method: 'GET',
      credentials: 'include' // Đảm bảo gửi cookie session
    })
    .then(response => response.json())
    .then(data => {
      if (data.loggedIn) {
        // Nếu đã đăng nhập, kiểm tra trạng thái tài khoản
        fetch('/api/account_status', {
          method: 'GET',
          credentials: 'include'
        })
        .then(response => response.json())
        .then(statusData => {
          if (statusData.account_status === 'đã duyệt') {
            // Nếu trạng thái là "đã duyệt", thực hiện logic cũ: log file mở và mở file
            fetch('/api/log-file-open', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ documentId: file.id })
            })
            .then(() => {
              window.open(filePath, '_blank'); // Mở file trong tab mới
            })
            .catch(error => {
              console.error('Lỗi khi log file:', error);
              window.open(filePath, '_blank'); // Vẫn mở file ngay cả khi log lỗi
            });
          } else if (statusData.account_status === 'bình thường') {
            // Nếu trạng thái là "bình thường", hiển thị modal xác thực
            const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
            modal.show();
          } else if (statusData.account_status === 'đang duyệt') {
            // Nếu trạng thái là "đang xét duyệt", hiển thị thông báo và không hiển thị modal
            alert("Tài khoản của bạn đang được xét duyệt, vui lòng đợi");
          }
        })
        .catch(error => {
          console.error('Lỗi khi kiểm tra trạng thái tài khoản:', error);
          // Fallback: hiển thị modal xác thực nếu có lỗi
          const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
          modal.show();
        });
      } else {
        // Nếu chưa đăng nhập, hiển thị modal đăng nhập
        const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
        modal.show();
      }
    })
    .catch(error => {
      console.error('Lỗi kiểm tra đăng nhập:', error);
      // Hiển thị modal đăng nhập nếu có lỗi trong quá trình kiểm tra
      const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
      modal.show();
    });
  });

  list.appendChild(li);
}

function openFile(filePath) {
  if (isInAppBrowser()) {
    // Với trình duyệt in-app, chuyển hướng trong cùng tab
    window.location.href = filePath;
  } else {
    // Các trình duyệt thông thường mở link trong tab mới
    window.open(filePath, '_blank');
  }
}

function isInAppBrowser() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  // Kiểm tra dấu hiệu của in-app browser: FBAN, FBAV cho Facebook; Messenger; Zalo
  return ua.indexOf("FBAN") > -1 ||
         ua.indexOf("FBAV") > -1 ||
         ua.indexOf("Messenger") > -1 ||
         ua.indexOf("Zalo") > -1;
}

  function showAdModal() {
    let countdown = 10;
    const countdownElement = document.getElementById('countdown');
    if (!countdownElement) {
      console.error('Không tìm thấy phần tử countdown trong DOM');
      return;
    }

    const adModal = new bootstrap.Modal(document.getElementById('adModal'));
    adModal.show();
    countdownElement.textContent = countdown;

    adTimer = setInterval(() => {
      countdown--;
      countdownElement.textContent = countdown;
      if (countdown <= 0) {
        clearInterval(adTimer);
        adModal.hide();
        openFileFromBackend();
      }
    }, 1000);
  }

  function openFileFromBackend() {
    if (window.currentFile?.file_path) {
      window.open(window.currentFile.file_path, '_blank');
    } else {
      console.error('Không có file để mở');
    }
  }

  /*=======================
    Preview File & Lịch sử
  =======================*/
  function previewFile(file) {
    currentFile = file;
    const activeTab = document.querySelector('.tab-pane.active').id;
    const fileType = activeTab === 'de-thi' ? 'Đề Thi' : 'Đề Cương';
    addFileToHistory(file, fileType);
    showAdModal();
  }

  function addFileToHistory(file, fileType) {
    let history = JSON.parse(localStorage.getItem('viewHistory')) || [];
    if (!history.find(item => item.name === file.name && item.type === fileType)) {
      history.push({ name: file.name, info: file.info || '', type: fileType });
      localStorage.setItem('viewHistory', JSON.stringify(history));
    }
  }

  function proceedFileOpen(file) {
    const ext = file.file_path.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
      const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
      const imgPreview = document.getElementById('imgPreview');
      imgPreview.style.transform = 'rotate(0deg)';
      imgPreview.src = file.file_path;
      imgPreview.classList.remove('d-none');
      document.getElementById('rotateControls').classList.remove('d-none');
      document.getElementById('filePreviewModalLabel').textContent = file.file_name;
      modal.show();
    } else if (['doc', 'docx'].includes(ext)) {
      const link = document.createElement('a');
      link.href = file.file_path;
      link.download = file.file_name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else if (ext === 'pdf') {
      const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
      const container = document.getElementById('pdfContainer');
      container.innerHTML = '';

      pdfjsLib.getDocument(file.file_path).promise.then(pdf => {
        const totalPages = pdf.numPages;
        const renderPromises = [];
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
          renderPromises.push(pdf.getPage(pageNum).then(page => {
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            container.appendChild(canvas);
            const context = canvas.getContext('2d');
            return page.render({ canvasContext: context, viewport }).promise;
          }));
        }
        Promise.all(renderPromises).then(() => modal.show());
      }).catch(error => {
        console.error('Lỗi khi render PDF:', error);
        window.open(file.file_path, '_blank');
      });
    } else {
      window.open(file.file_path, '_blank');
    }
  }

  /*=======================
    Quản lý trạng thái
  =======================*/
  function renderExamDrive(newPath) {
    examCurrentPath = newPath;
    localStorage.setItem('examCurrentPath', JSON.stringify(examCurrentPath));
    renderDrive('exam-drive-container', examCurrentPath, renderExamDrive);
  }

  function renderSyllabusDrive(newPath) {
    syllabusCurrentPath = newPath;
    localStorage.setItem('syllabusCurrentPath', JSON.stringify(syllabusCurrentPath));
    renderDrive('syllabus-drive-container', syllabusCurrentPath, renderSyllabusDrive);
  }

  /*=======================
    Khởi tạo khi tải trang
  =======================*/
  document.addEventListener('DOMContentLoaded', () => {
    const savedExamPath = localStorage.getItem('examCurrentPath');
    const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
    if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
    if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

    const examTab = document.getElementById('de-thi-tab');
    const syllabusTab = document.getElementById('de-cuong-tab');
    const examContent = document.getElementById('de-thi');
    const syllabusContent = document.getElementById('de-cuong');
    let activeTab = localStorage.getItem('activeTab') || 'exam';

    function switchTab(tab) {
      if (tab === 'exam') {
        examTab.classList.add('active');
        syllabusTab.classList.remove('active');
        examContent.classList.add('show', 'active');
        syllabusContent.classList.remove('show', 'active');
        localStorage.setItem('activeTab', 'exam');
        renderExamDrive(examCurrentPath);
      } else {
        syllabusTab.classList.add('active');
        examTab.classList.remove('active');
        syllabusContent.classList.add('show', 'active');
        examContent.classList.remove('show', 'active');
        localStorage.setItem('activeTab', 'syllabus');
        renderSyllabusDrive(syllabusCurrentPath);
      }
    }

    examTab.addEventListener('click', () => switchTab('exam'));
    syllabusTab.addEventListener('click', () => switchTab('syllabus'));
    switchTab(activeTab);

    // Xử lý nút quảng cáo và xoay ảnh
    document.getElementById('skipAdBtn')?.addEventListener('click', () => {
      clearInterval(adTimer);
      const adModal = bootstrap.Modal.getInstance(document.getElementById('adModal'));
      adModal.hide();
      if (currentFile) proceedFileOpen(currentFile);
    });

    document.getElementById('rotateLeft')?.addEventListener('click', () => {
      currentRotation -= 90;
      document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
    });

    document.getElementById('rotateRight')?.addEventListener('click', () => {
      currentRotation += 90;
      document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
    });

    // Xử lý quảng cáo trong modal
    const adModal = document.getElementById('adModal');
    if (adModal) {
      adModal.addEventListener('shown.bs.modal', () => {
        const adIframe = adModal.querySelector('iframe');
        if (adIframe && adIframe.getAttribute('src') === 'about:blank') {
          const adUrl = `https://www.effectiveratecpm.com/pb7fiwbhr?key=27b2a32441ee0c347f6e9fd270bc1a0c&t=${Date.now()}`;
          adIframe.setAttribute('src', adUrl);
        }
      });
    }
  });
document.addEventListener("DOMContentLoaded", function () {
  /*=======================
    Tìm kiếm Môn học
  =======================*/
  // Lấy các phần tử cần thiết từ modal
  const subjectSearchInput = document.getElementById("subjectSearchInput");
  const subjectSearchSuggestions = document.getElementById("subjectSearchSuggestions");
  const schoolSelectionNotice = document.getElementById("schoolSelectionNotice");
  const searchResultCount = document.getElementById("searchResultCount");
  const modalEl = document.getElementById("customSearchModal");

  if (!modalEl) {
    console.error('Không tìm thấy phần tử modal với id "customSearchModal"');
    return;
  }

  // Ẩn ban đầu tiêu đề kết quả và vùng gợi ý
  searchResultCount.style.display = "none";
  subjectSearchSuggestions.style.display = "none";

  // Khởi tạo instance của modal nếu chưa có
  let modalInstance = bootstrap.Modal.getInstance(modalEl);
  if (!modalInstance) {
    modalInstance = new bootstrap.Modal(modalEl);
  }

  // Sự kiện nhập liệu cho ô tìm kiếm
  subjectSearchInput?.addEventListener("input", async () => {
    const term = subjectSearchInput.value.trim().toLowerCase();

    // Nếu từ khóa ít hơn 2 ký tự thì ẩn vùng gợi ý và tiêu đề kết quả
    if (term.length < 2) {
      subjectSearchSuggestions.style.display = "none";
      searchResultCount.style.display = "none";
      return;
    } else {
      searchResultCount.style.display = "block";
    }

    // Xác định activeTab và currentPath (các biến toàn cục examCurrentPath, syllabusCurrentPath cần được định nghĩa)
    const activeTab = localStorage.getItem("activeTab") || "exam";
    const currentPath = activeTab === "exam" ? examCurrentPath : syllabusCurrentPath;

    // Nếu chưa chọn trường thì hiển thị thông báo
    if (!currentPath || currentPath.length === 0) {
      schoolSelectionNotice.classList.remove("d-none");
    } else {
      schoolSelectionNotice.classList.add("d-none");
    }

    // Lấy các tham số từ currentPath (nếu có)
    const schoolId = currentPath[0]?.id || 0;
    const facultyId = currentPath[1]?.id || 0;

    try {
      const url = new URL("/api/search/subjects", window.location.origin);
      url.searchParams.append("term", term);
      if (schoolId) url.searchParams.append("school_id", schoolId);
      if (facultyId) url.searchParams.append("faculty_id", facultyId);

      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
      const results = await response.json();

      // Cập nhật tiêu đề đếm kết quả với số lượng kết quả trả về
      searchResultCount.textContent = "Kết quả tìm kiếm (" + results.length + ")";

      // Xóa nội dung gợi ý cũ
      subjectSearchSuggestions.innerHTML = "";

      if (results.length > 0) {
        results.forEach(subject => {
          // Tạo card kết quả theo định dạng đã cho
          const card = document.createElement("div");
          card.className = "card mb-3";
          card.style.border = "none";
          card.style.borderRadius = "12px";
          card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
          card.style.transition = "all 0.3s ease";
          card.style.backgroundColor = "#ffffff";
          card.style.cursor = "pointer";
          card.onmouseover = function() {
            this.style.transform = "translateY(-3px)";
            this.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
            this.style.backgroundColor = "#f8f9fa";
          };
          card.onmouseout = function() {
            this.style.transform = "none";
            this.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
            this.style.backgroundColor = "#ffffff";
          };

          // Tạo phần card body
          const cardBody = document.createElement("div");
          cardBody.className = "card-body";

          // Tạo container nội dung sử dụng d-flex
          const contentDiv = document.createElement("div");
          contentDiv.className = "d-flex justify-content-between align-items-start";

          // Phần thông tin môn học (bên trái)
          const infoDiv = document.createElement("div");

          const h5 = document.createElement("h5");
          h5.className = "custom-card-title";
          h5.style.color = "#0d6efd";
          h5.style.fontWeight = "600";
          h5.style.marginBottom = "8px";
          h5.textContent = subject.name;

          const schoolDiv = document.createElement("div");
          schoolDiv.style.color = "#6c757d";
          schoolDiv.style.marginBottom = "0.5rem";
          schoolDiv.innerHTML = `<i class="fas fa-university me-1"></i> ${subject.school_name}`;

          const facultySpan = document.createElement("span");
          facultySpan.className = "custom-university-label";
          facultySpan.style.fontSize = "0.9em";
          facultySpan.style.backgroundColor = "#e9ecef";
          facultySpan.style.borderRadius = "20px";
          facultySpan.style.padding = "5px 15px";
          facultySpan.style.display = "inline-block";
          facultySpan.style.color = "#495057";
          facultySpan.style.marginTop = "8px";
          facultySpan.innerHTML = `<i class="fas fa-graduation-cap me-1"></i> ${subject.faculty_name}`;

          infoDiv.appendChild(h5);
          infoDiv.appendChild(schoolDiv);
          infoDiv.appendChild(facultySpan);

          // Phần nút "Xem" (bên phải)
          const viewButton = document.createElement("button");
          viewButton.type = "button";
          viewButton.style.fontSize = "0.875rem";
          viewButton.style.border = "1px solid #0d6efd";
          viewButton.style.color = "#0d6efd";
          viewButton.style.backgroundColor = "transparent";
          viewButton.style.padding = "0.375rem 0.75rem";
          viewButton.style.borderRadius = "0.25rem";
          viewButton.onmouseover = function() {
            this.style.backgroundColor = "#0d6efd";
            this.style.color = "#fff";
          };
          viewButton.onmouseout = function() {
            this.style.backgroundColor = "transparent";
            this.style.color = "#0d6efd";
          };
          viewButton.innerHTML = `<i class="fas fa-eye me-1"></i> Xem`;

          // Ghép thông tin và nút vào container d-flex
          contentDiv.appendChild(infoDiv);
          contentDiv.appendChild(viewButton);

          // Ghép container d-flex vào card body, sau đó vào card
          cardBody.appendChild(contentDiv);
          card.appendChild(cardBody);

          // Khi click vào card (hoặc nút "Xem"), cập nhật currentPath, gọi hàm render tương ứng, reset thanh tìm kiếm và đóng modal
          card.addEventListener("click", () => {
            const newPath = [
              { id: subject.school_id, name: subject.school_name },
              { id: subject.faculty_id, name: subject.faculty_name },
              { id: subject.id, name: subject.name }
            ];
            if (activeTab === "exam") {
              renderExamDrive(newPath);
            } else {
              renderSyllabusDrive(newPath);
            }
            // Reset thanh tìm kiếm
            subjectSearchInput.value = "";
            subjectSearchSuggestions.innerHTML = "";
            subjectSearchSuggestions.style.display = "none";
            searchResultCount.textContent = "Kết quả tìm kiếm (0)";
            // Đóng modal: luôn gọi getInstance để lấy instance hiện hành
            const modal = bootstrap.Modal.getInstance(document.getElementById("customSearchModal"));
            if (modal) {
              modal.hide();
            } else {
              new bootstrap.Modal(document.getElementById("customSearchModal")).hide();
            }
          });

          subjectSearchSuggestions.appendChild(card);
        });
        subjectSearchSuggestions.style.display = "block";
      } else {
        subjectSearchSuggestions.style.display = "none";
      }
    } catch (error) {
      console.error("Lỗi tìm kiếm:", error);
      subjectSearchSuggestions.innerHTML = '<div class="error">Lỗi tải kết quả</div>';
      subjectSearchSuggestions.style.display = "block";
    }
  });
});

  document.addEventListener('DOMContentLoaded', () => {
  const savedExamPath = localStorage.getItem('examCurrentPath');
  const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
  if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
  if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

  const examTab = document.getElementById('de-thi-tab');
  const syllabusTab = document.getElementById('de-cuong-tab');
  const examContent = document.getElementById('de-thi');
  const syllabusContent = document.getElementById('de-cuong');
  let activeTab = localStorage.getItem('activeTab') || 'exam';

  function switchTab(tab) {
    if (tab === 'exam') {
      examTab.classList.add('active');
      syllabusTab.classList.remove('active');
      examContent.classList.add('show', 'active');
      syllabusContent.classList.remove('show', 'active');
      localStorage.setItem('activeTab', 'exam');
      renderExamDrive(examCurrentPath);
    } else {
      syllabusTab.classList.add('active');
      examTab.classList.remove('active');
      syllabusContent.classList.add('show', 'active');
      examContent.classList.remove('show', 'active');
      localStorage.setItem('activeTab', 'syllabus');
      renderSyllabusDrive(syllabusCurrentPath);
    }
  }

  examTab.addEventListener('click', () => switchTab('exam'));
  syllabusTab.addEventListener('click', () => switchTab('syllabus'));
  switchTab(activeTab);

  // Xử lý nút quảng cáo và xoay ảnh
  document.getElementById('skipAdBtn')?.addEventListener('click', () => {
    clearInterval(adTimer);
    const adModal = bootstrap.Modal.getInstance(document.getElementById('adModal'));
    adModal.hide();
    if (currentFile) proceedFileOpen(currentFile);
  });

  document.getElementById('rotateLeft')?.addEventListener('click', () => {
    currentRotation -= 90;
    document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
  });

  document.getElementById('rotateRight')?.addEventListener('click', () => {
    currentRotation += 90;
    document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
  });

  // Khôi phục modal thông báo "Tiếp tục xem"
  if (activeTab === 'exam' && examCurrentPath.length > 0) {
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
    document.getElementById('resumeTabName').textContent = 'Đề Thi';
    document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + examCurrentPath.map(item => item.name).join(' > ');
    resumeModal.show();

    document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
      resumeModal.hide();
    });

    document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
      examCurrentPath = [];
      localStorage.removeItem('examCurrentPath');
      renderExamDrive(examCurrentPath);
      resumeModal.hide();
    });

    document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
      resumeModal.hide();
      showHistoryModal();
    });
  } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
    document.getElementById('resumeTabName').textContent = 'Đề Cương';
    document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
    resumeModal.show();

    document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
      resumeModal.hide();
    });

    document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
      syllabusCurrentPath = [];
      localStorage.removeItem('syllabusCurrentPath');
      renderSyllabusDrive(syllabusCurrentPath);
      resumeModal.hide();
    });

    document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
      resumeModal.hide();
      showHistoryModal();
    });
  }

  // Xử lý quảng cáo trong modal
const adModal = document.getElementById('adModal');
if (adModal) {
  adModal.addEventListener('shown.bs.modal', () => {
    // Quảng cáo thứ nhất: Luôn cập nhật link mới mỗi khi modal mở
    const adIframe1 = adModal.querySelector('#adIframe1');
    if (adIframe1) {
      const adUrl1 = `https://www.effectiveratecpm.com/pb7fiwbhr?key=27b2a32441ee0c347f6e9fd270bc1a0c&t=${Date.now()}`;
      adIframe1.setAttribute('src', adUrl1);
    }
    
    // Quảng cáo thứ hai: Luôn cập nhật link mới mỗi khi modal mở
    const adIframe2 = adModal.querySelector('#adIframe2');
    if (adIframe2) {
      const adUrl2 = `https://www.effectiveratecpm.com/wfijh2sa1q?key=a66715025bbe52ddd58f325f993e257e&t=${Date.now()}`;
      adIframe2.setAttribute('src', adUrl2);
    }
  });
}
});
document.addEventListener("DOMContentLoaded", function() {
  const recentActivityBtn = document.querySelector('.recent-activity-btn');

  // Hàm parse ngày theo local: loại bỏ " GMT" khỏi chuỗi trước khi tạo Date
  function parseLocalDate(dateString) {
    // Loại bỏ phần " GMT" (có thể có khoảng trắng thừa)
    const localString = dateString.replace(/ GMT$/, "");
    return new Date(localString);
  }

  // Hàm tính thời gian tương đối từ thời điểm hiện tại
  function timeSince(dateString) {
    const localDate = parseLocalDate(dateString);
    const seconds = Math.floor((new Date() - localDate) / 1000);

    let interval = Math.floor(seconds / 31536000);
    if (interval >= 1) return interval + " năm trước";
    interval = Math.floor(seconds / 2592000);
    if (interval >= 1) return interval + " tháng trước";
    interval = Math.floor(seconds / 86400);
    if (interval >= 1) return interval + " ngày trước";
    interval = Math.floor(seconds / 3600);
    if (interval >= 1) return interval + " giờ trước";
    interval = Math.floor(seconds / 60);
    if (interval >= 1) return interval + " phút trước";
    return seconds + " giây trước";
  }

  recentActivityBtn.addEventListener('click', function() {
    fetch('/api/latest-exams')
      .then(response => response.json())
      .then(data => {
        const systemActivityList = document.querySelector('.activity-box.system-activity .list-group');
        systemActivityList.innerHTML = '';

        data.forEach(exam => {
          const li = document.createElement('li');
          li.classList.add('list-group-item');
          li.innerHTML = `
            <span class="activity-text">
              Hệ thống đã upload đề thi mới: 
              <a href="${exam.file_path}" target="_blank" style="text-decoration: none;">
                <strong>${exam.file_name}</strong>
              </a>
            </span>
            <span class="activity-time">${timeSince(exam.created_at)}</span>
          `;
          systemActivityList.appendChild(li);
        });

        // Thêm nút đăng ký nhận thông báo chỉ một lần, bên ngoài danh sách log
        if (!document.querySelector('.subscribe-container')) {
          systemActivityList.insertAdjacentHTML('afterend', `
        <div class="subscribe-container text-center mt-3"> 
          <button type="button" class="btn btn-success subscribe-btn" data-bs-toggle="modal" data-bs-target="#subscribeModal">
            <i class="bi bi-bell-fill me-2"></i> Đăng ký nhận thông báo
          </button>
        </div>
          `);
        }
      })
      .catch(error => {
        console.error('Lỗi khi lấy dữ liệu đề thi:', error);
      });
  });
});

</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>