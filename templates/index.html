<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kho Học Liệu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="../static/logo.png" type="image/x-icon">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f4f6f9;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }
    .list-group-item :hover{
      cursor: pointer;
      color: red;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      margin: 0;
      padding-top: 60px;
    }
    
    .compact-container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .card-custom {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .nav-tabs .nav-link {
      font-weight: 500;
      color: var(--secondary-color);
      border: none;
      padding: 0.75rem 1rem;
      transition: color 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 3px solid var(--primary-color);
    }
    
    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
    }
    
    .breadcrumb {
      background: transparent;
      padding: 0.75rem 1rem;
      margin-bottom: 0;
    }
    
    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }
    
    .breadcrumb-item a:hover {
      color: #0056b3;
    }
    
    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
      background: #fff;
    }
    
    .file-item:hover {
      background-color: #f8f9fa;
      transform: translateX(5px);
    }
    
    .file-icon {
      font-size: 24px;
      margin-right: 15px;
      width: 30px;
    }
    
    .file-icon.folder {
      color: #ffc107;
    }
    
    .file-icon.pdf {
      color: #dc3545;
    }
    
    .file-icon.word {
      color: #2b579a;
    }
    
    .file-name {
      flex-grow: 1;
      font-size: 1rem;
    }
    
    .file-info {
      font-size: 0.8rem;
      color: var(--secondary-color);
    }
    
    /* CSS cho gợi ý tìm kiếm (autocomplete) */
    .suggestions {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .suggestions .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    
    .suggestions .suggestion-item:hover {
      background-color: #f8f9fa;
      opacity: 1;
    }
    
    /* Modern Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      background: #ffffff;
      animation: fadeInScale 0.4s ease;
    }
    
    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: #fff;
      border-bottom: none;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-header .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    .modal-header .btn-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }
    
    .modal-header .btn-close:hover {
      opacity: 1;
    }
    
    .modal-body {
      padding: 1.5rem;
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
    }
    
    .modal-footer {
      background: #f5f5f5;
      border-top: none;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    .modal-footer .btn {
      min-width: 120px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    
    .modal-footer .btn-primary {
      background: #2575fc;
      border: none;
    }
    
    .modal-footer .btn-primary:hover {
      background: #1a5bb8;
      transform: translateY(-2px);
    }
    
    .modal-footer .btn-secondary {
      background: #e0e0e0;
      border: none;
      color: #555;
    }
    
    .modal-footer .btn-secondary:hover {
      background: #cfcfcf;
      transform: translateY(-2px);
    }
    
    .modal-footer .btn-info {
      background: #17a2b8;
      border: none;
      color: #fff;
    }
    
    .modal-footer .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }
    
    @media (max-width: 576px) {
      .modal-header, .modal-body, .modal-footer {
        padding: 1rem;
      }
      .modal-header .modal-title {
        font-size: 1.5rem;
      }
    }
    
    /* Modal Resume Header màu xanh lá */
    #resumeModal .modal-header {
      background: linear-gradient(135deg, #28a745, #70db70);
    }
    .about-links {
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 20px 0;
}

.about-links h3 {
  font-size: 20px;
  color: #333;
  margin-bottom: 15px;
}

.about-links ul {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
}

.about-links li {
  display: flex;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.about-links li:last-child {
  border-bottom: none;
}

.about-links .label {
  flex: 0 0 150px;
  font-weight: 600;
  color: #007bff;
}

.about-links .desc {
  flex: 1;
  font-size: 16px;
  color: #555;
}

/* Footer style */
.custom-footer {
  border-top: 1px solid #ddd;
  padding-top: 15px;
  text-align: center;
}

.custom-footer .footer-item {
  margin-bottom: 10px;
  font-size: 16px;
  color: #333;
}

.custom-footer .footer-item span {
  display: block;
  line-height: 1.5;
}

/* Social links style */
.social-links {
  margin-top: 10px;
}

.social-links a {
  margin: 0 10px;
  font-size: 24px;
  color: #007bff;
  text-decoration: none;
  transition: color 0.3s;
}

.social-links a:hover {
  color: #0056b3;
}
/* Custom CSS for Modern and Elegant Modal */
.modal-content {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.modal-header {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    border-bottom: none;
    padding: 20px;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
}

.modal-body {
    padding: 20px;
    background-color: #f9f9f9;
}

.modal-footer {
    border-top: none;
    padding: 15px 20px;
    background-color: #f9f9f9;
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
}

.btn-close {
    filter: invert(1);
}

.btn-secondary {
    background-color: #6c757d;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    transition: background-color 0.3s ease;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.list-group-item {
    border: none;
    margin-bottom: 10px;
    border-radius: 8px;
    padding: 15px;
    background-color: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.list-group-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

/* Animation for modal */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal.fade .modal-dialog {
    animation: fadeIn 0.3s ease-out;
}
.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border-left-color: #09f;
  animation: spin 1s linear infinite;
  margin: 20px auto; /* canh giữa */
  text-indent: -9999px; /* ẩn text Loading... nếu không muốn hiển thị */
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
#subjectSearchModal .modal-dialog {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#subjectSearchModal .modal-content {
    height: 70%;
}
.suggestions {
    position: absolute;
    width: 100%;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050; /* Đảm bảo hiển thị trên modal */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background: #f8f9fa;
}
.suggestions {
    position: absolute;
    top: calc(100% + 2px); /* Nằm ngay dưới ô input, cách 2px để không dính liền */
    left: 0;
    width: 100%;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050; /* Đảm bảo hiển thị trên modal */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background: #f8f9fa;
}

  </style>

</head>
<body>

<div class="compact-container my-4">
    <div class="card card-custom">
      <div class="card-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="de-thi-tab" data-bs-toggle="tab" data-bs-target="#de-thi" type="button" role="tab">Đề Thi</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="de-cuong-tab" data-bs-toggle="tab" data-bs-target="#de-cuong" type="button" role="tab">Đề Cương</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="ve-chung-toi-tab" data-bs-toggle="tab" data-bs-target="#ve-chung-toi" type="button" role="tab">Về Chúng Tôi</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <!-- Tab Đề Thi -->
          <div class="tab-pane fade show active" id="de-thi" role="tabpanel" aria-labelledby="de-thi-tab">
            <div id="exam-drive-container"></div>
          </div>
          <!-- Tab Đề Cương -->
          <div class="tab-pane fade" id="de-cuong" role="tabpanel" aria-labelledby="de-cuong-tab">
            <div id="syllabus-drive-container"></div>
          </div>
          <!-- Tab Về Chúng Tôi -->
          <!-- Tab Về Chúng Tôi -->
<div class="tab-pane fade" id="ve-chung-toi" role="tabpanel" aria-labelledby="ve-chung-toi-tab">
  <div class="p-3">
    <p>
      Các đề thi và tài liệu trên website này đều được đóng góp bởi các cựu sinh viên, mang lại sự gần gũi và trải nghiệm thực tế trong học tập.
    </p>
    
    <!-- Nút "Hoạt động gần đây" chỉ hiển thị trong tab Về Chúng Tôi -->
<button type="button" class="btn btn-primary recent-activity-btn" data-bs-toggle="modal" data-bs-target="#recentActivityModal">
  Hoạt động gần đây
</button>
    
    <div class="about-links mt-3">
      <h3>Các trang web khác:</h3>
      <ul>
        <li>
          <span class="label">
            <a href="http://info.huehub.fun" style="text-decoration: none;" target="_blank">info.huehub.fun</a>
          </span>
          <span class="desc">Tìm kiếm INFO</span>
        </li>
      </ul>
      <footer class="custom-footer mt-4">
        <div class="footer-item">
          <span>Design by Nguyen Ngoc Truong</span>
        </div>
        <div class="social-links">
          <a href="https://www.facebook.com/nntruong05" target="_blank" aria-label="Facebook">
            <i class="bi bi-facebook"></i>
          </a>
          <a href="https://github.com/truongqb05x" target="_blank" aria-label="GitHub">
            <i class="bi bi-github"></i>
          </a>
        </div>
      </footer>
    </div>
  </div>
</div>
<!-- Modal "Hoạt động gần đây" -->
<!-- Modal "Hoạt động gần đây" -->
<div class="modal fade" id="recentActivityModal" tabindex="-1" aria-labelledby="recentActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="recentActivityModalLabel">Hoạt động gần đây</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <!-- Modal Body -->
      <div class="modal-body">
        <div class="activity-container">
          <!-- Cột hoạt động của User -->
          <div class="activity-box user-activity">
            <h3><i class="fas fa-user"></i> Hoạt động của người dùng</h3>
            <ul class="list-group" id="userActivityList">
              <!-- Log hoạt động của người dùng sẽ được chèn vào đây -->
            </ul>
          </div>
          <!-- Cột hoạt động của Hệ thống (ví dụ) -->
          <div class="activity-box system-activity">
            <h3><i class="fas fa-cogs"></i> Hoạt động của hệ thống</h3>
            <ul class="list-group">
              <li class="list-group-item">
                <span class="activity-text">Hệ thống đã upload đề thi mới: <strong>Tiếng Anh</strong></span>
                <span class="activity-time">3 giờ trước</span>
              </li>
              <li class="list-group-item">
                <span class="activity-text">Hệ thống đã upload đề thi mới: <strong>Sinh học</strong></span>
                <span class="activity-time">4 giờ trước</span>
              </li>
              <li class="list-group-item">
                <span class="activity-text">Hệ thống đã upload đề thi mới: <strong>Lịch sử</strong></span>
                <span class="activity-time">5 giờ trước</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script>
// Hàm tính thời gian tương đối từ thời điểm hiện tại (ví dụ: "10 phút trước")
function timeSince(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return interval + " năm trước";
  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return interval + " tháng trước";
  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return interval + " ngày trước";
  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return interval + " giờ trước";
  interval = Math.floor(seconds / 60);
  if (interval >= 1) return interval + " phút trước";
  return Math.floor(seconds) + " giây trước";
}

// Hàm tải và hiển thị 3 log hoạt động người dùng
function loadUserActivity() {
  fetch('/api/user-activity')
    .then(response => response.json())
    .then(data => {
      const userActivityList = document.getElementById('userActivityList');
      userActivityList.innerHTML = ''; // Xóa nội dung cũ
      data.forEach(activity => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `
          <span class="activity-text">Người dùng nào đó đã mở đề thi <strong>${activity.file_name}</strong></span>
          <span class="activity-time">${timeSince(activity.opened_at)}</span>
        `;
        userActivityList.appendChild(li);
      });
    })
    .catch(error => {
      console.error('Error loading user activity:', error);
    });
}

// Gọi loadUserActivity mỗi khi modal được hiển thị
var recentActivityModal = document.getElementById('recentActivityModal');
recentActivityModal.addEventListener('shown.bs.modal', function () {
  loadUserActivity();
});
</script>

<style>
    /* Container chứa 2 cột */
.activity-container {
  display: flex;
  gap: 20px;
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Khung thông báo của mỗi cột */
.activity-box {
  flex: 1;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  opacity: 0;
  animation: fadeIn 0.6s forwards;
}

/* Hiệu ứng fade-in */
@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

/* Tiêu đề mỗi cột */
.activity-box h3 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: #333;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  border-bottom: 2px solid;
  padding-bottom: 10px;
}

/* Phân biệt tiêu đề từng cột */
.user-activity h3 {
  border-color: #007bff;
  color: #007bff;
}

.system-activity h3 {
  border-color: #28a745;
  color: #28a745;
}

/* Các mục trong danh sách */
.list-group-item {
  border: none;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
  background-color: transparent !important;
}


.list-group-item:last-child {
  border-bottom: none;
}
.list-group-item {
  background-color: transparent !important;
  backdrop-filter: none !important;
  box-shadow: none !important;
}
.list-group-item:hover,
.list-group-item:focus,
.list-group-item:active {
  background-color: transparent !important;
}

/* Nội dung hoạt động */
.activity-text {
  display: block;
  font-size: 1rem;
  color: #555;
}

/* Thời gian hoạt động */
.activity-time {
  font-size: 0.9rem;
  color: #888;
  font-style: italic;
  margin-top: 5px;
}


</style>
</div>
      </div>
    </div>
  </div>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
<style>
/* Container chứa cả hai cột */
.activity-container {
  display: flex;
  gap: 20px;
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Cột hoạt động của người dùng và hệ thống */
.user-activity,
.system-activity {
  flex: 1;
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Tiêu đề mỗi cột */
.user-activity h3,
.system-activity h3 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: #333;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
}

/* Phân biệt tiêu đề cột người dùng và hệ thống */
.user-activity h3 {
  color: #007bff; /* Màu xanh dương cho người dùng */
}

.system-activity h3 {
  color: #28a745; /* Màu xanh lá cho hệ thống */
}

/* Khung hoạt động */
.activity-box {
  background: #f9f9f9;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.activity-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Nội dung trong khung hoạt động */
.activity-box p {
  margin: 0;
  font-size: 1rem;
  color: #555;
}

.activity-box strong {
  color: #333;
}

/* Thời gian hoạt động */
.activity-time {
  display: block;
  margin-top: 10px;
  font-size: 0.9rem;
  color: #888;
  font-style: italic;
} 
</style>
<p>Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?</p>
          <p id="resumePathDisplay"></p>

        </div>
        <div class="modal-footer">

          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal Lịch sử xem -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" >
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">Lịch sử xem</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <div id="historyMessage" class="mb-3"></div>
          <ul id="historyList" class="list-group">
            <!-- Danh sách lịch sử sẽ được chèn vào đây -->
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal quảng cáo -->
<div class="modal fade" id="adModal" tabindex="-1" aria-labelledby="adModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adModalLabel">Quảng cáo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Iframe cho quảng cáo thứ nhất -->
          <div class="col-md-6">
            <iframe id="adIframe1" src="about:blank" title="Advertisement 1" width="100%" height="400" frameborder="0"></iframe>
          </div>
          <!-- Iframe cho quảng cáo thứ hai -->
          <div class="col-md-6">
            <iframe id="adIframe2" src="about:blank" title="Advertisement 2" width="100%" height="400" frameborder="0"></iframe>
          </div>
        </div>
        <div class="countdown-overlay">
          Quảng cáo sẽ tắt sau <span id="countdown">10</span> giây
        </div>
        <button class="skip-ad" id="skipAdBtn">Bỏ qua quảng cáo</button>
      </div>
    </div>
  </div>
</div>


  <!-- Modal xem trước file (cho ảnh) -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filePreviewModalLabel">Xem Trước File</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body text-center">
<img id="imgPreview" src="" alt="Preview" class="img-fluid d-none">
          <div id="rotateControls" class="my-3 d-none">
            <button id="rotateLeft" class="btn btn-secondary"><i class="bi bi-arrow-counterclockwise"></i></button>
            <button id="rotateRight" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- CSS bổ sung -->
<style>
  /* Tùy chỉnh giao diện Modal */
  .modal-content {
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: none;
  }
  .modal-header, .modal-footer {
    border: none;
  }
  .modal-title {
    font-weight: 600;
    font-size: 1.5rem;
  }
  .btn-close {
    font-size: 1.25rem;
  }
  .modal-body p {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #333;
  }
  #resumePathDisplay {
    font-size: 0.9rem;
    color: #6c757d;
  }
  .btn-primary {
    background-color: #007bff;
    border: none;
    transition: background-color 0.3s ease;
  }
  .btn-primary:hover {
    background-color: #0056b3;
  }
  .btn-secondary {
    background-color: #6c757d;
    border: none;
    transition: background-color 0.3s ease;
  }
  .btn-secondary:hover {
    background-color: #565e64;
  }
</style>

<!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
<div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?
        </p>
        <p id="resumePathDisplay" class="text-muted"></p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu mới</button>
        <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>
      </div>
    </div>
  </div>
</div>


<!-- CSS bổ sung -->
<style>
  /* Tùy chỉnh giao diện Modal chung */
  .modal-content {
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    border: none;
  }
  .modal-header {
    border: none;
  }
  .modal-title {
    font-weight: 600;
    font-size: 1.5rem;
  }
  .btn-close {
    font-size: 1.25rem;
  }
  .modal-body {
    position: relative;
    padding: 1.5rem;
  }

  /* CSS dành riêng cho quảng cáo */
  .ad-container {
    position: relative;
  }
  .ad-container iframe {
    border-radius: 0.5rem;
  }
  .countdown-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 1rem;
  }
  .skip-ad {
    display: block;
    margin: 1rem auto 0;
    padding: 0.5rem 2rem;
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: background-color 0.3s ease;
  }
  .skip-ad:hover {
    background-color: #c82333;
  }
</style>

<!-- Modal quảng cáo -->
<div class="modal fade" id="adModal" tabindex="-1" aria-labelledby="adModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="adModalLabel">Quảng cáo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="ad-container">
          <iframe src="about:blank" title="Advertisement" width="100%" height="400" frameborder="0"></iframe>
          <div class="countdown-overlay">Quảng cáo sẽ tắt sau <span id="countdown">10</span> giây</div>
        </div>
        <button class="skip-ad" id="skipAdBtn">Bỏ qua quảng cáo</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal nhập từ khóa tìm kiếm theo tên môn học (nâng cao) -->
<!-- CSS bổ sung -->
<style>
  /* Tùy chỉnh giao diện Modal */
  .modal-content {
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: none;
  }
  .modal-header, .modal-footer {
    border: none;
  }
  .modal-title {
    font-weight: 600;
    font-size: 1.5rem;
  }
  .btn-close {
    font-size: 1.25rem;
  }
  .modal-body p {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #333;
  }
  .btn-primary {
    background-color: #007bff;
    border: none;
    transition: background-color 0.3s ease;
  }
  .btn-primary:hover {
    background-color: #0056b3;
  }
  .btn-secondary {
    background-color: #6c757d;
    border: none;
    transition: background-color 0.3s ease;
  }
  .btn-secondary:hover {
    background-color: #565e64;
  }
  /* CSS cho phần gợi ý tìm kiếm môn học */
  .suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    z-index: 1050;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 0.5rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
  }
  .suggestions div {
    padding: 0.5rem 1rem;
    cursor: pointer;
  }
  .suggestions div:hover {
    background-color: #f8f9fa;
  }
  /* Container chứa các gợi ý */
.suggestions {
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  margin-top: 5px;
}

/* Mỗi mục trong danh sách gợi ý */
.suggestion-item {
  padding: 12px 15px;
  cursor: pointer;
  transition: background 0.2s;
  border-bottom: 1px solid #eee; /* Đường kẻ ngăn cách giữa các mục */
}

/* Loại bỏ đường kẻ cuối cùng */
.suggestion-item:last-child {
  border-bottom: none;
}

/* Hiệu ứng khi di chuột qua */
.suggestion-item:hover {
  background: #f8f9fa;
}

/* Tên môn học */
.subject-name {
  font-weight: 500;
  color: #333;
  margin-bottom: 4px; /* Khoảng cách giữa tên và đường dẫn */
}

/* Đường dẫn (trường → khoa) */
.subject-path {
  font-size: 0.9em;
  color: #666;
}

/* Khi không có kết quả */
.no-results {
  padding: 15px;
  color: #666;
  font-style: italic;
  text-align: center;
  border-bottom: 1px solid #eee;
}

/* Khi có lỗi */
.error {
  padding: 15px;
  color: #dc3545;
  text-align: center;
  border-bottom: 1px solid #eee;
}

/* Hiệu ứng khi click */
.suggestion-item:active {
  background: #e9ecef;
}
.suggestions {
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 1000;
}

.suggestion-item {
  padding: 10px;
  cursor: pointer;
  transition: background 0.2s;
  border-bottom: 1px solid #ddd; /* Thêm đường kẻ phân cách */
}

.suggestion-item:last-child {
  border-bottom: none; /* Loại bỏ đường kẻ cuối cùng */
}

.suggestion-item:hover {
  background: #f8f9fa;
  text-decoration: underline;
  text-decoration-color: black; /* Gạch chân màu đen */
}

.subject-name {
  font-weight: 500;
  color: #333;
}

.subject-path {
  font-size: 0.9em;
  color: #666;
}

.no-results {
  padding: 10px;
  color: #666;
  font-style: italic;
}

.error {
  padding: 10px;
  color: #dc3545;
}
#schoolSelectionNotice {
  display: block; /* Đảm bảo hiển thị như block */
  font-size: 0.9rem; /* Kích thước chữ nhỏ gọn */
  color: #856404; /* Màu chữ vàng đậm (text-warning đậm hơn của Bootstrap) */
  background-color: #fff3cd; /* Nền vàng nhạt (bg-warning nhạt của Bootstrap) */
  border: 1px solid #ffeeba; /* Viền vàng nhạt */
  padding: 6px 10px; /* Khoảng cách bên trong */
  border-radius: 0.25rem; /* Bo góc nhẹ */
  margin-bottom: 8px; /* Khoảng cách với ô input */
  font-weight: 500; /* Chữ hơi đậm để nhấn mạnh */
  transition: opacity 0.3s ease; /* Hiệu ứng mượt mà khi hiển thị/ẩn */
}

/* Khi thông báo ẩn (d-none) */
#schoolSelectionNotice.d-none {
  opacity: 0; /* Ẩn mượt mà */
}

/* Khi thông báo hiển thị */
#schoolSelectionNotice:not(.d-none) {
  opacity: 1;
}
</style>

<!-- Modal Tìm kiếm theo tên môn học -->
<div class="modal fade" id="subjectSearchModal" tabindex="-1" aria-labelledby="subjectSearchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="subjectSearchModalLabel">Tìm kiếm theo tên môn học</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <!-- Wrapper chứa input và phần gợi ý -->
        <div class="position-relative">
          <span id="schoolSelectionNotice" class="text-muted d-none" style="font-size: 0.9rem; display: block; margin-bottom: 5px;">
            Mẹo nhỏ: Chọn trường rồi tìm kiếm để chỉ hiển thị dữ liệu của trường đó.
          </span>
          <input type="text" id="subjectSearchInput" class="form-control" placeholder="Nhập tên môn học...">
          <div id="subjectSearchSuggestions" class="suggestions" style="top: 100%; left: 0; display: none;"></div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <!-- Có thể thêm nút nếu cần -->
      </div>
    </div>
  </div>
</div>
<!-- HTML Imports -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Cấu hình PDF.js worker (chỉ cần khai báo một lần)
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';

  /*=======================
    Biến toàn cục
  =======================*/
  let examCurrentPath = [];
  let syllabusCurrentPath = [];
  let currentRotation = 0;
  let adTimer = null;
  let currentFile = null;

  /*=======================
    Hàm hiển thị Drive
  =======================*/
  async function renderDrive(containerId, path, updatePathCallback) {
    const documentType = containerId.includes('exam') ? 'exam' : 'syllabus';
    const container = document.getElementById(containerId);
    if (!container) {
      console.error(`Không tìm thấy container với ID: ${containerId}`);
      return;
    }
    container.innerHTML = '';

    // Hiển thị spinner khi tải dữ liệu
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    spinner.textContent = 'Loading...';
    container.appendChild(spinner);

    // Lấy dữ liệu từ backend
    let data = [];
    try {
      if (path.length === 0) {
        data = await (await fetch('/api/schools')).json();
      } else if (path.length === 1) {
        const schoolId = path[0].id;
        data = await (await fetch(`/api/schools/${schoolId}/faculties`)).json();
      } else if (path.length === 2) {
        const facultyId = path[1].id;
        data = await (await fetch(`/api/faculties/${facultyId}/subjects?type=${documentType}`)).json();
      } else if (path.length === 3) {
        const subjectId = path[2].id;
        const response = await fetch(`/api/subjects/${subjectId}/documents_by_year?type=${documentType}`);
        const groupedData = await response.json();
        data = Object.keys(groupedData)
          .map(year => ({
            id: parseInt(year),
            name: year,
            count: groupedData[year].length,
            documents: groupedData[year]
          }))
          .sort((a, b) => b.id - a.id);
      } else if (path.length === 4) {
        const subjectId = path[2].id;
        const year = path[3].id;
        data = await (await fetch(`/api/subjects/${subjectId}/documents/${year}?type=${documentType}`)).json();
      }
    } catch (error) {
      console.error('Lỗi khi lấy dữ liệu:', error);
    }

    container.innerHTML = ''; // Xóa spinner sau khi tải xong

    // Hiển thị breadcrumb
    renderBreadcrumb(container, path, updatePathCallback);

    // Thanh tìm kiếm inline
    const inlineSearchContainer = document.createElement('div');
    inlineSearchContainer.className = 'input-group mb-3';
    inlineSearchContainer.style.position = 'relative';
    inlineSearchContainer.innerHTML = `
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="search" class="form-control" placeholder="Tìm kiếm trong thư mục...">
    `;
    container.appendChild(inlineSearchContainer);

    const inlineSuggestions = document.createElement('div');
    inlineSuggestions.className = 'suggestions';
    inlineSuggestions.style.display = 'none';
    inlineSearchContainer.appendChild(inlineSuggestions);

    // Nút tìm kiếm nâng cao
    const advancedSearchBtn = document.createElement('button');
    advancedSearchBtn.className = 'btn btn-outline-primary mb-3';
    advancedSearchBtn.textContent = 'Tìm kiếm theo tên môn học';
    advancedSearchBtn.addEventListener('click', () => {
      const subjectSearchModal = new bootstrap.Modal(document.getElementById('subjectSearchModal'));
      subjectSearchModal.show();
    });
    container.appendChild(advancedSearchBtn);

    // Danh sách file/folder
    const list = document.createElement('ul');
    list.className = 'file-list';
    if (Array.isArray(data)) {
      data.forEach(item => {
        if ((path.length < 3 || path.length === 3) && item.count > 0) {
          renderFolderItem(list, item.name, path, updatePathCallback, item.count, item.id);
        } else if (path.length === 4) {
          renderFileItem(list, item, documentType);
        }
      });
    }
    container.appendChild(list);

    // Xử lý tìm kiếm inline
    const inlineSearchInput = inlineSearchContainer.querySelector('input');
    inlineSearchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const suggestions = [];
      Array.from(list.children).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(term) ? 'flex' : 'none';
        if (item.style.display !== 'none') {
          const name = item.querySelector('.file-name').textContent;
          if (!suggestions.includes(name)) suggestions.push(name);
        }
      });

      inlineSuggestions.innerHTML = '';
      if (term && suggestions.length > 0) {
        suggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.textContent = suggestion;
          div.addEventListener('click', () => {
            inlineSearchInput.value = suggestion;
            inlineSearchInput.dispatchEvent(new Event('input'));
            inlineSuggestions.style.display = 'none';
          });
          inlineSuggestions.appendChild(div);
        });
        inlineSuggestions.style.display = 'block';
      } else {
        inlineSuggestions.style.display = 'none';
      }
    });
  }

  /*=======================
    Hàm phụ trợ
  =======================*/
  function renderBreadcrumb(container, path, callback) {
    if (path.length === 0) return;
    const breadcrumb = document.createElement('nav');
    let html = `
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#" id="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
        </li>
    `;
    path.forEach((segment, index) => {
      html += index === path.length - 1
        ? `<li class="breadcrumb-item active">${segment.name}</li>`
        : `<li class="breadcrumb-item"><a href="#" class="breadcrumb-link" data-index="${index}">${segment.name}</a></li>`;
    });
    breadcrumb.innerHTML = html + '</ol>';

    breadcrumb.querySelector('#back-button').addEventListener('click', (e) => {
      e.preventDefault();
      callback(path.slice(0, -1));
    });

    breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const index = parseInt(link.getAttribute('data-index'));
        callback(path.slice(0, index + 1));
      });
    });

    container.prepend(breadcrumb);
  }

  function renderFolderItem(list, name, currentPath, callback, count, itemId) {
    const li = document.createElement('li');
    li.className = 'file-item';
    li.innerHTML = `
      <i class="bi bi-folder-fill file-icon folder"></i>
      <span class="file-name">${name}</span>
      <span class="file-count">${count}</span>
    `;
    li.addEventListener('click', () => callback([...currentPath, { id: itemId, name }]));
    list.appendChild(li);
  }

function renderFileItem(list, file, documentType) {
  if (!file.file_path) {
    console.warn('File không có đường dẫn hợp lệ:', file);
    return;
  }

  const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
  const ext = filePath.split('.').pop().toLowerCase();
  const iconClass = {
    pdf: 'bi-file-pdf pdf',
    doc: 'bi-file-earmark-word word',
    docx: 'bi-file-earmark-word word',
    jpg: 'bi-file-image',
    jpeg: 'bi-file-image',
    png: 'bi-file-image',
    gif: 'bi-file-image'
  }[ext] || 'bi-file-earmark';

  const li = document.createElement('li');
  li.className = 'file-item';
  const typeLabel = documentType === 'exam' ? 'Đề Thi' : 'Đề Cương';
  li.innerHTML = `
    <i class="bi ${iconClass} file-icon"></i>
    <div>
      <div class="file-name">${typeLabel} ${file.file_name}</div>
      <div class="file-info">${file.file_info || ''}</div>
    </div>
  `;

  li.addEventListener('click', () => {
    // Gọi API log lượt mở file trước khi hiển thị modal hoặc chuyển hướng
    fetch('/api/log-file-open', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ documentId: file.id }) // Giả sử file.id chứa ID của tài liệu
    })
    .then(response => response.json())
    .then(data => {
      console.log(data.message);
      // Sau khi log thành công, thực hiện hành động tiếp theo, ví dụ: hiển thị modal
      window.currentFile = { ...file, file_path: filePath };
      showAdModal();
    })
    .catch(error => {
      console.error('Error logging file open:', error);
      // Tiếp tục hiển thị file ngay cả khi log thất bại
      window.currentFile = { ...file, file_path: filePath };
      showAdModal();
    });
  });
  list.appendChild(li);
}

  function showAdModal() {
    let countdown = 10;
    const countdownElement = document.getElementById('countdown');
    if (!countdownElement) {
      console.error('Không tìm thấy phần tử countdown trong DOM');
      return;
    }

    const adModal = new bootstrap.Modal(document.getElementById('adModal'));
    adModal.show();
    countdownElement.textContent = countdown;

    adTimer = setInterval(() => {
      countdown--;
      countdownElement.textContent = countdown;
      if (countdown <= 0) {
        clearInterval(adTimer);
        adModal.hide();
        openFileFromBackend();
      }
    }, 1000);
  }

  function openFileFromBackend() {
    if (window.currentFile?.file_path) {
      window.open(window.currentFile.file_path, '_blank');
    } else {
      console.error('Không có file để mở');
    }
  }

  /*=======================
    Preview File & Lịch sử
  =======================*/
  function previewFile(file) {
    currentFile = file;
    const activeTab = document.querySelector('.tab-pane.active').id;
    const fileType = activeTab === 'de-thi' ? 'Đề Thi' : 'Đề Cương';
    addFileToHistory(file, fileType);
    showAdModal();
  }

  function addFileToHistory(file, fileType) {
    let history = JSON.parse(localStorage.getItem('viewHistory')) || [];
    if (!history.find(item => item.name === file.name && item.type === fileType)) {
      history.push({ name: file.name, info: file.info || '', type: fileType });
      localStorage.setItem('viewHistory', JSON.stringify(history));
    }
  }

  function proceedFileOpen(file) {
    const ext = file.file_path.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
      const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
      const imgPreview = document.getElementById('imgPreview');
      imgPreview.style.transform = 'rotate(0deg)';
      imgPreview.src = file.file_path;
      imgPreview.classList.remove('d-none');
      document.getElementById('rotateControls').classList.remove('d-none');
      document.getElementById('filePreviewModalLabel').textContent = file.file_name;
      modal.show();
    } else if (['doc', 'docx'].includes(ext)) {
      const link = document.createElement('a');
      link.href = file.file_path;
      link.download = file.file_name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else if (ext === 'pdf') {
      const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
      const container = document.getElementById('pdfContainer');
      container.innerHTML = '';

      pdfjsLib.getDocument(file.file_path).promise.then(pdf => {
        const totalPages = pdf.numPages;
        const renderPromises = [];
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
          renderPromises.push(pdf.getPage(pageNum).then(page => {
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            container.appendChild(canvas);
            const context = canvas.getContext('2d');
            return page.render({ canvasContext: context, viewport }).promise;
          }));
        }
        Promise.all(renderPromises).then(() => modal.show());
      }).catch(error => {
        console.error('Lỗi khi render PDF:', error);
        window.open(file.file_path, '_blank');
      });
    } else {
      window.open(file.file_path, '_blank');
    }
  }

  /*=======================
    Quản lý trạng thái
  =======================*/
  function renderExamDrive(newPath) {
    examCurrentPath = newPath;
    localStorage.setItem('examCurrentPath', JSON.stringify(examCurrentPath));
    renderDrive('exam-drive-container', examCurrentPath, renderExamDrive);
  }

  function renderSyllabusDrive(newPath) {
    syllabusCurrentPath = newPath;
    localStorage.setItem('syllabusCurrentPath', JSON.stringify(syllabusCurrentPath));
    renderDrive('syllabus-drive-container', syllabusCurrentPath, renderSyllabusDrive);
  }

  /*=======================
    Khởi tạo khi tải trang
  =======================*/
  document.addEventListener('DOMContentLoaded', () => {
    const savedExamPath = localStorage.getItem('examCurrentPath');
    const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
    if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
    if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

    const examTab = document.getElementById('de-thi-tab');
    const syllabusTab = document.getElementById('de-cuong-tab');
    const examContent = document.getElementById('de-thi');
    const syllabusContent = document.getElementById('de-cuong');
    let activeTab = localStorage.getItem('activeTab') || 'exam';

    function switchTab(tab) {
      if (tab === 'exam') {
        examTab.classList.add('active');
        syllabusTab.classList.remove('active');
        examContent.classList.add('show', 'active');
        syllabusContent.classList.remove('show', 'active');
        localStorage.setItem('activeTab', 'exam');
        renderExamDrive(examCurrentPath);
      } else {
        syllabusTab.classList.add('active');
        examTab.classList.remove('active');
        syllabusContent.classList.add('show', 'active');
        examContent.classList.remove('show', 'active');
        localStorage.setItem('activeTab', 'syllabus');
        renderSyllabusDrive(syllabusCurrentPath);
      }
    }

    examTab.addEventListener('click', () => switchTab('exam'));
    syllabusTab.addEventListener('click', () => switchTab('syllabus'));
    switchTab(activeTab);

    // Xử lý nút quảng cáo và xoay ảnh
    document.getElementById('skipAdBtn')?.addEventListener('click', () => {
      clearInterval(adTimer);
      const adModal = bootstrap.Modal.getInstance(document.getElementById('adModal'));
      adModal.hide();
      if (currentFile) proceedFileOpen(currentFile);
    });

    document.getElementById('rotateLeft')?.addEventListener('click', () => {
      currentRotation -= 90;
      document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
    });

    document.getElementById('rotateRight')?.addEventListener('click', () => {
      currentRotation += 90;
      document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
    });

    // Xử lý quảng cáo trong modal
    const adModal = document.getElementById('adModal');
    if (adModal) {
      adModal.addEventListener('shown.bs.modal', () => {
        const adIframe = adModal.querySelector('iframe');
        if (adIframe && adIframe.getAttribute('src') === 'about:blank') {
          const adUrl = `https://www.effectiveratecpm.com/pb7fiwbhr?key=27b2a32441ee0c347f6e9fd270bc1a0c&t=${Date.now()}`;
          adIframe.setAttribute('src', adUrl);
        }
      });
    }
  });
/*=======================
  Tìm kiếm môn học
=======================*/
const subjectSearchInput = document.getElementById('subjectSearchInput');
const subjectSearchSuggestions = document.getElementById('subjectSearchSuggestions');
const schoolSelectionNotice = document.getElementById('schoolSelectionNotice');

subjectSearchInput?.addEventListener('input', async () => {
  const term = subjectSearchInput.value.trim().toLowerCase();
  
  // Hiển thị/ẩn thông báo dựa trên việc đã chọn trường hay chưa
  const activeTab = localStorage.getItem('activeTab') || 'exam';
  const currentPath = activeTab === 'exam' ? examCurrentPath : syllabusCurrentPath;
  if (currentPath.length === 0) {
    schoolSelectionNotice.classList.remove('d-none'); // Hiển thị thông báo
  } else {
    schoolSelectionNotice.classList.add('d-none'); // Ẩn thông báo
  }

  // Nếu term quá ngắn thì ẩn gợi ý và không tìm kiếm
  if (term.length < 2) {
    subjectSearchSuggestions.style.display = 'none';
    return;
  }

  const schoolId = currentPath[0]?.id || 0;
  const facultyId = currentPath[1]?.id || 0;

  try {
    const url = new URL('/api/search/subjects', window.location.origin);
    url.searchParams.append('term', term);
    if (schoolId) url.searchParams.append('school_id', schoolId);
    if (facultyId) url.searchParams.append('faculty_id', facultyId);

    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
    const results = await response.json();

    subjectSearchSuggestions.innerHTML = '';
    if (results.length > 0) {
      results.forEach(subject => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.innerHTML = `
          <div class="subject-name">${subject.name}</div>
          <div class="subject-path">${subject.school_name} → ${subject.faculty_name}</div>
        `;
        div.addEventListener('click', () => {
          const newPath = [
            { id: subject.school_id, name: subject.school_name },
            { id: subject.faculty_id, name: subject.faculty_name },
            { id: subject.id, name: subject.name }
          ];
          if (activeTab === 'exam') renderExamDrive(newPath);
          else renderSyllabusDrive(newPath);
          bootstrap.Modal.getInstance(document.getElementById('subjectSearchModal')).hide();
        });
        subjectSearchSuggestions.appendChild(div);
      });
      subjectSearchSuggestions.style.display = 'block';
    } else {
      subjectSearchSuggestions.style.display = 'none';
    }
  } catch (error) {
    console.error('Lỗi tìm kiếm:', error);
    subjectSearchSuggestions.innerHTML = '<div class="error">Lỗi tải kết quả</div>';
    subjectSearchSuggestions.style.display = 'block';
  }
});
  document.addEventListener('DOMContentLoaded', () => {
  const savedExamPath = localStorage.getItem('examCurrentPath');
  const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
  if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
  if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

  const examTab = document.getElementById('de-thi-tab');
  const syllabusTab = document.getElementById('de-cuong-tab');
  const examContent = document.getElementById('de-thi');
  const syllabusContent = document.getElementById('de-cuong');
  let activeTab = localStorage.getItem('activeTab') || 'exam';

  function switchTab(tab) {
    if (tab === 'exam') {
      examTab.classList.add('active');
      syllabusTab.classList.remove('active');
      examContent.classList.add('show', 'active');
      syllabusContent.classList.remove('show', 'active');
      localStorage.setItem('activeTab', 'exam');
      renderExamDrive(examCurrentPath);
    } else {
      syllabusTab.classList.add('active');
      examTab.classList.remove('active');
      syllabusContent.classList.add('show', 'active');
      examContent.classList.remove('show', 'active');
      localStorage.setItem('activeTab', 'syllabus');
      renderSyllabusDrive(syllabusCurrentPath);
    }
  }

  examTab.addEventListener('click', () => switchTab('exam'));
  syllabusTab.addEventListener('click', () => switchTab('syllabus'));
  switchTab(activeTab);

  // Xử lý nút quảng cáo và xoay ảnh
  document.getElementById('skipAdBtn')?.addEventListener('click', () => {
    clearInterval(adTimer);
    const adModal = bootstrap.Modal.getInstance(document.getElementById('adModal'));
    adModal.hide();
    if (currentFile) proceedFileOpen(currentFile);
  });

  document.getElementById('rotateLeft')?.addEventListener('click', () => {
    currentRotation -= 90;
    document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
  });

  document.getElementById('rotateRight')?.addEventListener('click', () => {
    currentRotation += 90;
    document.getElementById('imgPreview').style.transform = `rotate(${currentRotation}deg)`;
  });

  // Khôi phục modal thông báo "Tiếp tục xem"
  if (activeTab === 'exam' && examCurrentPath.length > 0) {
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
    document.getElementById('resumeTabName').textContent = 'Đề Thi';
    document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + examCurrentPath.map(item => item.name).join(' > ');
    resumeModal.show();

    document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
      resumeModal.hide();
    });

    document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
      examCurrentPath = [];
      localStorage.removeItem('examCurrentPath');
      renderExamDrive(examCurrentPath);
      resumeModal.hide();
    });

    document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
      resumeModal.hide();
      showHistoryModal();
    });
  } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
    document.getElementById('resumeTabName').textContent = 'Đề Cương';
    document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
    resumeModal.show();

    document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
      resumeModal.hide();
    });

    document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
      syllabusCurrentPath = [];
      localStorage.removeItem('syllabusCurrentPath');
      renderSyllabusDrive(syllabusCurrentPath);
      resumeModal.hide();
    });

    document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
      resumeModal.hide();
      showHistoryModal();
    });
  }

  // Xử lý quảng cáo trong modal
const adModal = document.getElementById('adModal');
if (adModal) {
  adModal.addEventListener('shown.bs.modal', () => {
    // Quảng cáo thứ nhất: Luôn cập nhật link mới mỗi khi modal mở
    const adIframe1 = adModal.querySelector('#adIframe1');
    if (adIframe1) {
      const adUrl1 = `https://www.effectiveratecpm.com/pb7fiwbhr?key=27b2a32441ee0c347f6e9fd270bc1a0c&t=${Date.now()}`;
      adIframe1.setAttribute('src', adUrl1);
    }
    
    // Quảng cáo thứ hai: Luôn cập nhật link mới mỗi khi modal mở
    const adIframe2 = adModal.querySelector('#adIframe2');
    if (adIframe2) {
      const adUrl2 = `https://www.effectiveratecpm.com/wfijh2sa1q?key=a66715025bbe52ddd58f325f993e257e&t=${Date.now()}`;
      adIframe2.setAttribute('src', adUrl2);
    }
  });
}
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Lấy phần tử nút mở modal
  const recentActivityBtn = document.querySelector('.recent-activity-btn');

  // Lắng nghe sự kiện click trên nút
  recentActivityBtn.addEventListener('click', function() {
    // Gọi API để lấy danh sách đề thi mới nhất của hệ thống
    fetch('/api/latest-exams')
      .then(response => response.json())
      .then(data => {
          console.log("2")
        // Lấy phần tử <ul> chứa danh sách hoạt động của hệ thống
        const systemActivityList = document.querySelector('.activity-box.system-activity .list-group');
        // Xóa nội dung cũ (nếu có)
        systemActivityList.innerHTML = '';
        
        data.forEach(exam => {
          // Tạo phần tử li cho mỗi đề thi
          const li = document.createElement('li');
          li.classList.add('list-group-item');
          li.innerHTML = `
            <span class="activity-text">
              Hệ thống đã upload đề thi mới: 
              <a href="${exam.file_path}" target="_blank">
                <strong>${exam.file_name}</strong>
              </a>
            </span>
            <span class="activity-time">${exam.created_at}</span>
          `;
          systemActivityList.appendChild(li);
        });
      })
      .catch(error => {
        console.error('Lỗi khi lấy dữ liệu đề thi:', error);
      });
  });
});
</script>

</body>
</html>