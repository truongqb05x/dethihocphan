<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <!-- Mobile meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <!-- Title + Description -->
  <title>Ngân Hàng Đề Thi Kết Thúc Học Phần</title>

  <meta name="description"
    content="Tải Đề thi kết thúc học phần miễn phí, đa dạng nhiều môn. Cập nhật đề thi mới nhất, đầy đủ đáp án và hướng dẫn ôn tập hiệu quả.">
  <meta name="keywords" content="đề thi kết thúc học phần, đề thi học phần, tải đề thi, ôn tập học phần">

  <!-- Canonical -->
  <link rel="canonical" href="dethihocphan.com/de-thi-ket-thuc-hoc-phan">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Đề thi kết thúc học phần – Tải miễn phí, cập nhật mới nhất">
  <meta property="og:description"
    content="Tải Đề thi kết thúc học phần miễn phí, đa dạng nhiều môn. Cập nhật đề thi mới nhất, đầy đủ đáp án và hướng dẫn ôn tập hiệu quả.">
  <meta property="og:url" content="dethihocphan.com/de-thi-ket-thuc-hoc-phan">
  <meta property="og:image" content="dethihocphan.com/static/logo.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Đề thi kết thúc học phần – Tải miễn phí, cập nhật mới nhất">
  <meta name="twitter:description"
    content="Tải Đề thi kết thúc học phần miễn phí, đa dạng nhiều môn. Cập nhật đề thi mới nhất, đầy đủ đáp án và hướng dẫn ôn tập hiệu quả.">
  <meta name="twitter:image" content="dethihocphan.com/static/logo.png">

  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Đề thi kết thúc học phần",
    "description": "Tải Đề thi kết thúc học phần miễn phí, đa dạng nhiều môn. Cập nhật đề thi mới nhất, đầy đủ đáp án và hướng dẫn ôn tập hiệu quả.",
    "url": "dethihocphan.com/de-thi-ket-thuc-hoc-phan"
  }
  </script>

  <!-- Favicon -->
  <link rel="shortcut icon" href="../static/logo.png" type="image/x-icon">

  <!-- CSS/Fonts/Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../static/css/index.css">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f4f6f9;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }

    .list-group-item :hover {
      cursor: pointer;
      color: red;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      margin: 0;
      padding-top: 60px;
    }

    .compact-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card-custom {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .nav-tabs .nav-link {
      font-weight: 500;
      color: var(--secondary-color);
      border: none;
      padding: 0.75rem 1rem;
      transition: color 0.3s ease;
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 3px solid var(--primary-color);
    }

    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
    }

    .school-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
      border-radius: 4px;
    }

    .breadcrumb {
      background: transparent;
      padding: 0.75rem 1rem;
      margin-bottom: 0;
    }

    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: #0056b3;
    }

/* File List */
.file-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px; /* Maintain spacing between items */
}

/* File Item */
.file-item {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  transition: all 0.3s ease-out, border-left 0.2s ease-out; /* Smooth transitions */
  cursor: pointer;
  background: transparent; /* Transparent background to remove white */
  opacity: 0; /* Start invisible for appearance animation */
  transform: translateY(10px); /* Slight offset for animation */
  animation: fadeInUp 0.5s ease-out forwards; /* Appearance animation */
}

/* Appearance animation for file items */
@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Staggered animation for each file item */
.file-list .file-item {
  animation-delay: calc(0.05s * var(--index)); /* Staggered delay based on index */
}

.file-item:hover {
  background-color: rgba(248, 249, 250, 0.8); /* Semi-transparent hover background */
  transform: translateY(-2px) scale(1.02); /* Lift and slight zoom on hover */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Enhanced shadow on hover */
  border-left: 4px solid var(--primary-color); /* Colored left border on hover */
}

/* File Icon */
.file-icon {
  font-size: 24px;
  margin-right: 15px;
  width: 30px;
  transition: transform 0.3s ease-out, color 0.3s ease-out; /* Smooth icon transitions */
}

.file-item:hover .file-icon {
  transform: scale(1.15) rotate(5deg); /* Icon zoom and slight rotation on hover */
  color: var(--primary-color); /* Shift to primary color on hover */
}

/* File Name */
.file-name {
  flex-grow: 1;
  font-size: 1rem;
  transition: color 0.3s ease-out; /* Smooth color transition */
}

.file-item:hover .file-name {
  color: var(--primary-color); /* Highlight file name on hover */
}

/* File Info */
.file-info {
  font-size: 0.8rem;
  color: var(--secondary-color);
  transition: color 0.3s ease-out; /* Smooth color transition */
}

.file-item:hover .file-info {
  color: #5a6268; /* Slightly darker for emphasis on hover */
}

/* Compatibility with new-file-item */
.new-file-item {
  padding: 12px 15px;
  border-radius: 10px;
  transition: all 0.3s ease-out, border-left 0.2s ease-out; /* Match transition */
  background: transparent; /* Transparent background to match */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); /* Match shadow */
  opacity: 0; /* Start invisible for animation */
  transform: translateY(10px); /* Match offset */
  animation: fadeInUp 0.5s ease-out forwards; /* Match appearance animation */
  border-left: 4px solid transparent; /* Match initial border */
}

.new-file-item:hover {
  background-color: rgba(248, 249, 250, 0.8); /* Match semi-transparent hover background */
  transform: translateY(-2px) scale(1.02); /* Match hover transform */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Match hover shadow */
  border-left: 4px solid var(--primary-color); /* Match colored border on hover */
}

.new-file-icon {
  font-size: 1.8rem; /* Match dynamic CSS */
  transition: transform 0.3s ease-out, color 0.3s ease-out; /* Match icon transitions */
}

.new-file-item:hover .new-file-icon {
  transform: scale(1.15) rotate(5deg); /* Match icon hover effect */
  color: var(--primary-color); /* Match color shift */
}

.new-file-name {
  transition: color 0.3s ease-out; /* Match name transition */
}

.new-file-item:hover .new-file-name {
  color: var(--primary-color); /* Match name hover color */
}

.new-file-info {
  transition: color 0.3s ease-out; /* Match info transition */
}

.new-file-item:hover .new-file-info {
  color: #5a6268; /* Match info hover color */
}

.new-file-views {
  transition: color 0.3s ease-out; /* Add transition for views */
}

.new-file-item:hover .new-file-views {
  color: #5a6268; /* Match hover color */
}

/* Action Menu Button */
.new-btn-menu {
  transition: background-color 0.3s ease-out, transform 0.3s ease-out; /* Smooth button transitions */
}

.new-btn-menu:hover {
  background-color: #e9ecef; /* Subtle hover background */
  transform: scale(1.1); /* Slight zoom on hover */
}

/* Responsive Adjustments */
@media (max-width: 576px) {
  .file-item,
  .new-file-item {
    animation: fadeInUp 0.4s ease-out forwards; /* Slightly faster animation on mobile */
    border-left-width: 3px; /* Slightly thinner border on mobile */
  }

  .file-item:hover,
  .new-file-item:hover {
    transform: translateY(-1px) scale(1.01); /* Reduced scale for mobile */
    border-left: 3px solid var(--primary-color); /* Match border width on hover */
  }

  .file-icon,
  .new-file-icon {
    transform: scale(1.1) rotate(3deg); /* Reduced rotation for mobile */
  }
}
/* File List */
.file-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px; /* Maintain spacing between items */
}

/* File Item */
.file-item {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  border-radius: 10px;
  transition: all 0.3s ease-out, border-left 0.2s ease-out; /* Smooth transitions */
  cursor: pointer;
  background: transparent; /* Transparent background to remove white */
  opacity: 0; /* Start invisible for appearance animation */
  transform: translateY(10px); /* Slight offset for animation */
  animation: fadeInUp 0.5s ease-out forwards; /* Appearance animation */
  border-left: 4px solid transparent; /* Initial transparent border */
}

/* Appearance animation for file items */
@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Staggered animation for each file item */
.file-list .file-item {
  animation-delay: calc(0.05s * var(--index)); /* Staggered delay based on index */
}

.file-item:hover {
  background-color: rgba(248, 249, 250, 0.8); /* Semi-transparent hover background */
  transform: translateY(-2px) scale(1.02); /* Lift and slight zoom on hover */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Enhanced shadow on hover */
  border-left: 4px solid var(--primary-color); /* Colored left border on hover */
}

/* File Icon */
.file-icon {
  font-size: 24px;
  margin-right: 15px;
  width: 30px;
  transition: transform 0.3s ease-out, color 0.3s ease-out; /* Smooth icon transitions */
}

.file-item:hover .file-icon {
  transform: scale(1.15) rotate(5deg); /* Icon zoom and slight rotation on hover */
  color: var(--primary-color); /* Shift to primary color on hover */
}

/* File Name */
.file-name {
  flex-grow: 1;
  font-size: 1rem;
  transition: color 0.3s ease-out; /* Smooth color transition */
}

.file-item:hover .file-name {
  color: var(--primary-color); /* Highlight file name on hover */
}

/* File Info */
.file-info {
  font-size: 0.8rem;
  color: var(--secondary-color);
  transition: color 0.3s ease-out; /* Smooth color transition */
}

.file-item:hover .file-info {
  color: #5a6268; /* Slightly darker for emphasis on hover */
}

/* Compatibility with new-file-item */
.new-file-item {
  padding: 12px 15px;
  border-radius: 10px;
  transition: all 0.3s ease-out, border-left 0.2s ease-out; /* Match transition */
  background: transparent; /* Transparent background to match */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); /* Match shadow */
  opacity: 0; /* Start invisible for animation */
  transform: translateY(10px); /* Match offset */
  animation: fadeInUp 0.5s ease-out forwards; /* Match appearance animation */
  border-left: 4px solid transparent; /* Match initial border */
}

.new-file-item:hover {
  background-color: rgba(248, 249, 250, 0.8); /* Match semi-transparent hover background */
  transform: translateY(-2px) scale(1.02); /* Match hover transform */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Match hover shadow */
  border-left: 4px solid var(--primary-color); /* Match colored border on hover */
}

.new-file-icon {
  font-size: 1.8rem; /* Match dynamic CSS */
  transition: transform 0.3s ease-out, color 0.3s ease-out; /* Match icon transitions */
}

.new-file-item:hover .new-file-icon {
  transform: scale(1.15) rotate(5deg); /* Match icon hover effect */
  color: var(--primary-color); /* Match color shift */
}

.new-file-name {
  transition: color 0.3s ease-out; /* Match name transition */
}

.new-file-item:hover .new-file-name {
  color: var(--primary-color); /* Match name hover color */
}

.new-file-info {
  transition: color 0.3s ease-out; /* Match info transition */
}

.new-file-item:hover .new-file-info {
  color: #5a6268; /* Match info hover color */
}

.new-file-views {
  transition: color 0.3s ease-out; /* Add transition for views */
}

.new-file-item:hover .new-file-views {
  color: #5a6268; /* Match hover color */
}

/* Action Menu Button */
.new-btn-menu {
  transition: background-color 0.3s ease-out, transform 0.3s ease-out; /* Smooth button transitions */
}

.new-btn-menu:hover {
  background-color: #e9ecef; /* Subtle hover background */
  transform: scale(1.1); /* Slight zoom on hover */
}

/* Responsive Adjustments */
@media (max-width: 576px) {
  .file-item,
  .new-file-item {
    animation: fadeInUp 0.4s ease-out forwards; /* Slightly faster animation on mobile */
    border-left-width: 3px; /* Slightly thinner border on mobile */
  }

  .file-item:hover,
  .new-file-item:hover {
    transform: translateY(-1px) scale(1.01); /* Reduced scale for mobile */
    border-left: 3px solid var(--primary-color); /* Match border width on hover */
  }

  .file-icon,
  .new-file-icon {
    transform: scale(1.1) rotate(3deg); /* Reduced rotation for mobile */
  }
}
.about-links li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .about-links li:last-child {
      border-bottom: none;
    }

    .about-links .label {
      flex: 0 0 150px;
      font-weight: 600;
      color: #007bff;
    }

    .about-links .desc {
      flex: 1;
      font-size: 16px;
      color: #555;
    }

    /* Footer style */
    .custom-footer {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      text-align: center;
    }

    .custom-footer .footer-item {
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }

    .custom-footer .footer-item span {
      display: block;
      line-height: 1.5;
    }

    /* Social links style */
    .social-links {
      margin-top: 10px;
    }

    .social-links a {
      margin: 0 10px;
      font-size: 24px;
      color: #007bff;
      text-decoration: none;
      transition: color 0.3s;
    }

    .social-links a:hover {
      color: #0056b3;
    }

    /* Custom CSS for Modern and Elegant Modal */
    .modal-content {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      border-bottom: none;
      padding: 20px;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .modal-body {
      padding: 20px;
      background-color: #f9f9f9;
    }

    .modal-footer {
      border-top: none;
      padding: 15px 20px;
      background-color: #f9f9f9;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    /*thư mục rỗng*/
    .empty-folder {
      margin: 32px auto;
      padding: 24px;
      max-width: 480px;
      background: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
      border-left: 5px solid #0d6efd;
      border-radius: 8px;
      text-align: center;
      color: #6c757d;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .empty-folder::before {
      content: "📁";
      display: block;
      font-size: 48px;
      margin-bottom: 16px;
      filter: grayscale(100%);
      opacity: 0.6;
      transition: transform 0.3s ease;
    }

    .empty-folder:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .empty-folder:hover::before {
      transform: scale(1.1) rotate(-5deg);
      opacity: 0.8;
    }

    .empty-folder p {
      margin: 12px 0;
      font-size: 15px;
      line-height: 1.6;
      letter-spacing: 0.3px;
    }

    .empty-folder strong {
      display: block;
      font-weight: 600;
      color: #212529;
      margin-bottom: 8px;
      font-size: 17px;
    }

    .btn-close {
      filter: invert(1);
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .list-group-item {
      border: none;
      margin-bottom: 10px;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .list-group-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    /* Animation for modal */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal.fade .modal-dialog {
      animation: fadeIn 0.3s ease-out;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      /* canh giữa */
      text-indent: -9999px;
      /* ẩn text Loading... nếu không muốn hiển thị */
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #subjectSearchModal .modal-dialog {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #subjectSearchModal .modal-content {
      height: 70%;
    }

    .suggestions {
      position: absolute;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* Đảm bảo hiển thị trên modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }

    .suggestions {
      position: absolute;
      top: calc(100% + 2px);
      /* Nằm ngay dưới ô input, cách 2px để không dính liền */
      left: 0;
      width: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* Đảm bảo hiển thị trên modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }


    /* Trên mobile (chiều rộng nhỏ hơn 576px), tăng padding-top để bù navbar */
    @media (max-width: 576px) {
      body {
        padding-top: 100px;
        /* Tăng khoảng cách để tránh bị đè nội dung */
      }
    }

    /*hover content nav*/
    /* CSS cho tooltip: chỉ hiển thị khi di chuột vào nút */
    .btn-hover-tooltip {
      position: relative;
    }

    .btn-hover-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -30px;
      /* Điều chỉnh vị trí theo nhu cầu */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .btn-hover-tooltip:hover::after {
      opacity: 1;
    }
    
  </style>

</head>

<body>

  <!-- Bọc toàn bộ nội dung trong 1 container -->
  <!-- Thêm navbar vào trước phần content chính -->
  <nav id="navbar" class="navbar navbar-expand-lg navbar-light border-bottom py-3 fixed-top"
    style="border: none !important;">
    <div class="container-fluid">
      <!-- Tên trang web bên trái -->
      <a class="navbar-brand me-5" href="/">
        <span class="text-primary fw-bold fs-4">HueHub</span>
      </a>

      <!-- Các chức năng bên phải -->
      <div class="d-flex align-items-center gap-3">
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            // Lấy nút theo ID
            var activityBtn = document.getElementById('activityBtn');
            if (activityBtn) {
              // Khi nút được click, hiển thị modal
              activityBtn.addEventListener('click', function () {
                var activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
                activityModal.show();
              });
            }
          });

        </script>
        <!-- Nút đăng nhập trong navbar -->
        <button class="btn btn-outline-primary rounded-pill px-3" id="loginBtn" style="display: none;">
          <i class="bi bi-box-arrow-in-right me-2"></i>
          Đăng nhập
        </button>
        <div>
          <button class="js-bell-btn" id="jsNotificationBell">
            <i class="bi bi-bell"></i>
            <span class="js-bell-badge" id="jsBellBadge">5</span>
          </button>

          <!-- Notification Dropdown Container -->
          <div class="js-notification-container">
            <div class="js-notification-dropdown" id="jsNotificationDropdown">
              <div class="js-notification-header">
                <h3 class="js-notification-title">
                  <i class="bi bi-bell-fill"></i>
                  Thông Báo
                </h3>
                <div class="js-notification-actions">
                  <button class="btn btn-sm btn-outline-light" id="jsMarkAllRead">
                    <i class="bi bi-check2-all"></i>
                  </button>
                </div>
              </div>

              <!-- Filter tabs -->
              <div class="js-filter-tabs">
                <button class="js-filter-tab active" data-filter="all">Tất cả</button>
                <button class="js-filter-tab" data-filter="comment">Bình luận</button>
                <button class="js-filter-tab" data-filter="like">Thích</button>
                <button class="js-filter-tab" data-filter="mention">Nhắc đến</button>
                <button class="js-filter-tab" data-filter="system">Hệ thống</button>
              </div>

              <div class="js-notification-list" id="jsNotificationList">
                <!-- Dynamic content will be inserted here -->
              </div>
              <div class="js-notification-footer">
                <button class="js-view-all-btn" id="jsViewAllNotifications">
                  <i class="bi bi-x-lg"></i> Đóng
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Nút đăng xuất -->
        <button class="btn btn-outline-danger rounded-pill px-3 btn-hover-tooltip" id="logoutBtn"
          data-tooltip="Đăng xuất">
          <i class="bi bi-box-arrow-right me-2"></i>
          Đăng xuất
        </button>
      </div>
    </div>
  </nav>
  <script>
    document.getElementById('logoutBtn').addEventListener('click', function () {
      fetch('/api/logout', {
        method: 'POST',
        credentials: 'include' // Gửi cookie kèm theo nếu bạn dùng session
      })
        .then(response => {
          if (response.ok) {
            // Sau khi logout thành công, chuyển hướng về trang đăng nhập hoặc trang chính
            window.location.href = '/'; // Hoặc '/login.html' tùy bạn
          } else {
            alert('Đăng xuất thất bại!');
          }
        })
        .catch(error => {
          console.error('Lỗi khi gọi API logout:', error);
        });
    });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Kiểm tra trạng thái đăng nhập qua API
    fetch("/api/check-login", {
      method: 'GET',
      credentials: 'include'       // ← thêm dòng này
    })
      .then(response => response.json())
      .then(data => {
        if (data.loggedIn) {
          // Nếu đã đăng nhập, hiển thị nút Đăng xuất, Notification Container và nút chuông
          document.getElementById("logoutBtn").style.display = "block";
          document.getElementById("loginBtn").style.display = "none";
          document.querySelector(".js-notification-container").style.display = "block";
          document.getElementById("jsNotificationBell").style.display = "block";
        } else {
          // Nếu chưa đăng nhập, hiển thị nút Đăng nhập, ẩn thông báo và nút chuông
          document.getElementById("loginBtn").style.display = "block";
          document.getElementById("logoutBtn").style.display = "none";
          document.querySelector(".js-notification-container").style.display = "none";
          document.getElementById("jsNotificationBell").style.display = "none";

          const contributeBtn = document.querySelector(".btn.btn-primary.contribute-btn");
          if (contributeBtn) {
            contributeBtn.style.display = "none";
          }
        }
      })
      .catch(error => console.error("Lỗi kiểm tra đăng nhập:", error));

    // Khi nhấn nút Đăng nhập, chuyển hướng về trang /login
    const loginBtn = document.getElementById("loginBtn");
    if (loginBtn) {
      loginBtn.addEventListener("click", () => {
        window.location.href = '/login';
      });
    }
  });
</script>
  <!-- Full Notification Panel -->
  <div class="js-notification-panel" id="jsNotificationPanel">
    <div class="js-notification-panel-header">
      <h3 class="js-notification-panel-title">
        <i class="bi bi-bell-fill"></i>
        Tất cả thông báo
      </h3>
      <button class="js-close-panel" id="jsClosePanel">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Filter tabs -->
    <div class="js-filter-tabs">
      <button class="js-filter-tab active" data-filter="all">Tất cả</button>
      <button class="js-filter-tab" data-filter="comment">Bình luận</button>
      <button class="js-filter-tab" data-filter="like">Thích</button>
      <button class="js-filter-tab" data-filter="mention">Nhắc đến</button>
      <button class="js-filter-tab" data-filter="system">Hệ thống</button>
    </div>

    <!-- Notification list -->
    <div class="js-panel-notification-list" id="jsPanelNotificationList">
      <!-- Dynamic content will be inserted here -->
    </div>
  </div>

  <!-- Notification template (Đã đảo ngược thứ tự) -->
  <!-- Cập nhật thứ tự các phần tử trong template -->
  <template id="jsNotificationTemplate">
    <div class="js-notification-item js-unread" data-type="">
      <!-- Icon loại thông báo lên đầu -->
      <div class="js-notification-type">
        <i class="bi"></i>
      </div>

      <!-- Avatar người dùng -->
      <img class="js-user-avatar" src="" alt="User avatar">

      <!-- Nội dung thông báo -->
      <div class="js-notification-content">
        <div class="js-interaction-text">
          <span class="js-user-name"></span>
          <span class="js-action-text"></span>
          <span class="js-interaction-with"></span>
        </div>
        <p class="js-notification-text">
          <a href="#" class="js-post-link"></a>
        </p>
        <div class="js-notification-time">
          <i class="bi bi-clock"></i>
          <span class="js-time-text"></span>
        </div>
      </div>

      <!-- Badge unread -->
      <div class="js-unread-badge"></div>
    </div>
  </template>

  <!-- Tương tự cho panel notification template -->
  <template id="jsPanelNotificationTemplate">
    <div class="js-panel-notification-item js-unread" data-type="">
      <div class="js-notification-type">
        <i class="bi"></i>
      </div>

      <img class="js-user-avatar" src="" alt="User avatar">

      <div class="js-notification-content">
        <div class="js-interaction-text">
          <span class="js-user-name"></span>
          <span class="js-action-text"></span>
          <span class="js-interaction-with"></span>
        </div>
        <p class="js-notification-text">
          <a href="#" class="js-post-link"></a>
        </p>
        <div class="js-notification-time">
          <i class="bi bi-clock"></i>
          <span class="js-time-text"></span>
        </div>
        <div class="js-panel-notification-actions"></div>
      </div>

      <div class="js-unread-badge"></div>
      <button class="js-delete-btn" title="Xóa thông báo">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </template>
  <!-- Panel Notification template (Đã đảo ngược thứ tự) -->
  <template id="jsPanelNotificationTemplate">
    <div class="js-panel-notification-item js-unread" data-type="">
      <img class="js-user-avatar" src="" alt="User avatar">
      <div class="js-notification-content">
        <div class="js-interaction-text">
          <span class="js-user-name"></span>
          <span class="js-action-text"></span>
          <span class="js-interaction-with"></span>
        </div>
        <p class="js-notification-text">
          <a href="#" class="js-post-link"></a>
        </p>
        <div class="js-notification-time">
          <i class="bi bi-clock"></i>
          <span class="js-time-text"></span>
        </div>
        <div class="js-panel-notification-actions"></div>
      </div>
      <div class="js-notification-type">
        <i class="bi"></i>
      </div>
      <div class="js-unread-badge"></div>
      <button class="js-delete-btn" title="Xóa thông báo">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </template>

  <!-- Modal for system update details -->
  <div class="modal fade" id="jsUpdateDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thay đổi trong bản cập nhật</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="jsUpdateDetailsContent">
          <!-- Update details will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>
  <template id="jsEmptyNotificationTemplate">
    <div class="js-notification-empty">
      <div class="js-notification-empty-icon">
        <i class="bi bi-bell"></i>
      </div>
      <div class="js-notification-empty-text">Không có thông báo</div>
      <div class="js-notification-empty-subtext">Chúng tôi sẽ thông báo cho bạn khi có cập nhật mới</div>
    </div>
  </template>

  <template id="jsEmptyPanelNotificationTemplate">
    <div class="js-panel-notification-empty">
      <div class="js-panel-notification-empty-icon">
        <i class="bi bi-bell"></i>
      </div>
      <div class="js-panel-notification-empty-text">Không có thông báo</div>
      <div class="js-panel-notification-empty-subtext">Bạn đã xem tất cả thông báo của mình</div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Inject CSS styles
    function injectStyles() {
      const style = document.createElement('style');
      style.textContent = `
            :root {
                --js-primary-color: #6366f1;
                --js-secondary-color: #8b5cf6;
                --js-success-color: #10b981;
                --js-danger-color: #ef4444;
                --js-warning-color: #f59e0b;
                --js-info-color: #3b82f6;
                --js-text-primary: #1f2937;
                --js-text-secondary: #6b7280;
                --js-bg-light: #f9fafb;
                --js-bg-card: #ffffff;
                --js-border-color: #e5e7eb;
                --js-unread-bg: #f5f3ff;
                --js-dropdown-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }

            [data-bs-theme="dark"] {
                --js-primary-color: #818cf8;
                --js-secondary-color: #a78bfa;
                --js-text-primary: #f3f4f6;
                --js-text-secondary: #9ca3af;
                --js-bg-light: #111827;
                --js-bg-card: #1f2937;
                --js-border-color: #374151;
                --js-unread-bg: rgba(109, 40, 217, 0.1);
                --js-dropdown-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            }

            .js-bell-btn {
                background: transparent;
                border: none;
                position: relative;
                padding: 8px;
                border-radius: 50%;
                transition: all 0.2s ease;
                cursor: pointer;
                display: inline-block;
            }

            .js-bell-btn:hover {
                background: rgba(99, 102, 241, 0.1);
            }

            .js-bell-btn i {
                font-size: 1.5rem;
                color: var(--js-text-primary);
            }

            .js-bell-badge {
                position: absolute;
                top: -5px;
                right: -5px;
                background: var(--js-danger-color);
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                font-weight: bold;
            }

            .js-notification-container {
                position: relative;
                display: inline-block;
            }

            .js-notification-dropdown {
                width: 420px;
                max-height: 80vh;
                overflow: hidden;
                border: 1px solid var(--js-border-color);
                border-radius: 12px;
                box-shadow: var(--js-dropdown-shadow);
                transform: translateY(10px);
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                position: absolute;
                right: 0;
                top: 100%;
                margin-top: 10px;
                background: var(--js-bg-card);
                z-index: 999;
            }

            .js-notification-dropdown.show {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            .js-notification-header {
                padding: 1rem 1.25rem;
                background: linear-gradient(135deg, var(--js-primary-color) 0%, var(--js-secondary-color) 100%);
                color: white;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: relative;
            }

            .js-notification-title {
                font-weight: 600;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin: 0;
            }

            .js-notification-actions {
                display: flex;
                gap: 0.5rem;
            }

            .js-notification-actions .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            .js-filter-tabs {
                display: flex;
                padding: 0 1rem;
                background: var(--js-bg-card);
                border-bottom: 1px solid var(--js-border-color);
                overflow-x: auto;
                scrollbar-width: none;
            }

            .js-filter-tabs::-webkit-scrollbar {
                display: none;
            }

            .js-filter-tab {
                padding: 0.75rem;
                font-size: 0.85rem;
                font-weight: 500;
                color: var(--js-text-secondary);
                border: none;
                background: transparent;
                cursor: pointer;
                position: relative;
                white-space: nowrap;
                transition: all 0.2s ease;
            }

            .js-filter-tab.active {
                color: var(--js-primary-color);
            }

            .js-filter-tab.active::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 2px;
                background: var(--js-primary-color);
                border-radius: 2px 2px 0 0;
            }

            .js-notification-list {
                max-height: 60vh;
                overflow-y: auto;
                padding: 0.5rem;
            }

            .js-notification-empty {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem 1rem;
                text-align: center;
                color: var(--js-text-secondary);
            }

            .js-notification-empty-icon {
                font-size: 2.5rem;
                color: var(--js-text-secondary);
                opacity: 0.5;
                margin-bottom: 1rem;
            }

            .js-notification-empty-text {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .js-notification-empty-subtext {
                font-size: 0.8rem;
                opacity: 0.7;
            }

            .js-notification-item {
                padding: 0.75rem;
                margin: 0.25rem;
                border-radius: 8px;
                transition: all 0.2s ease;
                display: flex;
                gap: 0.75rem;
                position: relative;
                cursor: pointer;
            }

            .js-notification-item.js-unread {
                background-color: var(--js-unread-bg);
            }

            .js-notification-item:hover {
                background-color: rgba(99, 102, 241, 0.05);
            }

            .js-user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                object-fit: cover;
                flex-shrink: 0;
            }

            .js-notification-content {
                flex: 1;
                min-width: 0;
            }

            .js-interaction-text {
                font-weight: 500;
                color: var(--js-text-primary);
                margin-bottom: 0.25rem;
                font-size: 0.9rem;
            }

            .js-interaction-with {
                color: var(--js-primary-color);
                font-weight: 600;
            }

            .js-notification-time {
                font-size: 0.7rem;
                color: var(--js-text-secondary);
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            .js-notification-text {
                color: var(--js-text-secondary);
                margin: 0.25rem 0;
                font-size: 0.85rem;
            }

            .js-post-link {
                color: var(--js-primary-color);
                font-weight: 500;
                text-decoration: none;
                font-size: 0.85rem;
            }

            .js-post-link:hover {
                text-decoration: underline;
            }

            .js-notification-type {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                flex-shrink: 0;
                position: absolute;
                top: 0.75rem;
                right: 0.75rem;
                font-size: 0.75rem;
            }

            .js-type-comment {
                background: var(--js-success-color);
            }

            .js-type-like {
                background: var(--js-danger-color);
            }

            .js-type-mention {
                background: var(--js-info-color);
            }

            .js-type-system {
                background: var(--js-warning-color);
            }

            .js-unread-badge {
                position: absolute;
                top: 0.75rem;
                right: 2.5rem;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--js-primary-color);
            }

            .js-notification-footer {
                padding: 0.75rem;
                text-align: center;
                border-top: 1px solid var(--js-border-color);
            }

            .js-view-all-btn {
                padding: 0.375rem 0.75rem;
                border-radius: 6px;
                background: transparent;
                border: 1px solid var(--js-border-color);
                color: var(--js-primary-color);
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.85rem;
            }

            .js-view-all-btn:hover {
                background: rgba(99, 102, 241, 0.1);
                border-color: var(--js-primary-color);
            }

            .js-notification-panel {
                display: none;
                position: fixed;
                top: 0;
                right: 0;
                width: 400px;
                height: 100vh;
                background: var(--js-bg-card);
                box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
                z-index: 1050;
                border-left: 1px solid var(--js-border-color);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }

            .js-notification-panel.show {
                transform: translateX(0);
            }

            .js-notification-panel-header {
                padding: 1rem 1.25rem;
                background: linear-gradient(135deg, var(--js-primary-color) 0%, var(--js-secondary-color) 100%);
                color: white;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: relative;
            }

            .js-notification-panel-title {
                font-weight: 600;
                font-size: 1.25rem;
                margin: 0;
            }

            .js-close-panel {
                background: transparent;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
            }

            .js-panel-notification-list {
                height: calc(100vh - 120px);
                overflow-y: auto;
                padding: 0.5rem;
            }

            .js-panel-notification-empty {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: calc(100vh - 120px);
                text-align: center;
                color: var(--js-text-secondary);
                padding: 2rem;
            }

            .js-panel-notification-empty-icon {
                font-size: 3rem;
                color: var(--js-text-secondary);
                opacity: 0.5;
                margin-bottom: 1.5rem;
            }

            .js-panel-notification-empty-text {
                font-size: 1rem;
                margin-bottom: 0.5rem;
                font-weight: 500;
            }

            .js-panel-notification-empty-subtext {
                font-size: 0.85rem;
                opacity: 0.7;
            }

            .js-panel-notification-item {
                padding: 1rem;
                margin: 0.5rem 0;
                border-radius: 8px;
                transition: all 0.2s ease;
                display: flex;
                gap: 1rem;
                position: relative;
                cursor: pointer;
                border: 1px solid var(--js-border-color);
            }

            .js-panel-notification-item.js-unread {
                background-color: var(--js-unread-bg);
                border-left: 3px solid var(--js-primary-color);
            }

            .js-panel-notification-item:hover {
                background-color: rgba(99, 102, 241, 0.05);
            }

            .js-panel-notification-actions {
                display: flex;
                gap: 0.5rem;
                margin-top: 0.75rem;
            }

            .js-action-btn {
                padding: 0.375rem 0.75rem;
                border-radius: 6px;
                font-size: 0.8125rem;
                font-weight: 500;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 0.375rem;
            }

            .js-action-btn.primary {
                background: var(--js-primary-color);
                color: white;
            }

            .js-action-btn.primary:hover {
                background: var(--js-secondary-color);
            }

            .js-action-btn.secondary {
                background: transparent;
                color: var(--js-text-secondary);
                border: 1px solid var(--js-border-color);
            }

            .js-action-btn.secondary:hover {
                background: rgba(0, 0, 0, 0.05);
            }

            .js-delete-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(239, 68, 68, 0.1);
                color: var(--js-danger-color);
                border: none;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.2s;
            }

            .js-panel-notification-item:hover .js-delete-btn {
                opacity: 1;
            }

            .modal-content {
                background: var(--js-bg-card);
                border: 1px solid var(--js-border-color);
                color: var(--js-text-primary);
            }

            .modal-header {
                border-bottom: 1px solid var(--js-border-color);
            }

            .modal-footer {
                border-top: 1px solid var(--js-border-color);
            }

            .js-update-details-list {
                padding-left: 1.5rem;
            }

            .js-update-details-list li {
                margin-bottom: 0.5rem;
                position: relative;
            }

            .js-update-details-list li::before {
                content: '•';
                position: absolute;
                left: -1rem;
                color: var(--js-primary-color);
                font-weight: bold;
            }

            .js-update-feature {
                font-weight: 600;
                color: var(--js-primary-color);
            }

            .js-update-bugfix {
                font-weight: 600;
                color: var(--js-success-color);
            }

            .js-update-improvement {
                font-weight: 600;
                color: var(--js-info-color);
            }

            @keyframes js-fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .js-notification-item {
                animation: js-fadeIn 0.3s ease forwards;
            }

            @media (max-width: 576px) {
                .js-notification-dropdown {
                    width: calc(100vw - 20px);
                    right: 10px;
                    max-height: 80vh;
                    position: fixed;
                    top: auto;
                    bottom: 0;
                    transform: translateY(calc(100% + 10px));
                    border-radius: 12px 12px 0 0;
                }
                
                .js-notification-dropdown.show {
                    transform: translateY(0);
                }
                
                .js-notification-list {
                    max-height: 60vh;
                }
                
                .js-notification-panel {
                    width: 100%;
                    border-radius: 0;
                }
                
                body.notification-panel-open {
                    overflow: hidden;
                }
            }
            @keyframes js-slideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            @media (max-width: 576px) {
                .js-notification-dropdown.show {
                    animation: js-slideUp 0.3s ease forwards;
                }
            }
            /* Cập nhật phần notification item */
            .js-notification-item {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                transition: all 0.2s ease;
                position: relative;
                cursor: pointer;
            }

            /* Icon loại thông báo lớn hơn và nổi bật */
            .js-notification-type {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                flex-shrink: 0;
                font-size: 16px;
                position: static; /* Thay đổi từ absolute sang static */
                order: 1; /* Hiển thị đầu tiên */
            }

            /* Avatar người dùng */
            .js-user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                object-fit: cover;
                flex-shrink: 0;
                order: 2; /* Hiển thị thứ hai */
            }

            /* Nội dung thông báo */
            .js-notification-content {
                flex: 1;
                min-width: 0;
                order: 3; /* Hiển thị thứ ba */
            }

            /* Điều chỉnh lại vị trí badge unread */
            .js-unread-badge {
                position: absolute;
                top: 12px;
                right: 12px;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--js-primary-color);
            }

            /* Cập nhật bố cục cho mobile */
            @media (max-width: 576px) {
                .js-notification-item {
                    padding: 10px;
                    gap: 8px;
                }
                
                .js-notification-type {
                    width: 28px;
                    height: 28px;
                    font-size: 14px;
                }
                
                .js-user-avatar {
                    width: 36px;
                    height: 36px;
                }
            }
            .js-notification-time {
                display: flex;
                align-items: center;
                gap: 4px;
                font-size: 0.75rem;
                color: var(--js-text-secondary);
                margin-top: 4px;
            }

            .js-notification-time i {
                font-size: 0.7rem;
            }
                           /* Thêm style mới cho thông báo hệ thống */
        .js-system-notification {
            padding-left: 12px !important;
            align-items: center !important;
        }
        
        .js-system-notification .js-user-avatar,
        .js-system-notification .js-user-name,
        .js-system-notification .js-post-link,
        .js-system-notification .js-interaction-with {
            display: none !important;
        }
        
        .js-system-notification .js-action-text {
            margin-left: 0 !important;
            width: 100% !important;
            white-space: normal !important;
        }

        /* Style cho panel thông báo hệ thống */
        .js-panel-system-notification {
            padding-left: 16px !important;
            align-items: center !important;
        }
        
        .js-panel-system-notification .js-user-avatar,
        .js-panel-system-notification .js-user-name,
        .js-panel-system-notification .js-post-link,
        .js-panel-system-notification .js-interaction-with {
            display: none !important;
        }
        
        .js-panel-system-notification .js-action-text {
            margin-left: 0 !important;
            width: 100% !important;
            white-space: normal !important;
        }

        `;
      document.head.appendChild(style);
    }

    // Notification types configuration
    const notificationTypes = {
      comment: {
        icon: 'bi-chat-dots',
        class: 'js-type-comment',
        actionBtn: {
          text: 'Phản hồi',
          icon: 'bi-reply',
          class: 'primary'
        }
      },
      like: {
        icon: 'bi-heart-fill',
        class: 'js-type-like',
        actionBtn: {
          text: 'Xem bài viết',
          icon: 'bi-eye',
          class: 'secondary'
        }
      },
      mention: {
        icon: 'bi-at',
        class: 'js-type-mention',
        actionBtn: {
          text: 'Xem chi tiết',
          icon: 'bi-arrow-right',
          class: 'secondary'
        }
      },
      system: {
        icon: 'bi-info-circle',
        class: 'js-type-system',
        actionBtn: {
          text: 'Xem thêm',
          icon: 'bi-chevron-right',
          class: 'secondary'
        }
      }
    };

    // DOM elements
    const notificationBell = document.getElementById('jsNotificationBell');
    const bellBadge = document.getElementById('jsBellBadge');
    const notificationDropdown = document.getElementById('jsNotificationDropdown');
    const notificationList = document.getElementById('jsNotificationList');
    const viewAllBtn = document.getElementById('jsViewAllNotifications');
    const notificationPanel = document.getElementById('jsNotificationPanel');
    const panelNotificationList = document.getElementById('jsPanelNotificationList');
    const closePanelBtn = document.getElementById('jsClosePanel');
    const markAllReadBtn = document.getElementById('jsMarkAllRead');
    const notificationTemplate = document.getElementById('jsNotificationTemplate');
    const panelNotificationTemplate = document.getElementById('jsPanelNotificationTemplate');
    const emptyNotificationTemplate = document.getElementById('jsEmptyNotificationTemplate');
    const emptyPanelNotificationTemplate = document.getElementById('jsEmptyPanelNotificationTemplate');

    // Fetch notifications from backend
    async function fetchNotifications(filter = 'all') {
      const url = filter === 'all' ? '/api/notifications' : `/api/notifications?type=${filter}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch notifications');
        return await response.json();
      } catch (error) {
        console.error('Error fetching notifications:', error);
        return [];
      }
    }

    // Toggle notification dropdown
    notificationBell.addEventListener('click', async (e) => {
      e.stopPropagation();
      notificationDropdown.classList.toggle('show');

      document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        if (menu !== notificationDropdown) {
          menu.classList.remove('show');
        }
      });

      if (notificationDropdown.classList.contains('show')) {
        await renderDropdownNotifications(document.querySelector('.js-filter-tab.active').dataset.filter);
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
        notificationDropdown.classList.remove('show');
      }
    });

    // View all notifications
    viewAllBtn.addEventListener('click', async () => {
      notificationDropdown.classList.remove('show');
      notificationPanel.classList.add('show');
      document.body.classList.add('notification-panel-open');
      await renderPanelNotifications('all');
    });

    // Close panel
    closePanelBtn.addEventListener('click', () => {
      notificationPanel.classList.remove('show');
      document.body.classList.remove('notification-panel-open');
    });

    // Mark all as read
    markAllReadBtn.addEventListener('click', async () => {
      await markAllAsRead();
    });

    // Render notifications in dropdown
    async function renderDropdownNotifications(filter = 'all') {
      notificationList.innerHTML = '';
      const notifications = await fetchNotifications(filter);
      const recentNotifications = notifications.slice(0, 5);

      if (recentNotifications.length === 0) {
        const emptyClone = emptyNotificationTemplate.content.cloneNode(true);
        notificationList.appendChild(emptyClone);
      } else {
        recentNotifications.forEach(notification => {
          const clone = notificationTemplate.content.cloneNode(true);
          const item = clone.querySelector('.js-notification-item');
          const avatar = clone.querySelector('.js-user-avatar');
          const userName = clone.querySelector('.js-user-name');
          const actionText = clone.querySelector('.js-action-text');
          const interactionWith = clone.querySelector('.js-interaction-with');
          const timeText = clone.querySelector('.js-time-text');
          const postLink = clone.querySelector('.js-post-link');
          const typeIcon = clone.querySelector('.js-notification-type i');
          const typeBox = clone.querySelector('.js-notification-type');
          const badge = clone.querySelector('.js-unread-badge');

          item.dataset.id = notification.id;
          item.dataset.type = notification.type;

          // Thêm class system và điều chỉnh nội dung
          if (notification.type === 'system') {
            item.classList.add('js-system-notification');
            actionText.textContent = notification.action;
          } else {
            avatar.src = notification.avatar || 'https://i.pravatar.cc/80';
            avatar.alt = notification.name || 'User';
            userName.textContent = notification.name || 'Unknown';
            actionText.textContent = ` ${notification.action} `;
            interactionWith.textContent = notification.interaction || '';
            postLink.textContent = notification.post || 'No title';
            postLink.href = `#${notification.id}`;
          }

          timeText.textContent = notification.time;

          const typeConfig = notificationTypes[notification.type];
          typeIcon.className = `bi ${typeConfig.icon}`;
          typeBox.className = `js-notification-type ${typeConfig.class}`;

          if (!notification.unread) {
            item.classList.remove('js-unread');
            badge.remove();
          }

          item.addEventListener('click', async () => {
            await markAsRead(notification.id);
            await handleNotificationAction(notification);
          });

          notificationList.appendChild(clone);
        });
      }

      updateBadgeCount(notifications);
    }
    // Handle responsive
    function handleResponsive() {
      if (window.innerWidth <= 576) {
        notificationDropdown.style.position = 'fixed';
        notificationDropdown.style.bottom = '0';
        notificationDropdown.style.top = 'auto';
      } else {
        notificationDropdown.style.position = 'absolute';
        notificationDropdown.style.bottom = '';
        notificationDropdown.style.top = '100%';
      }
    }

    // Render notifications in panel
    async function renderPanelNotifications(filter = 'all') {
      panelNotificationList.innerHTML = '';
      const notifications = await fetchNotifications(filter);

      if (notifications.length === 0) {
        const emptyClone = emptyPanelNotificationTemplate.content.cloneNode(true);
        panelNotificationList.appendChild(emptyClone);
      } else {
        notifications.forEach(notification => {
          const clone = panelNotificationTemplate.content.cloneNode(true);
          const item = clone.querySelector('.js-panel-notification-item');
          const avatar = clone.querySelector('.js-user-avatar');
          const userName = clone.querySelector('.js-user-name');
          const actionText = clone.querySelector('.js-action-text');
          const interactionWith = clone.querySelector('.js-interaction-with');
          const timeText = clone.querySelector('.js-time-text');
          const postLink = clone.querySelector('.js-post-link');
          const typeIcon = clone.querySelector('.js-notification-type i');
          const typeBox = clone.querySelector('.js-notification-type');
          const badge = clone.querySelector('.js-unread-badge');
          const actionsContainer = clone.querySelector('.js-panel-notification-actions');
          const deleteBtn = clone.querySelector('.js-delete-btn');

          item.dataset.id = notification.id;
          item.dataset.type = notification.type;

          // Xử lý thông báo hệ thống
          if (notification.type === 'system') {
            // Ẩn hoàn toàn các phần tử không cần thiết
            avatar.remove();
            userName.remove();
            postLink.remove();
            interactionWith.remove();

            // Hiển thị toàn bộ nội dung trong actionText
            actionText.textContent = notification.action;
            actionText.style.marginLeft = '0'; // Loại bỏ margin nếu có

            // Điều chỉnh CSS cho item
            item.style.alignItems = 'center';
            item.style.paddingLeft = '12px'; // Giảm padding nếu cần
          } else {
            // Xử lý thông báo thông thường
            avatar.src = notification.avatar || 'https://i.pravatar.cc/80';
            avatar.alt = notification.name || 'User';
            userName.textContent = notification.name || 'Unknown';
            actionText.textContent = ` ${notification.action} `;
            interactionWith.textContent = notification.interaction || '';
            postLink.textContent = notification.post || 'No title';
            postLink.href = `#${notification.id}`;
          }

          timeText.textContent = notification.time;

          const typeConfig = notificationTypes[notification.type];
          typeIcon.className = `bi ${typeConfig.icon}`;
          typeBox.className = `js-notification-type ${typeConfig.class}`;

          if (typeConfig.actionBtn) {
            const actionBtn = document.createElement('button');
            actionBtn.className = `js-action-btn ${typeConfig.actionBtn.class}`;
            actionBtn.innerHTML = `
                    <i class="bi ${typeConfig.actionBtn.icon}"></i>
                    ${typeConfig.actionBtn.text}
                `;
            actionsContainer.appendChild(actionBtn);

            actionBtn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await handleNotificationAction(notification);
            });
          }

          if (!notification.unread) {
            item.classList.remove('js-unread');
            badge.remove();
          }

          deleteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            await deleteNotification(notification.id);
          });

          item.addEventListener('click', async () => {
            await markAsRead(notification.id);
          });

          panelNotificationList.appendChild(clone);
        });
      }

      updateBadgeCount(notifications);
    }

    // Handle notification actions
    async function handleNotificationAction(notification) {
      switch (notification.type) {
        case 'comment':
          alert(`Phản hồi bình luận từ ${notification.name}`);
          break;
        case 'like':
          alert(`Xem bài viết: ${notification.post}`);
          break;
        case 'mention':
          alert(`Xem chi tiết nhắc đến trong ${notification.post}`);
          break;
        case 'system':
          const response = await fetch(`/api/notifications/${notification.id}/update-details`);
          if (response.ok) {
            const updateDetails = await response.json();
            showUpdateDetails(updateDetails);
          } else {
            alert(`Thông báo hệ thống: ${notification.post}`);
          }
          break;
      }
    }

    // Show update details
    function showUpdateDetails(updateDetails) {
      const modal = new bootstrap.Modal(document.getElementById('jsUpdateDetailsModal'));
      const content = document.getElementById('jsUpdateDetailsContent');

      let html = `
            <div class="mb-3">
                <h6 class="fw-bold">Phiên bản ${updateDetails.version}</h6>
                <small class="text-muted">Ngày cập nhật: ${updateDetails.date}</small>
            </div>
            <ul class="js-update-details-list">
        `;

      updateDetails.changes.forEach(change => {
        const typeClass = `js-update-${change.type}`;
        html += `<li><span class="${typeClass}">${change.text}</span></li>`;
      });

      html += `</ul>`;
      content.innerHTML = html;

      modal.show();
    }

    // Mark notification as read
    async function markAsRead(id) {
      try {
        const response = await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed to mark as read');
        const currentFilter = document.querySelector('.js-filter-tab.active').dataset.filter;
        await renderDropdownNotifications(currentFilter);
        if (notificationPanel.classList.contains('show')) {
          await renderPanelNotifications(currentFilter);
        }
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    // Delete notification
    async function deleteNotification(id) {
      try {
        const response = await fetch(`/api/notifications/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete notification');
        const currentFilter = document.querySelector('.js-filter-tab.active').dataset.filter;
        await renderDropdownNotifications(currentFilter);
        await renderPanelNotifications(currentFilter);
      } catch (error) {
        console.error('Error deleting notification:', error);
      }
    }

    // Mark all as read
    async function markAllAsRead() {
      try {
        const response = await fetch('/api/notifications/read-all', { method: 'POST' });
        if (!response.ok) throw new Error('Failed to mark all as read');
        const currentFilter = document.querySelector('.js-filter-tab.active').dataset.filter;
        await renderDropdownNotifications(currentFilter);
        if (notificationPanel.classList.contains('show')) {
          await renderPanelNotifications(currentFilter);
        }
      } catch (error) {
        console.error('Error marking all as read:', error);
      }
    }

    // Update badge count
    function updateBadgeCount(notifications) {
      const count = notifications.filter(n => n.unread).length;
      bellBadge.textContent = count;
      bellBadge.style.display = count === 0 ? 'none' : 'flex';
    }

    // Initialize
    async function init() {
      injectStyles();
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-bs-theme', savedTheme);

      document.querySelectorAll('.js-filter-tab').forEach(tab => {
        tab.addEventListener('click', async () => {
          const container = tab.closest('.js-filter-tabs');
          container.querySelectorAll('.js-filter-tab').forEach(t => {
            t.classList.remove('active');
          });
          tab.classList.add('active');

          if (container.parentElement === notificationDropdown) {
            await renderDropdownNotifications(tab.dataset.filter);
          } else {
            await renderPanelNotifications(tab.dataset.filter);
          }
        });
      });

      window.addEventListener('resize', handleResponsive);
      handleResponsive();

      await renderDropdownNotifications('all');
    }

    init();
  </script>
  <style>
    /* Định dạng cho nút nav */
    .nav-link {
      position: relative;
      font-family: 'Roboto', sans-serif;
      color: #777777;
      text-decoration: none;
      padding: 10px 15px;
      transition: all 0.3s ease;
      border: none;
      background: none;
      cursor: pointer;
    }

    /* Hiệu ứng underline ẩn ban đầu */
    .nav-link::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background-color: #007bff;
      transition: width 0.3s ease;
    }

    /* Hiệu ứng khi hover (áp dụng cho các nav-link không active) */
    .nav-link:hover {
      color: #007bff;
      transform: translateY(-2px);
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Style cho nút active */
    .nav-link.active {
      color: #007bff;
    }

    /* Không áp dụng hiệu ứng hover cho nav-link đang active */
    .nav-link.active:hover {
      color: #007bff;
      transform: none;
    }

    .nav-link.active:hover::after {
      width: 0;
    }
  </style>


  <div class="compact-container my-4">
    <div class="card card-custom">
      <div class="card-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="de-thi-tab" data-bs-toggle="tab" data-bs-target="#de-thi" type="button"
              role="tab" style="color:#777777">Đề Thi</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="de-cuong-tab" data-bs-toggle="tab" data-bs-target="#de-cuong" type="button"
              role="tab" style="color:#777777">Đề Cương</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="ve-chung-toi-tab" data-bs-toggle="tab" data-bs-target="#ve-chung-toi"
              type="button" role="tab" style="color:#777777">Về Chúng Tôi</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <!-- Tab Đề Thi -->
          <div class="tab-pane fade show active" id="de-thi" role="tabpanel" aria-labelledby="de-thi-tab">
            <div id="exam-drive-container"></div>
          </div>
          <!-- Tab Đề Cương -->
          <div class="tab-pane fade" id="de-cuong" role="tabpanel" aria-labelledby="de-cuong-tab">
            <div id="syllabus-drive-container"></div>
          </div>
          <!-- Tab Về Chúng Tôi -->
          <div class="tab-pane fade" id="ve-chung-toi" role="tabpanel" aria-labelledby="ve-chung-toi-tab">
            <!-- Sử dụng position-relative để định vị phần "Phiên bản" -->
            <div class="p-3 position-relative">
              <p>
                Các đề thi và tài liệu trên website này đều được đóng góp bởi các cựu sinh viên, mang lại sự gần gũi và
                trải nghiệm thực tế trong học tập.
              </p>
              <div class="about-links mt-3">
                <footer class="custom-footer mt-4">
                  <div class="footer-item">
                    <span>Design by Nguyen Ngoc Truong</span>
                  </div>
                  <div class="social-links">
                    <a href="https://www.facebook.com/profile.php?id=100093400989542" target="_blank"
                      aria-label="Facebook">
                      <i class="bi bi-facebook"></i>
                    </a>
                    <a href="https://github.com/truongqb05x" target="_blank" aria-label="GitHub">
                      <i class="bi bi-github"></i>
                    </a>
                  </div>
                </footer>
              </div>

              <!-- Chữ "Phiên bản 0" được đặt ở góc dưới bên phải, có hiệu ứng nhấn để mở modal lịch sử cập nhật -->
              <div class="version-info"
                style="position: absolute; bottom: 0; right: 0; padding: 5px; font-size: 0.9rem; color: #666;"
                data-bs-toggle="modal" data-bs-target="#updateHistoryModal">
                Version 2.0.6
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Container chứa iframe thảo luận (ẩn ban đầu) -->
  <style>
    #discussion-container {
      display: none;
      /* Ẩn ban đầu */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: auto;
    }

    #discussion-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>

  <div id="discussion-container">
    <iframe id="discussion-iframe" src="/html/thaoluan.html"></iframe>
  </div>

  <script>
    // Khi cần hiển thị, chuyển đổi display và ép tính toán lại layout
    function showDiscussion() {
      var container = document.getElementById("discussion-container");
      container.style.display = "block";
      // ép reflow: đọc offsetHeight để trình duyệt tính lại layout
      var dummy = container.offsetHeight;
    }
  </script>
  <!-- Container chứa thông báo, sẽ được tạo tự động nếu chưa có -->
  <div class="my-notification-container"></div>


  <script>
    /**
     * Hàm triggerNotification: Kích hoạt thông báo bằng cách tạo CSS, container và thông báo mới.
     * @param {string} type - Loại thông báo: 'success', 'warning', 'danger'
     * @param {string} title - Tiêu đề thông báo
     * @param {string} message - Nội dung thông báo
     */
    function triggerNotification(type, title, message) {
      // Chèn CSS động nếu chưa có
      if (!document.getElementById('my-notification-style')) {
        const css = `
        .my-notification-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 320px;
        }
        
        .my-notification {
          position: relative;
          padding: 15px 20px;
          margin-bottom: 15px;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          opacity: 0;
          transform: translateX(120%);
          animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
          display: flex;
          align-items: center;
          transition: all 0.3s ease;
          border-left: 4px solid;
          background: #fff !important;  /* Đặt background ưu tiên */
        }

        /* Các màu nền riêng theo loại thông báo */
        .alert-success {
          background: #d4edda !important;
          border-color: #28a745;
        }
        
        .alert-warning {
          background: #fff3cd !important;
          border-color: #ffc107;
        }
        
        .alert-danger {
          background: #f8d7da !important;
          border-color: #dc3545;
        }
    
        .my-notification.hide {
          animation: slideOut 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
        }
    
        .my-notification:hover {
          transform: translateX(-5px);
          box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
    
        .my-notification-icon {
          font-size: 1.5rem;
          margin-right: 15px;
          flex-shrink: 0;
        }
    
        .my-notification-content {
          flex-grow: 1;
        }
    
        .my-notification-close {
          opacity: 0.6;
          margin-left: 15px;
          transition: opacity 0.2s;
        }
    
        .my-notification-close:hover {
          opacity: 1;
        }
    
        .my-progress-bar {
          position: absolute;
          bottom: 0;
          left: 0;
          height: 3px;
          background: rgba(255,255,255,0.3);
          width: 100%;
          overflow: hidden;
          border-radius: 0 0 8px 8px;
        }
    
        .my-progress-bar::after {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          height: 100%;
          width: 100%;
          background: currentColor;
          animation: progress 5s linear forwards;
        }
    
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(120%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
    
        @keyframes slideOut {
          from {
            opacity: 1;
            transform: translateX(0);
          }
          to {
            opacity: 0;
            transform: translateX(120%);
          }
        }
    
        @keyframes progress {
          from { transform: translateX(-100%); }
          to { transform: translateX(0); }
        }
      `;
        const styleEl = document.createElement('style');
        styleEl.type = 'text/css';
        styleEl.id = 'my-notification-style';
        styleEl.appendChild(document.createTextNode(css));
        document.head.appendChild(styleEl);
      }

      // Đảm bảo container thông báo tồn tại
      let container = document.querySelector('.my-notification-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'my-notification-container';
        document.body.appendChild(container);
      }

      // Tạo phần tử thông báo mới
      const notification = document.createElement('div');
      notification.classList.add('my-notification', `alert-${type}`);

      // Chọn icon tương ứng theo loại thông báo
      let iconClass = '';
      if (type === 'success') {
        iconClass = 'bi-check-circle-fill';
      } else if (type === 'warning') {
        iconClass = 'bi-hourglass-split';
      } else if (type === 'danger') {
        iconClass = 'bi-x-octagon-fill';
      }

      notification.innerHTML = `
      <i class="bi ${iconClass} my-notification-icon"></i>
      <div class="my-notification-content">
        <h6 class="mb-1 fw-semibold">${title}</h6>
        <p class="mb-0 small">${message}</p>
      </div>
      <div class="my-progress-bar"></div>
      <button class="my-notification-close btn btn-link p-0">
        <i class="bi bi-x"></i>
      </button>
    `;

      // Sự kiện đóng thông báo khi nhấn nút close
      notification.querySelector('.my-notification-close').addEventListener('click', () => {
        notification.classList.add('hide');
        notification.addEventListener('animationend', () => notification.remove());
      });

      container.appendChild(notification);

      // Tự động ẩn thông báo sau 3 giây
      setTimeout(() => {
        notification.classList.add('hide');
        notification.addEventListener('animationend', () => notification.remove());
      }, 3000);
    }

    // Ví dụ sử dụng:
    // triggerNotification('warning', 'Cảnh báo!', 'Vui lòng kiểm tra lại dữ liệu.');
    // triggerNotification('danger', 'Lỗi!', 'Không thể kết nối đến máy chủ.');
  </script>

  <!-- Nút đóng góp đề thi -->
  <button type="button" class="btn btn-primary contribute-btn"
    style="position: fixed; bottom: 0; right: 0; margin: 10px; " data-bs-toggle="modal"
    data-bs-target="#contributeExamModal">
    <i class="bi bi-pencil-square"></i> Đóng góp đề thi
  </button>

  <!-- Modal Đóng góp Đề thi -->
  <div class="modal fade" id="contributeExamModal" data-bs-backdrop="false" tabindex="-1"
    aria-labelledby="contributeExamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contributeExamModalLabel">Đóng góp đề thi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <!-- Thông báo -->
          <div id="alertContainer">
            <div id="successAlert" class="alert alert-success" role="alert" style="display: none;">
              <i class="bi bi-check-circle-fill me-2"></i>Upload thành công!
            </div>
            <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
              <i class="bi bi-exclamation-circle-fill me-2"></i><span id="errorMessage"></span>
            </div>
          </div>

          <!-- Form upload -->
          <form id="contributeExamForm" action="/api/upload_exam" method="POST" enctype="multipart/form-data">
            <!-- Chọn trường -->
            <div class="mb-4">
              <label for="fieldSelect" class="form-label fw-bold">Trường đại học <span
                  class="text-danger">*</span></label>
              <select class="form-select" id="fieldSelect" name="field" required>
                <option value="" disabled selected>Vui lòng chọn trường...</option>
                <!-- Options sẽ được thêm bằng JavaScript -->
              </select>
              <div class="invalid-feedback">Vui lòng chọn trường đại học</div>
            </div>

            <!-- File upload section -->
            <div class="mb-3">
              <label class="form-label fw-bold">Tải lên file <span class="text-danger">*</span></label>
              <div id="fileInputsContainer">
                <div class="file-input-group mb-3">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <span class="text-muted">File 1</span>
                    <button type="button" class="btn btn-link text-danger p-0 remove-file" disabled>
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div class="input-group">
                    <input type="file" class="form-control" name="examFile[]" accept="*/*" required>
                    <button class="btn btn-outline-secondary" type="button">
                      <i class="bi bi-folder2-open"></i>
                    </button>
                  </div>
                  <div class="form-text mt-1">Định dạng hỗ trợ: PDF, DOCX, JPG, PNG (Tối đa 10MB)</div>
                  <div class="invalid-feedback">Vui lòng chọn file</div>
                </div>
              </div>

              <button type="button" class="btn btn-outline-primary w-100" id="addFileInput">
                <i class="bi bi-plus-circle me-2"></i>Thêm file
              </button>
            </div>
          </form>
        </div>
        <div class="modal-footer bg-light">
          <button type="submit" form="contributeExamForm" class="btn btn-primary px-4">
            <i class="bi bi-send me-2"></i>Gửi đóng góp
          </button>
          <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .file-input-group {
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      transition: border-color 0.15s ease-in-out;
    }

    .file-input-group:hover {
      border-color: #86b7fe;
    }

    .remove-file {
      transition: opacity 0.2s ease-in-out;
    }

    .remove-file:not(:disabled):hover {
      opacity: 0.75;
    }

    .input-group button:hover {
      background-color: #e9ecef;
    }
  </style>
  <!-- Script xử lý form và các chức năng khác -->
  <script>
    // Load danh sách trường từ API /api/schools
    document.addEventListener('DOMContentLoaded', function () {
      var fieldSelect = document.getElementById('fieldSelect');
      fetch('/api/schools')
        .then(response => response.json())
        .then(data => {
          fieldSelect.innerHTML = '';
          if (data.error) {
            let errorOption = document.createElement('option');
            errorOption.text = 'Lỗi khi tải trường';
            fieldSelect.appendChild(errorOption);
            triggerNotification('danger', 'Lỗi', 'Lỗi khi tải danh sách trường!');
          } else {
            let defaultOption = document.createElement('option');
            defaultOption.text = 'Chọn trường của bạn';
            defaultOption.selected = true;
            defaultOption.value = ''; // Đảm bảo giá trị rỗng để kiểm tra
            fieldSelect.appendChild(defaultOption);
            data.forEach(function (school) {
              let option = document.createElement('option');
              option.value = school.id;
              option.text = school.name + " (" + school.count + ")";
              fieldSelect.appendChild(option);
            });
          }
        })
        .catch(err => {
          console.error(err);
          fieldSelect.innerHTML = '<option>Lỗi khi tải trường</option>';
          triggerNotification('danger', 'Lỗi', 'Có lỗi khi tải danh sách trường!');
        });
    });

    // Thêm input file mới
    document.getElementById('addFileInput').addEventListener('click', function () {
      var fileGroup = document.createElement('div');
      fileGroup.className = 'file-input-group mb-3';

      var fileLabel = document.createElement('label');
      fileLabel.className = 'form-label';
      fileLabel.innerText = 'Tải file đề thi';
      fileGroup.appendChild(fileLabel);

      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.className = 'form-control';
      fileInput.name = 'examFile[]';
      fileInput.accept = '*/*';
      fileGroup.appendChild(fileInput);

      document.getElementById('fileInputsContainer').appendChild(fileGroup);
    });

    // Xử lý submit form với kiểm tra đầy đủ
    document.getElementById('contributeExamForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Ngăn form submit mặc định
      var form = this;

      // Kiểm tra đã chọn trường chưa
      var fieldSelect = document.getElementById('fieldSelect');
      if (!fieldSelect.value) {
        triggerNotification('danger', 'Chưa chọn trường', 'Vui lòng chọn trường của bạn trước khi tải lên!');
        return;
      }

      // Kiểm tra xem đã chọn file chưa
      var fileInputs = document.getElementsByName('examFile[]');
      var fileSelected = false;
      for (var i = 0; i < fileInputs.length; i++) {
        if (fileInputs[i].files.length > 0) {
          fileSelected = true;
          break;
        }
      }
      if (!fileSelected) {
        triggerNotification('danger', 'Chưa chọn file', 'Vui lòng chọn ít nhất một file để tải lên!');
        return;
      }

      let formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            triggerNotification('success', 'Thành công', data.message);
            // Reset form sau khi upload thành công
            form.reset();
            // Cập nhật lại container file với một input mặc định
            document.getElementById('fileInputsContainer').innerHTML = `
          <div class="file-input-group mb-3">
            <label class="form-label">Tải file</label>
            <input type="file" class="form-control" name="examFile[]" accept="*/*">
            <p class="form-text mt-2">
              Bạn có thể chọn file đề thi hoặc đề cương!
            </p>
          </div>
        `;
          } else if (data.error) {
            triggerNotification('danger', 'Lỗi', "Lỗi: " + data.error);
          }
        })
        .catch(error => {
          console.error(error);
          triggerNotification('danger', 'Lỗi', 'Có lỗi xảy ra khi tải lên. Vui lòng thử lại!');
        });
    });
  </script>

  <!-- Modal báo lỗi -->
  <div class="mr-modal-overlay" id="mr-modal" style="display: none;">
    <div class="mr-modal-container">
      <div class="mr-modal-header">
        <h2 class="mr-modal-title">
          <i class="fas fa-bug"></i>
          Báo cáo sự cố
        </h2>
        <button class="mr-close-btn" onclick="mr_hideModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="mr-modal-content">
        <form id="mr-reportForm" onsubmit="mr_handleSubmit(event)">
          <!-- Hiển thị tên đề thi (readonly) -->
          <div class="mr-input-group">
            <input type="text" class="mr-form-input" placeholder=" " id="document_name" value="Đề thi mặc định"
              readonly>
            <label class="mr-form-label">Đề thi</label>
          </div>
          <!-- Input ẩn cho document_id -->
          <input type="hidden" id="document_id" name="document_id" value="">
          <!-- Input ẩn cho user_id (giả sử lấy từ biến currentUserId) -->
          <input type="hidden" id="user_id" name="user_id" value="">

          <!-- Nội dung báo cáo -->
          <div class="mr-input-group">
            <textarea class="mr-form-input" placeholder=" " id="report_content" rows="4" required></textarea>
            <label class="mr-form-label">Mô tả chi tiết</label>
          </div>

          <div class="mr-action-buttons">
            <button type="button" class="mr-btn mr-btn-secondary" onclick="mr_hideModal()">
              Hủy bỏ
            </button>
            <button type="submit" class="mr-btn mr-btn-primary">
              <i class="fas fa-paper-plane"></i>
              Gửi báo cáo
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Giả sử currentUserId được lấy từ session hoặc biến toàn cục
    const currentUserId = 1; // Ví dụ

    // Chèn CSS của modal qua DOM và prepend vào <head> để ưu tiên thực thi
    (function () {
      const style = document.createElement('style');
      style.type = 'text/css';
      style.id = 'mr-modalStyles';
      const css = `
      :root {
        --mr-primary: #6366f1;
        --mr-primary-hover: #4f46e5;
        --mr-background: #ffffff;
        --mr-text: #1e293b;
        --mr-glass: rgba(255, 255, 255, 0.9);
        --mr-border: #e2e8f0;
      }
      
      @media (prefers-color-scheme: dark) {
        :root {
          --mr-background: #0f172a;
          --mr-text: #f8fafc;
          --mr-glass: rgba(15, 23, 42, 0.9);
          --mr-border: #334155;
        }
      }
    
      /* Modal Overlay */
      .mr-modal-overlay {
        position: fixed;
        inset: 0;
        background: transparent;
        backdrop-filter: none;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: mr-fadeIn 0.3s ease;
      }
      
      /* Modal Container */
      .mr-modal-container {
        width: 90%;
        max-width: 480px;
        background: var(--mr-glass);
        border: 1px solid var(--mr-border);
        border-radius: 24px;
        backdrop-filter: blur(16px);
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.1);
        transform: scale(0.95);
        opacity: 0;
        animation: mr-modalEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }
      
      /* Modal Header */
      .mr-modal-header {
        padding: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--mr-border);
      }
      
      .mr-modal-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--mr-text);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .mr-close-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--mr-text);
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      
      .mr-close-btn:hover {
        opacity: 1;
      }
      
      /* Modal Content */
      .mr-modal-content {
        padding: 24px;
      }
      
      /* Form Elements */
      .mr-input-group {
        margin-bottom: 24px;
        position: relative;
      }
      
      .mr-form-input {
        width: 100%;
        padding: 16px;
        border: 2px solid var(--mr-border);
        border-radius: 12px;
        background: transparent;
        color: var(--mr-text);
        font-size: 16px;
        transition: border-color 0.3s;
      }
      
      .mr-form-input:focus {
        outline: none;
        border-color: var(--mr-primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }
      
      .mr-form-label {
        position: absolute;
        left: 16px;
        top: 16px;
        color: #64748b;
        pointer-events: none;
        transition: all 0.3s;
        background: var(--mr-glass);
        padding: 0 4px;
      }
      
      .mr-form-input:focus ~ .mr-form-label,
      .mr-form-input:not(:placeholder-shown) ~ .mr-form-label {
        transform: translateY(-24px);
        font-size: 14px;
        color: var(--mr-primary);
      }
      
      /* Action Buttons */
      .mr-action-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
      }
      
      .mr-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        gap: 8px;
        align-items: center;
        transition: all 0.3s;
      }
      
      .mr-btn-primary {
        background: var(--mr-primary);
        color: white;
      }
      
      .mr-btn-primary:hover {
        background: var(--mr-primary-hover);
        transform: translateY(-1px);
      }
      
      .mr-btn-secondary {
        background: rgba(99, 102, 241, 0.1);
        color: var(--mr-primary);
        border: 1px solid var(--mr-border);
      }
      
      .mr-btn-secondary:hover {
        background: rgba(99, 102, 241, 0.2);
      }
      
      /* Animations */
      @keyframes mr-fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes mr-modalEnter {
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      /* Success Animation */
      .mr-success-check {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--mr-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 24px auto;
        animation: mr-checkBounce 0.6s ease;
      }
      
      @keyframes mr-checkBounce {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      
      /* Responsive Design */
      @media (max-width: 480px) {
        .mr-modal-container {
          border-radius: 16px;
        }
        
        .mr-modal-title {
          font-size: 20px;
        }
        
        .mr-form-input {
          padding: 14px;
        }
      }
    `;
      style.textContent = css;
      document.head.prepend(style);
    })();

    // Hàm mở modal báo lỗi và cập nhật nội dung "Đề thi" cũng như document_id
    function openReportModal(file) {
      const modal = document.getElementById('mr-modal');
      // Cập nhật tên đề thi
      const examInput = document.getElementById('document_name');
      if (examInput) {
        examInput.value = file.file_name;
      }
      // Lưu document_id vào input ẩn
      document.getElementById('document_id').value = file.id;
      // Cập nhật user_id (giả sử lấy từ biến currentUserId)
      document.getElementById('user_id').value = currentUserId;

      mr_showModal();
      console.log("Mở modal báo lỗi cho file:", file.file_name);
    }

    // Hàm mở modal
    function mr_showModal() {
      const modal = document.getElementById('mr-modal');
      modal.style.display = 'flex';
      modal.style.opacity = '1';
      document.body.style.overflow = 'hidden';
    }

    // Hàm đóng modal
    function mr_hideModal() {
      const modal = document.getElementById('mr-modal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset form nếu cần
        resetReportForm();
      }, 300);
    }

    // Reset form modal về ban đầu
    function resetReportForm() {
      const form = document.getElementById('mr-reportForm');
      form.reset();
      // Nếu bạn có nội dung HTML mặc định cần khôi phục thì có thể đặt lại ở đây.
      // Ví dụ: reset giá trị của document_name nếu cần.
    }

    // Xử lý submit form báo lỗi, gửi dữ liệu đến backend
    async function mr_handleSubmit(e) {
      e.preventDefault();

      const user_id = document.getElementById('user_id').value;
      const document_id = document.getElementById('document_id').value;
      const report_content = document.getElementById('report_content').value;

      if (!user_id || !document_id || !report_content) {
        alert("Vui lòng nhập đủ thông tin báo cáo.");
        return;
      }

      // Gói dữ liệu theo định dạng JSON
      const payload = {
        user_id: user_id,
        document_id: document_id,
        report_content: report_content
      };

      try {
        // Gọi API POST đến backend
        const response = await fetch('/report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          // Hiệu ứng chuyển đổi form thành thông báo thành công
          const form = document.getElementById('mr-reportForm');
          form.style.opacity = '0';
          setTimeout(() => {
            form.innerHTML = `
            <div class="mr-success-check">
              <i class="fas fa-check" style="color: white; font-size: 24px;"></i>
            </div>
            <h3 style="text-align: center; color: var(--mr-text); margin-bottom: 24px;">
              Báo cáo đã được gửi thành công!
            </h3>
            <button 
              class="mr-btn mr-btn-primary" 
              style="margin: 0 auto;" 
              onclick="mr_hideModal()"
            >
              Đóng
            </button>
          `;
            form.style.opacity = '1';
          }, 500);
        } else {
          const errorData = await response.json();
          alert("Có lỗi xảy ra: " + (errorData.error || 'Lỗi không xác định'));
        }
      } catch (error) {
        console.error("Lỗi khi gửi báo cáo:", error);
        alert("Không thể kết nối đến máy chủ.");
      }
    }

    // Đóng modal khi click bên ngoài container
    document.getElementById('mr-modal').addEventListener('click', function (e) {
      if (e.target === this) mr_hideModal();
    });

    // Đóng modal khi nhấn phím ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') mr_hideModal();
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    /*************************************
     * Hàm kiểm tra và reset lịch sử      *
     *************************************/
    // Hàm checkAndResetHistory: Kiểm tra thông tin trường của user qua API /user/university,
    // so sánh với lịch sử truy cập (examCurrentPath, syllabusCurrentPath) và reset nếu không khớp.
    async function checkAndResetHistory() {
      try {
        const res = await fetch('/user/university', { credentials: 'include' });
        if (res.ok) {
          const userSchool = await res.json();
          window.userSchoolId = userSchool.university;
          console.log("User school id:", window.userSchoolId);
          console.log("Exam history school id:", examCurrentPath.length > 0 ? examCurrentPath[0].id : 'none');
          console.log("Syllabus history school id:", syllabusCurrentPath.length > 0 ? syllabusCurrentPath[0].id : 'none');

          // Nếu lịch sử của Đề Thi không khớp, reset nó
          if (examCurrentPath.length > 0 && String(examCurrentPath[0].id) !== String(window.userSchoolId)) {
            console.log("Reset exam history");
            examCurrentPath = [];
            localStorage.removeItem('examCurrentPath');
          }
          // Nếu lịch sử của Đề Cương không khớp, reset nó
          if (syllabusCurrentPath.length > 0 && String(syllabusCurrentPath[0].id) !== String(window.userSchoolId)) {
            console.log("Reset syllabus history");
            syllabusCurrentPath = [];
            localStorage.removeItem('syllabusCurrentPath');
          }
        } else {
          console.warn("Không thể lấy thông tin trường của user");
        }
      } catch (error) {
        console.error("Lỗi khi kiểm tra lịch sử trường:", error);
      }
    }



    /*************************************
     * DOMContentLoaded: Các sự kiện bổ sung *
     *************************************/
    document.addEventListener("DOMContentLoaded", function () {
      // Các sự kiện hoặc thao tác DOM bổ sung có thể đặt tại đây.
      // Ví dụ: Tự động điền thông tin đăng nhập sau đăng ký đã được xử lý ở formRegister.
    });
  </script>

  <!-- Modal Xác thực -->
  <div class="modal fade" id="verificationModal-v2" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-3">
        <!-- Header sử dụng Shadow DOM với hậu tố _v2 -->
        <modal-header-v2></modal-header-v2>

        <!-- Body -->
        <div class="modal-body pt-0">
          <p class="text-muted mb-4">
            Tài khoản của bạn chưa được xác thực. Bạn cần chọn 1 trong 2 cách sau nhé! 😊
          </p>

          <!-- Phương thức 1: Đóng góp ảnh đề thi -->
          <div class="card mb-3 border-primary card-method-v2">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <i class="bi bi-cloud-upload fs-3 text-primary me-2"></i>
                <div>
                  <h6 class="mb-1">Đóng góp ảnh đề thi</h6>
                  <p class="text-muted small mb-0">
                    Chia sẻ ảnh đề thi bất kỳ để cộng đồng cùng học tập
                  </p>
                  
                </div>
                
              </div>
              <div class="position-relative">
                <!-- File input cho ảnh đề thi -->
                <input type="file" id="examImageUpload_v2" accept="image/*" class="d-none" multiple
                  data-container="fileNameExamImage_v2" onchange="handleFileUpload_v2(event, 'exam')">
                <label for="examImageUpload_v2" class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                  <i class="bi bi-upload me-2"></i>Chọn ảnh đề thi
                </label>
                <div id="fileNameExamImage_v2" class="text-muted small mt-2"></div>
              </div>
              <!-- Nút gửi file -->
              <button class="btn btn-success btn-sm mt-2" onclick="submitExamImage_v2()" id="submitExamBtn_v2">
                <i class="bi bi-send me-2"></i>Gửi ảnh đề thi
              </button>
              
              <div id="examUploadLoading_v2" class="text-primary small mt-2" style="display:none;">
                <i class="bi bi-hourglass-split"></i> Đang upload, vui lòng chờ...
              </div>
            </div>
                    <!-- Thêm dòng cảnh báo nghiêm cấm -->
        <div class="alert alert-danger alert-sm mb-3 p-2 text-center" style="font-size: 0.8rem;">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          <strong>NGHIÊM CẤM</strong> xác thực bằng tài nguyên lấy từ nền tảng. Nếu vi phạm sẽ bị <strong>BAN</strong> vĩnh viễn!
        </div>

          </div>

          <!-- Phương thức 2: Chia sẻ với bạn bè -->
          <div class="card border-success card-method-v2">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-share fs-3 text-success me-2"></i>
                <div>
                  <h6 class="mb-1">Chia sẻ với bạn bè</h6>
                  <p class="text-muted small mb-0">
                    Share trang web cho 2 người bạn để xác thực
                  </p>
                </div>
              </div>

              <div class="input-group mb-3">
                <div id="copyContent_v2" class="form-control bg-light">
                  Kho lưu trữ đề thi và đề cương qua các năm, tại: https://dethihocphan.com
                </div>
                <button class="btn btn-success btn-copy-v2" onclick="copyText_v2()">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              <div id="copySuccess_v2" class="text-success small mt-2" style="display:none;">
                <i class="bi bi-check2"></i> Đã sao chép!
              </div>

              <!-- Ghi chú hướng dẫn chụp màn hình -->
              <div class="mt-2">
                <small class="text-muted">
                  Ghi chú: Vui lòng coppy rồi gửi cho bạn bè đảm bảo có sự tương tác của họ rồi chụp lại màn hình sau
                  khi chia sẻ, sau đó ấn "Xác nhận đã chia sẻ"!
                </small>
              </div>
              <div class="position-relative">
                <!-- File input cho ảnh chụp màn hình -->
                <input type="file" id="shareScreenshotUpload_v2" accept="image/*" class="d-none"
                  data-container="fileNameShareScreenshot_v2" onchange="handleFileUpload_v2(event, 'share')">
                <label for="shareScreenshotUpload_v2"
                  class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                  <i class="bi bi-upload me-2"></i>Chọn ảnh màn hình
                </label>
                <div id="fileNameShareScreenshot_v2" class="text-muted small mt-2"></div>
              </div>

              <!-- Nút xác nhận đã chia sẻ -->
              <button class="btn btn-outline-success w-100 btn-confirm-share-v2 mt-2" onclick="confirmShare_v2()"
                id="confirmShareBtn_v2">
                <i class="bi bi-check-circle me-2"></i>Xác nhận đã chia sẻ
              </button>
              <div id="shareUploadLoading_v2" class="text-primary small mt-2 text-center" style="display:none;">
                <i class="bi bi-hourglass-split"></i> Đang upload, vui lòng chờ...
              </div>
              <div id="confirmSuccess_v2" class="text-success small mt-2 text-center" style="display:none;">
                <i class="bi bi-check2-circle"></i> Đã xác nhận chia sẻ!
              </div>
            </div>
          </div>

          <!-- Khu vực hiển thị thông tin xác thực -->
          <div id="verification-alert" class="alert alert-danger mt-3" style="display: none;">
            <p class="mb-1">
              <strong>Lần xác thực gần nhất:</strong> <span id="last-rejected-time">12/03/2025 09:45</span>
            </p>
            <p class="mb-0">
              <strong>Lý do từ chối:</strong> <span id="rejection-note">Thông tin xác thực không hợp lệ, vui lòng kiểm
                tra lại</span>
            </p>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary btn-close-v2" data-bs-dismiss="modal">
            Để sau đi
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      fetch('https://dethihocphan.com//get_verification_info', {
        method: 'GET',
        credentials: 'include', // Gửi cookie session để server nhận diện người dùng
        headers: {
          'Accept': 'application/json'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const alertDiv = document.getElementById('verification-alert');
          const lastRejectedTimeSpan = document.getElementById('last-rejected-time');
          const rejectionNoteSpan = document.getElementById('rejection-note');

          if (data.status === 'rejected') {
            // Cập nhật nội dung từ API
            lastRejectedTimeSpan.textContent = data.last_rejected_time || 'Không có dữ liệu';
            rejectionNoteSpan.textContent = data.note || 'Không có ghi chú';
            alertDiv.style.display = 'block'; // Hiển thị khi có dữ liệu
          } else {
            alertDiv.style.display = 'none'; // Ẩn nếu không có bản ghi bị từ chối
          }
        })
        .catch(error => {
          console.error('Lỗi khi gọi API:', error);
          document.getElementById('verification-alert').style.display = 'none'; // Ẩn nếu có lỗi
        });
    });
  </script>

  <!-- Định nghĩa custom element sử dụng Shadow DOM cho header, với tên có hậu tố _v2 -->
  <script>
    class ModalHeaderV2 extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
        shadow.innerHTML = `
      <style>
        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border: 0;
          padding: 1rem;
          padding-bottom: 0;
          background-color: transparent;
        }
        .header h5 {
          color: #0d6efd;
          margin: 0;
          font-size: 1.25rem;
        }
        .header button {
          background: transparent;
          border: none;
          cursor: pointer;
        }
      </style>
      <div class="header">
        <h5 class="modal-title">
          <i class="bi bi-patch-exclamation me-2"></i> Xác thực tài khoản
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
    `;
      }
    }
    customElements.define('modal-header-v2', ModalHeaderV2);
  </script>

  <script>
    // Biến lưu file riêng cho từng phương thức
    let examFiles_v2 = [];
    let shareFile_v2 = null;

    // Hàm xử lý khi chọn file (hậu tố _v2)
    function handleFileUpload_v2(event, type) {
      const newFiles = Array.from(event.target.files);
      const containerId = event.target.getAttribute('data-container');
      let fileListHtml = '';

      if (type === 'exam') {
        // Với ảnh đề thi: cộng dồn vào mảng examFiles_v2
        examFiles_v2 = examFiles_v2.concat(newFiles);
        examFiles_v2.forEach(file => {
          fileListHtml += `<div><i class="bi bi-file-image"></i> Đã chọn: ${file.name}</div>`;
        });
      } else if (type === 'share') {
        // Với ảnh share: chỉ lưu file đầu tiên được chọn
        shareFile_v2 = newFiles[0];
        fileListHtml += `<div><i class="bi bi-file-image"></i> Đã chọn: ${shareFile_v2.name}</div>`;
      }
      document.getElementById(containerId).innerHTML = fileListHtml;
      // Reset giá trị của input để cho phép chọn lại file nếu cần
      event.target.value = '';
    }

    // Hàm gửi ảnh đề thi khi nhấn "Gửi ảnh đề thi" (không thay đổi)
    function submitExamImage_v2() {
      console.log("DEBUG: Hàm submitExamImage_v2 được gọi");

      // Hiển thị thông báo "Vui lòng chờ"
      document.getElementById('examUploadLoading_v2').style.display = 'block';
      document.getElementById('submitExamBtn_v2').disabled = true;

      // Kiểm tra file được chọn (ảnh đề thi)
      if (!examFiles_v2 || examFiles_v2.length === 0) {
        console.error("ERROR: Không có ảnh đề thi được chọn.", { examFiles_v2 });
        triggerNotification('error', 'Lỗi', 'Vui lòng chọn ảnh đề thi trước khi gửi.');
        document.getElementById('examUploadLoading_v2').style.display = 'none';
        document.getElementById('submitExamBtn_v2').disabled = false;
        return;
      }
      console.log("DEBUG: Số lượng file được chọn:", examFiles_v2.length);

      // Tạo mảng các promise để upload file
      const uploadPromises = examFiles_v2.map(file => {
        console.log("DEBUG: Bắt đầu upload file:", file.name);
        return uploadFile_v2(file, 'exam')
          .then(response => {
            console.log("DEBUG: Upload file thành công:", response);
            return response;
          })
          .catch(error => {
            console.error("ERROR: Lỗi khi upload file:", error);
            throw error;
          });
      });

      // Thực hiện upload tất cả file
      Promise.all(uploadPromises)
        .then(results => {
          console.log("DEBUG: Kết quả upload file:", results);

          // Kiểm tra kết quả upload
          const uploadedFilePaths = results.map(result => {
            if (!result || !result.filepath) {
              console.error("ERROR: Upload file không trả về filepath hợp lệ", result);
              throw new Error("Upload file không trả về filepath hợp lệ");
            }
            return result.filepath;
          });
          console.log("DEBUG: Danh sách file path sau upload:", uploadedFilePaths);

          // Reset giao diện sau khi upload thành công
          examFiles_v2 = [];
          document.getElementById('fileNameExamImage_v2').innerHTML = "";
          document.getElementById('examUploadLoading_v2').style.display = 'none';
          document.getElementById('submitExamBtn_v2').disabled = false;

          // Gọi API cập nhật trạng thái tài khoản
          console.log("DEBUG: Gọi API cập nhật trạng thái tài khoản...");
          return fetch('/update_account_status_v2', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          });
        })
        .then(response => {
          console.log("DEBUG: Response status của update_account_status_v2:", response.status);
          if (!response.ok) {
            throw new Error(`Lỗi HTTP! status: ${response.status}`);
          }
          return response.json();
        })
        .then(statusData => {
          console.log("DEBUG: Response từ update_account_status_v2:", statusData);

          // Hiển thị thông báo thành công chung
          triggerNotification('warning', 'Thông báo', 'Tài khoản của bạn đang được xét duyệt, vui lòng đợi');

          // Đóng modal sau 2 giây
          setTimeout(() => {
            const modalElement = document.getElementById('verificationModal-v2');
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (!modalInstance) {
              modalInstance = new bootstrap.Modal(modalElement);
            }
            modalInstance.hide();
          }, 2000);
        })
        .catch(error => {
          console.error('ERROR: Lỗi trong quá trình upload hoặc cập nhật:', error);
          // Hiển thị thông báo lỗi chung
          triggerNotification('error', 'Lỗi', 'Đã xảy ra lỗi. Vui lòng thử lại.');
          document.getElementById('examUploadLoading_v2').style.display = 'none';
          document.getElementById('submitExamBtn_v2').disabled = false;
        });
    }

    function uploadFile_v2(file, type) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', type);

      return fetch('/upload_v2', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          console.log(`Response từ uploadFile_v2 (${type}):`, response);
          return response.json();
        })
        .then(data => {
          console.log('Upload thành công:', data);
          return data;
        })
        .catch(error => {
          console.error(`ERROR: Lỗi khi upload file (${type}):`, error);
          throw error;
        });
    }

    function copyText_v2() {
      const text = document.getElementById('copyContent_v2').innerText;
      navigator.clipboard.writeText(text);

      const successMsg = document.getElementById('copySuccess_v2');
      successMsg.style.display = 'block';
      setTimeout(() => successMsg.style.display = 'none', 2000);
    }

    // Hàm xác nhận đã chia sẻ: chỉ upload ảnh màn hình khi người dùng ấn nút xác nhận
    function confirmShare_v2() {
      // Hiển thị thông báo "Vui lòng chờ"
      document.getElementById('shareUploadLoading_v2').style.display = 'block';
      document.getElementById('confirmShareBtn_v2').disabled = true;

      // Kiểm tra xem người dùng đã chọn ảnh chưa
      if (!shareFile_v2) {
        alert("Vui lòng chọn ảnh màn hình trước khi xác nhận.");
        document.getElementById('shareUploadLoading_v2').style.display = 'none';
        document.getElementById('confirmShareBtn_v2').disabled = false;
        return;
      }

      // Upload ảnh chia sẻ
      uploadFile_v2(shareFile_v2, 'share')
        .then(data => {
          console.log("Upload ảnh chia sẻ thành công:", data);

          // Reset file và giao diện sau khi upload thành công
          shareFile_v2 = null;
          document.getElementById('fileNameShareScreenshot_v2').innerHTML = "";
          document.getElementById('shareUploadLoading_v2').style.display = 'none';
          document.getElementById('confirmShareBtn_v2').disabled = false;

          // Gọi API cập nhật trạng thái tài khoản
          console.log("Gọi API cập nhật trạng thái tài khoản...");
          return fetch('/update_account_status_v2', {
            method: 'POST',
            credentials: 'include', // Server sẽ lấy user_id từ session
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          });
        })
        .then(response => {
          console.log("Response status của update_account_status_v2:", response.status);
          if (!response.ok) {
            throw new Error(`Lỗi HTTP! status: ${response.status}`);
          }
          return response.json();
        })
        .then(statusData => {
          console.log("Response từ update_account_status_v2:", statusData);

          // Hiển thị thông báo thành công
          triggerNotification('success', 'Thành công', 'Ảnh chia sẻ đã được upload và trạng thái tài khoản đã được cập nhật.');

          // Đóng modal sau 2 giây
          setTimeout(() => {
            const modalElement = document.getElementById('verificationModal-v2');
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (!modalInstance) {
              modalInstance = new bootstrap.Modal(modalElement);
            }
            modalInstance.hide();
          }, 2000);
        })
        .catch(error => {
          console.error("Lỗi khi upload ảnh chia sẻ hoặc cập nhật trạng thái:", error);
          // Hiển thị thông báo lỗi
          triggerNotification('error', 'Lỗi', 'Đã xảy ra lỗi. Vui lòng thử lại.');
          document.getElementById('shareUploadLoading_v2').style.display = 'none';
          document.getElementById('confirmShareBtn_v2').disabled = false;
        });
    }
  </script>
  <style>
    .cursor-pointer {
      cursor: pointer;
    }

    .modal-content {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .card-method-v2 {
      transition: transform 0.2s;
    }

    .btn-success {
      background: #28a745;
      border-color: #28a745;
    }

    .btn-confirm-share-v2 {
      transition: background-color 0.2s, color 0.2s;
    }

    .btn-confirm-share-v2:hover {
      background-color: #28a745;
      color: white;
    }
  </style>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* CSS cho thiết bị di động */
    @media (max-width: 576px) {

      /* Điều chỉnh kích thước modal */
      .modal-dialog {
        max-width: 95%;
        margin: 1rem auto;
      }

      /* Điều chỉnh padding cho modal */
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      /* Điều chỉnh tiêu đề modal */
      .modal-title {
        font-size: 1.25rem;
      }

      /* Sắp xếp lại các cột hoạt động theo dạng dọc */
      .activity-container {
        display: flex;
        flex-direction: column;
      }

      /* Cho mỗi hộp hoạt động chiếm toàn bộ chiều rộng */
      .activity-box {
        width: 100%;
        margin-bottom: 1rem;
      }
    }
  </style>


  <style>
    /* Container chứa 2 cột */
    .activity-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Khung thông báo của mỗi cột */
    .activity-box {
      flex: 1;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
      animation: fadeIn 0.6s forwards;
    }

    /* Hiệu ứng fade-in */
    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    /* Tiêu đề mỗi cột */
    .activity-box h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      border-bottom: 2px solid;
      padding-bottom: 10px;
    }

    /* Phân biệt tiêu đề từng cột */
    .user-activity h3 {
      border-color: #007bff;
      color: #007bff;
    }

    .system-activity h3 {
      border-color: #28a745;
      color: #28a745;
    }

    /* Các mục trong danh sách */
    .list-group-item {
      border: none;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      background-color: transparent !important;
    }


    .list-group-item:last-child {
      border-bottom: none;
    }

    .list-group-item {
      background-color: transparent !important;
      backdrop-filter: none !important;
      box-shadow: none !important;
    }

    .list-group-item:hover,
    .list-group-item:focus,
    .list-group-item:active {
      background-color: transparent !important;
    }

    /* Nội dung hoạt động */
    .activity-text {
      display: block;
      font-size: 1rem;
      color: #555;
    }

    /* Thời gian hoạt động */
    .activity-time {
      font-size: 0.9rem;
      color: #888;
      font-style: italic;
      margin-top: 5px;
    }
  </style>
  </div>
  </div>
  </div>
  </div>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <style>
            /* Container chứa cả hai cột */
            .activity-container {
              display: flex;
              gap: 20px;
              padding: 20px;
              background-color: #f9f9f9;
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            /* Cột hoạt động của người dùng và hệ thống */
            .user-activity,
            .system-activity {
              flex: 1;
              background: #ffffff;
              border-radius: 12px;
              padding: 20px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            /* Tiêu đề mỗi cột */
            .user-activity h3,
            .system-activity h3 {
              font-size: 1.5rem;
              margin-bottom: 20px;
              color: #333;
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              border-bottom: 2px solid #007bff;
              padding-bottom: 10px;
            }

            /* Phân biệt tiêu đề cột người dùng và hệ thống */
            .user-activity h3 {
              color: #007bff;
              /* Màu xanh dương cho người dùng */
            }

            .system-activity h3 {
              color: #28a745;
              /* Màu xanh lá cho hệ thống */
            }

            /* Khung hoạt động */
            .activity-box {
              background: #f9f9f9;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .activity-box:hover {
              transform: translateY(-5px);
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            /* Nội dung trong khung hoạt động */
            .activity-box p {
              margin: 0;
              font-size: 1rem;
              color: #555;
            }

            .activity-box strong {
              color: #333;
            }

            /* Thời gian hoạt động */
            .activity-time {
              display: block;
              margin-top: 10px;
              font-size: 0.9rem;
              color: #888;
              font-style: italic;
            }
          </style>
          <p>Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?</p>
          <p id="resumePathDisplay"></p>

        </div>
        <div class="modal-footer">

          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu
            mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>

        </div>
      </div>
    </div>
  </div>

  <!-- CSS bổ sung -->
  <style>
    /* Tùy chỉnh giao diện Modal */
    .modal-content {
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      border: none;
    }

    .modal-header,
    .modal-footer {
      border: none;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.5rem;
    }

    .btn-close {
      font-size: 1.25rem;
    }

    .modal-body p {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #333;
    }

    #resumePathDisplay {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #565e64;
    }
  </style>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?
          </p>
          <p id="resumePathDisplay" class="text-muted"></p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu
            mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tìm kiếm Môn học -->
  <div class="modal fade" id="customSearchModal" tabindex="-1" aria-labelledby="customSearchModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
        <!-- Modal Header -->
        <div class="custom-modal-header"
          style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 16px;">
          <h5 class="custom-modal-title" id="customSearchModalLabel"
            style="font-size: 1.25rem; font-weight: 600; color: #0d6efd;">
            <i class="fas fa-book-open me-2"></i>Tìm kiếm Môn học
          </h5>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <!-- Search Input Group -->
          <div class="custom-search-input-group" style="position: relative; margin-bottom: 1rem;">
            <input type="text" id="subjectSearchInput" class="form-control form-control-lg"
              placeholder="Nhập tên môn học..." aria-label="Search input"
              style="border-radius: 8px; padding-right: 50px; border: 1px solid #ced4da;">
            <button type="button"
              style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 8px 8px 0; background-color: #0d6efd; border: none; color: #fff;"
              onmouseover="this.style.backgroundColor='#0b5ed7'" onmouseout="this.style.backgroundColor='#0d6efd'">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <!-- Tip Text (Thông báo chọn trường) -->
          <div id="schoolSelectionNotice" class="custom-tip-text d-none"
            style="display: flex; align-items: center; padding: 10px 15px; background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%); border-radius: 4px; font-size: 0.9em; color: #333; margin-top: 8px; margin-bottom: 16px;">
            <i class="fas fa-lightbulb icon-combined" style="font-size: 1em; margin-right: 10px;"></i>
            Thứ bạn cần là thứ người khác có, cho nên đừng ngần ngại đóng góp dữ liệu để xây dựng cộng đồng nhé!
          </div>

          <!-- Kết quả tìm kiếm -->
          <h6 id="searchResultCount" class="text-muted mb-3">Kết quả tìm kiếm (0)</h6>
          <div id="subjectSearchSuggestions" class="custom-scrollable-results"
            style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
            <!-- Các kết quả tìm kiếm sẽ được chèn vào đây qua JS -->
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="custom-modal-footer"
          style="background-color: #f8f9fa; border-top: 1px solid #e9ecef; padding: 16px; display: flex; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (bao gồm Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- HTML Imports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* Khi modal đang hoạt động, ẩn các phần tử khác ngoài #modalContainer */
    body.modal-active> :not(#modalContainer) {
      display: none !important;
    }
  </style>

  <!-- Bao bọc toàn bộ HTML của modal trong container có ID riêng -->
  <!-- Modal Container -->
  <div id="modalContainer">
    <div class="modal" id="welcomeModal">
      <div class="modal-content" id="welcomeCard">
        <i class="fas fa-star badge" id="badgeIcon"></i>
        <h1 class="title" id="titleText">Chào mừng thành viên!</h1>
        <p class="message" id="messageText">Cảm ơn bạn đã tham gia cộng đồng của chúng tôi!</p>
        <button class="continue-btn" id="continueBtn">Tiếp tục</button>
      </div>
    </div>
  </div>

  <script>
    // Tạo thẻ style và chèn CSS vào container #modalContainer
    const style = document.createElement('style');
    style.textContent = `
      /* Modal */
      #modalContainer .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          backdrop-filter: blur(5px);
          justify-content: center;
          align-items: center;
          opacity: 0;
          animation: fadeIn 1s ease-in forwards;
      }
      #modalContainer .modal-content {
          background: white;
          padding: 2.5rem;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          text-align: center;
          max-width: 500px;
          width: 90%;
          position: relative;
          overflow: hidden;
          transform: scale(0);
          animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      }
      @keyframes fadeIn {
          to { opacity: 1; }
      }
      @keyframes fadeOut {
          to { opacity: 0; }
      }
      #modalContainer .badge {
          font-size: 3rem;
          margin-bottom: 1.5rem;
          animation: float 3s ease-in-out infinite, twinkle 1.5s infinite;
          display: block !important;
      }
      #modalContainer .title {
          color: #333;
          font-size: 1.8rem;
          margin-bottom: 1rem;
          font-weight: 700;
          animation: slideIn 1s ease-in-out;
      }
      #modalContainer .message {
          color: #666;
          line-height: 1.6;
          margin-bottom: 1.5rem;
          animation: slideIn 1.5s ease-in-out;
      }
      #modalContainer .highlight {
          color: #e91e63;
          font-weight: 700;
      }
      #modalContainer .continue-btn {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          color: white;
          border: none;
          padding: 0.8rem 2rem;
          border-radius: 25px;
          font-size: 1rem;
          cursor: pointer;
          transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
          margin-top: 1rem;
          animation: slideIn 2s ease-in-out;
      }
      #modalContainer .continue-btn:hover {
          background: linear-gradient(135deg, #2575fc, #6a11cb);
          transform: translateY(-2px) scale(1.05);
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }
      #modalContainer .continue-btn:active {
          transform: translateY(0);
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      /* Các lớp tùy biến cho từng loại thành viên */
      #modalContainer .first-member {
          background: linear-gradient(135deg, #fff9c4, #ffecb3);
          border: 2px solid #ffd54f;
      }
      #modalContainer .first-member .badge {
          color: #ffd54f;
      }
      #modalContainer .milestone {
          background: linear-gradient(135deg, #b3e5fc, #81d4fa);
          border: 2px solid #29b6f6;
      }
      #modalContainer .milestone .badge {
          color: #29b6f6;
      }
      #modalContainer .regular-member {
          background: linear-gradient(135deg, #f3e5f5, #e1bee7);
          border: 2px solid #ba68c8;
      }
      #modalContainer .regular-member .badge {
          color: #9c27b0;
      }
      /* Confetti */
      #modalContainer .confetti {
          position: absolute;
          width: 10px;
          height: 10px;
          background: #ffeb3b;
          border-radius: 50%;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          animation: confetti 3s linear;
      }
      @keyframes popIn {
          to { transform: scale(1); }
      }
      @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-15px); }
      }
      @keyframes confetti {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(-500px) rotate(720deg); opacity: 0; }
      }
      @keyframes slideIn {
          0% { transform: translateY(-20px); opacity: 0; }
          100% { transform: translateY(0); opacity: 1; }
      }
      @keyframes twinkle {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
      }
      @media (max-width: 600px) {
          #modalContainer .modal-content {
              padding: 1.5rem;
          }
          #modalContainer .title {
              font-size: 1.5rem;
          }
          #modalContainer .message {
              font-size: 0.9rem;
          }
          #modalContainer .continue-btn {
              padding: 0.6rem 1.5rem;
              font-size: 0.9rem;
          }
      }
    `;
    document.getElementById('modalContainer').appendChild(style);

    // Hàm hiển thị modal và ẩn các giao diện khác bằng cách thêm class "modal-active" vào body
    function showWelcomeModal() {
      document.body.classList.add("modal-active");
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'flex';
    }

    // Hàm ẩn modal, xóa hiệu ứng và hiển thị lại các giao diện khác
    function hideWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.animation = 'fadeOut 0.6s ease-in forwards';
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.classList.remove("modal-active");
      }, 600);
    }

    // Hàm cập nhật thông điệp modal dựa trên dữ liệu thành viên từ backend
    function updateWelcomeMessage(memberNumber, universityName) {
      const container = document.getElementById('welcomeCard');
      const message = document.getElementById('messageText');
      const icon = document.getElementById('badgeIcon');
      const title = document.getElementById('titleText');

      // Reset các class cũ
      container.className = 'modal-content';
      icon.className = 'badge';
      // Thêm class mặc định cho icon
      icon.classList.add('fas', 'fa-star');

      if (memberNumber === 1) {
        container.classList.add('first-member');
        icon.classList.add('fas', 'fa-crown');
        title.textContent = 'Khởi đầu vĩ đại!';
        message.innerHTML = `👑 Chào mừng <span class="highlight">thành viên đầu tiên</span> của ${universityName}!<br>
          Bạn là người tiên phong, mở ra một chương mới đầy hứa hẹn cho cộng đồng của chúng tôi. Hãy cùng nhau tạo nên những điều kỳ diệu!`;
      } else if (memberNumber % 100 === 0) {
        container.classList.add('milestone');
        icon.classList.add('fas', 'fa-trophy');
        title.textContent = 'Cột mốc đáng nhớ!';
        message.innerHTML = `🎉 Chào mừng <span class="highlight">thành viên thứ ${memberNumber}</span> của ${universityName}!<br>
          Cột mốc này không chỉ là con số mà còn là minh chứng cho sự phát triển mạnh mẽ của cộng đồng chúng ta. Hãy tiếp tục lan tỏa năng lượng tích cực!`;
        createConfetti();
      } else {
        container.classList.add('regular-member');
        icon.classList.add('fas', 'fa-user-plus');
        title.textContent = 'Thành viên mới!';
        message.innerHTML = `🤝 Chào mừng <span class="highlight">thành viên thứ ${memberNumber}</span> của ${universityName}!<br>
          Sự hiện diện của bạn là một phần quan trọng giúp cộng đồng chúng ta ngày càng phát triển. Hãy cùng nhau xây dựng những giá trị tuyệt vời!`;
      }

      container.style.animation = 'none';
      void container.offsetWidth; // Reset animation
      container.style.animation = 'popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
      showWelcomeModal();
    }

    // Hàm tạo hiệu ứng confetti
    function createConfetti() {
      const colors = ['#ffeb3b', '#e91e63', '#4caf50', '#2196f3', '#ff9800'];
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.animationDelay = Math.random() * 1 + 's';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        document.getElementById('modalContainer').appendChild(confetti);

        setTimeout(() => {
          confetti.remove();
        }, 3000);
      }
    }

    // Hàm gọi API cập nhật trạng thái welcome_checked (chuyển từ 0 thành 1)
    function updateWelcomeStatus() {
      fetch('/api/update_welcome', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ welcome_checked: 1 })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error updating welcome status:', data.error);
          } else {
            console.log('Welcome status updated:', data);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Xử lý sự kiện nút "Tiếp tục"
    const continueBtn = document.getElementById('continueBtn');
    continueBtn.addEventListener('click', () => {
      // Gọi API cập nhật trạng thái thông báo (chuyển từ 0 thành 1)
      updateWelcomeStatus();
      // Ẩn modal và hiển thị lại các giao diện khác
      hideWelcomeModal();
    });

    // Hàm lấy dữ liệu từ backend và cập nhật modal chào mừng
    function fetchMembershipData() {
      fetch('/membership_number') // Đảm bảo endpoint này khớp với backend của bạn
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error(data.error);
          } else {
            updateWelcomeMessage(data.membership_number, data.university);
          }
        })
        .catch(error => console.error('Error fetching membership data:', error));
    }
  </script>
  <script>
    (function () {
      const css = `
      :root {
        --custom-primary-color: #4a90e2;
        --custom-accent-color: #6c5ce7;
        --custom-progress-color: #00cec9;
        --custom-glass-bg: rgba(255, 255, 255, 0.95);
      }

      @keyframes customFloatIn {
        0% {
            transform: translateY(100%) scale(0.9);
            opacity: 0;
        }
        80% {
            transform: translateY(-10px) scale(1.02);
        }
        100% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
      }

      .custom-notification-wrapper {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        animation: customFloatIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }

      /* Sử dụng flex cho container của notification để header và actions luôn hiển thị,
         phần nội dung (grid) sẽ cuộn khi vượt quá chiều cao tối đa */
      .custom-study-notification {
        width: 380px;
        background: var(--custom-glass-bg);
        border-radius: 16px;
        padding: 20px;
        backdrop-filter: blur(12px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        max-height: 80vh;
      }

      .custom-study-notification:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .custom-header-section {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-shrink: 0;
      }

      .custom-subject-badge {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--custom-primary-color), var(--custom-accent-color));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
      }

      .custom-subject-info {
        flex: 1;
      }

      .custom-subject-title {
        font: 600 18px/1.2 'Segoe UI', sans-serif;
        color: #2d3436;
        margin-bottom: 4px;
      }

      .custom-subject-progress {
        font: 500 12px/1.4 'Segoe UI', sans-serif;
        color: #636e72;
      }

      .custom-progress-bar {
        height: 4px;
        background: rgba(108, 92, 231, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 12px;
      }

      .custom-progress-fill {
        height: 100%;
        width: 65%;
        background: var(--custom-progress-color);
        border-radius: 2px;
        transition: width 0.5s ease;
      }

      /* Container grid được đặt làm flex-grow để chiếm phần không gian còn lại,
         nếu dữ liệu nhiều thì sẽ cuộn theo chiều dọc */
      .custom-doc-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
        flex: 1 1 auto;
        overflow-y: auto;
      }

      /* CSS cho thanh cuộn (scrollbar) trên trình duyệt Webkit */
      .custom-doc-grid::-webkit-scrollbar {
        width: 6px;
      }
      .custom-doc-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-doc-grid::-webkit-scrollbar-thumb {
        background: var(--custom-accent-color);
        border-radius: 3px;
      }
      
      /* Firefox scrollbar width */
      .custom-doc-grid {
        scrollbar-width: thin;
        scrollbar-color: var(--custom-accent-color) #f1f1f1;
      }

      .custom-doc-card {
        background: white;
        padding: 14px;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .custom-doc-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .custom-doc-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--custom-progress-color);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .custom-doc-card:hover::after {
        transform: scaleX(1);
      }

      .custom-doc-type {
        font: 600 10px/1 'Segoe UI', sans-serif;
        color: var(--custom-primary-color);
        text-transform: uppercase;
        margin-bottom: 6px;
      }

      .custom-doc-name {
        font: 500 14px/1.3 'Segoe UI', sans-serif;
        color: #2d3436;
      }

      .custom-actions-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .custom-view-all-btn {
        background: linear-gradient(to right, var(--custom-primary-color), var(--custom-accent-color));
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font: 500 12px/1 'Segoe UI', sans-serif;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s ease;
      }

      .custom-view-all-btn svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
        transition: transform 0.2s ease;
      }

      .custom-view-all-btn:hover {
        transform: translateY(-1px);
      }

      .custom-view-all-btn:hover svg {
        transform: translateX(3px);
      }

      .custom-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .custom-close-btn:hover {
        background: rgba(0, 0, 0, 0.08);
        transform: rotate(90deg);
      }

      /* Hiệu ứng notification indicator */
      @keyframes customPing {
        0% {
            transform: scale(0.9);
            opacity: 1;
        }
        100% {
            transform: scale(2);
            opacity: 0;
        }
      }

      .custom-notification-indicator {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 16px;
        height: 16px;
        background: #ff4757;
        border-radius: 50%;
        animation: customPing 1.5s infinite;
      }

      /* Mobile view: chỉnh sửa vị trí và kích thước */
      @media (max-width: 480px) {
        .custom-notification-wrapper {
          bottom: 20px;
          right: 10px;
        }
        .custom-study-notification {
          width: 90vw;
          max-width: 320px;
        }
        .custom-doc-grid {
          grid-template-columns: 1fr;
        }
      }
    `;
      const styleTag = document.createElement('style');
      styleTag.textContent = css;
      document.head.appendChild(styleTag);
    })();
  </script>
  <!-- Phần thông báo custom -->
  <div class="custom-notification-wrapper" style="display:block;">
    <div class="custom-study-notification">
      <div class="custom-notification-indicator"></div>
      <button class="custom-close-btn">×</button>

      <div class="custom-header-section">
        <div class="custom-subject-badge">📐</div>
        <div class="custom-subject-info">
          <div class="custom-subject-title">Toán nâng cao 10</div>
          <div class="custom-subject-progress">Đang xem: Đại số - Chương 2</div>
          <div class="custom-progress-bar">
            <div class="custom-progress-fill"></div>
          </div>
        </div>
      </div>

      <div class="custom-doc-grid">
        <div class="custom-doc-card">
          <div class="custom-doc-type">Bài giảng</div>
          <div class="custom-doc-name">Hàm số bậc nhất</div>
        </div>
        <div class="custom-doc-card">
          <div class="custom-doc-type">Bài tập</div>
          <div class="custom-doc-name">50 bài tập vận dụng</div>
        </div>
        <div class="custom-doc-card">
          <div class="custom-doc-type">Video</div>
          <div class="custom-doc-name">Giải đề giữa kỳ</div>
        </div>
        <div class="custom-doc-card">
          <div class="custom-doc-type">Tài liệu</div>
          <div class="custom-doc-name">Công thức cần nhớ</div>
        </div>
      </div>

      <div class="custom-actions-section">
        <a href="#" class="custom-view-all-btn">
          <span>Xem chi tiết</span>
          <svg viewBox="0 0 24 24">
            <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z" />
          </svg>
        </a>
      </div>
    </div>
  </div>

  <script>
    // Xử lý nút đóng thông báo (chỉ ẩn đi, không remove)
    document.querySelector('.custom-close-btn').addEventListener('click', () => {
      const notification = document.querySelector('.custom-notification-wrapper');
      notification.style.transform = 'translateY(100%)';
      notification.style.opacity = 0;
      setTimeout(() => {
        notification.style.display = 'none';
      }, 500);
    });

    // Logic thay đổi nội dung dựa theo môn học (màu sắc, biểu tượng,…)
    const docTypes = {
      math: { badge: '🧮', color: '#e55039' },
      physics: { badge: '⚛️', color: '#0984e3' },
      chemistry: { badge: '⚗️', color: '#6c5ce7' }
    };

    function updateNotification(subject) {
      const typeConfig = docTypes[subject];
      document.querySelector('.custom-subject-badge').textContent = typeConfig.badge;
      document.documentElement.style.setProperty('--custom-primary-color', typeConfig.color);
    }

    // Xử lý tương tác cho các thẻ tài liệu
    document.querySelectorAll('.custom-doc-card').forEach(card => {
      card.addEventListener('click', () => {
        card.style.transform = 'scale(0.98)';
        setTimeout(() => card.style.transform = '', 100);
      });
    });

    // Tự động ẩn sau một khoảng thời gian nhất định
    let timeout;
    function resetTimer() {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        const notif = document.querySelector('.custom-notification-wrapper');
        if (notif) {
          notif.style.transform = 'translateY(100%)';
          notif.style.opacity = 0;
        }
      }, 10000);
    }
    document.querySelector('.custom-study-notification').addEventListener('mouseenter', () => clearTimeout(timeout));
    document.querySelector('.custom-study-notification').addEventListener('mouseleave', resetTimer);
    resetTimer();
  </script>
  <!-- Chèn CSS bằng JS DOM -->
  <script>
    function loadCSS(url) {
      var link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = url;
      document.head.appendChild(link);
    }

  </script>


  <script>
    /* PDF.js Worker Configuration */
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';

    /* Global Variables */
    let examCurrentPath = [];
    let syllabusCurrentPath = [];
    let currentRotation = 0;
    let adTimer = null;
    let currentFile = null;
    function renderFolderItem(list, name, currentPath, callback, count, itemId) {
      const li = document.createElement('li');
      li.className = 'file-item';

      // Đã ẩn logic hiển thị count: thay vì hiển thị count, gán countHTML thành chuỗi rỗng
      // Để mở lại, bỏ comment đoạn dưới và comment dòng gán countHTML thành chuỗi rỗng.
      /*
      const countHTML = count > 0 ? `<span class="file-count">${count}</span>` : '';
      */
      const countHTML = '';

      li.innerHTML = `
    <i class="bi bi-folder-fill file-icon folder"></i>
    <span class="file-name">${name}</span>
    ${countHTML}
  `;

      li.addEventListener('click', () => {
        callback([...currentPath, { id: itemId, name }]);
      });

      list.appendChild(li);
    }



    // Hàm renderSchoolFolderItem: dùng cho folder trường (path.length === 0)
    // Phiên bản này ẩn luôn logic hiển thị icon cộng đồng và số count.
    // Nếu muốn mở lại, bỏ comment đoạn logic bên dưới.
    // Hàm renderSchoolFolderItem: dùng cho folder trường (path.length === 0)
    // === 1. Định nghĩa map logo và default logo ===
    const SCHOOL_LOGOS = {
      1: '/static/image/logo_uni/husc.ico',
      2: '/static/image/logo_uni/logo_dhsp2.gif',
      3: '/static/image/logo_uni/hus.ico',
      5: '/static/image/logo_uni/hcmu.png',
      8: '/static/image/logo_uni/sgu.jpg',
      11: '/static/image/logo_uni/HCMULAW.png',
      9: '/static/image/logo_uni/qnu.jpg'
    };

    const DEFAULT_SCHOOL_LOGO = '/static/logo.png';

    /**
     * renderSchoolFolderItem: render folder cấp trường với logo
     *
     * @param {HTMLElement} list         - phần tử <ul> chứa danh sách
     * @param {string}       name        - tên trường
     * @param {Array}        currentPath - đường dẫn hiện tại dưới dạng mảng
     * @param {Function}     callback    - hàm gọi khi click vào trường
     * @param {number}       count       - (nếu cần) số thành viên
     * @param {number|string} itemId     - id của trường
     * @param {string}       logoUrl     - đường dẫn đến logo của trường
     */
    function renderSchoolFolderItem(list, name, currentPath, callback, count, itemId) {
      const li = document.createElement('li');
      li.className = 'file-item';

      // ✅ Lấy logo theo itemId từ SCHOOL_LOGOS hoặc dùng mặc định
      const logoSrc = SCHOOL_LOGOS[itemId] || DEFAULT_SCHOOL_LOGO;

      // Ẩn phần count nếu không cần thiết
      const countHTML = '';

      li.innerHTML = `
    <div class="school-folder d-flex align-items-center">
      <img
        class="school-logo"
        src="${logoSrc}"
        alt="Logo ${name}"
        onerror="this.src='${DEFAULT_SCHOOL_LOGO}';"
      />
      <span class="file-name ms-2">${name}</span>
      ${countHTML}
    </div>
  `;

      li.addEventListener('click', () => {
        callback([...currentPath, { id: itemId, name }]);
      });

      list.appendChild(li);
    }

    /* Hàm renderFileItem: Tạo file item (giữ nguyên logic ban đầu) */
    function renderFileItem(list, file, documentType) {
      // Nếu CSS động cho phần tử file mới chưa được thêm vào, tạo và chèn thẻ <style>
      if (!document.getElementById('dynamic-new-file-item-css')) {
        const style = document.createElement('style');
        style.id = 'dynamic-new-file-item-css';
        style.textContent = `
      /* CSS cho phần tử file mới với lớp "new-file-item" */
      .new-file-item {
        padding: 12px 15px;
        border-radius: 8px;
        transition: background-color 0.2s;
        margin-bottom: 8px;
        background-color: #ffffff;
        position: relative;
      }
      .new-file-info-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        flex: 1;
      }
      .new-file-text-info {
        flex: 1;
      }
      .new-file-views {
        font-size: 0.75em;
        color: #666;
        margin-top: 2px;
      }
      .new-file-actions {
        display: flex;
        gap: 8px;
      }
      .new-btn-menu {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
        border: none;
        background-color: transparent;
        color: #555;
        transition: all 0.2s;
        cursor: pointer;
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
      }
      .new-btn-menu:hover {
        background-color: #f0f0f0;
      }
      .new-action-menu {
        position: absolute;
        right: 15px;
        top: 50px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
        min-width: 120px;
        overflow: hidden;
      }
      .new-action-menu.show {
        display: block;
      }
      .new-menu-item {
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #333;
        text-decoration: none;
        white-space: nowrap;
      }
      .new-menu-item:hover {
        background-color: #f5f5f5;
      }
      .new-menu-item i {
        font-size: 1rem;
      }
      .new-file-icon {
        font-size: 1.8rem;
        color: #5f6368;
      }
      .new-file-icon.pdf {
        color: #d93025;
      }
      .new-file-icon.word {
        color: #2a5699;
      }
      
    `;
        document.head.appendChild(style);
      }

      // Kiểm tra file có đường dẫn hợp lệ; nếu không có thì dừng hàm và in cảnh báo
      if (!file.file_path) {
        console.warn('File không có đường dẫn hợp lệ:', file);
        return;
      }

      // Kiểm tra quyền truy cập file theo trường (school_id)
      if (file.school_id && window.userSchoolId && file.school_id != window.userSchoolId) {
        console.warn("File không thuộc trường của user! File school_id:", file.school_id, "User's school id:", window.userSchoolId);
        triggerNotification('danger', 'Lỗi', "Bạn không được phép mở file của trường khác!");
        return;
      }

      // Đảm bảo đường dẫn file có dấu "/" đầu tiên
      const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
      // Lấy phần mở rộng của file và chọn icon tương ứng dựa trên một mapping
      const ext = filePath.split('.').pop().toLowerCase();
      const iconClass = {
        pdf: 'bi-file-pdf pdf',
        doc: 'bi-file-earmark-word word',
        docx: 'bi-file-earmark-word word',
        jpg: 'bi-file-image',
        jpeg: 'bi-file-image',
        png: 'bi-file-image',
        gif: 'bi-file-image'
      }[ext] || 'bi-file-earmark';

      // Tạo phần tử list item <li> cho file
      const li = document.createElement('li');
      li.className = 'file-item new-file-item';
      // Chọn nhãn cho file dựa trên documentType: 'exam' hoặc 'other'
      const typeLabel = documentType === 'exam' ? 'Đề Thi' : 'Đề Cương';

      console.log('File object:', file);
      console.log('View count:', file.view_count);

      // Xây dựng nội dung HTML cho file item
      li.innerHTML = `
    <div class="file-item-container new-file-item-container">
      <div class="file-info-section new-file-info-section">
        <i class="bi ${iconClass} file-icon new-file-icon"></i>
        <div class="file-text-info new-file-text-info">
          <div class="file-name new-file-name">${typeLabel} ${file.file_name}</div>
          <div class="file-info new-file-info">${file.file_info || ''}</div>
          <div class="file-views new-file-views">Lượt xem: ${file.view_count || 0}</div>
        </div>
      </div>
      <div class="file-actions new-file-actions">
        <button class="btn btn-menu new-btn-menu" title="Menu">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="action-menu new-action-menu">
          <a class="menu-item btn-download new-menu-item">
            <i class="bi bi-download"></i>
            <span>Tải xuống</span>
          </a>
          <a href="#" class="menu-item btn-share new-menu-item">
            <i class="bi bi-exclamation-triangle"></i>
            <span>Báo lỗi</span>
          </a>
          <a class="menu-item btn-discuss new-menu-item">
            <i class="bi bi-chat"></i>
            <span>Thảo luận</span>
          </a>
        </div>
      </div>
    </div>
  `;

      // Lấy các nút tương tác từ phần tử HTML vừa tạo
      const menuBtn = li.querySelector('.new-btn-menu');
      const actionMenu = li.querySelector('.new-action-menu');
      const downloadBtn = li.querySelector('.btn-download');
      const shareBtn = li.querySelector('.btn-share');
      const discussBtn = li.querySelector('.btn-discuss');

      // Sự kiện click nút menu: hiển thị/ẩn menu hành động
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        actionMenu.classList.toggle('show');
      });

      // Sự kiện click nút download
      downloadBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        actionMenu.classList.remove('show');
        // Kiểm tra đăng nhập trước khi cho phép tải file
        try {
          const res = await fetch('/api/check-login');
          const data = await res.json();
          if (!data.loggedIn) {
            triggerNotification('danger', 'Lỗi', 'Bạn cần đăng nhập để thực hiện thao tác này!');
            return;
          }
        } catch (error) {
          console.error('Lỗi khi kiểm tra đăng nhập:', error);
          triggerNotification('danger', 'Lỗi', 'Không thể kiểm tra đăng nhập lúc này!');
          return;
        }

        console.log('Download button clicked for file:', file.file_name);
        // Xử lý file khi nhấn download (ví dụ: tăng lượt xem,...)
        handleFileClick(file, documentType, filePath);
        // Tạo link tải và kích hoạt sự kiện click để tải file
        const downloadLink = document.createElement('a');
        downloadLink.href = filePath;
        downloadLink.download = file.file_name;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });

      // Sự kiện click nút báo lỗi (share)
      shareBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        actionMenu.classList.remove('show');
        // Kiểm tra đăng nhập trước khi báo lỗi
        try {
          const res = await fetch('/api/check-login');
          const data = await res.json();
          if (!data.loggedIn) {
            triggerNotification('danger', 'Lỗi', 'Bạn cần đăng nhập để thực hiện thao tác này!');
            return;
          }
        } catch (error) {
          console.error('Lỗi khi kiểm tra đăng nhập:', error);
          triggerNotification('danger', 'Lỗi', 'Không thể kiểm tra đăng nhập lúc này!');
          return;
        }
        // Gọi hàm mở modal báo lỗi cho file
        openReportModal(file);
      });

      // Sự kiện click nút thảo luận
      discussBtn.addEventListener('click', async function (e) {
        e.stopPropagation();
        // Kiểm tra đăng nhập trước khi chuyển sang trang thảo luận
        try {
          const res = await fetch('/api/check-login');
          const data = await res.json();
          if (!data.loggedIn) {
            triggerNotification('danger', 'Lỗi', 'Bạn cần đăng nhập để thực hiện thao tác này!');
            return;
          }
        } catch (error) {
          console.error('Lỗi khi kiểm tra đăng nhập:', error);
          triggerNotification('danger', 'Lỗi', 'Không thể kiểm tra đăng nhập lúc này!');
          return;
        }

        // Ẩn container compact-container trên trang hiện tại
        const compactContainer = document.querySelector('.compact-container.my-4');
        if (compactContainer) {
          compactContainer.style.display = 'none';
        } else {
          console.warn('Không tìm thấy phần tử compact-container.');
        }
        // Hiển thị container chứa thảo luận và tải trang thảo luận vào iframe
        const discussionContainer = document.getElementById('discussion-container');
        if (discussionContainer) {
          discussionContainer.style.display = 'block';
          const iframe = document.getElementById('discussion-iframe');
          if (iframe) {
            // Gán trang thảo luận vào iframe (có thể chuyển đổi URL nếu cần)
            iframe.src = '/html/thaoluan.html';
          }
        } else {
          console.warn('Không tìm thấy phần tử discussion-container.');
        }
      });

      // Khi click bên ngoài phần tử li, ẩn action menu
      document.addEventListener('click', (e) => {
        if (!li.contains(e.target)) {
          actionMenu.classList.remove('show');
        }
      });

      // Nếu nhấn vào li (ngoại trừ các nút menu) thì gọi hàm xử lý file
      li.addEventListener('click', (e) => {
        if (e.target.closest('.new-btn-menu') || e.target.closest('.new-action-menu')) {
          return;
        }
        handleFileClick(file, documentType, filePath);
      });

      // Thêm phần tử li vừa tạo vào danh sách
      list.appendChild(li);
    }
document.addEventListener('DOMContentLoaded', async () => {
  // Khôi phục đường dẫn từ localStorage
  const savedExamPath = localStorage.getItem('examCurrentPath');
  const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
  if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
  if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

  // Kiểm tra và reset lịch sử nếu trường không khớp
  await checkAndResetHistory();

  // Tiếp tục với logic render các tab
  const examTab = document.getElementById('de-thi-tab');
  const syllabusTab = document.getElementById('de-cuong-tab');
  const examContent = document.getElementById('de-thi');
  const syllabusContent = document.getElementById('de-cuong');
  let activeTab = localStorage.getItem('activeTab') || 'exam';

  function switchTab(tab) {
    if (tab === 'exam') {
      examTab.classList.add('active');
      syllabusTab.classList.remove('active');
      examContent.classList.add('show', 'active');
      syllabusContent.classList.remove('show', 'active');
      localStorage.setItem('activeTab', 'exam');
      renderExamDrive(examCurrentPath);
    } else {
      syllabusTab.classList.add('active');
      examTab.classList.remove('active');
      syllabusContent.classList.add('show', 'active');
      examContent.classList.remove('show', 'active');
      localStorage.setItem('activeTab', 'syllabus');
      renderSyllabusDrive(syllabusCurrentPath);
    }
  }

  examTab.addEventListener('click', () => switchTab('exam'));
  syllabusTab.addEventListener('click', () => switchTab('syllabus'));
  switchTab(activeTab);

  // Hiển thị modal resume nếu đường dẫn hợp lệ
  if (activeTab === 'exam' && examCurrentPath.length > 0) {
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
    document.getElementById('resumeTabName').textContent = 'Đề Thi';
    document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + examCurrentPath.map(item => item.name).join(' > ');
    resumeModal.show();

    document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
      resumeModal.hide();
    });
    document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
      examCurrentPath = [];
      localStorage.removeItem('examCurrentPath');
      renderExamDrive(examCurrentPath);
      resumeModal.hide();
    });
    document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
      resumeModal.hide();
      showHistoryModal();
    });
  } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
    const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
    document.getElementById('resumeTabName').textContent = 'Đề Cương';
    document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
    resumeModal.show();

    document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
      resumeModal.hide();
    });
    document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
      syllabusCurrentPath = [];
      localStorage.removeItem('syllabusCurrentPath');
      renderSyllabusDrive(syllabusCurrentPath);
      resumeModal.hide();
    });
    document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
      resumeModal.hide();
      showHistoryModal();
    });
  }
});
    /* Hàm renderDrive: Hiển thị danh sách file/folder theo đường dẫn */
    async function renderDrive(containerId, path, updatePathCallback) {
      const documentType = containerId.includes('exam') ? 'exam' : 'syllabus';
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`Không tìm thấy container với ID: ${containerId}`);
        return;
      }
      container.innerHTML = '';

      // Tạo hàm bọc để cập nhật đường dẫn và đồng thời gán tiêu đề là tên folder cuối
      const updatePath = (newPath) => {
        updatePathCallback(newPath);
        if (newPath.length > 0) {
          document.title = newPath[newPath.length - 1].name;
        }
      };

      // Ẩn thông báo gợi ý nếu không ở cấp môn
      if (path.length !== 3) {
        const notif = document.querySelector('.custom-notification-wrapper');
        if (notif) notif.style.display = 'none';
      }

      // Hiển thị spinner khi đang tải dữ liệu
      const spinner = document.createElement('div');
      spinner.className = 'spinner';
      spinner.textContent = 'Loading...';
      container.appendChild(spinner);

      let data = [];
      try {
        if (path.length === 0) {
          // Lấy thông tin trường của user nếu có đăng nhập
          let res = await fetch('/user/university', { credentials: 'include' });
          if (res.ok) {
            const userSchool = await res.json();
            window.userSchoolId = userSchool.university;
            data = [{
              id: userSchool.university,
              name: userSchool.school_name,
              // <-- thêm logo_url
              logo_url: SCHOOL_LOGOS[userSchool.university] || DEFAULT_SCHOOL_LOGO
            }];
          } else {
            const allSchoolsRes = await fetch('/api/schools');
            if (allSchoolsRes.ok) {
              data = await allSchoolsRes.json();
            } else {
              throw new Error("Không thể lấy danh sách trường");
            }
          }

          // Lấy số liệu thống kê số thành viên theo trường
          try {
            const statsRes = await fetch('/api/users/statistics');
            if (statsRes.ok) {
              const stats = await statsRes.json();
              const statsMap = {};
              stats.forEach(stat => {
                statsMap[stat.school] = stat.user_count;
              });
              // map lại data, thêm count và logo_url
              data = data.map(item => {
                const count = statsMap[item.name] || 0;
                return {
                  ...item,
                  count,
                  logo_url: SCHOOL_LOGOS[item.id] || DEFAULT_SCHOOL_LOGO
                };
              });
            }
          } catch (error) {
            console.error("Lỗi khi lấy thống kê người dùng:", error);
          }
        } else if (path.length === 1) {
          const schoolId = path[0].id;
          data = await (await fetch(`/api/schools/${schoolId}/faculties`)).json();
        } else if (path.length === 2) {
          const facultyId = path[1].id;
          data = await (await fetch(`/api/faculties/${facultyId}/subjects?type=${documentType}`)).json();
        } else if (path.length === 3) {
          const subjectId = path[2].id;
          const response = await fetch(`/api/subjects/${subjectId}/documents_by_year?type=${documentType}`);
          const groupedData = await response.json();
          data = Object.keys(groupedData)
            .map(year => ({
              id: parseInt(year),
              name: year,
              count: groupedData[year].length,
              documents: groupedData[year]
            }))
            .sort((a, b) => b.id - a.id);
        } else if (path.length === 4) {
          const subjectId = path[2].id;
          const year = path[3].id;
          data = await (await fetch(`/api/subjects/${subjectId}/documents/${year}?type=${documentType}`)).json();
        }
      } catch (error) {
        console.error('Lỗi khi lấy dữ liệu:', error);
        container.innerHTML = `<div class="alert alert-danger">
      Có lỗi khi tải dữ liệu: ${error.message || error}.<br>
      Vui lòng <a href="#" onclick="window.location.reload()">nhấn vào đây</a> để thử lại (F5).
    </div>`;
        return;
      }

      // Xóa spinner
      container.innerHTML = '';

      if (path.length > 0) {
        // Sử dụng hàm updatePath thay vì updatePathCallback để cập nhật tiêu đề
        renderBreadcrumb(container, path, updatePath);
      }
      // >>>>> CHỈNH SỬA: Gọi modal chào mừng khi ở trang chủ <<<<<
      if (path.length === 0) {
        // Nếu có user đã đăng nhập, kiểm tra trạng thái welcome_checked
        fetch('/api/welcome_checked')
          .then(response => response.json())
          .then(data => {
            // Nếu không có lỗi và welcome_checked bằng 0 (chưa xem thông báo)
            if (!data.error && data.welcome_checked === 0) {
              fetchMembershipData();
            }
          })
          .catch(error => console.error('Error checking welcome status:', error));
      }
      // <<< END CHỈNH SỬA

      // Phần gợi ý cho cấp môn (path.length === 3) giữ nguyên như cũ
      if (path.length === 3) {
        const subjectId = path[2].id;
        const alternateType = documentType === 'exam' ? 'syllabus' : 'exam';
        console.log(`Đang gọi API gợi ý cho subject_id: ${subjectId} với type: ${alternateType}`);
        fetch(`/api/subjects/${subjectId}/documents_by_year?type=${alternateType}`)
          .then(response => response.json())
          .then(alternateData => {
            console.log("Dữ liệu gợi ý trả về:", alternateData);
            const wrapper = document.querySelector('.custom-notification-wrapper');
            if (Object.keys(alternateData).length > 0) {
              wrapper.style.display = 'block';
              const years = Object.keys(alternateData).sort((a, b) => parseInt(b) - parseInt(a));
              const totalItems = years.length;
              const collapsedLimit = 4;
              let isCollapsed = totalItems > collapsedLimit;
              let displayedYears = isCollapsed ? years.slice(0, collapsedLimit) : years;
              function renderGrid(yearList) {
                let gridHtml = '';
                yearList.forEach(year => {
                  const group = alternateData[year];
                  gridHtml += `
                <div class="custom-doc-card alternate-suggestion-item" data-year="${year}" style="cursor:pointer;">
                  <div class="custom-doc-type">Năm ${year}</div>
                  <div class="custom-doc-name">(${group.length} tài liệu)</div>
                </div>
              `;
                });
                return gridHtml;
              }
              let newContent = `
            <div class="custom-study-notification">
              <div class="custom-notification-indicator"></div>
              <button class="custom-close-btn">×</button>
              <div class="custom-header-section">
                <div class="custom-subject-badge">${documentType === 'exam' ? '📐' : '📘'}</div>
                <div class="custom-subject-info">
                  <div class="custom-subject-title">Gợi ý ${alternateType === 'exam' ? 'Đề Thi' : 'Đề Cương'}</div>
                  <div class="custom-subject-progress">Cho môn ${path[2].name}</div>
                  <div class="custom-progress-bar">
                    <div class="custom-progress-fill"></div>
                  </div>
                </div>
              </div>
              <div class="custom-doc-grid" id="alternateGrid">
                ${renderGrid(displayedYears)}
              </div>
          `;
              if (isCollapsed) {
                newContent += `
              <div class="custom-actions-section">
                <a href="#" class="custom-view-all-btn">
                  <span>Xem thêm</span>
                  <svg viewBox="0 0 24 24">
                    <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                  </svg>
                </a>
              </div>
            `;
              }
              newContent += `</div>`;
              wrapper.innerHTML = newContent;
              wrapper.querySelector('.custom-close-btn').addEventListener('click', () => {
                wrapper.style.transform = 'translateY(100%)';
                wrapper.style.opacity = 0;
                setTimeout(() => {
                  wrapper.style.display = 'none';
                }, 500);
              });
              function addItemEvents() {
                wrapper.querySelectorAll('.alternate-suggestion-item').forEach(item => {
                  item.addEventListener('click', (e) => {
                    const selectedYear = e.currentTarget.getAttribute('data-year');
                    console.log(`Người dùng chọn năm ${selectedYear}`);
                    const newPath = [...path, { id: parseInt(selectedYear), name: selectedYear }];
                    if (documentType === 'exam') {
                      document.getElementById('de-thi-tab').classList.remove('active');
                      document.getElementById('de-cuong-tab').classList.add('active');
                      document.getElementById('de-thi').classList.remove('show', 'active');
                      document.getElementById('de-cuong').classList.add('show', 'active');
                      renderSyllabusDrive(newPath);
                    } else {
                      document.getElementById('de-cuong-tab').classList.remove('active');
                      document.getElementById('de-thi-tab').classList.add('active');
                      document.getElementById('de-cuong').classList.remove('show', 'active');
                      document.getElementById('de-thi').classList.add('show', 'active');
                      renderExamDrive(newPath);
                    }
                  });
                });
              }
              addItemEvents();
              const viewAllBtn = wrapper.querySelector('.custom-view-all-btn');
              if (viewAllBtn) {
                viewAllBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  const fullGridHtml = renderGrid(years);
                  const gridContainer = document.getElementById('alternateGrid');
                  if (gridContainer) {
                    gridContainer.innerHTML = fullGridHtml;
                    viewAllBtn.parentElement.remove();
                    addItemEvents();
                  }
                });
              }
            } else {
              console.log("Không có dữ liệu gợi ý; ẩn thông báo gợi ý.");
              const wrapper = document.querySelector('.custom-notification-wrapper');
              if (wrapper) wrapper.style.display = 'none';
            }
          })
          .catch(err => console.error("Error fetching alternate suggestions", err));
      }

      // Thanh tìm kiếm inline
      const inlineSearchContainer = document.createElement('div');
      inlineSearchContainer.className = 'input-group mb-3';
      inlineSearchContainer.style.position = 'relative';
      inlineSearchContainer.innerHTML = `
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="search" class="form-control" placeholder="Tìm kiếm trong thư mục...">
  `;
      container.appendChild(inlineSearchContainer);

      const inlineSuggestions = document.createElement('div');
      inlineSuggestions.className = 'suggestions';
      inlineSuggestions.style.display = 'none';
      inlineSearchContainer.appendChild(inlineSuggestions);

      const advancedSearchBtn = document.createElement('button');
      advancedSearchBtn.className = 'btn btn-outline-primary mb-3';
      advancedSearchBtn.textContent = 'Tìm kiếm theo tên môn học';
      advancedSearchBtn.addEventListener('click', () => {
        const subjectSearchModal = new bootstrap.Modal(document.getElementById('customSearchModal'));
        subjectSearchModal.show();
      });
      container.appendChild(advancedSearchBtn);

      // Tạo danh sách file/folder
      const list = document.createElement('ul');
      list.className = 'file-list';
      if (Array.isArray(data)) {
        data.forEach(item => {
          if (path.length === 0) {
            // Ở cấp trường: sử dụng hàm renderSchoolFolderItem để chèn icon cộng đồng
            renderSchoolFolderItem(list, item.name, path, updatePath, item.count || 0, item.id);
          } else if (path.length < 3) {
            if (typeof item.count !== 'undefined') {
              renderFolderItem(list, item.name, path, updatePath, item.count, item.id);
            } else {
              renderFolderItem(list, item.name, path, updatePath, 0, item.id);
            }
          } else if (path.length === 3) {
            renderFolderItem(list, item.name, path, updatePath, item.count || 0, item.id);
          } else if (path.length === 4) {
            renderFileItem(list, item, documentType);
          }
        });
      }
      container.appendChild(list);

      // Nếu danh sách folder trống thì hiển thị thông báo "Thư mục rỗng"
      if (!list.hasChildNodes()) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'empty-folder';
        emptyMsg.textContent = 'Thư mục rỗng';
        container.appendChild(emptyMsg);
      }

      // Xử lý tìm kiếm inline
      // Thêm CSS trực tiếp vào trang
      const style = document.createElement('style');
      style.textContent = `
  /* Container gợi ý tìm kiếm */
  .inline-suggestions {
    position: absolute;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    display: none;
  }

  /* Mỗi item gợi ý */
  .suggestion-item {
    padding: 10px 16px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .suggestion-item:hover {
    background-color: #f5f5f5;
  }

  /* Thông báo không có kết quả */
  .no-results-message {
    color: #dc3545;
    padding: 12px 16px;
    margin: 0;
    font-size: 0.9em;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .no-results-message::before {
    content: "⚠️";
    font-style: normal;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .inline-suggestions {
      max-height: 200px;
    }
    
    .suggestion-item, .no-results-message {
      padding: 8px 12px;
    }
  }
`;
      document.head.appendChild(style);

      // Xử lý tìm kiếm inline
      const inlineSearchInput = inlineSearchContainer.querySelector('input');
      inlineSearchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase().trim();
        const suggestions = [];

        // Lọc và hiển thị các item phù hợp
        Array.from(list.children).forEach(item => {
          const text = item.textContent.toLowerCase();
          const isVisible = text.includes(term);
          item.style.display = isVisible ? 'flex' : 'none';

          if (isVisible) {
            const name = item.querySelector('.file-name').textContent;
            if (!suggestions.includes(name)) suggestions.push(name);
          }
        });

        // Xóa gợi ý cũ
        inlineSuggestions.innerHTML = '';

        if (term) {
          if (suggestions.length > 0) {
            // Hiển thị gợi ý
            suggestions.forEach(suggestion => {
              const div = document.createElement('div');
              div.className = 'suggestion-item';
              div.textContent = suggestion;

              div.addEventListener('click', () => {
                inlineSearchInput.value = suggestion;
                inlineSearchInput.dispatchEvent(new Event('input'));
                inlineSuggestions.style.display = 'none';
              });

              inlineSuggestions.appendChild(div);
            });
          } else {
            // Hiển thị thông báo không có kết quả
            const p = document.createElement('p');
            p.className = 'no-results-message';
            p.textContent = 'Không tìm thấy kết quả phù hợp';
            inlineSuggestions.appendChild(p);
          }

          inlineSuggestions.style.display = 'block';
        } else {
          inlineSuggestions.style.display = 'none';
        }
      });

      // Ẩn gợi ý khi click ra ngoài
      document.addEventListener('click', (e) => {
        if (!inlineSearchContainer.contains(e.target)) {
          inlineSuggestions.style.display = 'none';
        }
      });
    }
    function renderBreadcrumb(container, path, callback) {
      if (path.length === 0) return;
      const breadcrumb = document.createElement('nav');
      let html = `
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#" id="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
        </li>
    `;
      path.forEach((segment, index) => {
        html += index === path.length - 1
          ? `<li class="breadcrumb-item active">${segment.name}</li>`
          : `<li class="breadcrumb-item"><a href="#" class="breadcrumb-link" data-index="${index}">${segment.name}</a></li>`;
      });
      breadcrumb.innerHTML = html + '</ol>';
      breadcrumb.querySelector('#back-button').addEventListener('click', (e) => {
        e.preventDefault();
        callback(path.slice(0, -1));
      });
      breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const index = parseInt(link.getAttribute('data-index'));
          callback(path.slice(0, index + 1));
        });
      });
      container.prepend(breadcrumb);
    }

    // Hàm tạo file item (renderFileItem)
    function renderFileItem(list, file, documentType) {
      // Thêm CSS động cho phần tử file mới (nếu chưa có)
      if (!document.getElementById('dynamic-new-file-item-css')) {
        const style = document.createElement('style');
        style.id = 'dynamic-new-file-item-css';
        style.textContent = `
      /* CSS cho phần tử file mới với lớp "new-file-item" */
      .new-file-item {
        padding: 12px 15px;
        border-radius: 8px;
        transition: background-color 0.2s;
        margin-bottom: 8px;
        background-color: #ffffff;
        position: relative;
          overflow: visible;  /* Nếu menu vượt ra ngoài phạm vi, tránh bị ẩn */

      }
      .new-file-info-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        flex: 1;
      }
      .new-file-text-info {
        flex: 1;
      }
      .new-file-views {
        font-size: 0.75em;
        color: #666;
        margin-top: 2px;
      }
      .new-file-actions {
        display: flex;
        gap: 8px;
      }
      .new-btn-menu {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
        border: none;
        background-color: transparent;
        color: #555;
        transition: all 0.2s;
        cursor: pointer;
        position: absolute;
        right: 0;
        top: 50%;
        z-index: 9999;
        transform: translateY(-50%);
      }
      .new-btn-menu:hover {
        background-color: #f0f0f0;
        z-index: 9999;
      }
      .new-action-menu {
        position: absolute;
        right: 15px;
        top: 50px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 10;
        display: none;
        min-width: 120px;
        z-index: 9999;

        overflow: hidden;
      }
      .new-action-menu.show {
      z-index: 9999;
        display: block;
      }
      .new-menu-item {
        padding: 8px 16px;
        display: flex;
        z-index: 9999;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #333;
        text-decoration: none;
        white-space: nowrap;
      }
      .new-menu-item:hover {
        background-color: #f5f5f5;
        z-index: 9999;
      }
      .new-menu-item i {
        font-size: 1rem;
      }
      .new-file-icon {
        font-size: 1.8rem;
        color: #5f6368;
      }
      .new-file-icon.pdf {
        color: #d93025;
      }
      .new-file-icon.word {
        color: #2a5699;
      }
    `;
        document.head.appendChild(style);
      }

      if (!file.file_path) {
        console.warn('File không có đường dẫn hợp lệ:', file);
        return;
      }

      if (file.school_id && window.userSchoolId && file.school_id != window.userSchoolId) {
        console.warn("File không thuộc trường của user! File school_id:", file.school_id, "User's school id:", window.userSchoolId);
        triggerNotification('danger', 'Lỗi', "Bạn không được phép mở file của trường khác!");
        return;
      }

      const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
      const ext = filePath.split('.').pop().toLowerCase();
      const iconClass = {
        pdf: 'bi-file-pdf pdf',
        doc: 'bi-file-earmark-word word',
        docx: 'bi-file-earmark-word word',
        jpg: 'bi-file-image',
        jpeg: 'bi-file-image',
        png: 'bi-file-image',
        gif: 'bi-file-image'
      }[ext] || 'bi-file-earmark';

      // Tạo phần tử li cho file item
      const li = document.createElement('li');
      li.className = 'file-item new-file-item';
      const typeLabel = documentType === 'exam' ? 'Đề Thi' : 'Đề Cương';

      li.innerHTML = `
    <div class="file-item-container new-file-item-container">
      <div class="file-info-section new-file-info-section">
        <i class="bi ${iconClass} file-icon new-file-icon"></i>
        <div class="file-text-info new-file-text-info">
          <div class="file-name new-file-name">${typeLabel} ${file.file_name}</div>
          <div class="file-info new-file-info">${file.file_info || ''}</div>
        <div class="file-views new-file-views">Lượt xem: ${file.view_count || 0}</div> 
        </div>
      </div>
      <div class="file-actions new-file-actions">
        <button class="btn btn-menu new-btn-menu" title="Menu">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="action-menu new-action-menu">
          <a class="menu-item btn-download new-menu-item">
            <i class="bi bi-download"></i>
            <span>Tải xuống</span>
          </a>
          <!-- Menu báo lỗi -->
          <a href="#" class="menu-item btn-share new-menu-item">
            <i class="bi bi-exclamation-triangle"></i>
            <span>Báo lỗi</span>
          </a>
          <a class="menu-item btn-discuss new-menu-item">
            <i class="bi bi-chat"></i>
            <span>Thảo luận</span>
          </a>
        </div>
      </div>
    </div>
  `;

      // Lấy các phần tử cần xử lý sự kiện
      const menuBtn = li.querySelector('.new-btn-menu');
      const actionMenu = li.querySelector('.new-action-menu');
      const downloadBtn = li.querySelector('.btn-download');
      const shareBtn = li.querySelector('.btn-share');
      const discussBtn = li.querySelector('.btn-discuss');

      // Xử lý click vào nút menu
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        actionMenu.classList.toggle('show');
      });

      // Xử lý click nút download
      // Xử lý click nút download
      downloadBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        actionMenu.classList.remove('show');

        // Kiểm tra đăng nhập qua API
        try {
          const res = await fetch('/api/check-login');
          const data = await res.json();
          if (!data.loggedIn) {
            triggerNotification('danger', 'Lỗi', 'Bạn cần đăng nhập để thực hiện thao tác này!');
            return;
          }
        } catch (error) {
          console.error('Lỗi khi kiểm tra đăng nhập:', error);
          triggerNotification('danger', 'Lỗi', 'Không thể kiểm tra đăng nhập lúc này!');
          return;
        }

        console.log('Download button clicked for file:', file.file_name);
        // Thực hiện logic mở file (ví dụ: cập nhật lượt xem, ghi log, v.v.)
        handleFileClick(file, documentType, filePath);

        // Tạo thẻ a ẩn và thiết lập thuộc tính download để tải file xuống tại tab hiện tại
        const downloadLink = document.createElement('a');
        downloadLink.href = filePath;
        downloadLink.download = file.file_name;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });

      // Xử lý click "Báo lỗi": mở modal và cập nhật tên đề thi theo file được click
      shareBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        actionMenu.classList.remove('show');

        // Kiểm tra đăng nhập qua API
        try {
          const res = await fetch('/api/check-login');
          const data = await res.json();
          if (!data.loggedIn) {
            triggerNotification('danger', 'Lỗi', 'Bạn cần đăng nhập để thực hiện thao tác này!');
            return;
          }
        } catch (error) {
          console.error('Lỗi khi kiểm tra đăng nhập:', error);
          triggerNotification('danger', 'Lỗi', 'Không thể kiểm tra đăng nhập lúc này!');
          return;
        }

        openReportModal(file);
      });

      // Xử lý sự kiện "Thảo luận": chuyển hướng sang trang thaoluan.html và truyền document_id
      // Xử lý khi nhấn nút thảo luận
      discussBtn.addEventListener('click', async function (e) {
        e.stopPropagation();
        try {
          const res = await fetch('/api/check-login');
          const data = await res.json();
          if (!data.loggedIn) {
            triggerNotification('danger', 'Lỗi', 'Bạn cần đăng nhập để thực hiện thao tác này!');
            return;
          }
        } catch (error) {
          console.error('Lỗi khi kiểm tra đăng nhập:', error);
          triggerNotification('danger', 'Lỗi', 'Không thể kiểm tra đăng nhập lúc này!');
          return;
        }

        // Ẩn container compact-container
        const compactContainer = document.querySelector('.compact-container.my-4');
        if (compactContainer) {
          compactContainer.style.display = 'none';
        } else {
          console.warn('Không tìm thấy phần tử compact-container.');
        }

        // Ẩn nút đóng góp đề thi
        const contributeButton = document.querySelector('.btn.btn-primary.contribute-btn');
        if (contributeButton) {
          contributeButton.style.display = 'none';
        } else {
          console.warn('Không tìm thấy nút đóng góp đề thi.');
        }

        // Ẩn thanh cuộn của trang gốc
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';

        // Đảm bảo iframe vẫn có thanh cuộn
        const iframe = document.getElementById('discussion-iframe');
        if (iframe) {
          iframe.style.overflow = 'auto';
          iframe.style.scrollbarWidth = 'auto'; // Firefox
          iframe.style.webkitScrollbar = 'auto'; // Chrome, Safari
        }

        // Hiển thị container chứa iframe thảo luận và chuyển document_id qua URL
        const discussionContainer = document.getElementById('discussion-container');
        if (discussionContainer) {
          discussionContainer.style.display = 'block';
          const iframe = document.getElementById('discussion-iframe');
          if (iframe) {
            // Sử dụng file.document_id nếu có, nếu không thì sử dụng file.id
            const docId = file.document_id || file.id;
            if (!docId) {
              console.error('Không tìm thấy document_id hợp lệ trong file:', file);
              triggerNotification('danger', 'Lỗi', 'File không có document_id hợp lệ!');
              return;
            }
            // Truyền document_id qua query string
            iframe.src = '/html/thaoluan.html?document_id=' + docId;
          }
        } else {
          console.warn('Không tìm thấy phần tử discussion-container.');
        }
      });

      // Hàm đóng container thảo luận và khôi phục lại các trạng thái của trang chính
      function closeDiscussion() {
        const discussionContainer = document.getElementById('discussion-container');
        if (discussionContainer) {
          discussionContainer.style.display = 'none';
        }
        // Khôi phục thanh cuộn của trang chính
        document.documentElement.style.overflow = 'auto';
        document.body.style.overflow = 'auto';

        // Khôi phục lại các phần tử đã ẩn (nếu cần)
        const compactContainer = document.querySelector('.compact-container.my-4');
        if (compactContainer) {
          compactContainer.style.display = '';
        }
        const contributeButton = document.querySelector('.btn.btn-primary.contribute-btn');
        if (contributeButton) {
          contributeButton.style.display = '';
        }
      }

      // Lắng nghe sự kiện từ iframe
      window.addEventListener('message', function (event) {
        // Có thể kiểm tra origin của event nếu cần bảo mật
        if (event.data === 'closeDiscussion') {
          closeDiscussion();
        }
      });

      // Các đoạn code khác (đóng menu, xử lý sự kiện click của li, ...)
      document.addEventListener('click', (e) => {
        if (!li.contains(e.target)) {
          actionMenu.classList.remove('show');
        }
      });

      li.addEventListener('click', (e) => {
        if (e.target.closest('.new-btn-menu') || e.target.closest('.new-action-menu')) {
          return;
        }
        handleFileClick(file, documentType, filePath);
      });

      list.appendChild(li);
    }
    // Hàm xử lý click file (giữ nguyên)
    function handleFileClick(file, documentType, filePath) {
      fetch('/api/check-login', { method: 'GET', credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          if (data.loggedIn) {
            fetch('/api/account_status', { method: 'GET', credentials: 'include' })
              .then(response => response.json())
              .then(statusData => {
                if (statusData.account_status === 'đã duyệt') {
                  fetch('/api/check-file-open-timer', { method: 'GET', credentials: 'include' })
                    .then(response => response.json())
                    .then(timerData => {
                      if (timerData.can_open) {
                        fetch('/api/log-file-open', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          credentials: 'include',
                          body: JSON.stringify({ documentId: file.id })
                        })
                          .then(() => {
                            if (documentType === 'exam') {
                              fetch('/api/log-view-exam-v2', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ documentId: file.id })
                              })
                                .then(response => {
                                  if (!response.ok) {
                                    return response.json().then(data => {
                                      triggerNotification('danger', 'Lỗi', data.error);
                                      throw new Error(data.error);
                                    });
                                  }
                                  return response.json();
                                })
                                .then(() => {
                                  window.open(filePath, '_blank');
                                })
                                .catch(error => {
                                  console.error('Lỗi khi log view exam:', error);
                                });
                            } else {
                              window.open(filePath, '_blank');
                            }
                          })
                          .catch(error => {
                            console.error('Lỗi khi log file:', error);
                            window.open(filePath, '_blank');
                          });
                      } else {
                        triggerNotification('warning', 'Thông báo', `Vui lòng chờ ${Math.ceil(timerData.seconds_left)} giây trước khi thực hiện thao tác tiếp theo`);
                      }
                    })
                    .catch(error => {
                      console.error('Lỗi khi kiểm tra thời gian mở file:', error);
                    });
                } else if (statusData.account_status === 'bình thường') {
                  const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                  modal.show();
                } else if (statusData.account_status === 'đang duyệt') {
                  triggerNotification('warning', 'Lỗi', 'Tài khoản của bạn đang được xét duyệt');
                }
              })
              .catch(error => {
                console.error('Lỗi khi kiểm tra trạng thái tài khoản:', error);
                const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                modal.show();
              });
          } else {
            // ❗ Chưa đăng nhập → chuyển về trang login
            window.location.href = '/login';
          }
        })
        .catch(error => {
          console.error('Lỗi kiểm tra đăng nhập:', error);
          // ❗ Nếu lỗi khi gọi /api/check-login → cũng chuyển về login
          window.location.href = '/login';
        });
    }

    function openFile(filePath) {
      if (isInAppBrowser()) {
        window.location.href = filePath;
      } else {
        window.open(filePath, '_blank');
      }
    }

    function isInAppBrowser() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      return ua.indexOf("FBAN") > -1 ||
        ua.indexOf("FBAV") > -1 ||
        ua.indexOf("Messenger") > -1 ||
        ua.indexOf("Zalo") > -1;
    }

    function renderExamDrive(newPath) {
      examCurrentPath = newPath;
      localStorage.setItem('examCurrentPath', JSON.stringify(examCurrentPath));
      renderDrive('exam-drive-container', examCurrentPath, renderExamDrive);
    }

    function renderSyllabusDrive(newPath) {
      syllabusCurrentPath = newPath;
      localStorage.setItem('syllabusCurrentPath', JSON.stringify(syllabusCurrentPath));
      renderDrive('syllabus-drive-container', syllabusCurrentPath, renderSyllabusDrive);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedExamPath = localStorage.getItem('examCurrentPath');
      const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
      if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
      if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

      const examTab = document.getElementById('de-thi-tab');
      const syllabusTab = document.getElementById('de-cuong-tab');
      const examContent = document.getElementById('de-thi');
      const syllabusContent = document.getElementById('de-cuong');
      let activeTab = localStorage.getItem('activeTab') || 'exam';

      function switchTab(tab) {
        if (tab === 'exam') {
          examTab.classList.add('active');
          syllabusTab.classList.remove('active');
          examContent.classList.add('show', 'active');
          syllabusContent.classList.remove('show', 'active');
          localStorage.setItem('activeTab', 'exam');
          renderExamDrive(examCurrentPath);
        } else {
          syllabusTab.classList.add('active');
          examTab.classList.remove('active');
          syllabusContent.classList.add('show', 'active');
          examContent.classList.remove('show', 'active');
          localStorage.setItem('activeTab', 'syllabus');
          renderSyllabusDrive(syllabusCurrentPath);
        }
      }

      examTab.addEventListener('click', () => switchTab('exam'));
      syllabusTab.addEventListener('click', () => switchTab('syllabus'));
      switchTab(activeTab);

      if (activeTab === 'exam' && examCurrentPath.length > 0) {
        const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
        document.getElementById('resumeTabName').textContent = 'Đề Thi';
        document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + examCurrentPath.map(item => item.name).join(' > ');
        resumeModal.show();

        document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
          resumeModal.hide();
        });
        document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
          examCurrentPath = [];
          localStorage.removeItem('examCurrentPath');
          renderExamDrive(examCurrentPath);
          resumeModal.hide();
        });
        document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
          resumeModal.hide();
          showHistoryModal();
        });
      } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
        const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
        document.getElementById('resumeTabName').textContent = 'Đề Cương';
        document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
        resumeModal.show();

        document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
          resumeModal.hide();
        });
        document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
          syllabusCurrentPath = [];
          localStorage.removeItem('syllabusCurrentPath');
          renderSyllabusDrive(syllabusCurrentPath);
          resumeModal.hide();
        });
        document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
          resumeModal.hide();
          showHistoryModal();
        });
      }
    });

    async function checkAndResetHistory() {
      try {
        const res = await fetch('/user/university', { credentials: 'include' });
        if (res.ok) {
          const userSchool = await res.json();
          window.userSchoolId = userSchool.university;
          if (examCurrentPath.length > 0 && String(examCurrentPath[0].id) !== String(window.userSchoolId)) {
            examCurrentPath = [];
            localStorage.removeItem('examCurrentPath');
            window.location.href = '/';
          }
          if (syllabusCurrentPath.length > 0 && String(syllabusCurrentPath[0].id) !== String(window.userSchoolId)) {
            syllabusCurrentPath = [];
            localStorage.removeItem('syllabusCurrentPath');
            window.location.href = '/';
          }
        }
      } catch (error) {
        console.error("Lỗi khi kiểm tra lịch sử trường:", error);
      }
    }

    /* ==================================================
       Initialization: Subject Search Modal
       Mô tả:
         - Thiết lập chức năng tìm kiếm môn học trong modal tìm kiếm
         - Xử lý hiển thị kết quả và gợi ý tìm kiếm theo từ khóa nhập vào
       ================================================== */
    document.addEventListener("DOMContentLoaded", function () {
      // Thêm CSS hiện đại trực tiếp vào trang
      const style = document.createElement('style');
      style.textContent = `
    /* Modern Empty State Styles */
    .empty-search-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin: 1rem 0;
      animation: fadeIn 0.3s ease-out;
    }

    .empty-search-icon {
      font-size: 3rem;
      color: #adb5bd;
      margin-bottom: 1rem;
    }

    .empty-search-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #212529;
      margin-bottom: 0.5rem;
    }

    .empty-search-description {
      color: #6c757d;
      margin-bottom: 1.5rem;
      max-width: 400px;
    }

    .empty-search-action {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0.5rem 1.25rem;
      color: #495057;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .empty-search-action:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .empty-search-action i {
      font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Error State Styles */
    .error-search-container {
      background: #fff3f3;
      border-left: 4px solid #ff6b6b;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .error-search-title {
      color: #dc3545;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .error-search-message {
      color: #6c757d;
      font-size: 0.9rem;
    }
  `;
      document.head.appendChild(style);

      const subjectSearchInput = document.getElementById("subjectSearchInput");
      const subjectSearchSuggestions = document.getElementById("subjectSearchSuggestions");
      const schoolSelectionNotice = document.getElementById("schoolSelectionNotice");
      const searchResultCount = document.getElementById("searchResultCount");
      const modalEl = document.getElementById("customSearchModal");

      if (!modalEl) {
        console.error('Không tìm thấy phần tử modal với id "customSearchModal"');
        return;
      }

      searchResultCount.style.display = "none";
      subjectSearchSuggestions.style.display = "none";

      let modalInstance = bootstrap.Modal.getInstance(modalEl);
      if (!modalInstance) {
        modalInstance = new bootstrap.Modal(modalEl);
      }

      subjectSearchInput?.addEventListener("input", async function () {
        const term = subjectSearchInput.value.trim().toLowerCase();

        if (term.length < 2) {
          subjectSearchSuggestions.style.display = "none";
          searchResultCount.style.display = "none";
          return;
        } else {
          searchResultCount.style.display = "block";
        }

        const activeTab = localStorage.getItem("activeTab") || "exam";
        const currentPath = activeTab === "exam" ? examCurrentPath : syllabusCurrentPath;

        if (!currentPath || currentPath.length === 0) {
          schoolSelectionNotice.classList.remove("d-none");
        } else {
          schoolSelectionNotice.classList.add("d-none");
        }

        // Lấy school_id từ user hoặc từ currentPath[0]
        const schoolId = window.userSchoolId || (currentPath[0]?.id);
        // Lưu ý: bỏ qua faculty_id để tìm kiếm toàn bộ khoa trong cùng trường
        // const facultyId = currentPath[1]?.id || 0;

        try {
          const url = new URL("/api/search/subjects", window.location.origin);
          url.searchParams.append("term", term);
          if (schoolId) url.searchParams.append("school_id", schoolId);
          // Bỏ dòng thêm faculty_id để cho phép tìm kiếm trong toàn bộ các khoa cùng trường
          // if (facultyId) url.searchParams.append("faculty_id", facultyId);

          const response = await fetch(url, { credentials: 'include' });
          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
          const results = await response.json();

          searchResultCount.textContent = "Kết quả tìm kiếm (" + results.length + ")";

          subjectSearchSuggestions.innerHTML = "";
          if (results.length > 0) {
            results.forEach(subject => {
              const card = document.createElement("div");
              card.className = "card mb-3";
              card.style.border = "none";
              card.style.borderRadius = "12px";
              card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
              card.style.transition = "all 0.3s ease";
              card.style.backgroundColor = "#ffffff";
              card.style.cursor = "pointer";
              card.onmouseover = function () {
                this.style.transform = "translateY(-3px)";
                this.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
                this.style.backgroundColor = "#f8f9fa";
              };
              card.onmouseout = function () {
                this.style.transform = "none";
                this.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
                this.style.backgroundColor = "#ffffff";
              };

              const cardBody = document.createElement("div");
              cardBody.className = "card-body";

              const contentDiv = document.createElement("div");
              contentDiv.className = "d-flex justify-content-between align-items-start";

              const infoDiv = document.createElement("div");

              const h5 = document.createElement("h5");
              h5.className = "custom-card-title";
              h5.style.color = "#0d6efd";
              h5.style.fontWeight = "600";
              h5.style.marginBottom = "8px";
              h5.textContent = subject.name;

              const schoolDiv = document.createElement("div");
              schoolDiv.style.color = "#6c757d";
              schoolDiv.style.marginBottom = "0.5rem";
              schoolDiv.innerHTML = `<i class="fas fa-university me-1"></i> ${subject.school_name}`;

              const facultySpan = document.createElement("span");
              facultySpan.className = "custom-university-label";
              facultySpan.style.fontSize = "0.9em";
              facultySpan.style.backgroundColor = "#e9ecef";
              facultySpan.style.borderRadius = "20px";
              facultySpan.style.padding = "5px 15px";
              facultySpan.style.display = "inline-block";
              facultySpan.style.color = "#495057";
              facultySpan.style.marginTop = "8px";
              facultySpan.innerHTML = `<i class="fas fa-graduation-cap me-1"></i> ${subject.faculty_name}`;

              infoDiv.appendChild(h5);
              infoDiv.appendChild(schoolDiv);
              infoDiv.appendChild(facultySpan);

              const viewButton = document.createElement("button");
              viewButton.type = "button";
              viewButton.style.fontSize = "0.875rem";
              viewButton.style.border = "1px solid #0d6efd";
              viewButton.style.color = "#0d6efd";
              viewButton.style.backgroundColor = "transparent";
              viewButton.style.padding = "0.375rem 0.75rem";
              viewButton.style.borderRadius = "0.25rem";
              viewButton.onmouseover = function () {
                this.style.backgroundColor = "#0d6efd";
                this.style.color = "#fff";
              };
              viewButton.onmouseout = function () {
                this.style.backgroundColor = "transparent";
                this.style.color = "#0d6efd";
              };
              viewButton.innerHTML = `<i class="fas fa-eye me-1"></i> Xem`;

              contentDiv.appendChild(infoDiv);
              contentDiv.appendChild(viewButton);

              cardBody.appendChild(contentDiv);
              card.appendChild(cardBody);

              card.addEventListener("click", () => {
                // Khi click vào kết quả tìm kiếm, thiết lập đường dẫn mới dựa trên thông tin của môn
                const newPath = [
                  { id: subject.school_id, name: subject.school_name },
                  { id: subject.faculty_id, name: subject.faculty_name },
                  { id: subject.id, name: subject.name }
                ];
                const activeTab = localStorage.getItem("activeTab") || "exam";
                if (activeTab === "exam") {
                  renderExamDrive(newPath);
                } else {
                  renderSyllabusDrive(newPath);
                }
                subjectSearchInput.value = "";
                subjectSearchSuggestions.innerHTML = "";
                subjectSearchSuggestions.style.display = "none";
                searchResultCount.textContent = "Kết quả tìm kiếm (0)";
                const modal = bootstrap.Modal.getInstance(document.getElementById("customSearchModal"));
                if (modal) {
                  modal.hide();
                } else {
                  new bootstrap.Modal(document.getElementById("customSearchModal")).hide();
                }
              });

              subjectSearchSuggestions.appendChild(card);
            });
            subjectSearchSuggestions.style.display = "block";
          } else {
            // Hiển thị empty state hiện đại khi không có kết quả
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-search-container';
            emptyState.innerHTML = `
          <div class="empty-search-icon">
            <i class="fas fa-search-minus"></i>
          </div>
          <h3 class="empty-search-title">Không tìm thấy kết quả</h3>
          <p class="empty-search-description">Không có môn học nào phù hợp với từ khóa "${term}". Vui lòng thử lại với từ khóa khác.</p>
<button class="empty-search-action" onclick="
  document.getElementById('subjectSearchInput').value = '';
  document.getElementById('subjectSearchInput').focus();
  document.getElementById('subjectSearchSuggestions').style.display = 'none';
">
  <i class="fas fa-redo"></i> Thử tìm kiếm khác
</button>
        `;
            subjectSearchSuggestions.appendChild(emptyState);
            subjectSearchSuggestions.style.display = "block";
          }
        } catch (error) {
          console.error("Lỗi tìm kiếm:", error);
          // Hiển thị error state hiện đại
          subjectSearchSuggestions.innerHTML = `
        <div class="error-search-container">
          <h4 class="error-search-title"><i class="fas fa-exclamation-triangle me-2"></i>Đã xảy ra lỗi</h4>
          <p class="error-search-message">Không thể tải kết quả tìm kiếm. Vui lòng thử lại sau hoặc kiểm tra kết nối mạng.</p>
        </div>
      `;
          subjectSearchSuggestions.style.display = "block";
        }
      });
    });  
  </script>
<script>
   document.addEventListener('DOMContentLoaded', () => {
     // Gọi API để kiểm tra IP
     fetch('/api/check-ip-blocked', {
       credentials: 'include'
     })
       .then(res => res.json())
       .then(data => {
         if (data.blocked) {
           // Nếu IP bị chặn, chuyển hướng đến trang block.html
           window.location.href = 'block.html';
         } else {
           // Nếu không bị chặn, không làm gì cả (hoặc thêm logic khác nếu cần)
           console.log('IP không bị chặn.');
         }
       })
       .catch(err => {
         // Xử lý lỗi nếu có khi gọi API
         console.error('Lỗi khi kiểm tra IP block:', err);
         // Có thể thêm logic xử lý lỗi tại đây, ví dụ hiển thị thông báo
       });
   });
 </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>