<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kho Học Liệu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Thêm CDN Bootstrap và icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="shortcut icon" href="../static/logo.png" type="image/x-icon">
  <link rel="stylesheet" href="../static/css/index.css">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f4f6f9;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }

    .list-group-item :hover {
      cursor: pointer;
      color: red;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      margin: 0;
      padding-top: 60px;
    }

    .compact-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card-custom {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .nav-tabs .nav-link {
      font-weight: 500;
      color: var(--secondary-color);
      border: none;
      padding: 0.75rem 1rem;
      transition: color 0.3s ease;
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 3px solid var(--primary-color);
    }

    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
    }

    .breadcrumb {
      background: transparent;
      padding: 0.75rem 1rem;
      margin-bottom: 0;
    }

    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: #0056b3;
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
      background: #fff;
    }

    .file-item:hover {
      background-color: #f8f9fa;
      transform: translateX(5px);
    }

    .file-icon {
      font-size: 24px;
      margin-right: 15px;
      width: 30px;
    }

    .file-icon.folder {
      color: #ffc107;
    }

    .file-icon.pdf {
      color: #dc3545;
    }

    .file-icon.word {
      color: #2b579a;
    }

    .file-name {
      flex-grow: 1;
      font-size: 1rem;
    }

    .file-info {
      font-size: 0.8rem;
      color: var(--secondary-color);
    }

    /* CSS cho gợi ý tìm kiếm (autocomplete) */
    .suggestions {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .suggestions .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions .suggestion-item:hover {
      background-color: #f8f9fa;
      opacity: 1;
    }

    /* Modern Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      background: #ffffff;
      animation: fadeInScale 0.4s ease;
    }

    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: #fff;
      border-bottom: none;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .modal-header .btn-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }

    .modal-header .btn-close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 1.5rem;
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
    }

    .modal-footer {
      background: #f5f5f5;
      border-top: none;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      min-width: 120px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .modal-footer .btn-primary {
      background: #2575fc;
      border: none;
    }

    .modal-footer .btn-primary:hover {
      background: #1a5bb8;
      transform: translateY(-2px);
    }

    .modal-footer .btn-secondary {
      background: #e0e0e0;
      border: none;
      color: #555;
    }

    .modal-footer .btn-secondary:hover {
      background: #cfcfcf;
      transform: translateY(-2px);
    }

    .modal-footer .btn-info {
      background: #17a2b8;
      border: none;
      color: #fff;
    }

    .modal-footer .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    @media (max-width: 576px) {

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      .modal-header .modal-title {
        font-size: 1.5rem;
      }
    }

    /* Modal Resume Header màu xanh lá */
    #resumeModal .modal-header {
      background: linear-gradient(135deg, #28a745, #70db70);
    }

    .about-links {
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }

    .about-links h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 15px;
    }

    .about-links ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }

    .about-links li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .about-links li:last-child {
      border-bottom: none;
    }

    .about-links .label {
      flex: 0 0 150px;
      font-weight: 600;
      color: #007bff;
    }

    .about-links .desc {
      flex: 1;
      font-size: 16px;
      color: #555;
    }

    /* Footer style */
    .custom-footer {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      text-align: center;
    }

    .custom-footer .footer-item {
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }

    .custom-footer .footer-item span {
      display: block;
      line-height: 1.5;
    }

    /* Social links style */
    .social-links {
      margin-top: 10px;
    }

    .social-links a {
      margin: 0 10px;
      font-size: 24px;
      color: #007bff;
      text-decoration: none;
      transition: color 0.3s;
    }

    .social-links a:hover {
      color: #0056b3;
    }

    /* Custom CSS for Modern and Elegant Modal */
    .modal-content {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      border-bottom: none;
      padding: 20px;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .modal-body {
      padding: 20px;
      background-color: #f9f9f9;
    }

    .modal-footer {
      border-top: none;
      padding: 15px 20px;
      background-color: #f9f9f9;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    .btn-close {
      filter: invert(1);
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .list-group-item {
      border: none;
      margin-bottom: 10px;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .list-group-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    /* Animation for modal */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal.fade .modal-dialog {
      animation: fadeIn 0.3s ease-out;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      /* canh giữa */
      text-indent: -9999px;
      /* ẩn text Loading... nếu không muốn hiển thị */
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #subjectSearchModal .modal-dialog {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #subjectSearchModal .modal-content {
      height: 70%;
    }

    .suggestions {
      position: absolute;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* Đảm bảo hiển thị trên modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }

    .suggestions {
      position: absolute;
      top: calc(100% + 2px);
      /* Nằm ngay dưới ô input, cách 2px để không dính liền */
      left: 0;
      width: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* Đảm bảo hiển thị trên modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }


    /* Trên mobile (chiều rộng nhỏ hơn 576px), tăng padding-top để bù navbar */
    @media (max-width: 576px) {
      body {
        padding-top: 100px;
        /* Tăng khoảng cách để tránh bị đè nội dung */
      }
    }

    /*hover content nav*/
    /* CSS cho tooltip: chỉ hiển thị khi di chuột vào nút */
    .btn-hover-tooltip {
      position: relative;
    }

    .btn-hover-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -30px;
      /* Điều chỉnh vị trí theo nhu cầu */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .btn-hover-tooltip:hover::after {
      opacity: 1;
    }
  </style>

</head>

<body>
  <!-- Thêm navbar vào trước phần content chính -->
  <nav id="navbar" class="navbar navbar-expand-lg navbar-light border-bottom py-3 fixed-top" style="display: none;">
    <div class="container-fluid">
      <!-- Tên trang web bên trái -->
      <a class="navbar-brand me-5" href="/">
        <span class="text-primary fw-bold fs-4">HueHub</span>
      </a>

      <!-- Các chức năng bên phải -->
      <div class="d-flex align-items-center gap-3">

        <!-- Nút "Nhật ký hoạt động hệ thống" -->
        <button id="activityBtn" class="btn btn-light rounded-pill px-3 btn-hover-tooltip"
          data-tooltip="Nhật ký hoạt động hệ thống">
          <i class="bi bi-clock-history me-2"></i>
        </button>
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            // Lấy nút theo ID
            var activityBtn = document.getElementById('activityBtn');
            if (activityBtn) {
              // Khi nút được click, hiển thị modal
              activityBtn.addEventListener('click', function () {
                var activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
                activityModal.show();
              });
            }
          });

        </script>

        <!-- Nút đăng xuất -->
        <button class="btn btn-outline-danger rounded-pill px-3 btn-hover-tooltip" id="logoutBtn"
          data-tooltip="Đăng xuất">
          <i class="bi bi-box-arrow-right me-2"></i>
          Đăng xuất
        </button>
      </div>
    </div>
  </nav>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch("/api/check-login")
        .then(response => response.json())
        .then(data => {
          if (data.loggedIn) {
            document.getElementById("navbar").style.display = "block"; // Hiển thị navbar nếu đã đăng nhập
          }
        })
        .catch(error => console.error("Lỗi kiểm tra đăng nhập:", error));
    });

  </script>

  <div class="compact-container my-4">
    <div class="card card-custom">
      <div class="card-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="de-thi-tab" data-bs-toggle="tab" data-bs-target="#de-thi" type="button"
              role="tab">Đề Thi</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="de-cuong-tab" data-bs-toggle="tab" data-bs-target="#de-cuong" type="button"
              role="tab">Đề Cương</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="ve-chung-toi-tab" data-bs-toggle="tab" data-bs-target="#ve-chung-toi"
              type="button" role="tab">Về Chúng Tôi</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <!-- Tab Đề Thi -->
          <div class="tab-pane fade show active" id="de-thi" role="tabpanel" aria-labelledby="de-thi-tab">
            <div id="exam-drive-container"></div>
          </div>
          <!-- Tab Đề Cương -->
          <div class="tab-pane fade" id="de-cuong" role="tabpanel" aria-labelledby="de-cuong-tab">
            <div id="syllabus-drive-container"></div>
          </div>
          <!-- Tab Về Chúng Tôi -->
          <div class="tab-pane fade" id="ve-chung-toi" role="tabpanel" aria-labelledby="ve-chung-toi-tab">
            <!-- Sử dụng position-relative để định vị phần "Phiên bản" -->
            <div class="p-3 position-relative">
              <p>
                Các đề thi và tài liệu trên website này đều được đóng góp bởi các cựu sinh viên, mang lại sự gần gũi và
                trải nghiệm thực tế trong học tập.
              </p>
              <div class="about-links mt-3">
                <footer class="custom-footer mt-4">
                  <div class="footer-item">
                    <span>Design by Nguyen Ngoc Truong</span>
                  </div>
                  <div class="social-links">
                    <a href="https://www.facebook.com/nntruong05" target="_blank" aria-label="Facebook">
                      <i class="bi bi-facebook"></i>
                    </a>
                    <a href="https://github.com/truongqb05x" target="_blank" aria-label="GitHub">
                      <i class="bi bi-github"></i>
                    </a>
                  </div>
                </footer>
              </div>

              <!-- Chữ "Phiên bản 0" được đặt ở góc dưới bên phải, có hiệu ứng nhấn để mở modal lịch sử cập nhật -->
              <div class="version-info"
                style="position: absolute; bottom: 0; right: 0; padding: 5px; font-size: 0.9rem; color: #666;"
                data-bs-toggle="modal" data-bs-target="#updateHistoryModal">
                Version 2.0.2
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Container chứa thông báo, sẽ được tạo tự động nếu chưa có -->
  <div class="my-notification-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * Hàm triggerNotification: Kích hoạt thông báo bằng cách tạo CSS, container và thông báo mới.
     * @param {string} type - Loại thông báo: 'success', 'warning', 'danger'
     * @param {string} title - Tiêu đề thông báo
     * @param {string} message - Nội dung thông báo
     */
    function triggerNotification(type, title, message) {
      // Chèn CSS động nếu chưa có
      if (!document.getElementById('my-notification-style')) {
        const css = `
          .my-notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 320px;
          }
          
          .my-notification {
            position: relative;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(120%);
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid;
          }
      
          .my-notification.hide {
            animation: slideOut 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
          }
      
          .my-notification:hover {
            transform: translateX(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
          }
      
          .my-notification-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            flex-shrink: 0;
          }
      
          .my-notification-content {
            flex-grow: 1;
          }
      
          .my-notification-close {
            opacity: 0.6;
            margin-left: 15px;
            transition: opacity 0.2s;
          }
      
          .my-notification-close:hover {
            opacity: 1;
          }
      
          .my-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
            width: 100%;
            overflow: hidden;
            border-radius: 0 0 8px 8px;
          }
      
          .my-progress-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background: currentColor;
            animation: progress 5s linear forwards;
          }
      
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateX(120%);
            }
            to {
              opacity: 1;
              transform: translateX(0);
            }
          }
      
          @keyframes slideOut {
            from {
              opacity: 1;
              transform: translateX(0);
            }
            to {
              opacity: 0;
              transform: translateX(120%);
            }
          }
      
          @keyframes progress {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
          }
        `;
        const styleEl = document.createElement('style');
        styleEl.type = 'text/css';
        styleEl.id = 'my-notification-style';
        styleEl.appendChild(document.createTextNode(css));
        document.head.appendChild(styleEl);
      }

      // Đảm bảo container thông báo tồn tại
      let container = document.querySelector('.my-notification-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'my-notification-container';
        document.body.appendChild(container);
      }

      // Tạo phần tử thông báo mới
      const notification = document.createElement('div');
      notification.classList.add('my-notification', `alert-${type}`);

      // Chọn icon tương ứng theo loại thông báo
      let iconClass = '';
      if (type === 'success') {
        iconClass = 'bi-check-circle-fill';
      } else if (type === 'warning') {
        iconClass = 'bi-hourglass-split';
      } else if (type === 'danger') {
        iconClass = 'bi-x-octagon-fill';
      }

      notification.innerHTML = `
        <i class="bi ${iconClass} my-notification-icon"></i>
        <div class="my-notification-content">
          <h6 class="mb-1 fw-semibold">${title}</h6>
          <p class="mb-0 small">${message}</p>
        </div>
        <div class="my-progress-bar"></div>
        <button class="my-notification-close btn btn-link p-0">
          <i class="bi bi-x"></i>
        </button>
      `;

      // Sự kiện đóng thông báo khi nhấn nút close
      notification.querySelector('.my-notification-close').addEventListener('click', () => {
        notification.classList.add('hide');
        notification.addEventListener('animationend', () => notification.remove());
      });

      container.appendChild(notification);

      // Tự động ẩn thông báo sau 5 giây
      setTimeout(() => {
        notification.classList.add('hide');
        notification.addEventListener('animationend', () => notification.remove());
      }, 3000);
    }

    // Bạn có thể gọi triggerNotification bất cứ lúc nào, ví dụ:
    // triggerNotification('warning', 'Cảnh báo!', 'Vui lòng kiểm tra lại dữ liệu.');
    // triggerNotification('danger', 'Lỗi!', 'Không thể kết nối đến máy chủ.');
  </script>

  <!-- Modal Structure -->
  <!-- Modal: Lịch sử hoạt động -->
  <div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-history me-2"></i>Lịch sử hoạt động
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <!-- Timeline: Hoạt động người dùng -->
          <div class="section-divider">
            <i class="fas fa-user"></i>
            <span>Hoạt động người dùng</span>
          </div>
          <!-- Nhóm "Mở đề thi" với nhiều môn khác nhau -->
          <div class="timeline-group user-group" id="openExamGroup">
            <div class="timeline-group-header">
              <div class="timeline-icon">
                <i class="fas fa-book-open"></i>
              </div>
              <div class="group-title">
                <h6>Mở đề thi</h6>
              </div>
            </div>
            <div class="timeline-group-items">
              <!-- Nội dung mẫu ban đầu (sẽ được thay thế bởi dữ liệu backend) -->
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>39 phút trước</small>
                  <strong>Mở đề thi Java Cơ Bản</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-user-circle text-purple"></i> Nguyễn Văn A
                    </span>
                    <span class="info-badge">
                      <img src="logo-hue.png" alt="ĐH Khoa học Huế" class="university-logo" /> ĐH Khoa học Huế
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Nhóm "Đăng nhập" -->
          <div class="timeline-group user-group" id="loginGroup">
            <div class="timeline-group-header">
              <div class="timeline-icon">
                <i class="fas fa-sign-in-alt"></i>
              </div>
              <div class="group-title">
                <h6>Đăng nhập vào hệ thống</h6>
              </div>
            </div>
            <div class="timeline-group-items">
              <!-- Nội dung mẫu ban đầu (sẽ được thay thế bởi dữ liệu backend) -->
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>2 giờ trước</small>
                  <strong>Đăng nhập thành công</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-user-circle text-purple"></i> Lê Văn C
                    </span>
                    <span class="info-badge">
                      <img src="logo-dhkt.png" alt="ĐH Kinh Tế" class="university-logo" /> ĐH Kinh Tế
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Nhóm "Đăng kí tài khoản" -->
          <div class="timeline-group user-group" id="registerGroup">
            <div class="timeline-group-header">
              <div class="timeline-icon">
                <i class="fas fa-user-plus"></i>
              </div>
              <div class="group-title">
                <h6>Đăng kí tài khoản</h6>
              </div>
            </div>
            <div class="timeline-group-items">
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>1 giờ trước</small>
                  <strong>Đăng kí thành công</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-user-circle text-purple"></i> Trần Thị D
                    </span>
                    <span class="info-badge">
                      <img src="logo-dhct.png" alt="ĐH Công nghệ" class="university-logo" /> ĐH Công nghệ
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline: Hoạt động hệ thống -->
          <div class="section-divider">
            <i class="fas fa-server"></i>
            <span>Hoạt động hệ thống</span>
          </div>
          <!-- Nhóm "Đã upload đề thi mới" -->
          <div class="timeline-group system-group" id="uploadGroup">
            <div class="timeline-group-header">
              <div class="timeline-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="group-title">
                <h6>Đã upload đề thi mới</h6>
              </div>
            </div>
            <div class="timeline-group-items">
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>24 phút trước</small>
                  <strong>Upload đề thi Đại Số Đồ Thị</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-tag text-success"></i> Đề thi
                    </span>
                    <span class="info-badge">
                      <i class="fas fa-database text-info"></i> 2.4 MB
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Nhóm "Bảo trì hệ thống" -->
          <div class="timeline-group system-group" id="maintenanceGroup">
            <div class="timeline-group-header">
              <div class="timeline-icon">
                <i class="fas fa-tools"></i>
              </div>
              <div class="group-title">
                <h6>Bảo trì hệ thống</h6>
              </div>
            </div>
            <div class="timeline-group-items">
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>3 giờ trước</small>
                  <strong>Bảo trì định kỳ</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-cog text-info"></i> Bảo trì
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Nhóm "Cập nhật hệ thống" -->
          <!-- Nhóm "Cập nhật hệ thống" -->
          <div class="timeline-group system-group" id="updateGroup">
            <div class="timeline-group-header">
              <div class="timeline-icon">
                <i class="fas fa-sync-alt"></i>
              </div>
              <div class="group-title">
                <h6>Cập nhật hệ thống</h6>
              </div>
            </div>
            <div class="timeline-group-items">
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>45 phút trước</small>
                  <strong>Cập nhật tự động</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-cogs text-info"></i> Tự động
                    </span>
                  </div>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>15 phút trước</small>
                  <strong>Sao lưu dữ liệu</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-cloud-download-alt text-info"></i> Sao lưu
                    </span>
                  </div>
                </div>
              </div>
              <!-- Tính năng con "Cập nhật phiên bản" với icon phù hợp -->
              <div class="timeline-item">
                <div class="timeline-content">
                  <small>5 phút trước</small>
                  <strong>Cập nhật phiên bản</strong>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="info-badge">
                      <i class="fas fa-code-branch text-info"></i> Phiên bản mới
                    </span>
                  </div>
                  <p>Các tính năng thêm:</p>
                  <ul>
                    <li>Tối ưu hóa hiệu suất hệ thống</li>
                    <li>Nâng cao bảo mật người dùng</li>
                    <li>Cải thiện giao diện người dùng</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>


          <!-- Thống kê thành viên -->
          <div class="section-divider">
            <i class="fas fa-chart-bar"></i>
            <span>Thống kê thành viên</span>
          </div>
          <div class="statistics-list">
            <div class="statistics-item d-flex justify-content-between">
              <div>
                <img src="logo-dhtn.png" alt="ĐH Khoa học Tự nhiên" class="university-logo me-2" />
                ĐH Khoa học Tự nhiên
              </div>
              <span class="badge bg-primary rounded-pill">150</span>
            </div>
            <div class="statistics-item d-flex justify-content-between">
              <div>
                <img src="logo-dhct.png" alt="ĐH Công nghệ" class="university-logo me-2" />
                ĐH Công nghệ
              </div>
              <span class="badge bg-primary rounded-pill">200</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Chèn CSS động: Giữ nguyên form CSS cũ -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Chèn CSS động để đảm bảo biến và keyframes được định nghĩa
      var style = document.createElement("style");
      style.innerHTML = `
      :root {
        --primary-color: #6366f1;
        --secondary-color: #3b82f6;
        --accent-color: #10b981;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e9ecef;
        --bg-light: #f8f9fa;
        --card-bg: #ffffff;
      }
      .modal-content {
        border-radius: 12px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
        border: none;
        overflow: hidden;
      }
      .modal-header {
        background: var(--primary-color);
        color: #fff;
        padding: 1rem 1.5rem;
      }
      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
      }
      .modal-title i { margin-right: 8px; }
      .section-divider {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 1.5rem 0 1rem;
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
      }
      .section-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border-color);
      }
      .timeline-group {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .timeline-group-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      .timeline-icon {
        flex: 0 0 40px;
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 20px;
        margin-right: 10px;
      }
      .system-group .timeline-icon {
        background: var(--secondary-color);
      }
      .group-title h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      .timeline-group-items {
        padding-left: 50px;
        border-left: 2px solid var(--border-color);
        position: relative;
        width: 100%;
        white-space: normal;
      }
      .timeline-item {
        margin-bottom: 1rem;
        opacity: 0;
        position: relative;
      }
      .timeline-item:last-child {
        margin-bottom: 0;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -11px;
        top: 4px;
        width: 12px;
        height: 12px;
        background: #fff;
        border: 2px solid var(--primary-color);
        border-radius: 50%;
      }
      .system-group .timeline-item::before {
        border-color: var(--secondary-color);
      }
      .timeline-content {
        margin-left: 10px;
        width: 100%;
        display: block;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .timeline-content small {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .timeline-content .info-badge {
        font-size: 0.85rem;
        padding: 0.35rem 0.7rem;
        border-radius: 6px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.25rem;
      }
      .university-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 50%;
        margin-right: 0.5rem;
        vertical-align: middle;
      }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .timeline-item.animate {
        animation: fadeInUp 0.5s ease-out forwards;
      }
      .subscription-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .subscribe-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
      }
      .subscribe-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .statistics-item {
        padding: 0.75rem;
        background: var(--card-bg);
        border-radius: 8px;
        margin: 0.5rem 0;
      }
      @media (max-width: 576px) {
        .timeline-icon {
          width: 36px;
          height: 36px;
          font-size: 18px;
        }
      }
      .modal-body .section-divider:first-of-type {
        margin-top: 0;
      }
    `;
      document.head.appendChild(style);
    });
  </script>

  <!-- Script xử lý sự kiện và chèn data backend vào nhóm "Mở đề thi" và "Đăng nhập" -->
  <!-- Script xử lý sự kiện và chèn data backend vào các nhóm -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Hàm chuyển đổi thời gian ISO sang dạng relative (vài giây, phút, giờ, ngày, tháng, năm trước)
      function timeAgo(timeStr) {
        const past = new Date(timeStr);
        if (isNaN(past.getTime())) return timeStr;
        const now = new Date();
        const diff = now - past;
        const diffSeconds = Math.floor(diff / 1000);
        const diffMinutes = Math.floor(diff / (1000 * 60));
        const diffHours = Math.floor(diff / (1000 * 60 * 60));
        const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
        const diffMonths = Math.floor(diffDays / 30);
        const diffYears = Math.floor(diffDays / 365);
        if (diffSeconds < 60) return 'vài giây trước';
        else if (diffMinutes < 60) return diffMinutes + ' phút trước';
        else if (diffHours < 24) return diffHours + ' giờ trước';
        else if (diffDays < 30) return diffDays + ' ngày trước';
        else if (diffMonths < 12) return diffMonths + ' tháng trước';
        else return diffYears + ' năm trước';
      }

      // Mapping giữa tên trường và logo
      const schoolLogos = {
        'Trường Đại học Khoa học - Đại Học Huế': 'static/logo_uni/favicon_husc.ico',
        'Trường Đại học Sư phạm - Đại Học Huế': 'static/logo_uni/logo_dhsp2.ico',
        'Trường Đại học Khoa học Tự nhiên - Đại học Quốc gia TP. HCM': 'static/logo_uni/iconhcm.ico',
        'ĐH Khoa học Tự nhiên': 'logo-dhtn.png',
        'ĐH Công nghệ': 'logo-dhct.png'
      };

      // Hàm dùng chung để chèn các timeline item
      function insertTimelineItems(selector, activities, isActivity = true) {
        const container = document.querySelector(selector);
        if (container) {
          container.innerHTML = '';
          activities.forEach(activity => {
            const logoURL = schoolLogos[activity.school] || 'logo-placeholder.png';
            const relativeTime = timeAgo(activity.activity_time || activity.created_at);
            let contentHTML = '';

            if (isActivity) {
              contentHTML = `
            <small>${relativeTime}</small>
            <strong>${activity.description}</strong>
            <div class="d-flex flex-wrap gap-2 mt-1">
              <span class="info-badge">
                <i class="fas fa-user-circle text-purple"></i> ${activity.fullname}
              </span>
              <span class="info-badge">
                <img src="${logoURL}" alt="${activity.school}" class="university-logo" />
                ${activity.school}
              </span>
            </div>
          `;
            } else {
              // Trường hợp upload tài liệu
              contentHTML = `
            <small>${relativeTime}</small>
            <strong>Upload đề thi ${activity.file_name}</strong>
            <div class="d-flex flex-wrap gap-2 mt-1">
              <span class="info-badge">
                <i class="fas fa-tag text-success"></i> ${activity.document_type === 'exam' ? 'Đề thi' : 'Đề cương'}
              </span>
              <span class="info-badge">
                <i class="fas fa-database text-info"></i> ${activity.file_size_mb} MB
              </span>
            </div>
          `;
            }

            const timelineHTML = `
          <div class="timeline-item">
            <div class="timeline-content">
              ${contentHTML}
            </div>
          </div>
        `;
            container.insertAdjacentHTML('beforeend', timelineHTML);
          });
          // Áp dụng hiệu ứng animation cho từng item
          container.querySelectorAll('.timeline-item').forEach(function (item, index) {
            item.style.animationDelay = (index * 0.2) + 's';
            item.classList.add('animate');
          });
        }
      }

      // Xử lý khi modal hoạt động được hiển thị
      var activityModal = document.getElementById('activityModal');
      activityModal.addEventListener('shown.bs.modal', function () {
        // Áp dụng animation cho các timeline-item đã có
        activityModal.querySelectorAll('.timeline-item').forEach(function (item, index) {
          item.style.animationDelay = (index * 0.2) + 's';
          item.classList.add('animate');
        });

        // Lấy log hoạt động hệ thống
        fetch('/api/system-activities', { method: 'GET' })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error("Lỗi khi tải log từ backend:", data.error);
              return;
            }
            const viewExamActivities = data.filter(activity => activity.activity_type === 'view_exam');
            const loginActivities = data.filter(activity => activity.activity_type === 'login');
            const registerActivities = data.filter(activity => activity.activity_type === 'register');

            insertTimelineItems('#openExamGroup .timeline-group-items', viewExamActivities);
            insertTimelineItems('#loginGroup .timeline-group-items', loginActivities);
            insertTimelineItems('#registerGroup .timeline-group-items', registerActivities);
          })
          .catch(error => {
            console.error("Lỗi khi tải log từ backend:", error);
          });

        // Lấy danh sách tài liệu mới nhất
        fetch('/api/documents/latest', { method: 'GET' })
          .then(response => response.json())
          .then(docs => {
            insertTimelineItems('#uploadGroup .timeline-group-items', docs, false);
          })
          .catch(error => {
            console.error("Lỗi khi tải tài liệu mới:", error);
          });

        // Lấy thống kê người dùng theo trường
        fetch('/api/users/statistics', { method: 'GET' })
          .then(response => response.json())
          .then(stats => {
            const statisticsList = document.querySelector('.statistics-list');
            if (statisticsList) {
              statisticsList.innerHTML = '';
              stats.forEach(stat => {
                const logoURL = schoolLogos[stat.school] || 'logo-placeholder.png';
                const statHTML = `
              <div class="statistics-item d-flex justify-content-between">
                <div>
                  <img src="${logoURL}" alt="${stat.school}" class="university-logo me-2" />
                  ${stat.school}
                </div>
                <span class="badge bg-primary rounded-pill">${stat.user_count}</span>
              </div>
            `;
                statisticsList.insertAdjacentHTML('beforeend', statHTML);
              });
            }
          })
          .catch(error => {
            console.error("Lỗi khi tải thống kê người dùng:", error);
          });
      });

      // Các xử lý sự kiện khác
      document.getElementById('subscribeBtn').addEventListener('click', function () {
        var form = document.getElementById('notificationForm');
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
      });

      document.getElementById('activateFormBtn').addEventListener('click', function () {
        document.getElementById('additionalForm').style.display = 'block';
      });
    });
  </script>
  <!-- Nút đóng góp đề thi -->
  <button type="button" class="btn btn-primary contribute-btn"
    style="position: fixed; bottom: 0; right: 0; margin: 10px; z-index: 1050;" data-bs-toggle="modal"
    data-bs-target="#contributeExamModal">
    <i class="bi bi-pencil-square"></i> Đóng góp đề thi
  </button>
  <!-- Modal Đóng góp Đề thi -->
  <div class="modal fade" id="contributeExamModal" data-bs-backdrop="false" tabindex="-1"
    aria-labelledby="contributeExamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contributeExamModalLabel">Đóng góp đề thi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <!-- Thông báo thành công, ẩn mặc định -->
          <div id="successAlert" class="alert alert-success" role="alert" style="display: none;">
            Upload thành công!
          </div>
          <!-- Form upload -->
          <form id="contributeExamForm" action="/api/upload_exam" method="POST" enctype="multipart/form-data">
            <!-- Chọn trường -->
            <div class="mb-3">
              <label for="fieldSelect" class="form-label">Chọn trường</label>
              <select class="form-select" id="fieldSelect" name="field">
                <option selected>Đang tải...</option>
              </select>
            </div>
            <!-- Tải file đề thi -->
            <div id="fileInputsContainer">
              <div class="file-input-group mb-3">
                <label class="form-label">Tải file</label>
                <input type="file" class="form-control" name="examFile[]" accept="*/*">
                <p class="form-text mt-2">
                  Bạn có thể chọn file đề thi hoặc đề cương!
                </p>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary" id="addFileInput">
              <i class="bi bi-plus-circle"></i> Thêm file
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <!-- Nút gửi và nút đóng được đặt trong modal footer như cũ -->
          <button type="submit" form="contributeExamForm" class="btn btn-primary">Gửi đóng góp</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load danh sách trường từ API /api/schools
    document.addEventListener('DOMContentLoaded', function () {
      var fieldSelect = document.getElementById('fieldSelect');
      fetch('/api/schools')
        .then(response => response.json())
        .then(data => {
          fieldSelect.innerHTML = '';
          if (data.error) {
            let errorOption = document.createElement('option');
            errorOption.text = 'Lỗi khi tải trường';
            fieldSelect.appendChild(errorOption);
          } else {
            let defaultOption = document.createElement('option');
            defaultOption.text = 'Chọn trường của bạn';
            defaultOption.selected = true;
            fieldSelect.appendChild(defaultOption);
            data.forEach(function (school) {
              let option = document.createElement('option');
              option.value = school.id;
              option.text = school.name + " (" + school.count + ")";
              fieldSelect.appendChild(option);
            });
          }
        })
        .catch(err => {
          console.error(err);
          fieldSelect.innerHTML = '<option>Lỗi khi tải trường</option>';
        });
    });

    // Script thêm file upload mới không kèm ghi chú
    document.getElementById('addFileInput').addEventListener('click', function () {
      var fileGroup = document.createElement('div');
      fileGroup.className = 'file-input-group mb-3';

      var fileLabel = document.createElement('label');
      fileLabel.className = 'form-label';
      fileLabel.innerText = 'Tải file đề thi';
      fileGroup.appendChild(fileLabel);

      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.className = 'form-control';
      fileInput.name = 'examFile[]';
      fileInput.accept = '*/*';
      fileGroup.appendChild(fileInput);

      document.getElementById('fileInputsContainer').appendChild(fileGroup);
    });

    // Xử lý submit form bằng AJAX để hiển thị thông báo thành công trong modal
    document.getElementById('contributeExamForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Ngăn form submit mặc định
      let form = this;
      let formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            // Hiển thị thông báo thành công
            document.getElementById('successAlert').style.display = 'block';
            // Reset form sau khi upload thành công
            form.reset();
            // Cập nhật lại container file với một input mặc định
            document.getElementById('fileInputsContainer').innerHTML = `
            <div class="file-input-group mb-3">
              <label class="form-label">Tải file</label>
              <input type="file" class="form-control" name="examFile[]" accept="*/*">
              <p class="form-text mt-2">
                Bạn có thể chọn file đề thi hoặc đề cương!
              </p>
            </div>
          `;
          } else if (data.error) {
            // Thông báo lỗi nếu có
            alert("Lỗi: " + data.error);
          }
        })
        .catch(error => {
          console.error(error);
          alert("Có lỗi xảy ra khi upload.");
        });
    });
  </script>

  <style>
    .modal-dialog-v3 {
      max-width: 420px;
    }

    .modal-content-v3 {
      background: #f8f9fa;
      /* Nền modal sáng nhẹ */
      border: 1px solid #e0e0e0;
      /* Viền sáng hơn */
      border-radius: 15px;
      transform: perspective(1000px) rotateX(5deg);
      transition: transform 0.3s;
      animation: popIn-v3 0.5s ease-out;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      /* Bóng nhẹ */
    }

    .modal-content-v3:hover {
      transform: perspective(1000px) rotateX(0deg);
    }

    .modal-header-v3 {
      border-bottom: none;
      padding: 2rem 2rem 0;
    }

    .modal-title-v3 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: #333;
      /* Màu chữ tối để nổi trên nền sáng */
    }

    .modal-body-v3 {
      padding: 1.5rem 2rem 2rem;
      text-align: center;
      color: #555;
      /* Màu chữ nhạt hơn cho nội dung */
      font-family: 'Montserrat', sans-serif;
    }

    .btn-custom-v3 {
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.3s;
    }

    .btn-login-v3 {
      background: #007bff;
      /* Màu xanh dương tươi sáng */
      color: #fff;
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-register-v3 {
      background: #ff4d4d;
      /* Màu đỏ nhẹ nhàng */
      color: #fff;
      box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
    }

    .btn-custom-v3:hover {
      transform: translateZ(10px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      /* Bóng đậm hơn khi hover */
    }

    @keyframes popIn-v3 {
      from {
        opacity: 0;
        transform: perspective(1000px) rotateX(20deg);
      }

      to {
        opacity: 1;
        transform: perspective(1000px) rotateX(5deg);
      }
    }
  </style>

  <div class="modal fade" id="loginModal-v3" tabindex="-1" aria-labelledby="loginModalLabel-v3" aria-hidden="true">
    <div class="modal-dialog modal-dialog-v3 modal-dialog-centered">
      <div class="modal-content modal-content-v3">
        <div class="modal-header modal-header-v3">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body modal-body-v3">
          <p class="fs-5 mb-3">Hình như bạn chưa đăng nhập!</p>
          <p class="fs-6 mb-4">Vui lòng đăng nhập hoặc đăng ký để tiếp tục.</p>
          <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-custom-v3 btn-login-v3" data-bs-dismiss="modal" data-bs-toggle="modal"
              data-bs-target="#authModal" onclick="toggleForm('loginForm')">Đăng nhập</button>
            <button type="button" class="btn btn-custom-v3 btn-register-v3" data-bs-dismiss="modal"
              data-bs-toggle="modal" data-bs-target="#authModal" onclick="toggleForm('registerForm')">Đăng ký</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"
        style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding-bottom: 1rem;">

        <!-- Đăng Nhập -->
        <div id="loginForm" style="display: block;">
          <div class="modal-header text-center"
            style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
            <h5 class="modal-title" id="authModalLabel"
              style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Đăng Nhập</h5>
          </div>
          <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
            <form id="formLogin">
              <div class="mb-3">
                <label for="loginUsername" class="form-label">Tên đăng nhập</label>
                <input type="text" class="form-control" id="loginUsername" placeholder="Nhập tên đăng nhập" required>
              </div>
              <div class="mb-4">
                <label for="loginPassword" class="form-label">Mật khẩu</label>
                <input type="password" class="form-control" id="loginPassword" placeholder="••••••••" required>
              </div>
              <button type="submit" class="btn"
                style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
                Đăng Nhập
              </button>
            </form>
            <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
              <span class="text-muted" style="margin-right: 5px;">Chưa có tài khoản?</span>
              <button onclick="toggleForm('registerForm')" class="btn btn-link p-0"
                style="text-decoration: none; color: #007bff; font-weight: 500;">
                Đăng ký ngay
              </button>
            </div>
          </div>
        </div>

        <!-- Đăng Ký -->
        <div id="registerForm" style="display: none;">
          <div class="modal-header text-center"
            style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
            <h5 class="modal-title" style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Đăng Ký</h5>
          </div>
          <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
            <form id="formRegister">
              <div class="mb-3">
                <label for="registerFullname" class="form-label">Họ và tên</label>
                <input type="text" class="form-control" id="registerFullname" placeholder="Nguyễn Văn A" required>
              </div>
              <small id="fullnameNote" class="form-note"
                style="display: none; color: #d9534f; font-size: 0.875rem; font-style: italic;">
                Vui lòng sử dụng tên thật, chúng tôi sẽ tự động xóa những tài khoản tên giả và chặn bạn vĩnh viễn khỏi
                hệ thống!
              </small>
              <script>
                document.addEventListener("DOMContentLoaded", function () {
                  const fullnameInput = document.getElementById("registerFullname");
                  const fullnameNote = document.getElementById("fullnameNote");

                  fullnameInput.addEventListener("input", function () {
                    fullnameNote.style.display = "block";
                  });
                });
              </script>

              <div class="mb-3">
                <label for="registerUsername" class="form-label">Tên đăng nhập</label>
                <input type="text" class="form-control" id="registerUsername" placeholder="Tên đăng nhập" required>
              </div>
              <div class="mb-4">
                <label for="registerPassword" class="form-label">Mật khẩu</label>
                <input type="password" class="form-control" id="registerPassword" placeholder="••••••••" required>
              </div>
              <div class="mb-3">
                <label for="registerUniversity" class="form-label">Trường Đại Học</label>
                <select class="form-control" id="registerUniversity" required>
                  <option value="" disabled selected>Chọn trường đại học</option>
                </select>
              </div>
              <script>
                document.addEventListener("DOMContentLoaded", function () {
                  fetch("/api/schools")
                    .then(response => response.json())
                    .then(data => {
                      const selectElement = document.getElementById("registerUniversity");
                      data.forEach(school => {
                        const option = document.createElement("option");
                        option.value = school.id;  // Giá trị là ID của trường
                        option.textContent = school.name;  // Hiển thị tên trường
                        selectElement.appendChild(option);
                      });
                    })
                    .catch(error => console.error("Lỗi khi tải danh sách trường:", error));
                });

              </script>
              <button type="submit" class="btn"
                style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
                Đăng Ký
              </button>
            </form>
            <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
              <span class="text-muted" style="margin-right: 5px;">Đã có tài khoản?</span>
              <button onclick="toggleForm('loginForm')" class="btn btn-link p-0"
                style="text-decoration: none; color: #007bff; font-weight: 500;">
                Đăng nhập ngay
              </button>
            </div>
          </div>
        </div>

        <!-- Footer chứa nút Đóng -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Hàm toggleForm để chuyển đổi giữa loginForm và registerForm
    function toggleForm(formId) {
      document.getElementById('loginForm').style.display = formId === 'loginForm' ? 'block' : 'none';
      document.getElementById('registerForm').style.display = formId === 'registerForm' ? 'block' : 'none';
    }

    // Reset form và hiển thị loginForm khi modal đóng
    document.getElementById('authModal').addEventListener('hidden.bs.modal', function () {
      toggleForm('loginForm');
      document.getElementById('formLogin').reset();
      document.getElementById('formRegister').reset();
    });

    // Xử lý form đăng nhập
    document.getElementById('formLogin').addEventListener('submit', function (e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      // Kiểm tra username: chỉ cho phép chữ (không dấu) và số, không khoảng trắng
      const usernameRegex = /^[a-zA-Z0-9]+$/;
      if (!usernameRegex.test(username)) {
        triggerNotification('warning', 'Cảnh báo', 'Vui lòng tuân thủ quy tắc đặt user name: không dấu, không cách.');
        return;
      }

      fetch('/api/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, password })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            triggerNotification('danger', 'Lỗi', data.error);
          } else {
            triggerNotification('success', 'Thành công', data.message);
            // Đóng modal sau khi đăng nhập thành công
            const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
            authModal.hide();
            // Chờ 5 giây (thời gian đếm ngược của thông báo) rồi mới load lại trang
            setTimeout(() => {
              window.parent.location.href = window.parent.location.href;
            }, 3000);
          }
        })
        .catch(error => {
          console.error('Lỗi:', error);
          triggerNotification('danger', 'Lỗi', 'Đã xảy ra lỗi khi đăng nhập');
        });
    });

    // Xử lý form đăng ký
    document.getElementById('formRegister').addEventListener('submit', function (e) {
      e.preventDefault();

      const fullname = document.getElementById('registerFullname').value;
      const username = document.getElementById('registerUsername').value;
      const password = document.getElementById('registerPassword').value;
      const university = document.getElementById('registerUniversity').value;

      // Kiểm tra username: chỉ cho phép chữ (không dấu) và số, không khoảng trắng
      const usernameRegex = /^[a-zA-Z0-9]+$/;
      if (!usernameRegex.test(username)) {
        triggerNotification('warning', 'Cảnh báo', 'Vui lòng tuân thủ quy tắc đặt user name: không dấu, không cách.');
        return;
      }

      fetch('/api/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ fullname, username, password, university })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            triggerNotification('danger', 'Lỗi', data.error);
          } else {
            triggerNotification('success', 'Thành công', data.message);
            // Chuyển sang tab đăng nhập sau khi đăng ký thành công
            toggleForm('loginForm');
            // Reset form đăng ký
            document.getElementById('formRegister').reset();
          }
        })
        .catch(error => {
          console.error('Lỗi:', error);
          triggerNotification('danger', 'Lỗi', 'Đã xảy ra lỗi khi đăng ký');
        });
    });

    document.getElementById('logoutBtn').addEventListener('click', function () {
      fetch("/api/logout", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(response => response.json())
        .then(data => {
          // Hiển thị thông báo đăng xuất thành công
          triggerNotification('success', 'Thành công', data.message);
          // Chuyển hướng về trang chủ sau 2 giây để người dùng có thời gian xem thông báo
          setTimeout(() => {
            window.location.href = "/";
          }, 2000);
        })
        .catch(error => {
          // Hiển thị thông báo lỗi nếu đăng xuất không thành công
          triggerNotification('error', 'Lỗi', 'Có lỗi khi đăng xuất.');
          console.error("Lỗi:", error);
        });
    });

  </script>

  <!-- Modal Xác thực -->
  <div class="modal fade" id="verificationModal-v2" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-3">
        <!-- Header sử dụng Shadow DOM với hậu tố _v2 -->
        <modal-header-v2></modal-header-v2>

        <!-- Body -->
        <div class="modal-body pt-0">
          <p class="text-muted mb-4">
            Tài khoản của bạn chưa được xác thực. Bạn cần chọn 1 trong 2 cách sau nhé! 😊
          </p>

          <!-- Phương thức 1: Đóng góp ảnh đề thi -->
          <div class="card mb-3 border-primary card-method-v2">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <i class="bi bi-cloud-upload fs-3 text-primary me-2"></i>
                <div>
                  <h6 class="mb-1">Đóng góp ảnh đề thi</h6>
                  <p class="text-muted small mb-0">
                    Chia sẻ ảnh đề thi bất kỳ để cộng đồng cùng học tập
                  </p>
                </div>
              </div>
              <div class="position-relative">
                <!-- File input cho ảnh đề thi -->
                <input type="file" id="examImageUpload_v2" accept="image/*" class="d-none"
                  data-container="fileNameExamImage_v2" onchange="handleFileUpload_v2(event, 'exam')">
                <label for="examImageUpload_v2" class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                  <i class="bi bi-upload me-2"></i>Chọn ảnh đề thi
                </label>
                <div id="fileNameExamImage_v2" class="text-muted small mt-2"></div>
              </div>
              <!-- Nút gửi file -->
              <button class="btn btn-success btn-sm mt-2" onclick="submitExamImage_v2()">
                <i class="bi bi-send me-2"></i>Gửi ảnh đề thi
              </button>
            </div>
          </div>

          <!-- Phương thức 2: Chia sẻ với bạn bè -->
          <div class="card border-success card-method-v2">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-share fs-3 text-success me-2"></i>
                <div>
                  <h6 class="mb-1">Chia sẻ với bạn bè</h6>
                  <p class="text-muted small mb-0">
                    Share trang web cho 2 người bạn để xác thực
                  </p>
                </div>
              </div>

              <div class="input-group mb-3">
                <div id="copyContent_v2" class="form-control bg-light">
                  Kho lưu trữ đề thi và đề cương qua các năm, tại: huehub.fun
                </div>
                <button class="btn btn-success btn-copy-v2" onclick="copyText_v2()">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              <div id="copySuccess_v2" class="text-success small mt-2" style="display:none;">
                <i class="bi bi-check2"></i> Đã sao chép!
              </div>

              <!-- Ghi chú hướng dẫn chụp màn hình -->
              <div class="mt-2">
                <small class="text-muted">
                  Ghi chú: Vui lòng coppy rồi gửi cho bạn bè rồi chụp lại màn hình sau khi chia sẻ, sau đó ấn "Xác nhận
                  đã chia sẻ".
                </small>
              </div>
              <div class="position-relative">
                <!-- File input cho ảnh chụp màn hình -->
                <input type="file" id="shareScreenshotUpload_v2" accept="image/*" class="d-none"
                  data-container="fileNameShareScreenshot_v2" onchange="handleFileUpload_v2(event, 'share')">
                <label for="shareScreenshotUpload_v2"
                  class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                  <i class="bi bi-upload me-2"></i>Chọn ảnh màn hình
                </label>
                <div id="fileNameShareScreenshot_v2" class="text-muted small mt-2"></div>
              </div>

              <!-- Nút xác nhận đã chia sẻ -->
              <button class="btn btn-outline-success w-100 btn-confirm-share-v2 mt-2" onclick="confirmShare_v2()">
                <i class="bi bi-check-circle me-2"></i>Xác nhận đã chia sẻ
              </button>
              <div id="confirmSuccess_v2" class="text-success small mt-2 text-center" style="display:none;">
                <i class="bi bi-check2-circle"></i> Đã xác nhận chia sẻ!
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary btn-close-v2" data-bs-dismiss="modal">
            Để sau đi
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Định nghĩa custom element sử dụng Shadow DOM cho header, với tên có hậu tố _v2 -->
  <script>
    class ModalHeaderV2 extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
        shadow.innerHTML = `
        <style>
          .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 0;
            padding: 1rem;
            padding-bottom: 0;
            background-color: transparent;
          }
          .header h5 {
            color: #0d6efd;
            margin: 0;
            font-size: 1.25rem;
          }
          .header button {
            background: transparent;
            border: none;
            cursor: pointer;
          }
        </style>
        <div class="header">
          <h5 class="modal-title">
            <i class="bi bi-patch-exclamation me-2"></i> Xác thực tài khoản
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      `;
      }
    }
    customElements.define('modal-header-v2', ModalHeaderV2);
  </script>

  <script>
    // Biến toàn cục lưu file ảnh đề thi (hậu tố _v2)
    let examFile_v2 = null;

    // Hàm xử lý khi chọn file (hậu tố _v2)
    function handleFileUpload_v2(event, type) {
      const file = event.target.files[0];
      if (file) {
        const containerId = event.target.getAttribute('data-container');
        document.getElementById(containerId).innerHTML =
          `<i class="bi bi-file-image"></i> Đã chọn: ${file.name}`;

        if (type === 'exam') {
          examFile_v2 = file;
        } else if (type === 'share') {
          // Gọi hàm uploadFile_v2 trực tiếp đối với file share
          uploadFile_v2(file, type);
        }
      }
    }

    // Hàm gửi ảnh đề thi khi người dùng nhấn nút "Gửi ảnh đề thi" (hậu tố _v2)
    function submitExamImage_v2() {
      if (!examFile_v2) {
        alert("Vui lòng chọn ảnh đề thi trước khi gửi.");
        return;
      }
      uploadFile_v2(examFile_v2, 'exam');
      examFile_v2 = null;
      document.getElementById('fileNameExamImage_v2').innerHTML = "";
    }

    // Hàm upload file lên server với route /upload_v2 (hậu tố _v2)
    function uploadFile_v2(file, type) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('type', type);

      fetch('/upload_v2', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          console.log('Upload thành công:', data);
          // Sau khi upload file thành công, gọi route cập nhật trạng thái tài khoản
          fetch('/update_account_status_v2', {
            method: 'POST',
            credentials: 'include'
          })
            .then(response => response.json())
            .then(statusData => {
              // Đóng modal verification nếu đang mở
              const modalEl = document.getElementById('verificationModal-v2');
              const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
              modalInstance.hide();
              // Hiển thị thông báo cho người dùng
              triggerNotification('warning', 'Thông báo', 'Tài khoản của bạn đang được xét duyệt, vui lòng đợi');
            })
            .catch(err => {
              console.error("Error updating account status:", err);
              triggerNotification('error', 'Thông báo', 'Đã upload file, nhưng không thể cập nhật trạng thái tài khoản.');
            });
        })
        .catch(error => {
          console.error('Lỗi khi upload file:', error);
        });
    }

    function copyText_v2() {
      const text = document.getElementById('copyContent_v2').innerText;
      navigator.clipboard.writeText(text);

      const successMsg = document.getElementById('copySuccess_v2');
      successMsg.style.display = 'block';
      setTimeout(() => successMsg.style.display = 'none', 2000);
    }

    function confirmShare_v2() {
      const confirmMsg = document.getElementById('confirmSuccess_v2');
      confirmMsg.style.display = 'block';
      setTimeout(() => confirmMsg.style.display = 'none', 2000);
    }
  </script>

  <style>
    .cursor-pointer {
      cursor: pointer;
    }

    .modal-content {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .card-method-v2 {
      transition: transform 0.2s;
    }

    .btn-success {
      background: #28a745;
      border-color: #28a745;
    }

    .btn-confirm-share-v2 {
      transition: background-color 0.2s, color 0.2s;
    }

    .btn-confirm-share-v2:hover {
      background-color: #28a745;
      color: white;
    }
  </style>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* CSS cho thiết bị di động */
    @media (max-width: 576px) {

      /* Điều chỉnh kích thước modal */
      .modal-dialog {
        max-width: 95%;
        margin: 1rem auto;
      }

      /* Điều chỉnh padding cho modal */
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      /* Điều chỉnh tiêu đề modal */
      .modal-title {
        font-size: 1.25rem;
      }

      /* Sắp xếp lại các cột hoạt động theo dạng dọc */
      .activity-container {
        display: flex;
        flex-direction: column;
      }

      /* Cho mỗi hộp hoạt động chiếm toàn bộ chiều rộng */
      .activity-box {
        width: 100%;
        margin-bottom: 1rem;
      }
    }
  </style>


  <style>
    /* Container chứa 2 cột */
    .activity-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Khung thông báo của mỗi cột */
    .activity-box {
      flex: 1;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
      animation: fadeIn 0.6s forwards;
    }

    /* Hiệu ứng fade-in */
    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    /* Tiêu đề mỗi cột */
    .activity-box h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      border-bottom: 2px solid;
      padding-bottom: 10px;
    }

    /* Phân biệt tiêu đề từng cột */
    .user-activity h3 {
      border-color: #007bff;
      color: #007bff;
    }

    .system-activity h3 {
      border-color: #28a745;
      color: #28a745;
    }

    /* Các mục trong danh sách */
    .list-group-item {
      border: none;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      background-color: transparent !important;
    }


    .list-group-item:last-child {
      border-bottom: none;
    }

    .list-group-item {
      background-color: transparent !important;
      backdrop-filter: none !important;
      box-shadow: none !important;
    }

    .list-group-item:hover,
    .list-group-item:focus,
    .list-group-item:active {
      background-color: transparent !important;
    }

    /* Nội dung hoạt động */
    .activity-text {
      display: block;
      font-size: 1rem;
      color: #555;
    }

    /* Thời gian hoạt động */
    .activity-time {
      font-size: 0.9rem;
      color: #888;
      font-style: italic;
      margin-top: 5px;
    }
  </style>
  </div>
  </div>
  </div>
  </div>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <style>
            /* Container chứa cả hai cột */
            .activity-container {
              display: flex;
              gap: 20px;
              padding: 20px;
              background-color: #f9f9f9;
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            /* Cột hoạt động của người dùng và hệ thống */
            .user-activity,
            .system-activity {
              flex: 1;
              background: #ffffff;
              border-radius: 12px;
              padding: 20px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            /* Tiêu đề mỗi cột */
            .user-activity h3,
            .system-activity h3 {
              font-size: 1.5rem;
              margin-bottom: 20px;
              color: #333;
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              border-bottom: 2px solid #007bff;
              padding-bottom: 10px;
            }

            /* Phân biệt tiêu đề cột người dùng và hệ thống */
            .user-activity h3 {
              color: #007bff;
              /* Màu xanh dương cho người dùng */
            }

            .system-activity h3 {
              color: #28a745;
              /* Màu xanh lá cho hệ thống */
            }

            /* Khung hoạt động */
            .activity-box {
              background: #f9f9f9;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .activity-box:hover {
              transform: translateY(-5px);
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            /* Nội dung trong khung hoạt động */
            .activity-box p {
              margin: 0;
              font-size: 1rem;
              color: #555;
            }

            .activity-box strong {
              color: #333;
            }

            /* Thời gian hoạt động */
            .activity-time {
              display: block;
              margin-top: 10px;
              font-size: 0.9rem;
              color: #888;
              font-style: italic;
            }
          </style>
          <p>Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?</p>
          <p id="resumePathDisplay"></p>

        </div>
        <div class="modal-footer">

          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu
            mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>

        </div>
      </div>
    </div>
  </div>

  <!-- CSS bổ sung -->
  <style>
    /* Tùy chỉnh giao diện Modal */
    .modal-content {
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      border: none;
    }

    .modal-header,
    .modal-footer {
      border: none;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.5rem;
    }

    .btn-close {
      font-size: 1.25rem;
    }

    .modal-body p {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #333;
    }

    #resumePathDisplay {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #565e64;
    }
  </style>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?
          </p>
          <p id="resumePathDisplay" class="text-muted"></p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu
            mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>
        </div>
      </div>
    </div>
  </div>




  <!-- Modal Tìm kiếm Môn học -->
  <div class="modal fade" id="customSearchModal" tabindex="-1" aria-labelledby="customSearchModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
        <!-- Modal Header -->
        <div class="custom-modal-header"
          style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 16px;">
          <h5 class="custom-modal-title" id="customSearchModalLabel"
            style="font-size: 1.25rem; font-weight: 600; color: #0d6efd;">
            <i class="fas fa-book-open me-2"></i>Tìm kiếm Môn học
          </h5>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <!-- Search Input Group -->
          <div class="custom-search-input-group" style="position: relative; margin-bottom: 1rem;">
            <input type="text" id="subjectSearchInput" class="form-control form-control-lg"
              placeholder="Nhập tên môn học..." aria-label="Search input"
              style="border-radius: 8px; padding-right: 50px; border: 1px solid #ced4da;">
            <button type="button"
              style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 8px 8px 0; background-color: #0d6efd; border: none; color: #fff;"
              onmouseover="this.style.backgroundColor='#0b5ed7'" onmouseout="this.style.backgroundColor='#0d6efd'">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <!-- Tip Text (Thông báo chọn trường) -->
          <div id="schoolSelectionNotice" class="custom-tip-text d-none"
            style="display: flex; align-items: center; padding: 10px 15px; background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%); border-radius: 4px; font-size: 0.9em; color: #333; margin-top: 8px; margin-bottom: 16px;">
            <i class="fas fa-lightbulb icon-combined" style="font-size: 1em; margin-right: 10px;"></i>
            Mẹo nhỏ: Chọn trường rồi tìm kiếm để chỉ hiển thị dữ liệu của trường đó.
          </div>

          <!-- Kết quả tìm kiếm -->
          <h6 id="searchResultCount" class="text-muted mb-3">Kết quả tìm kiếm (0)</h6>
          <div id="subjectSearchSuggestions" class="custom-scrollable-results"
            style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
            <!-- Các kết quả tìm kiếm sẽ được chèn vào đây qua JS -->
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="custom-modal-footer"
          style="background-color: #f8f9fa; border-top: 1px solid #e9ecef; padding: 16px; display: flex; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (bao gồm Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- HTML Imports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ==================================================
       PDF.js Worker Configuration
       - Chỉ cần khai báo một lần để cấu hình PDF.js worker
       ================================================== */
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';


    /* ==================================================
       Global Variables
       - Các biến toàn cục dùng trong toàn bộ ứng dụng
       ================================================== */
    let examCurrentPath = [];
    let syllabusCurrentPath = [];
    let currentRotation = 0;
    let adTimer = null;
    let currentFile = null;


    /* ==================================================
       Function: renderDrive
       Mô tả:
         - Hiển thị danh sách file/folder từ backend dựa theo đường dẫn (path)
         - Hiển thị spinner trong khi tải dữ liệu, breadcrumb, thanh tìm kiếm inline và nút tìm kiếm nâng cao
       Tham số:
         @containerId         : ID của phần tử container hiển thị drive
         @path                : Mảng đường dẫn hiện tại
         @updatePathCallback  : Hàm callback cập nhật đường dẫn khi người dùng click chọn folder
       ================================================== */
    async function renderDrive(containerId, path, updatePathCallback) {
      const documentType = containerId.includes('exam') ? 'exam' : 'syllabus';
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`Không tìm thấy container với ID: ${containerId}`);
        return;
      }
      container.innerHTML = '';

      // Hiển thị spinner khi tải dữ liệu
      const spinner = document.createElement('div');
      spinner.className = 'spinner';
      spinner.textContent = 'Loading...';
      container.appendChild(spinner);

      // Lấy dữ liệu từ backend dựa trên độ dài của path
      let data = [];
      try {
        if (path.length === 0) {
          data = await (await fetch('/api/schools')).json();
        } else if (path.length === 1) {
          const schoolId = path[0].id;
          data = await (await fetch(`/api/schools/${schoolId}/faculties`)).json();
        } else if (path.length === 2) {
          const facultyId = path[1].id;
          data = await (await fetch(`/api/faculties/${facultyId}/subjects?type=${documentType}`)).json();
        } else if (path.length === 3) {
          const subjectId = path[2].id;
          const response = await fetch(`/api/subjects/${subjectId}/documents_by_year?type=${documentType}`);
          const groupedData = await response.json();
          data = Object.keys(groupedData)
            .map(year => ({
              id: parseInt(year),
              name: year,
              count: groupedData[year].length,
              documents: groupedData[year]
            }))
            .sort((a, b) => b.id - a.id);
        } else if (path.length === 4) {
          const subjectId = path[2].id;
          const year = path[3].id;
          data = await (await fetch(`/api/subjects/${subjectId}/documents/${year}?type=${documentType}`)).json();
        }
      } catch (error) {
        console.error('Lỗi khi lấy dữ liệu:', error);
      }

      // Xóa spinner sau khi tải xong
      container.innerHTML = '';

      // Hiển thị breadcrumb dựa trên đường dẫn hiện tại
      renderBreadcrumb(container, path, updatePathCallback);

      // Tạo thanh tìm kiếm inline
      const inlineSearchContainer = document.createElement('div');
      inlineSearchContainer.className = 'input-group mb-3';
      inlineSearchContainer.style.position = 'relative';
      inlineSearchContainer.innerHTML = `
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="search" class="form-control" placeholder="Tìm kiếm trong thư mục...">
  `;
      container.appendChild(inlineSearchContainer);

      const inlineSuggestions = document.createElement('div');
      inlineSuggestions.className = 'suggestions';
      inlineSuggestions.style.display = 'none';
      inlineSearchContainer.appendChild(inlineSuggestions);

      // Nút tìm kiếm nâng cao: mở modal tìm kiếm môn học
      const advancedSearchBtn = document.createElement('button');
      advancedSearchBtn.className = 'btn btn-outline-primary mb-3';
      advancedSearchBtn.textContent = 'Tìm kiếm theo tên môn học';
      advancedSearchBtn.addEventListener('click', () => {
        const subjectSearchModal = new bootstrap.Modal(document.getElementById('customSearchModal'));
        subjectSearchModal.show();
      });
      container.appendChild(advancedSearchBtn);

      // Tạo danh sách file/folder
      const list = document.createElement('ul');
      list.className = 'file-list';
      if (Array.isArray(data)) {
        data.forEach(item => {
          if ((path.length < 3 || path.length === 3) && item.count > 0) {
            // Hiển thị folder
            renderFolderItem(list, item.name, path, updatePathCallback, item.count, item.id);
          } else if (path.length === 4) {
            // Hiển thị file
            renderFileItem(list, item, documentType);
          }
        });
      }
      container.appendChild(list);

      // Xử lý tìm kiếm inline: lọc danh sách theo từ khóa nhập vào
      const inlineSearchInput = inlineSearchContainer.querySelector('input');
      inlineSearchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const suggestions = [];
        Array.from(list.children).forEach(item => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(term) ? 'flex' : 'none';
          if (item.style.display !== 'none') {
            const name = item.querySelector('.file-name').textContent;
            if (!suggestions.includes(name)) suggestions.push(name);
          }
        });

        inlineSuggestions.innerHTML = '';
        if (term && suggestions.length > 0) {
          suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            div.addEventListener('click', () => {
              inlineSearchInput.value = suggestion;
              inlineSearchInput.dispatchEvent(new Event('input'));
              inlineSuggestions.style.display = 'none';
            });
            inlineSuggestions.appendChild(div);
          });
          inlineSuggestions.style.display = 'block';
        } else {
          inlineSuggestions.style.display = 'none';
        }
      });
    }


    /* ==================================================
       Function: renderBreadcrumb
       Mô tả:
         - Tạo breadcrumb dựa trên mảng đường dẫn hiện tại
         - Cho phép quay lại hoặc chuyển đến một phần cụ thể của đường dẫn
       Tham số:
         @container : Phần tử chứa breadcrumb
         @path      : Mảng chứa các phần (segment) của đường dẫn
         @callback  : Hàm callback được gọi khi người dùng chọn quay lại
       ================================================== */
    function renderBreadcrumb(container, path, callback) {
      if (path.length === 0) return;
      const breadcrumb = document.createElement('nav');
      let html = `
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="#" id="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
      </li>
  `;
      path.forEach((segment, index) => {
        html += index === path.length - 1
          ? `<li class="breadcrumb-item active">${segment.name}</li>`
          : `<li class="breadcrumb-item"><a href="#" class="breadcrumb-link" data-index="${index}">${segment.name}</a></li>`;
      });
      breadcrumb.innerHTML = html + '</ol>';

      // Sự kiện "Quay lại" của breadcrumb
      breadcrumb.querySelector('#back-button').addEventListener('click', (e) => {
        e.preventDefault();
        callback(path.slice(0, -1));
      });

      // Sự kiện khi click vào từng đường dẫn trong breadcrumb
      breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const index = parseInt(link.getAttribute('data-index'));
          callback(path.slice(0, index + 1));
        });
      });

      container.prepend(breadcrumb);
    }


    /* ==================================================
       Function: renderFolderItem
       Mô tả:
         - Tạo một mục (item) folder trong danh sách hiển thị drive
         - Khi click vào folder, đường dẫn sẽ được cập nhật qua callback
       Tham số:
         @list        : Phần tử <ul> chứa danh sách
         @name        : Tên folder
         @currentPath : Đường dẫn hiện tại
         @callback    : Hàm callback cập nhật đường dẫn khi chọn folder
         @count       : Số lượng file/folder con
         @itemId      : ID của folder
       ================================================== */
    function renderFolderItem(list, name, currentPath, callback, count, itemId) {
      const li = document.createElement('li');
      li.className = 'file-item';
      li.innerHTML = `
    <i class="bi bi-folder-fill file-icon folder"></i>
    <span class="file-name">${name}</span>
    <span class="file-count">${count}</span>
  `;
      li.addEventListener('click', () => callback([...currentPath, { id: itemId, name }]));
      list.appendChild(li);
    }


    /* ==================================================
       Function: renderFileItem
       Mô tả:
         - Tạo một mục (item) file trong danh sách hiển thị drive
         - Xử lý logic mở file (kiểm tra đăng nhập & trạng thái tài khoản)
       Tham số:
         @list         : Phần tử <ul> chứa danh sách
         @file         : Đối tượng file chứa thông tin file
         @documentType : Loại tài liệu ('exam' hoặc 'syllabus')
       ================================================== */
    function renderFileItem(list, file, documentType) {
      if (!file.file_path) {
        console.warn('File không có đường dẫn hợp lệ:', file);
        return;
      }

      const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
      const ext = filePath.split('.').pop().toLowerCase();
      const iconClass = {
        pdf: 'bi-file-pdf pdf',
        doc: 'bi-file-earmark-word word',
        docx: 'bi-file-earmark-word word',
        jpg: 'bi-file-image',
        jpeg: 'bi-file-image',
        png: 'bi-file-image',
        gif: 'bi-file-image'
      }[ext] || 'bi-file-earmark';

      const li = document.createElement('li');
      li.className = 'file-item';
      const typeLabel = documentType === 'exam' ? 'Đề Thi' : 'Đề Cương';
      li.innerHTML = `
    <i class="bi ${iconClass} file-icon"></i>
    <div>
      <div class="file-name">${typeLabel} ${file.file_name}</div>
      <div class="file-info">${file.file_info || ''}</div>
    </div>
  `;

      // Xử lý sự kiện click vào file: kiểm tra đăng nhập và trạng thái tài khoản
      li.addEventListener('click', () => {
        fetch('/api/check-login', {
          method: 'GET',
          credentials: 'include' // Gửi cookie session
        })
          .then(response => response.json())
          .then(data => {
            if (data.loggedIn) {
              // Kiểm tra trạng thái tài khoản
              fetch('/api/account_status', {
                method: 'GET',
                credentials: 'include'
              })
                .then(response => response.json())
                .then(statusData => {
                  if (statusData.account_status === 'đã duyệt') {
                    // Log file mở và mở file
                    fetch('/api/log-file-open', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify({ documentId: file.id })
                    })
                      .then(() => {
                        // --- Logic mới: Nếu là đề thi, lưu hoạt động "xem đề thi" vào bảng log ---
                        if (documentType === 'exam') {
                          fetch('/api/log-view-exam', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ documentId: file.id })
                          })
                            .catch(error => {
                              console.error('Lỗi khi log view exam:', error);
                            });
                        }
                        // ------------------------------------------------------------
                        window.open(filePath, '_blank'); // Mở file trong tab mới
                      })
                      .catch(error => {
                        console.error('Lỗi khi log file:', error);
                        window.open(filePath, '_blank'); // Vẫn mở file ngay cả khi log lỗi
                      });
                  } else if (statusData.account_status === 'bình thường') {
                    // Hiển thị modal xác thực nếu trạng thái là "bình thường"
                    const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                    modal.show();
                  } else if (statusData.account_status === 'đang duyệt') {
                    // Hiển thị thông báo nếu tài khoản đang xét duyệt
                    triggerNotification('warning', 'Thông báo', 'Tài khoản của bạn đang được xét duyệt, vui lòng đợi');
                  }

                })
                .catch(error => {
                  console.error('Lỗi khi kiểm tra trạng thái tài khoản:', error);
                  const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                  modal.show();
                });
            } else {
              // Nếu chưa đăng nhập, hiển thị modal đăng nhập
              const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
              modal.show();
            }
          })
          .catch(error => {
            console.error('Lỗi kiểm tra đăng nhập:', error);
            const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
            modal.show();
          });
      });

      list.appendChild(li);
    }


    /* ==================================================
       Function: openFile
       Mô tả:
         - Mở file trong trình duyệt.
         - Nếu là in-app browser thì chuyển hướng trong cùng tab.
       Tham số:
         @filePath : Đường dẫn file cần mở
       ================================================== */
    function openFile(filePath) {
      if (isInAppBrowser()) {
        window.location.href = filePath;
      } else {
        window.open(filePath, '_blank');
      }
    }


    /* ==================================================
       Function: isInAppBrowser
       Mô tả:
         - Kiểm tra xem trình duyệt có phải là in-app browser (Facebook, Messenger, Zalo,...) hay không.
       ================================================== */
    function isInAppBrowser() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      return ua.indexOf("FBAN") > -1 ||
        ua.indexOf("FBAV") > -1 ||
        ua.indexOf("Messenger") > -1 ||
        ua.indexOf("Zalo") > -1;
    }


    /* ==================================================
       Function: renderExamDrive
       Mô tả:
         - Cập nhật đường dẫn và hiển thị drive cho "Đề Thi"
       ================================================== */
    function renderExamDrive(newPath) {
      examCurrentPath = newPath;
      localStorage.setItem('examCurrentPath', JSON.stringify(examCurrentPath));
      renderDrive('exam-drive-container', examCurrentPath, renderExamDrive);
    }


    /* ==================================================
       Function: renderSyllabusDrive
       Mô tả:
         - Cập nhật đường dẫn và hiển thị drive cho "Đề Cương"
       ================================================== */
    function renderSyllabusDrive(newPath) {
      syllabusCurrentPath = newPath;
      localStorage.setItem('syllabusCurrentPath', JSON.stringify(syllabusCurrentPath));
      renderDrive('syllabus-drive-container', syllabusCurrentPath, renderSyllabusDrive);
    }


    /* ==================================================
       Initialization: Tab Switching & Resume Modal
       Mô tả:
         - Khởi tạo giao diện chuyển đổi tab (Đề Thi / Đề Cương)
         - Khôi phục modal "Tiếp tục xem" nếu có đường dẫn lưu
       ================================================== */
    document.addEventListener('DOMContentLoaded', () => {
      // Lấy đường dẫn lưu từ localStorage
      const savedExamPath = localStorage.getItem('examCurrentPath');
      const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
      if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
      if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

      // Lấy các phần tử DOM cho tab và nội dung
      const examTab = document.getElementById('de-thi-tab');
      const syllabusTab = document.getElementById('de-cuong-tab');
      const examContent = document.getElementById('de-thi');
      const syllabusContent = document.getElementById('de-cuong');
      let activeTab = localStorage.getItem('activeTab') || 'exam';

      // Hàm chuyển đổi tab
      function switchTab(tab) {
        if (tab === 'exam') {
          examTab.classList.add('active');
          syllabusTab.classList.remove('active');
          examContent.classList.add('show', 'active');
          syllabusContent.classList.remove('show', 'active');
          localStorage.setItem('activeTab', 'exam');
          renderExamDrive(examCurrentPath);
        } else {
          syllabusTab.classList.add('active');
          examTab.classList.remove('active');
          syllabusContent.classList.add('show', 'active');
          examContent.classList.remove('show', 'active');
          localStorage.setItem('activeTab', 'syllabus');
          renderSyllabusDrive(syllabusCurrentPath);
        }
      }

      // Gán sự kiện chuyển tab
      examTab.addEventListener('click', () => switchTab('exam'));
      syllabusTab.addEventListener('click', () => switchTab('syllabus'));
      switchTab(activeTab);

      // Khôi phục modal "Tiếp tục xem" nếu có dữ liệu đường dẫn lưu
      if (activeTab === 'exam' && examCurrentPath.length > 0) {
        const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
        document.getElementById('resumeTabName').textContent = 'Đề Thi';
        document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + examCurrentPath.map(item => item.name).join(' > ');
        resumeModal.show();

        document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
          resumeModal.hide();
        });

        document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
          examCurrentPath = [];
          localStorage.removeItem('examCurrentPath');
          renderExamDrive(examCurrentPath);
          resumeModal.hide();
        });

        document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
          resumeModal.hide();
          showHistoryModal();
        });
      } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
        const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
        document.getElementById('resumeTabName').textContent = 'Đề Cương';
        document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
        resumeModal.show();

        document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
          resumeModal.hide();
        });

        document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
          syllabusCurrentPath = [];
          localStorage.removeItem('syllabusCurrentPath');
          renderSyllabusDrive(syllabusCurrentPath);
          resumeModal.hide();
        });

        document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
          resumeModal.hide();
          showHistoryModal();
        });
      }
    });


    /* ==================================================
       Initialization: Subject Search Modal
       Mô tả:
         - Thiết lập chức năng tìm kiếm môn học trong modal tìm kiếm
         - Xử lý hiển thị kết quả và gợi ý tìm kiếm theo từ khóa nhập vào
       ================================================== */
    document.addEventListener("DOMContentLoaded", function () {
      // Lấy các phần tử cần thiết từ modal tìm kiếm môn học
      const subjectSearchInput = document.getElementById("subjectSearchInput");
      const subjectSearchSuggestions = document.getElementById("subjectSearchSuggestions");
      const schoolSelectionNotice = document.getElementById("schoolSelectionNotice");
      const searchResultCount = document.getElementById("searchResultCount");
      const modalEl = document.getElementById("customSearchModal");

      if (!modalEl) {
        console.error('Không tìm thấy phần tử modal với id "customSearchModal"');
        return;
      }

      // Ẩn tiêu đề kết quả và vùng gợi ý ban đầu
      searchResultCount.style.display = "none";
      subjectSearchSuggestions.style.display = "none";

      // Lấy instance của modal (nếu chưa có thì tạo mới)
      let modalInstance = bootstrap.Modal.getInstance(modalEl);
      if (!modalInstance) {
        modalInstance = new bootstrap.Modal(modalEl);
      }

      // Sự kiện nhập liệu cho ô tìm kiếm môn học
      subjectSearchInput?.addEventListener("input", async () => {
        const term = subjectSearchInput.value.trim().toLowerCase();

        // Nếu từ khóa ít hơn 2 ký tự, ẩn gợi ý và tiêu đề kết quả
        if (term.length < 2) {
          subjectSearchSuggestions.style.display = "none";
          searchResultCount.style.display = "none";
          return;
        } else {
          searchResultCount.style.display = "block";
        }

        // Xác định activeTab và đường dẫn hiện tại
        const activeTab = localStorage.getItem("activeTab") || "exam";
        const currentPath = activeTab === "exam" ? examCurrentPath : syllabusCurrentPath;

        // Nếu chưa chọn trường, hiển thị thông báo
        if (!currentPath || currentPath.length === 0) {
          schoolSelectionNotice.classList.remove("d-none");
        } else {
          schoolSelectionNotice.classList.add("d-none");
        }

        // Lấy các tham số school_id và faculty_id từ currentPath
        const schoolId = currentPath[0]?.id || 0;
        const facultyId = currentPath[1]?.id || 0;

        try {
          const url = new URL("/api/search/subjects", window.location.origin);
          url.searchParams.append("term", term);
          if (schoolId) url.searchParams.append("school_id", schoolId);
          if (facultyId) url.searchParams.append("faculty_id", facultyId);

          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
          const results = await response.json();

          // Cập nhật tiêu đề kết quả với số lượng kết quả trả về
          searchResultCount.textContent = "Kết quả tìm kiếm (" + results.length + ")";

          // Xóa nội dung gợi ý cũ
          subjectSearchSuggestions.innerHTML = "";

          if (results.length > 0) {
            results.forEach(subject => {
              // Tạo card cho mỗi kết quả tìm kiếm môn học
              const card = document.createElement("div");
              card.className = "card mb-3";
              card.style.border = "none";
              card.style.borderRadius = "12px";
              card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
              card.style.transition = "all 0.3s ease";
              card.style.backgroundColor = "#ffffff";
              card.style.cursor = "pointer";
              card.onmouseover = function () {
                this.style.transform = "translateY(-3px)";
                this.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
                this.style.backgroundColor = "#f8f9fa";
              };
              card.onmouseout = function () {
                this.style.transform = "none";
                this.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
                this.style.backgroundColor = "#ffffff";
              };

              // Tạo card body chứa thông tin môn học
              const cardBody = document.createElement("div");
              cardBody.className = "card-body";

              // Container d-flex để chia layout giữa thông tin và nút "Xem"
              const contentDiv = document.createElement("div");
              contentDiv.className = "d-flex justify-content-between align-items-start";

              // Phần thông tin môn học (bên trái)
              const infoDiv = document.createElement("div");

              const h5 = document.createElement("h5");
              h5.className = "custom-card-title";
              h5.style.color = "#0d6efd";
              h5.style.fontWeight = "600";
              h5.style.marginBottom = "8px";
              h5.textContent = subject.name;

              const schoolDiv = document.createElement("div");
              schoolDiv.style.color = "#6c757d";
              schoolDiv.style.marginBottom = "0.5rem";
              schoolDiv.innerHTML = `<i class="fas fa-university me-1"></i> ${subject.school_name}`;

              const facultySpan = document.createElement("span");
              facultySpan.className = "custom-university-label";
              facultySpan.style.fontSize = "0.9em";
              facultySpan.style.backgroundColor = "#e9ecef";
              facultySpan.style.borderRadius = "20px";
              facultySpan.style.padding = "5px 15px";
              facultySpan.style.display = "inline-block";
              facultySpan.style.color = "#495057";
              facultySpan.style.marginTop = "8px";
              facultySpan.innerHTML = `<i class="fas fa-graduation-cap me-1"></i> ${subject.faculty_name}`;

              infoDiv.appendChild(h5);
              infoDiv.appendChild(schoolDiv);
              infoDiv.appendChild(facultySpan);

              // Phần nút "Xem" (bên phải)
              const viewButton = document.createElement("button");
              viewButton.type = "button";
              viewButton.style.fontSize = "0.875rem";
              viewButton.style.border = "1px solid #0d6efd";
              viewButton.style.color = "#0d6efd";
              viewButton.style.backgroundColor = "transparent";
              viewButton.style.padding = "0.375rem 0.75rem";
              viewButton.style.borderRadius = "0.25rem";
              viewButton.onmouseover = function () {
                this.style.backgroundColor = "#0d6efd";
                this.style.color = "#fff";
              };
              viewButton.onmouseout = function () {
                this.style.backgroundColor = "transparent";
                this.style.color = "#0d6efd";
              };
              viewButton.innerHTML = `<i class="fas fa-eye me-1"></i> Xem`;

              // Ghép thông tin và nút "Xem" vào container d-flex
              contentDiv.appendChild(infoDiv);
              contentDiv.appendChild(viewButton);

              // Ghép container d-flex vào card body, sau đó vào card
              cardBody.appendChild(contentDiv);
              card.appendChild(cardBody);

              // Xử lý sự kiện click: cập nhật currentPath, render drive mới, reset thanh tìm kiếm và đóng modal
              card.addEventListener("click", () => {
                const newPath = [
                  { id: subject.school_id, name: subject.school_name },
                  { id: subject.faculty_id, name: subject.faculty_name },
                  { id: subject.id, name: subject.name }
                ];
                if (activeTab === "exam") {
                  renderExamDrive(newPath);
                } else {
                  renderSyllabusDrive(newPath);
                }
                // Reset thanh tìm kiếm
                subjectSearchInput.value = "";
                subjectSearchSuggestions.innerHTML = "";
                subjectSearchSuggestions.style.display = "none";
                searchResultCount.textContent = "Kết quả tìm kiếm (0)";
                // Đóng modal tìm kiếm
                const modal = bootstrap.Modal.getInstance(document.getElementById("customSearchModal"));
                if (modal) {
                  modal.hide();
                } else {
                  new bootstrap.Modal(document.getElementById("customSearchModal")).hide();
                }
              });

              subjectSearchSuggestions.appendChild(card);
            });
            subjectSearchSuggestions.style.display = "block";
          } else {
            subjectSearchSuggestions.style.display = "none";
          }
        } catch (error) {
          console.error("Lỗi tìm kiếm:", error);
          subjectSearchSuggestions.innerHTML = '<div class="error">Lỗi tải kết quả</div>';
          subjectSearchSuggestions.style.display = "block";
        }
      });
    });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>