<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kho Học Liệu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Thêm CDN Bootstrap và icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <!-- Import Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Import Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="shortcut icon" href="../static/logo.png" type="image/x-icon">
  <link rel="stylesheet" href="../static/css/index.css">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f4f6f9;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }

    .list-group-item :hover {
      cursor: pointer;
      color: red;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      margin: 0;
      padding-top: 60px;
    }

    .compact-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card-custom {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .nav-tabs .nav-link {
      font-weight: 500;
      color: var(--secondary-color);
      border: none;
      padding: 0.75rem 1rem;
      transition: color 0.3s ease;
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 3px solid var(--primary-color);
    }

    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
    }

    .breadcrumb {
      background: transparent;
      padding: 0.75rem 1rem;
      margin-bottom: 0;
    }

    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: #0056b3;
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
      background: #fff;
    }

    .file-item:hover {
      background-color: #f8f9fa;
      transform: translateX(5px);
    }

    .file-icon {
      font-size: 24px;
      margin-right: 15px;
      width: 30px;
    }

    .file-icon.folder {
      color: #ffc107;
    }

    .file-icon.pdf {
      color: #dc3545;
    }

    .file-icon.word {
      color: #2b579a;
    }

    .file-name {
      flex-grow: 1;
      font-size: 1rem;
    }

    .file-info {
      font-size: 0.8rem;
      color: var(--secondary-color);
    }

    /* CSS cho gợi ý tìm kiếm (autocomplete) */
    .suggestions {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .suggestions .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions .suggestion-item:hover {
      background-color: #f8f9fa;
      opacity: 1;
    }

    /* Modern Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      background: #ffffff;
      animation: fadeInScale 0.4s ease;
    }

    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: #fff;
      border-bottom: none;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .modal-header .btn-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }

    .modal-header .btn-close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 1.5rem;
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
    }

    .modal-footer {
      background: #f5f5f5;
      border-top: none;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      min-width: 120px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .modal-footer .btn-primary {
      background: #2575fc;
      border: none;
    }

    .modal-footer .btn-primary:hover {
      background: #1a5bb8;
      transform: translateY(-2px);
    }

    .modal-footer .btn-secondary {
      background: #e0e0e0;
      border: none;
      color: #555;
    }

    .modal-footer .btn-secondary:hover {
      background: #cfcfcf;
      transform: translateY(-2px);
    }

    .modal-footer .btn-info {
      background: #17a2b8;
      border: none;
      color: #fff;
    }

    .modal-footer .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    @media (max-width: 576px) {

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      .modal-header .modal-title {
        font-size: 1.5rem;
      }
    }

    /* Modal Resume Header màu xanh lá */
    #resumeModal .modal-header {
      background: linear-gradient(135deg, #28a745, #70db70);
    }

    .about-links {
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }

    .about-links h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 15px;
    }

    .about-links ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }

    .about-links li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .about-links li:last-child {
      border-bottom: none;
    }

    .about-links .label {
      flex: 0 0 150px;
      font-weight: 600;
      color: #007bff;
    }

    .about-links .desc {
      flex: 1;
      font-size: 16px;
      color: #555;
    }

    /* Footer style */
    .custom-footer {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      text-align: center;
    }

    .custom-footer .footer-item {
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }

    .custom-footer .footer-item span {
      display: block;
      line-height: 1.5;
    }

    /* Social links style */
    .social-links {
      margin-top: 10px;
    }

    .social-links a {
      margin: 0 10px;
      font-size: 24px;
      color: #007bff;
      text-decoration: none;
      transition: color 0.3s;
    }

    .social-links a:hover {
      color: #0056b3;
    }

    /* Custom CSS for Modern and Elegant Modal */
    .modal-content {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      border-bottom: none;
      padding: 20px;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .modal-body {
      padding: 20px;
      background-color: #f9f9f9;
    }

    .modal-footer {
      border-top: none;
      padding: 15px 20px;
      background-color: #f9f9f9;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    .btn-close {
      filter: invert(1);
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .list-group-item {
      border: none;
      margin-bottom: 10px;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .list-group-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    /* Animation for modal */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal.fade .modal-dialog {
      animation: fadeIn 0.3s ease-out;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      /* canh giữa */
      text-indent: -9999px;
      /* ẩn text Loading... nếu không muốn hiển thị */
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #subjectSearchModal .modal-dialog {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #subjectSearchModal .modal-content {
      height: 70%;
    }

    .suggestions {
      position: absolute;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* Đảm bảo hiển thị trên modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }

    .suggestions {
      position: absolute;
      top: calc(100% + 2px);
      /* Nằm ngay dưới ô input, cách 2px để không dính liền */
      left: 0;
      width: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* Đảm bảo hiển thị trên modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }


    /* Trên mobile (chiều rộng nhỏ hơn 576px), tăng padding-top để bù navbar */
    @media (max-width: 576px) {
      body {
        padding-top: 100px;
        /* Tăng khoảng cách để tránh bị đè nội dung */
      }
    }

    /*hover content nav*/
    /* CSS cho tooltip: chỉ hiển thị khi di chuột vào nút */
    .btn-hover-tooltip {
      position: relative;
    }

    .btn-hover-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -30px;
      /* Điều chỉnh vị trí theo nhu cầu */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .btn-hover-tooltip:hover::after {
      opacity: 1;
    }
  </style>

</head>

<body>
  <!-- Thêm navbar vào trước phần content chính -->
  <nav id="navbar" class="navbar navbar-expand-lg navbar-light border-bottom py-3 fixed-top" style="display: none;">
    <div class="container-fluid">
      <!-- Tên trang web bên trái -->
      <a class="navbar-brand me-5" href="/">
        <span class="text-primary fw-bold fs-4">HueHub</span>
      </a>

      <!-- Các chức năng bên phải -->
      <div class="d-flex align-items-center gap-3">
        <!-- Nút "Nhật ký hoạt động hệ thống" -->
        <button id="activityBtn" class="btn btn-light rounded-pill px-3 btn-hover-tooltip"
          data-tooltip="Nhật ký hoạt động hệ thống">
          <i class="bi bi-clock-history me-2"></i>
        </button>
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            // Lấy nút theo ID
            var activityBtn = document.getElementById('activityBtn');
            if (activityBtn) {
              // Khi nút được click, hiển thị modal
              activityBtn.addEventListener('click', function () {
                var activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
                activityModal.show();
              });
            }
          });

        </script>

        <!-- Nút đăng xuất -->
        <button class="btn btn-outline-danger rounded-pill px-3 btn-hover-tooltip" id="logoutBtn"
          data-tooltip="Đăng xuất">
          <i class="bi bi-box-arrow-right me-2"></i>
          Đăng xuất
        </button>
      </div>
    </div>
  </nav>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch("/api/check-login")
        .then(response => response.json())
        .then(data => {
          if (data.loggedIn) {
            document.getElementById("navbar").style.display = "block"; // Hiển thị navbar nếu đã đăng nhập
          }
        })
        .catch(error => console.error("Lỗi kiểm tra đăng nhập:", error));
    });

  </script>
  <style>
  
/* Định dạng cho nút nav */
.nav-link {
  position: relative;
  font-family: 'Roboto', sans-serif;
  color: #777777;
  text-decoration: none;
  padding: 10px 15px;
  transition: all 0.3s ease;
  border: none;
  background: none;
  cursor: pointer;
}
/* Hiệu ứng underline ẩn ban đầu */
.nav-link::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: 0;
  transform: translateX(-50%);
  width: 0;
  height: 2px;
  background-color: #007bff;
  transition: width 0.3s ease;
}
/* Hiệu ứng khi hover (áp dụng cho các nav-link không active) */
.nav-link:hover {
  color: #007bff;
  transform: translateY(-2px);
}
.nav-link:hover::after {
  width: 100%;
}
/* Style cho nút active */
.nav-link.active {
  color: #007bff;
}
/* Không áp dụng hiệu ứng hover cho nav-link đang active */
.nav-link.active:hover {
  color: #007bff;
  transform: none;
}
.nav-link.active:hover::after {
  width: 0;
}

    
  </style>

  <div class="compact-container my-4">
    <div class="card card-custom">
      <div class="card-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="de-thi-tab" data-bs-toggle="tab" data-bs-target="#de-thi" type="button"
              role="tab" style = "color:#777777">Đề Thi</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="de-cuong-tab" data-bs-toggle="tab" data-bs-target="#de-cuong" type="button"
              role="tab"  style = "color:#777777">Đề Cương</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="ve-chung-toi-tab" data-bs-toggle="tab" data-bs-target="#ve-chung-toi"
              type="button" role="tab"  style = "color:#777777">Về Chúng Tôi</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <!-- Tab Đề Thi -->
          <div class="tab-pane fade show active" id="de-thi" role="tabpanel" aria-labelledby="de-thi-tab">
            <div id="exam-drive-container"></div>
          </div>
          <!-- Tab Đề Cương -->
          <div class="tab-pane fade" id="de-cuong" role="tabpanel" aria-labelledby="de-cuong-tab">
            <div id="syllabus-drive-container"></div>
          </div>
          <!-- Tab Về Chúng Tôi -->
          <div class="tab-pane fade" id="ve-chung-toi" role="tabpanel" aria-labelledby="ve-chung-toi-tab">
            <!-- Sử dụng position-relative để định vị phần "Phiên bản" -->
            <div class="p-3 position-relative">
              <p>
                Các đề thi và tài liệu trên website này đều được đóng góp bởi các cựu sinh viên, mang lại sự gần gũi và
                trải nghiệm thực tế trong học tập.
              </p>
              <div class="about-links mt-3">
                <footer class="custom-footer mt-4">
                  <div class="footer-item">
                    <span>Design by Nguyen Ngoc Truong</span>
                  </div>
                  <div class="social-links">
                    <a href="https://www.facebook.com/nntruong05" target="_blank" aria-label="Facebook">
                      <i class="bi bi-facebook"></i>
                    </a>
                    <a href="https://github.com/truongqb05x" target="_blank" aria-label="GitHub">
                      <i class="bi bi-github"></i>
                    </a>
                  </div>
                </footer>
              </div>

              <!-- Chữ "Phiên bản 0" được đặt ở góc dưới bên phải, có hiệu ứng nhấn để mở modal lịch sử cập nhật -->
              <div class="version-info"
                style="position: absolute; bottom: 0; right: 0; padding: 5px; font-size: 0.9rem; color: #666;"
                data-bs-toggle="modal" data-bs-target="#updateHistoryModal">
                Version 2.0.4
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Container chứa thông báo, sẽ được tạo tự động nếu chưa có -->
  <div class="my-notification-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * Hàm triggerNotification: Kích hoạt thông báo bằng cách tạo CSS, container và thông báo mới.
     * @param {string} type - Loại thông báo: 'success', 'warning', 'danger'
     * @param {string} title - Tiêu đề thông báo
     * @param {string} message - Nội dung thông báo
     */
    function triggerNotification(type, title, message) {
      // Chèn CSS động nếu chưa có
      if (!document.getElementById('my-notification-style')) {
        const css = `
          .my-notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 320px;
          }
          
          .my-notification {
            position: relative;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(120%);
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid;
          }
      
          .my-notification.hide {
            animation: slideOut 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
          }
      
          .my-notification:hover {
            transform: translateX(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
          }
      
          .my-notification-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            flex-shrink: 0;
          }
      
          .my-notification-content {
            flex-grow: 1;
          }
      
          .my-notification-close {
            opacity: 0.6;
            margin-left: 15px;
            transition: opacity 0.2s;
          }
      
          .my-notification-close:hover {
            opacity: 1;
          }
      
          .my-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
            width: 100%;
            overflow: hidden;
            border-radius: 0 0 8px 8px;
          }
      
          .my-progress-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background: currentColor;
            animation: progress 5s linear forwards;
          }
      
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateX(120%);
            }
            to {
              opacity: 1;
              transform: translateX(0);
            }
          }
      
          @keyframes slideOut {
            from {
              opacity: 1;
              transform: translateX(0);
            }
            to {
              opacity: 0;
              transform: translateX(120%);
            }
          }
      
          @keyframes progress {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
          }
        `;
        const styleEl = document.createElement('style');
        styleEl.type = 'text/css';
        styleEl.id = 'my-notification-style';
        styleEl.appendChild(document.createTextNode(css));
        document.head.appendChild(styleEl);
      }

      // Đảm bảo container thông báo tồn tại
      let container = document.querySelector('.my-notification-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'my-notification-container';
        document.body.appendChild(container);
      }

      // Tạo phần tử thông báo mới
      const notification = document.createElement('div');
      notification.classList.add('my-notification', `alert-${type}`);

      // Chọn icon tương ứng theo loại thông báo
      let iconClass = '';
      if (type === 'success') {
        iconClass = 'bi-check-circle-fill';
      } else if (type === 'warning') {
        iconClass = 'bi-hourglass-split';
      } else if (type === 'danger') {
        iconClass = 'bi-x-octagon-fill';
      }

      notification.innerHTML = `
        <i class="bi ${iconClass} my-notification-icon"></i>
        <div class="my-notification-content">
          <h6 class="mb-1 fw-semibold">${title}</h6>
          <p class="mb-0 small">${message}</p>
        </div>
        <div class="my-progress-bar"></div>
        <button class="my-notification-close btn btn-link p-0">
          <i class="bi bi-x"></i>
        </button>
      `;

      // Sự kiện đóng thông báo khi nhấn nút close
      notification.querySelector('.my-notification-close').addEventListener('click', () => {
        notification.classList.add('hide');
        notification.addEventListener('animationend', () => notification.remove());
      });

      container.appendChild(notification);

      // Tự động ẩn thông báo sau 5 giây
      setTimeout(() => {
        notification.classList.add('hide');
        notification.addEventListener('animationend', () => notification.remove());
      }, 3000);
    }

    // Bạn có thể gọi triggerNotification bất cứ lúc nào, ví dụ:
    // triggerNotification('warning', 'Cảnh báo!', 'Vui lòng kiểm tra lại dữ liệu.');
    // triggerNotification('danger', 'Lỗi!', 'Không thể kết nối đến máy chủ.');
  </script>

  <!-- Modal Structure -->
<!-- Modal: Lịch sử hoạt động -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg"><!-- .modal-dialog -->
    <div class="modal-content"><!-- .modal-content -->
      <div class="modal-header"><!-- .modal-header -->
        <h5 class="modal-title">
          <i class="fas fa-history me-2"></i>Lịch sử hoạt động
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div><!-- End .modal-header -->
      <div class="modal-body"><!-- .modal-body -->
        <!-- Timeline: Hoạt động người dùng -->
        <div class="section-divider"><!-- .section-divider -->
          <i class="fas fa-user"></i>
          <span>Hoạt động người dùng</span>
        </div><!-- End .section-divider -->
        <!-- Nhóm "Mở đề thi" với nhiều môn khác nhau -->
        <div class="timeline-group user-group" id="openExamGroup"><!-- #openExamGroup -->
          <div class="timeline-group-header"><!-- .timeline-group-header -->
            <div class="timeline-icon"><!-- .timeline-icon -->
              <i class="fas fa-book-open"></i>
            </div><!-- End .timeline-icon -->
            <div class="group-title"><!-- .group-title -->
              <h6>Mở đề thi</h6>
            </div><!-- End .group-title -->
          </div><!-- End .timeline-group-header -->
          <div class="timeline-group-items"><!-- .timeline-group-items -->
            <!-- Nội dung mẫu ban đầu (sẽ được thay thế bởi dữ liệu backend) -->
            <div class="timeline-item"><!-- .timeline-item -->
              <div class="timeline-content"><!-- .timeline-content -->
                <small>39 phút trước</small>
                <strong>Mở đề thi Java Cơ Bản</strong>
                <div class="d-flex flex-wrap gap-2 mt-1"><!-- .d-flex -->
                  <span class="info-badge">
                    <i class="fas fa-user-circle text-purple"></i> Nguyễn Văn A
                  </span>
                  <span class="info-badge">
                    <img src="logo-hue.png" alt="ĐH Khoa học Huế" class="university-logo" /> ĐH Khoa học Huế
                  </span>
                </div><!-- End .d-flex -->
              </div><!-- End .timeline-content -->
            </div><!-- End .timeline-item -->
          </div><!-- End .timeline-group-items -->
        </div><!-- End #openExamGroup -->
        <!-- Nhóm "Đăng nhập" -->
        <div class="timeline-group user-group" id="loginGroup"><!-- #loginGroup -->
          <div class="timeline-group-header"><!-- .timeline-group-header -->
            <div class="timeline-icon"><!-- .timeline-icon -->
              <i class="fas fa-sign-in-alt"></i>
            </div><!-- End .timeline-icon -->
            <div class="group-title"><!-- .group-title -->
              <h6>Đăng nhập vào hệ thống</h6>
            </div><!-- End .group-title -->
          </div><!-- End .timeline-group-header -->
          <div class="timeline-group-items"><!-- .timeline-group-items -->
            <!-- Nội dung mẫu ban đầu (sẽ được thay thế bởi dữ liệu backend) -->
            <div class="timeline-item"><!-- .timeline-item -->
              <div class="timeline-content"><!-- .timeline-content -->
                <small>2 giờ trước</small>
                <strong>Đăng nhập thành công</strong>
                <div class="d-flex flex-wrap gap-2 mt-1"><!-- .d-flex -->
                  <span class="info-badge">
                    <i class="fas fa-user-circle text-purple"></i> Lê Văn C
                  </span>
                  <span class="info-badge">
                    <img src="logo-dhkt.png" alt="ĐH Kinh Tế" class="university-logo" /> ĐH Kinh Tế
                  </span>
                </div><!-- End .d-flex -->
              </div><!-- End .timeline-content -->
            </div><!-- End .timeline-item -->
          </div><!-- End .timeline-group-items -->
        </div><!-- End #loginGroup -->
        <!-- Nhóm "Đăng kí tài khoản" -->
        <div class="timeline-group user-group" id="registerGroup"><!-- #registerGroup -->
          <div class="timeline-group-header"><!-- .timeline-group-header -->
            <div class="timeline-icon"><!-- .timeline-icon -->
              <i class="fas fa-user-plus"></i>
            </div><!-- End .timeline-icon -->
            <div class="group-title"><!-- .group-title -->
              <h6>Đăng kí tài khoản</h6>
            </div><!-- End .group-title -->
          </div><!-- End .timeline-group-header -->
          <div class="timeline-group-items"><!-- .timeline-group-items -->
            <div class="timeline-item"><!-- .timeline-item -->
              <div class="timeline-content"><!-- .timeline-content -->
                <small>1 giờ trước</small>
                <strong>Đăng kí thành công</strong>
                <div class="d-flex flex-wrap gap-2 mt-1"><!-- .d-flex -->
                  <span class="info-badge">
                    <i class="fas fa-user-circle text-purple"></i> Trần Thị D
                  </span>
                  <span class="info-badge">
                    <img src="logo-dhct.png" alt="ĐH Công nghệ" class="university-logo" /> ĐH Công nghệ
                  </span>
                </div><!-- End .d-flex -->
              </div><!-- End .timeline-content -->
            </div><!-- End .timeline-item -->
          </div><!-- End .timeline-group-items -->
        </div><!-- End #registerGroup -->
        <!-- Timeline: Hoạt động hệ thống -->
        <div class="section-divider"><!-- .section-divider -->
          <i class="fas fa-server"></i>
          <span>Hoạt động hệ thống</span>
        </div><!-- End .section-divider -->
        <!-- Nhóm "Đã upload đề thi mới" -->
        <div class="timeline-group system-group" id="uploadGroup"><!-- #uploadGroup -->
          <div class="timeline-group-header"><!-- .timeline-group-header -->
            <div class="timeline-icon"><!-- .timeline-icon -->
              <i class="fas fa-cloud-upload-alt"></i>
            </div><!-- End .timeline-icon -->
            <div class="group-title"><!-- .group-title -->
              <h6>Đã upload đề thi mới</h6>
            </div><!-- End .group-title -->
          </div><!-- End .timeline-group-header -->
          <div class="timeline-group-items"><!-- .timeline-group-items -->
            <div class="timeline-item"><!-- .timeline-item -->
              <div class="timeline-content"><!-- .timeline-content -->
                <small>24 phút trước</small>
                <strong>Upload đề thi Đại Số Đồ Thị</strong>
                <div class="d-flex flex-wrap gap-2 mt-1"><!-- .d-flex -->
                  <span class="info-badge">
                    <i class="fas fa-tag text-success"></i> Đề thi
                  </span>
                  <span class="info-badge">
                    <i class="fas fa-database text-info"></i> 2.4 MB
                  </span>
                </div><!-- End .d-flex -->
              </div><!-- End .timeline-content -->
            </div><!-- End .timeline-item -->
          </div><!-- End .timeline-group-items -->
        </div><!-- End #uploadGroup -->
        <!-- (Đã xóa nhóm "Bảo trì hệ thống" và "Cập nhật hệ thống") -->
        <!-- Thống kê thành viên -->
        <div class="section-divider"><!-- .section-divider -->
          <i class="fas fa-chart-bar"></i>
          <span>Thống kê thành viên</span>
        </div><!-- End .section-divider -->
        <div class="statistics-list"><!-- .statistics-list -->
          <div class="statistics-item d-flex justify-content-between"><!-- .statistics-item -->
            <div>
              <img src="logo-dhtn.png" alt="ĐH Khoa học Tự nhiên" class="university-logo me-2" />
              ĐH Khoa học Tự nhiên
            </div>
            <span class="badge bg-primary rounded-pill">150</span>
          </div><!-- End .statistics-item -->
          <div class="statistics-item d-flex justify-content-between"><!-- .statistics-item -->
            <div>
              <img src="logo-dhct.png" alt="ĐH Công nghệ" class="university-logo me-2" />
              ĐH Công nghệ
            </div>
            <span class="badge bg-primary rounded-pill">200</span>
          </div><!-- End .statistics-item -->
        </div><!-- End .statistics-list -->
      </div><!-- End .modal-body -->
      <div class="modal-footer"><!-- .modal-footer -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div><!-- End .modal-footer -->
    </div><!-- End .modal-content -->
  </div><!-- End .modal-dialog -->
</div><!-- End .modal -->


  <!-- Chèn CSS động: Giữ nguyên form CSS cũ -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Chèn CSS động để đảm bảo biến và keyframes được định nghĩa
      var style = document.createElement("style");
      style.innerHTML = `
      :root {
        --primary-color: #6366f1;
        --secondary-color: #3b82f6;
        --accent-color: #10b981;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e9ecef;
        --bg-light: #f8f9fa;
        --card-bg: #ffffff;
      }
      .modal-content {
        border-radius: 12px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
        border: none;
        overflow: hidden;
      }
      .modal-header {
        background: var(--primary-color);
        color: #fff;
        padding: 1rem 1.5rem;
      }
      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
      }
      .modal-title i { margin-right: 8px; }
      .section-divider {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 1.5rem 0 1rem;
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
      }
      .section-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border-color);
      }
      .timeline-group {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .timeline-group-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      .timeline-icon {
        flex: 0 0 40px;
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 20px;
        margin-right: 10px;
      }
      .system-group .timeline-icon {
        background: var(--secondary-color);
      }
      .group-title h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      .timeline-item {
        margin-bottom: 1rem;
        opacity: 0;
        position: relative;
      }
      .timeline-item:last-child {
        margin-bottom: 0;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -11px;
        top: 4px;
        width: 12px;
        height: 12px;
        background: #fff;
        border: 2px solid var(--primary-color);
        border-radius: 50%;
      }
      .system-group .timeline-item::before {
        border-color: var(--secondary-color);
      }
      .timeline-content {
        margin-left: 10px;
        width: 100%;
        display: block;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .timeline-content small {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .timeline-content .info-badge {
        font-size: 0.85rem;
        padding: 0.35rem 0.7rem;
        border-radius: 6px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.25rem;
      }
      .university-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 50%;
        margin-right: 0.5rem;
        vertical-align: middle;
      }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .timeline-item.animate {
        animation: fadeInUp 0.5s ease-out forwards;
      }
      .subscription-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .subscribe-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
      }
      .subscribe-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .statistics-item {
        padding: 0.75rem;
        background: var(--card-bg);
        border-radius: 8px;
        margin: 0.5rem 0;
      }
      @media (max-width: 576px) {
        .timeline-icon {
          width: 36px;
          height: 36px;
          font-size: 18px;
        }
      }
      .modal-body .section-divider:first-of-type {
        margin-top: 0;
      }

/* Thêm pseudo-element để tạo đường dọc */
.timeline-group-items::before {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  left: 39px; /* Vị trí này khớp với vị trí vòng tròn ở .timeline-item::before */
  border-left: 2px dashed var(--border-color); /* Có thể đổi thành solid nếu thích */
}

    `;
      document.head.appendChild(style);
    });
  </script>

  <!-- Script xử lý sự kiện và chèn data backend vào nhóm "Mở đề thi" và "Đăng nhập" -->
  <!-- Script xử lý sự kiện và chèn data backend vào các nhóm -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Hàm chuyển đổi thời gian ISO sang dạng relative (vài giây, phút, giờ, ngày, tháng, năm trước)
      function timeAgo(timeStr) {
        const past = new Date(timeStr);
        if (isNaN(past.getTime())) return timeStr;
        const now = new Date();
        const diff = now - past;
        const diffSeconds = Math.floor(diff / 1000);
        const diffMinutes = Math.floor(diff / (1000 * 60));
        const diffHours = Math.floor(diff / (1000 * 60 * 60));
        const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
        const diffMonths = Math.floor(diffDays / 30);
        const diffYears = Math.floor(diffDays / 365);
        if (diffSeconds < 60) return 'vài giây trước';
        else if (diffMinutes < 60) return diffMinutes + ' phút trước';
        else if (diffHours < 24) return diffHours + ' giờ trước';
        else if (diffDays < 30) return diffDays + ' ngày trước';
        else if (diffMonths < 12) return diffMonths + ' tháng trước';
        else return diffYears + ' năm trước';
      }

      // Mapping giữa tên trường và logo
      const schoolLogos = {
        'Trường Đại học Khoa học - Đại Học Huế': 'static/logo_uni/favicon_husc.ico',
        'Trường Đại học Sư phạm - Đại Học Huế': 'static/logo_uni/logo_dhsp2.ico',
        'Trường Đại học Khoa học Tự nhiên - Đại học Quốc gia TP. HCM': 'static/logo_uni/iconhcm.ico',
        'ĐH Khoa học Tự nhiên': 'logo-dhtn.png',
        'ĐH Công nghệ': 'logo-dhct.png'
      };

      // Hàm dùng chung để chèn các timeline item
      function insertTimelineItems(selector, activities, isActivity = true) {
        const container = document.querySelector(selector);
        if (container) {
          container.innerHTML = '';
          activities.forEach(activity => {
            const logoURL = schoolLogos[activity.school] || 'logo-placeholder.png';
            const relativeTime = timeAgo(activity.activity_time || activity.created_at);
            let contentHTML = '';

            if (isActivity) {
              contentHTML = `
            <small>${relativeTime}</small>
            <strong>${activity.description}</strong>
            <div class="d-flex flex-wrap gap-2 mt-1">
              <span class="info-badge">
                <i class="fas fa-user-circle text-purple"></i> ${activity.fullname}
              </span>
              <span class="info-badge">
                <img src="${logoURL}" alt="${activity.school}" class="university-logo" />
                ${activity.school}
              </span>
            </div>
          `;
            } else {
              // Trường hợp upload tài liệu
              contentHTML = `
            <small>${relativeTime}</small>
            <strong>Upload đề thi ${activity.file_name}</strong>
            <div class="d-flex flex-wrap gap-2 mt-1">
              <span class="info-badge">
                <i class="fas fa-tag text-success"></i> ${activity.document_type === 'exam' ? 'Đề thi' : 'Đề cương'}
              </span>
              <span class="info-badge">
                <i class="fas fa-database text-info"></i> ${activity.file_size_mb} MB
              </span>
            </div>
          `;
            }

            const timelineHTML = `
          <div class="timeline-item">
            <div class="timeline-content">
              ${contentHTML}
            </div>
          </div>
        `;
            container.insertAdjacentHTML('beforeend', timelineHTML);
          });
          // Áp dụng hiệu ứng animation cho từng item
          container.querySelectorAll('.timeline-item').forEach(function (item, index) {
            item.style.animationDelay = (index * 0.2) + 's';
            item.classList.add('animate');
          });
        }
      }

      // Xử lý khi modal hoạt động được hiển thị
      var activityModal = document.getElementById('activityModal');
      activityModal.addEventListener('shown.bs.modal', function () {
        // Áp dụng animation cho các timeline-item đã có
        activityModal.querySelectorAll('.timeline-item').forEach(function (item, index) {
          item.style.animationDelay = (index * 0.2) + 's';
          item.classList.add('animate');
        });

        // Lấy log hoạt động hệ thống
        fetch('/api/system-activities', { method: 'GET' })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error("Lỗi khi tải log từ backend:", data.error);
              return;
            }
            const viewExamActivities = data.filter(activity => activity.activity_type === 'view_exam');
            const loginActivities = data.filter(activity => activity.activity_type === 'login');
            const registerActivities = data.filter(activity => activity.activity_type === 'register');

            insertTimelineItems('#openExamGroup .timeline-group-items', viewExamActivities);
            insertTimelineItems('#loginGroup .timeline-group-items', loginActivities);
            insertTimelineItems('#registerGroup .timeline-group-items', registerActivities);
          })
          .catch(error => {
            console.error("Lỗi khi tải log từ backend:", error);
          });

        // Lấy danh sách tài liệu mới nhất
        fetch('/api/documents/latest', { method: 'GET' })
          .then(response => response.json())
          .then(docs => {
            insertTimelineItems('#uploadGroup .timeline-group-items', docs, false);
          })
          .catch(error => {
            console.error("Lỗi khi tải tài liệu mới:", error);
          });

        // Lấy thống kê người dùng theo trường
        fetch('/api/users/statistics', { method: 'GET' })
          .then(response => response.json())
          .then(stats => {
            const statisticsList = document.querySelector('.statistics-list');
            if (statisticsList) {
              statisticsList.innerHTML = '';
              stats.forEach(stat => {
                const logoURL = schoolLogos[stat.school] || 'logo-placeholder.png';
                const statHTML = `
              <div class="statistics-item d-flex justify-content-between">
                <div>
                  <img src="${logoURL}" alt="${stat.school}" class="university-logo me-2" />
                  ${stat.school}
                </div>
                <span class="badge bg-primary rounded-pill">${stat.user_count}</span>
              </div>
            `;
                statisticsList.insertAdjacentHTML('beforeend', statHTML);
              });
            }
          })
          .catch(error => {
            console.error("Lỗi khi tải thống kê người dùng:", error);
          });
      });

      // Các xử lý sự kiện khác
      document.getElementById('subscribeBtn').addEventListener('click', function () {
        var form = document.getElementById('notificationForm');
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
      });

      document.getElementById('activateFormBtn').addEventListener('click', function () {
        document.getElementById('additionalForm').style.display = 'block';
      });
    });
  </script>
  <!-- Nút đóng góp đề thi -->
  <button type="button" class="btn btn-primary contribute-btn"
    style="position: fixed; bottom: 0; right: 0; margin: 10px; z-index: 1050;" data-bs-toggle="modal"
    data-bs-target="#contributeExamModal">
    <i class="bi bi-pencil-square"></i> Đóng góp đề thi
  </button>
  <!-- Modal Đóng góp Đề thi -->
  <div class="modal fade" id="contributeExamModal" data-bs-backdrop="false" tabindex="-1"
    aria-labelledby="contributeExamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contributeExamModalLabel">Đóng góp đề thi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <!-- Thông báo thành công, ẩn mặc định -->
          <div id="successAlert" class="alert alert-success" role="alert" style="display: none;">
            Upload thành công!
          </div>
          <!-- Form upload -->
          <form id="contributeExamForm" action="/api/upload_exam" method="POST" enctype="multipart/form-data">
            <!-- Chọn trường -->
            <div class="mb-3">
              <label for="fieldSelect" class="form-label">Chọn trường</label>
              <select class="form-select" id="fieldSelect" name="field">
                <option selected>Đang tải...</option>
              </select>
            </div>
            <!-- Tải file đề thi -->
            <div id="fileInputsContainer">
              <div class="file-input-group mb-3">
                <label class="form-label">Tải file</label>
                <input type="file" class="form-control" name="examFile[]" accept="*/*">
                <p class="form-text mt-2">
                  Bạn có thể chọn file đề thi hoặc đề cương!
                </p>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary" id="addFileInput">
              <i class="bi bi-plus-circle"></i> Thêm file
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <!-- Nút gửi và nút đóng được đặt trong modal footer như cũ -->
          <button type="submit" form="contributeExamForm" class="btn btn-primary">Gửi đóng góp</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load danh sách trường từ API /api/schools
    document.addEventListener('DOMContentLoaded', function () {
      var fieldSelect = document.getElementById('fieldSelect');
      fetch('/api/schools')
        .then(response => response.json())
        .then(data => {
          fieldSelect.innerHTML = '';
          if (data.error) {
            let errorOption = document.createElement('option');
            errorOption.text = 'Lỗi khi tải trường';
            fieldSelect.appendChild(errorOption);
          } else {
            let defaultOption = document.createElement('option');
            defaultOption.text = 'Chọn trường của bạn';
            defaultOption.selected = true;
            fieldSelect.appendChild(defaultOption);
            data.forEach(function (school) {
              let option = document.createElement('option');
              option.value = school.id;
              option.text = school.name + " (" + school.count + ")";
              fieldSelect.appendChild(option);
            });
          }
        })
        .catch(err => {
          console.error(err);
          fieldSelect.innerHTML = '<option>Lỗi khi tải trường</option>';
        });
    });

    // Script thêm file upload mới không kèm ghi chú
    document.getElementById('addFileInput').addEventListener('click', function () {
      var fileGroup = document.createElement('div');
      fileGroup.className = 'file-input-group mb-3';

      var fileLabel = document.createElement('label');
      fileLabel.className = 'form-label';
      fileLabel.innerText = 'Tải file đề thi';
      fileGroup.appendChild(fileLabel);

      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.className = 'form-control';
      fileInput.name = 'examFile[]';
      fileInput.accept = '*/*';
      fileGroup.appendChild(fileInput);

      document.getElementById('fileInputsContainer').appendChild(fileGroup);
    });

    // Xử lý submit form bằng AJAX để hiển thị thông báo thành công trong modal
    document.getElementById('contributeExamForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Ngăn form submit mặc định
      let form = this;
      let formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            // Hiển thị thông báo thành công
            document.getElementById('successAlert').style.display = 'block';
            // Reset form sau khi upload thành công
            form.reset();
            // Cập nhật lại container file với một input mặc định
            document.getElementById('fileInputsContainer').innerHTML = `
            <div class="file-input-group mb-3">
              <label class="form-label">Tải file</label>
              <input type="file" class="form-control" name="examFile[]" accept="*/*">
              <p class="form-text mt-2">
                Bạn có thể chọn file đề thi hoặc đề cương!
              </p>
            </div>
          `;
          } else if (data.error) {
            // Thông báo lỗi nếu có
            alert("Lỗi: " + data.error);
          }
        })
        .catch(error => {
          console.error(error);
          alert("Có lỗi xảy ra khi upload.");
        });
    });
  </script>

  <style>
    .modal-dialog-v3 {
      max-width: 420px;
    }

    .modal-content-v3 {
      background: #f8f9fa;
      /* Nền modal sáng nhẹ */
      border: 1px solid #e0e0e0;
      /* Viền sáng hơn */
      border-radius: 15px;
      transform: perspective(1000px) rotateX(5deg);
      transition: transform 0.3s;
      animation: popIn-v3 0.5s ease-out;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      /* Bóng nhẹ */
    }

    .modal-content-v3:hover {
      transform: perspective(1000px) rotateX(0deg);
    }

    .modal-header-v3 {
      border-bottom: none;
      padding: 2rem 2rem 0;
    }

    .modal-title-v3 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: #333;
      /* Màu chữ tối để nổi trên nền sáng */
    }

    .modal-body-v3 {
      padding: 1.5rem 2rem 2rem;
      text-align: center;
      color: #555;
      /* Màu chữ nhạt hơn cho nội dung */
      font-family: 'Montserrat', sans-serif;
    }

    .btn-custom-v3 {
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.3s;
    }

    .btn-login-v3 {
      background: #007bff;
      /* Màu xanh dương tươi sáng */
      color: #fff;
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-register-v3 {
      background: #ff4d4d;
      /* Màu đỏ nhẹ nhàng */
      color: #fff;
      box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
    }

    .btn-custom-v3:hover {
      transform: translateZ(10px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      /* Bóng đậm hơn khi hover */
    }

    @keyframes popIn-v3 {
      from {
        opacity: 0;
        transform: perspective(1000px) rotateX(20deg);
      }

      to {
        opacity: 1;
        transform: perspective(1000px) rotateX(5deg);
      }
    }
  </style>

  <div class="modal fade" id="loginModal-v3" tabindex="-1" aria-labelledby="loginModalLabel-v3" aria-hidden="true">
    <div class="modal-dialog modal-dialog-v3 modal-dialog-centered">
      <div class="modal-content modal-content-v3">
        <div class="modal-header modal-header-v3">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body modal-body-v3">
          <p class="fs-5 mb-3">Hình như bạn chưa đăng nhập!</p>
          <p class="fs-6 mb-4">Vui lòng đăng nhập hoặc đăng ký để tiếp tục.</p>
          <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-custom-v3 btn-login-v3" data-bs-dismiss="modal" data-bs-toggle="modal"
              data-bs-target="#authModal" onclick="toggleForm('loginForm')">Đăng nhập</button>
            <button type="button" class="btn btn-custom-v3 btn-register-v3" data-bs-dismiss="modal"
              data-bs-toggle="modal" data-bs-target="#authModal" onclick="toggleForm('registerForm')">Đăng ký</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content"
      style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding-bottom: 1rem;">

      <!-- Đăng Nhập -->
      <div id="loginForm" style="display: block;">
        <div class="modal-header text-center"
          style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
          <h5 class="modal-title" id="authModalLabel"
            style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Đăng Nhập</h5>
        </div>
        <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
          <form id="formLogin">
            <div class="mb-3">
              <label for="loginUsername" class="form-label">Tên đăng nhập</label>
              <input type="text" class="form-control" id="loginUsername" placeholder="Nhập tên đăng nhập" required>
            </div>
            <div class="mb-4">
              <label for="loginPassword" class="form-label">Mật khẩu</label>
              <input type="password" class="form-control" id="loginPassword" placeholder="••••••••" required>
            </div>
            <button type="submit" class="btn"
              style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
              Đăng Nhập
            </button>
          </form>
          <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
            <span class="text-muted" style="margin-right: 5px;">Chưa có tài khoản?</span>
            <button onclick="toggleForm('registerForm')" class="btn btn-link p-0"
              style="text-decoration: none; color: #007bff; font-weight: 500;">
              Đăng ký ngay
            </button>
          </div>
        </div>
      </div>

      <!-- Đăng Ký -->
      <div id="registerForm" style="display: none;">
        <div class="modal-header text-center" style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
          <h5 class="modal-title" style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">Đăng Ký</h5>
        </div>
        <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
          <form id="formRegister">
            <!-- Họ và tên -->
            <div class="mb-3">
              <label for="registerFullname" class="form-label">Họ và tên</label>
              <input type="text" class="form-control" id="registerFullname" placeholder="Nguyễn Văn A" required>
            </div>
            <small id="fullnameNote" class="form-note" style="display: none; color: #d9534f; font-size: 0.875rem; font-style: italic;">
              Vui lòng sử dụng tên thật, chúng tôi sẽ tự động xóa những tài khoản tên giả và chặn bạn vĩnh viễn khỏi hệ thống!
            </small>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const fullnameInput = document.getElementById("registerFullname");
                const fullnameNote = document.getElementById("fullnameNote");
                fullnameInput.addEventListener("input", function () {
                  fullnameNote.style.display = "block";
                });
              });
            </script>

            <!-- Tên đăng nhập -->
            <div class="mb-3">
              <label for="registerUsername" class="form-label">Tên đăng nhập</label>
              <input type="text" class="form-control" id="registerUsername" placeholder="Tên đăng nhập" required>
            </div>

            <!-- Mật khẩu với toggle icon -->
            <div class="mb-4">
              <label for="registerPassword" class="form-label">Mật khẩu</label>
              <div class="input-group">
                <input type="password" class="form-control" id="registerPassword" placeholder="••••••••" required>
                <span class="input-group-text" id="togglePassword" style="cursor: pointer;">
                  <i class="fa fa-eye"></i>
                </span>
              </div>
            </div>

            <!-- Xác nhận mật khẩu với toggle icon -->
            <div class="mb-4">
              <label for="confirmPassword" class="form-label">Xác nhận mật khẩu</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirmPassword" placeholder="••••••••" required>
                <span class="input-group-text" id="toggleConfirmPassword" style="cursor: pointer;">
                  <i class="fa fa-eye"></i>
                </span>
              </div>
            </div>
            <!-- Thông báo lỗi nếu mật khẩu không khớp -->
            <div id="passwordError" style="color: #d9534f; font-size: 0.875rem; display: none;">
              Mật khẩu không khớp
            </div>

            <!-- Chọn trường Đại Học -->
            <div class="mb-3">
              <label for="registerUniversity" class="form-label">Trường Đại Học</label>
              <select class="form-control" id="registerUniversity" required>
                <option value="" disabled selected>Chọn trường đại học</option>
              </select>
            </div>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
                // Tải danh sách trường
                fetch("/api/schools")
                  .then(response => response.json())
                  .then(data => {
                    const selectElement = document.getElementById("registerUniversity");
                    data.forEach(school => {
                      const option = document.createElement("option");
                      option.value = school.id;
                      option.textContent = school.name;
                      selectElement.appendChild(option);
                    });
                  })
                  .catch(error => console.error("Lỗi khi tải danh sách trường:", error));

                // Toggle hiển thị mật khẩu cho ô Mật khẩu
                const togglePassword = document.getElementById("togglePassword");
                const passwordInput = document.getElementById("registerPassword");
                togglePassword.addEventListener("click", function () {
                  const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
                  passwordInput.setAttribute("type", type);
                  this.innerHTML = type === "password" ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });

                // Toggle hiển thị mật khẩu cho ô Xác nhận mật khẩu
                const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");
                const confirmPasswordInput = document.getElementById("confirmPassword");
                toggleConfirmPassword.addEventListener("click", function () {
                  const type = confirmPasswordInput.getAttribute("type") === "password" ? "text" : "password";
                  confirmPasswordInput.setAttribute("type", type);
                  this.innerHTML = type === "password" ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });

                // Kiểm tra xem mật khẩu có khớp hay không
                const passwordError = document.getElementById("passwordError");
                confirmPasswordInput.addEventListener("input", function () {
                  if (confirmPasswordInput.value !== passwordInput.value) {
                    passwordError.style.display = "block";
                  } else {
                    passwordError.style.display = "none";
                  }
                });
              });
            </script>

            <!-- Nút đăng ký -->
            <button type="submit" class="btn" style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
              Đăng Ký
            </button>
          </form>
          <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
            <span class="text-muted" style="margin-right: 5px;">Đã có tài khoản?</span>
            <button onclick="toggleForm('loginForm')" class="btn btn-link p-0" style="text-decoration: none; color: #007bff; font-weight: 500;">
              Đăng nhập ngay
            </button>
          </div>
        </div>
      </div>



      <!-- Footer chứa nút Đóng -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
      </div>

    </div>
  </div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /*************************************
   * Các hàm hỗ trợ chuyển đổi giữa form *
   *************************************/
  // Hàm toggleForm: Chuyển đổi hiển thị giữa form đăng nhập và đăng ký
  function toggleForm(formId) {
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    if (formId === "loginForm") {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
    } else {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
    }
  }

  // Khi modal xác thực (authModal) đóng, reset form và hiển thị form đăng nhập
  document.getElementById('authModal').addEventListener('hidden.bs.modal', function () {
    toggleForm('loginForm');
    document.getElementById('formLogin').reset();
    document.getElementById('formRegister').reset();
  });

  /*************************************
   * Hàm kiểm tra và reset lịch sử      *
   *************************************/
  // Hàm checkAndResetHistory: Kiểm tra thông tin trường của user qua API /user/university,
  // so sánh với lịch sử truy cập (examCurrentPath, syllabusCurrentPath) và reset nếu không khớp.
  async function checkAndResetHistory() {
    try {
      const res = await fetch('/user/university', { credentials: 'include' });
      if (res.ok) {
        const userSchool = await res.json();
        window.userSchoolId = userSchool.university;
        console.log("User school id:", window.userSchoolId);
        console.log("Exam history school id:", examCurrentPath.length > 0 ? examCurrentPath[0].id : 'none');
        console.log("Syllabus history school id:", syllabusCurrentPath.length > 0 ? syllabusCurrentPath[0].id : 'none');

        // Nếu lịch sử của Đề Thi không khớp, reset nó
        if (examCurrentPath.length > 0 && String(examCurrentPath[0].id) !== String(window.userSchoolId)) {
          console.log("Reset exam history");
          examCurrentPath = [];
          localStorage.removeItem('examCurrentPath');
        }
        // Nếu lịch sử của Đề Cương không khớp, reset nó
        if (syllabusCurrentPath.length > 0 && String(syllabusCurrentPath[0].id) !== String(window.userSchoolId)) {
          console.log("Reset syllabus history");
          syllabusCurrentPath = [];
          localStorage.removeItem('syllabusCurrentPath');
        }
      } else {
        console.warn("Không thể lấy thông tin trường của user");
      }
    } catch (error) {
      console.error("Lỗi khi kiểm tra lịch sử trường:", error);
    }
  }

  /*************************************
   * Xử lý đăng nhập                   *
   *************************************/
document.getElementById('formLogin').addEventListener('submit', function (e) {
  e.preventDefault();

  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  // Kiểm tra username: chỉ cho phép chữ (không dấu) và số, không có khoảng trắng
  const usernameRegex = /^[a-zA-Z0-9]+$/;
  if (!usernameRegex.test(username)) {
    triggerNotification('warning', 'Cảnh báo', 'Vui lòng tuân thủ quy tắc đặt user name: không dấu, không cách.');
    return;
  }

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        triggerNotification('danger', 'Lỗi', data.error);
      } else {
        triggerNotification('success', 'Thành công', data.message);
        // Đóng modal sau khi đăng nhập thành công
        const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
        authModal.hide();
        // Giữ nguyên logic check lịch sử, sau đó delay 5s rồi reload trang
        checkAndResetHistory()
          .then(() => new Promise(resolve => setTimeout(resolve, 5000)))
          .then(() => {
            window.parent.location.reload();
          });
      }
    })
    .catch(error => {
      console.error('Lỗi:', error);
      triggerNotification('danger', 'Lỗi', 'Đã xảy ra lỗi khi đăng nhập');
    });
});

/*************************************
 * Xử lý đăng ký                     *
 *************************************/
document.getElementById('formRegister').addEventListener('submit', function (e) {
  e.preventDefault();

  const fullname = document.getElementById('registerFullname').value;
  const username = document.getElementById('registerUsername').value;
  const password = document.getElementById('registerPassword').value;
  const university = document.getElementById('registerUniversity').value;

  // Kiểm tra username: chỉ cho phép chữ (không dấu) và số, không có khoảng trắng
  const usernameRegex = /^[a-zA-Z0-9]+$/;
  if (!usernameRegex.test(username)) {
    triggerNotification('warning', 'Cảnh báo', 'Vui lòng tuân thủ quy tắc đặt user name: không dấu, không cách.');
    return;
  }

  fetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fullname, username, password, university })
  })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        triggerNotification('danger', 'Lỗi', data.error);
        // Nếu lỗi do IP đã tồn tại thì tự mở modal có id "accountModal"
        if (data.error.includes("IP đã được sử dụng")) {
          // Đóng modal hiện tại (giả sử modal đăng nhập/đăng ký có id "authModal")
          var authModalEl = document.getElementById('authModal');
          var authModalInstance = bootstrap.Modal.getInstance(authModalEl);
          if (authModalInstance) {
            authModalInstance.hide();
          }
          // Mở modal mới có id "accountModal"
          var accountModal = new bootstrap.Modal(document.getElementById("accountModal"));
          accountModal.show();
        }
      } else {
        triggerNotification('success', 'Thành công', data.message);
        // Sau khi đăng ký thành công, chuyển sang form đăng nhập
        toggleForm('loginForm');
        // Reset form đăng ký
        document.getElementById('formRegister').reset();
        // Tự động điền thông tin đăng nhập vừa đăng ký vào form đăng nhập
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = password;
      }
    })
    .catch(error => {
      console.error('Lỗi:', error);
      triggerNotification('danger', 'Lỗi', 'Đã xảy ra lỗi khi đăng ký');
    });
});

  /*************************************
   * Xử lý đăng xuất                   *
   *************************************/
  document.getElementById('logoutBtn').addEventListener('click', function () {
    fetch("/api/logout", {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" }
    })
      .then(response => response.json())
      .then(data => {
        // Hiển thị thông báo đăng xuất thành công
        triggerNotification('success', 'Thành công', data.message);
        // Chuyển hướng về trang chủ sau 2000ms
        setTimeout(() => {
          window.location.href = "/";
        }, 2000);
      })
      .catch(error => {
        triggerNotification('error', 'Lỗi', 'Có lỗi khi đăng xuất.');
        console.error("Lỗi:", error);
      });
  });

  /*************************************
   * DOMContentLoaded: Các sự kiện bổ sung *
   *************************************/
  document.addEventListener("DOMContentLoaded", function () {
    // Các sự kiện hoặc thao tác DOM bổ sung có thể đặt tại đây.
    // Ví dụ: Tự động điền thông tin đăng nhập sau đăng ký đã được xử lý ở formRegister.
  });
</script>

<!-- Modal Xác thực -->
<div class="modal fade" id="verificationModal-v2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <!-- Header sử dụng Shadow DOM với hậu tố _v2 -->
      <modal-header-v2></modal-header-v2>

      <!-- Body -->
      <div class="modal-body pt-0">
        <p class="text-muted mb-4">
          Tài khoản của bạn chưa được xác thực. Bạn cần chọn 1 trong 2 cách sau nhé! 😊
        </p>

        <!-- Phương thức 1: Đóng góp ảnh đề thi -->
        <div class="card mb-3 border-primary card-method-v2">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-cloud-upload fs-3 text-primary me-2"></i>
              <div>
                <h6 class="mb-1">Đóng góp ảnh đề thi</h6>
                <p class="text-muted small mb-0">
                  Chia sẻ ảnh đề thi bất kỳ để cộng đồng cùng học tập
                </p>
              </div>
            </div>
            <div class="position-relative">
              <!-- File input cho ảnh đề thi -->
              <input type="file" id="examImageUpload_v2" accept="image/*" class="d-none" multiple
                     data-container="fileNameExamImage_v2" onchange="handleFileUpload_v2(event, 'exam')">
              <label for="examImageUpload_v2" class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                <i class="bi bi-upload me-2"></i>Chọn ảnh đề thi
              </label>
              <div id="fileNameExamImage_v2" class="text-muted small mt-2"></div>
            </div>
            <!-- Nút gửi file -->
            <button class="btn btn-success btn-sm mt-2" onclick="submitExamImage_v2()">
              <i class="bi bi-send me-2"></i>Gửi ảnh đề thi
            </button>
          </div>
        </div>

        <!-- Phương thức 2: Chia sẻ với bạn bè -->
        <div class="card border-success card-method-v2">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <i class="bi bi-share fs-3 text-success me-2"></i>
              <div>
                <h6 class="mb-1">Chia sẻ với bạn bè</h6>
                <p class="text-muted small mb-0">
                  Share trang web cho 2 người bạn để xác thực
                </p>
              </div>
            </div>

            <div class="input-group mb-3">
              <div id="copyContent_v2" class="form-control bg-light">
                Kho lưu trữ đề thi và đề cương qua các năm, tại: huehub.fun
              </div>
              <button class="btn btn-success btn-copy-v2" onclick="copyText_v2()">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
            <div id="copySuccess_v2" class="text-success small mt-2" style="display:none;">
              <i class="bi bi-check2"></i> Đã sao chép!
            </div>

            <!-- Ghi chú hướng dẫn chụp màn hình -->
            <div class="mt-2">
              <small class="text-muted">
                Ghi chú: Vui lòng coppy rồi gửi cho bạn bè đảm bảo có sự tương tác của họ rồi chụp lại màn hình sau khi chia sẻ, sau đó ấn "Xác nhận đã chia sẻ"!
              </small>
            </div>
            <div class="position-relative">
              <!-- File input cho ảnh chụp màn hình -->
              <input type="file" id="shareScreenshotUpload_v2" accept="image/*" class="d-none"
                     data-container="fileNameShareScreenshot_v2" onchange="handleFileUpload_v2(event, 'share')">
              <label for="shareScreenshotUpload_v2" class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                <i class="bi bi-upload me-2"></i>Chọn ảnh màn hình
              </label>
              <div id="fileNameShareScreenshot_v2" class="text-muted small mt-2"></div>
            </div>

            <!-- Nút xác nhận đã chia sẻ -->
            <button class="btn btn-outline-success w-100 btn-confirm-share-v2 mt-2" onclick="confirmShare_v2()">
              <i class="bi bi-check-circle me-2"></i>Xác nhận đã chia sẻ
            </button>
            <div id="confirmSuccess_v2" class="text-success small mt-2 text-center" style="display:none;">
              <i class="bi bi-check2-circle"></i> Đã xác nhận chia sẻ!
            </div>
          </div>
        </div>

        <!-- Khu vực hiển thị thông tin xác thực -->
        <div id="verification-alert" class="alert alert-danger mt-3" style="display: none;">
          <p class="mb-1">
            <strong>Lần xác thực gần nhất:</strong> <span id="last-rejected-time">12/03/2025 09:45</span>
          </p>
          <p class="mb-0">
            <strong>Lý do từ chối:</strong> <span id="rejection-note">Thông tin xác thực không hợp lệ, vui lòng kiểm tra lại</span>
          </p>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary btn-close-v2" data-bs-dismiss="modal">
          Để sau đi
        </button>
      </div>
    </div>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    fetch('https://huehub.fun/get_verification_info', {
        method: 'GET',
        credentials: 'include', // Gửi cookie session để server nhận diện người dùng
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const alertDiv = document.getElementById('verification-alert');
        const lastRejectedTimeSpan = document.getElementById('last-rejected-time');
        const rejectionNoteSpan = document.getElementById('rejection-note');

        if (data.status === 'rejected') {
            // Cập nhật nội dung từ API
            lastRejectedTimeSpan.textContent = data.last_rejected_time || 'Không có dữ liệu';
            rejectionNoteSpan.textContent = data.note || 'Không có ghi chú';
            alertDiv.style.display = 'block'; // Hiển thị khi có dữ liệu
        } else {
            alertDiv.style.display = 'none'; // Ẩn nếu không có bản ghi bị từ chối
        }
    })
    .catch(error => {
        console.error('Lỗi khi gọi API:', error);
        document.getElementById('verification-alert').style.display = 'none'; // Ẩn nếu có lỗi
    });
});
</script>
  <!-- Định nghĩa custom element sử dụng Shadow DOM cho header, với tên có hậu tố _v2 -->
  <script>
    class ModalHeaderV2 extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
        shadow.innerHTML = `
        <style>
          .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 0;
            padding: 1rem;
            padding-bottom: 0;
            background-color: transparent;
          }
          .header h5 {
            color: #0d6efd;
            margin: 0;
            font-size: 1.25rem;
          }
          .header button {
            background: transparent;
            border: none;
            cursor: pointer;
          }
        </style>
        <div class="header">
          <h5 class="modal-title">
            <i class="bi bi-patch-exclamation me-2"></i> Xác thực tài khoản
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      `;
      }
    }
    customElements.define('modal-header-v2', ModalHeaderV2);
  </script>

  <script>
// Biến lưu file riêng cho từng phương thức
let examFiles_v2 = [];
let shareFile_v2 = null;

// Hàm xử lý khi chọn file (hậu tố _v2)
function handleFileUpload_v2(event, type) {
  const newFiles = Array.from(event.target.files);
  const containerId = event.target.getAttribute('data-container');
  let fileListHtml = '';

  if (type === 'exam') {
    // Với ảnh đề thi: cộng dồn vào mảng examFiles_v2
    examFiles_v2 = examFiles_v2.concat(newFiles);
    examFiles_v2.forEach(file => {
      fileListHtml += `<div><i class="bi bi-file-image"></i> Đã chọn: ${file.name}</div>`;
    });
  } else if (type === 'share') {
    // Với ảnh share: chỉ lưu file đầu tiên được chọn
    shareFile_v2 = newFiles[0];
    fileListHtml += `<div><i class="bi bi-file-image"></i> Đã chọn: ${shareFile_v2.name}</div>`;
  }
  document.getElementById(containerId).innerHTML = fileListHtml;
  // Reset giá trị của input để cho phép chọn lại file nếu cần
  event.target.value = '';
}

// Hàm gửi ảnh đề thi khi nhấn "Gửi ảnh đề thi" (không thay đổi)
function submitExamImage_v2() {
    console.log("DEBUG: Hàm submitExamImage_v2 được gọi");

    // Kiểm tra file được chọn (ảnh đề thi)
    if (!examFiles_v2 || examFiles_v2.length === 0) {
        console.error("ERROR: Không có ảnh đề thi được chọn.", { examFiles_v2 });
        triggerNotification('error', 'Lỗi', 'Vui lòng chọn ảnh đề thi trước khi gửi.');
        return;
    }
    console.log("DEBUG: Số lượng file được chọn:", examFiles_v2.length);

    // Tạo mảng các promise để upload file
    const uploadPromises = examFiles_v2.map(file => {
        console.log("DEBUG: Bắt đầu upload file:", file.name);
        return uploadFile_v2(file, 'exam')
            .then(response => {
                console.log("DEBUG: Upload file thành công:", response);
                return response;
            })
            .catch(error => {
                console.error("ERROR: Lỗi khi upload file:", error);
                throw error;
            });
    });

    // Thực hiện upload tất cả file
    Promise.all(uploadPromises)
        .then(results => {
            console.log("DEBUG: Kết quả upload file:", results);

            // Kiểm tra kết quả upload
            const uploadedFilePaths = results.map(result => {
                if (!result || !result.filepath) {
                    console.error("ERROR: Upload file không trả về filepath hợp lệ", result);
                    throw new Error("Upload file không trả về filepath hợp lệ");
                }
                return result.filepath;
            });
            console.log("DEBUG: Danh sách file path sau upload:", uploadedFilePaths);

            // Reset giao diện sau khi upload thành công
            examFiles_v2 = [];
            document.getElementById('fileNameExamImage_v2').innerHTML = "";

            // Gọi API cập nhật trạng thái tài khoản
            console.log("DEBUG: Gọi API cập nhật trạng thái tài khoản...");
            return fetch('/update_account_status_v2', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
        })
        .then(response => {
            console.log("DEBUG: Response status của update_account_status_v2:", response.status);
            if (!response.ok) {
                throw new Error(`Lỗi HTTP! status: ${response.status}`);
            }
            return response.json();
        })
        .then(statusData => {
            console.log("DEBUG: Response từ update_account_status_v2:", statusData);

            // Hiển thị thông báo thành công chung
            triggerNotification('warning', 'Thông báo', 'Tài khoản của bạn đang được xét duyệt, vui lòng đợi');

            // Đóng modal sau 2 giây
            setTimeout(() => {
                const modalElement = document.getElementById('verificationModal-v2');
                let modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalElement);
                }
                modalInstance.hide();
            }, 2000);
        })
        .catch(error => {
            console.error('ERROR: Lỗi trong quá trình upload hoặc cập nhật:', error);
            // Hiển thị thông báo lỗi chung
            triggerNotification('error', 'Lỗi', 'Đã xảy ra lỗi. Vui lòng thử lại.');
        });
}
function uploadFile_v2(file, type) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('type', type);

  return fetch('/upload_v2', {
    method: 'POST',
    body: formData
  })
    .then(response => {
      console.log(`Response từ uploadFile_v2 (${type}):`, response);
      return response.json();
    })
    .then(data => {
      console.log('Upload thành công:', data);
      return data;
    })
    .catch(error => {
      console.error(`ERROR: Lỗi khi upload file (${type}):`, error);
      throw error;
    });
}

function copyText_v2() {
  const text = document.getElementById('copyContent_v2').innerText;
  navigator.clipboard.writeText(text);

  const successMsg = document.getElementById('copySuccess_v2');
  successMsg.style.display = 'block';
  setTimeout(() => successMsg.style.display = 'none', 2000);
}

// Hàm xác nhận đã chia sẻ: chỉ upload ảnh màn hình khi người dùng ấn nút xác nhận
function confirmShare_v2() {
    // Kiểm tra xem người dùng đã chọn ảnh chưa
    if (!shareFile_v2) {
        alert("Vui lòng chọn ảnh màn hình trước khi xác nhận.");
        return;
    }

    // Upload ảnh chia sẻ
    uploadFile_v2(shareFile_v2, 'share')
        .then(data => {
            console.log("Upload ảnh chia sẻ thành công:", data);

            // Reset file và giao diện sau khi upload thành công
            shareFile_v2 = null;
            document.getElementById('fileNameShareScreenshot_v2').innerHTML = "";

            // Gọi API cập nhật trạng thái tài khoản
            console.log("Gọi API cập nhật trạng thái tài khoản...");
            return fetch('/update_account_status_v2', {
                method: 'POST',
                credentials: 'include', // Server sẽ lấy user_id từ session
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
        })
        .then(response => {
            console.log("Response status của update_account_status_v2:", response.status);
            if (!response.ok) {
                throw new Error(`Lỗi HTTP! status: ${response.status}`);
            }
            return response.json();
        })
        .then(statusData => {
            console.log("Response từ update_account_status_v2:", statusData);

            // Hiển thị thông báo thành công
            triggerNotification('success', 'Thành công', 'Ảnh chia sẻ đã được upload và trạng thái tài khoản đã được cập nhật.');

            // Đóng modal sau 2 giây
            setTimeout(() => {
                const modalElement = document.getElementById('verificationModal-v2');
                let modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalElement);
                }
                modalInstance.hide();
            }, 2000);
        })
        .catch(error => {
            console.error("Lỗi khi upload ảnh chia sẻ hoặc cập nhật trạng thái:", error);
            // Hiển thị thông báo lỗi
            triggerNotification('error', 'Lỗi', 'Đã xảy ra lỗi. Vui lòng thử lại.');
        });
}
    function copyText_v2() {
      const text = document.getElementById('copyContent_v2').innerText;
      navigator.clipboard.writeText(text);

      const successMsg = document.getElementById('copySuccess_v2');
      successMsg.style.display = 'block';
      setTimeout(() => successMsg.style.display = 'none', 2000);
    }

  </script>

  <style>
    .cursor-pointer {
      cursor: pointer;
    }

    .modal-content {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .card-method-v2 {
      transition: transform 0.2s;
    }

    .btn-success {
      background: #28a745;
      border-color: #28a745;
    }

    .btn-confirm-share-v2 {
      transition: background-color 0.2s, color 0.2s;
    }

    .btn-confirm-share-v2:hover {
      background-color: #28a745;
      color: white;
    }
  </style>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* CSS cho thiết bị di động */
    @media (max-width: 576px) {

      /* Điều chỉnh kích thước modal */
      .modal-dialog {
        max-width: 95%;
        margin: 1rem auto;
      }

      /* Điều chỉnh padding cho modal */
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      /* Điều chỉnh tiêu đề modal */
      .modal-title {
        font-size: 1.25rem;
      }

      /* Sắp xếp lại các cột hoạt động theo dạng dọc */
      .activity-container {
        display: flex;
        flex-direction: column;
      }

      /* Cho mỗi hộp hoạt động chiếm toàn bộ chiều rộng */
      .activity-box {
        width: 100%;
        margin-bottom: 1rem;
      }
    }
  </style>


  <style>
    /* Container chứa 2 cột */
    .activity-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Khung thông báo của mỗi cột */
    .activity-box {
      flex: 1;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
      animation: fadeIn 0.6s forwards;
    }

    /* Hiệu ứng fade-in */
    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    /* Tiêu đề mỗi cột */
    .activity-box h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      border-bottom: 2px solid;
      padding-bottom: 10px;
    }

    /* Phân biệt tiêu đề từng cột */
    .user-activity h3 {
      border-color: #007bff;
      color: #007bff;
    }

    .system-activity h3 {
      border-color: #28a745;
      color: #28a745;
    }

    /* Các mục trong danh sách */
    .list-group-item {
      border: none;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      background-color: transparent !important;
    }


    .list-group-item:last-child {
      border-bottom: none;
    }

    .list-group-item {
      background-color: transparent !important;
      backdrop-filter: none !important;
      box-shadow: none !important;
    }

    .list-group-item:hover,
    .list-group-item:focus,
    .list-group-item:active {
      background-color: transparent !important;
    }

    /* Nội dung hoạt động */
    .activity-text {
      display: block;
      font-size: 1rem;
      color: #555;
    }

    /* Thời gian hoạt động */
    .activity-time {
      font-size: 0.9rem;
      color: #888;
      font-style: italic;
      margin-top: 5px;
    }
  </style>
  </div>
  </div>
  </div>
  </div>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <style>
            /* Container chứa cả hai cột */
            .activity-container {
              display: flex;
              gap: 20px;
              padding: 20px;
              background-color: #f9f9f9;
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            /* Cột hoạt động của người dùng và hệ thống */
            .user-activity,
            .system-activity {
              flex: 1;
              background: #ffffff;
              border-radius: 12px;
              padding: 20px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            /* Tiêu đề mỗi cột */
            .user-activity h3,
            .system-activity h3 {
              font-size: 1.5rem;
              margin-bottom: 20px;
              color: #333;
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              border-bottom: 2px solid #007bff;
              padding-bottom: 10px;
            }

            /* Phân biệt tiêu đề cột người dùng và hệ thống */
            .user-activity h3 {
              color: #007bff;
              /* Màu xanh dương cho người dùng */
            }

            .system-activity h3 {
              color: #28a745;
              /* Màu xanh lá cho hệ thống */
            }

            /* Khung hoạt động */
            .activity-box {
              background: #f9f9f9;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .activity-box:hover {
              transform: translateY(-5px);
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            /* Nội dung trong khung hoạt động */
            .activity-box p {
              margin: 0;
              font-size: 1rem;
              color: #555;
            }

            .activity-box strong {
              color: #333;
            }

            /* Thời gian hoạt động */
            .activity-time {
              display: block;
              margin-top: 10px;
              font-size: 0.9rem;
              color: #888;
              font-style: italic;
            }
          </style>
          <p>Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?</p>
          <p id="resumePathDisplay"></p>

        </div>
        <div class="modal-footer">

          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu
            mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>

        </div>
      </div>
    </div>
  </div>

  <!-- CSS bổ sung -->
  <style>
    /* Tùy chỉnh giao diện Modal */
    .modal-content {
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      border: none;
    }

    .modal-header,
    .modal-footer {
      border: none;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.5rem;
    }

    .btn-close {
      font-size: 1.25rem;
    }

    .modal-body p {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #333;
    }

    #resumePathDisplay {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #565e64;
    }
  </style>

  <!-- Modal Resume: Gợi ý "Tiếp tục xem" có nút Lịch sử xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Bạn có muốn tiếp tục xem từ chỗ dở dang của <strong id="resumeTabName"></strong>?
          </p>
          <p id="resumePathDisplay" class="text-muted"></p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">Bắt đầu
            mới</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Tiếp tục</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal -->
  <!-- Modal đăng ký tài khoản & cấp lại mật khẩu -->
  <div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header gradient-bg text-white">
          <h5 class="modal-title">
            <i class="bi bi-shield-lock-fill me-2"></i>
            Đăng ký tài khoản & Cấp lại mật khẩu
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          <!-- Thông báo IP -->
          <div class="alert alert-warning small d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
              Địa chỉ IP của bạn: <span id="userIP" class="fw-bold">...</span>
              <br>Mỗi IP chỉ được tạo tối đa 1 tài khoản
            </div>
          </div>

          <!-- Danh sách tài khoản -->
          <div id="accountList" class="mb-4 d-none">
            <h6 class="mb-3 fw-bold text-muted">
              <i class="bi bi-person-lines-fill me-2"></i>
              Tài khoản đã đăng ký:
            </h6>
            <div class="row g-3" id="accountCards"></div>
          </div>

          <!-- Form bước 1: Nhập username (kiểm tra xem đã đăng ký hay chưa) -->
          <form id="step1Form">
            <div class="instruction-box">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-info-circle me-2"></i>
                Hướng dẫn nhập username:
              </h6>
              <p class="small mb-0">
                Nhập username của bạn vào ô bên dưới. Chúng tôi sẽ kiểm tra và cho phép cấp lại mật khẩu nếu tài khoản đã đăng ký.
              </p>
            </div>
            
            <div class="mb-4">
              <label class="form-label fw-bold">Nhập username:</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-person-fill"></i>
                </span>
                <input type="text" 
                       class="form-control" 
                       name="username" 
                       required
                       placeholder="Nhập username..."
                       pattern="[A-Za-z0-9]{4,20}">
              </div>
              <div class="form-text">Username từ 4-20 ký tự, chỉ chứa chữ và số</div>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-custom">
                <span class="submit-text">Tiếp tục</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>

          <!-- Form bước 2: Nhập email để nhận mật khẩu mới -->
          <form id="step2Form" class="d-none">
            <div class="instruction-box">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-info-circle me-2"></i>
                Hướng dẫn nhập email:
              </h6>
              <p class="small mb-0">
                Vui lòng nhập địa chỉ email của bạn. Chúng tôi sẽ gửi mật khẩu mới nhất về email này.
                <br>Đảm bảo email chính xác để nhận được thông tin tài khoản.
              </p>
            </div>
            
            <div class="mb-4">
              <label class="form-label fw-bold">Nhập email nhận mật khẩu mới:</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-envelope-fill"></i>
                </span>
                <input type="email" 
                       class="form-control" 
                       name="email" 
                       required
                       placeholder="Nhập email...">
              </div>
              <div class="form-text">Vui lòng kiểm tra cả hộp thư spam nếu không thấy email</div>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-custom">
                <span class="submit-text">Gửi mật khẩu</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>

          <!-- Thông báo (lỗi hoặc thành công) -->
          <div id="responseMessage" class="mt-3 d-none"></div>
          <!-- Thông báo lỗi riêng cho form kiểm tra username -->
          <div id="errorMessage" class="alert alert-danger mt-3 d-none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Bootstrap JS và dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 1. Chèn CSS mới, scope chỉ cho modal #accountModal
      const dynamicStyle = document.createElement('style');
      dynamicStyle.textContent = `
        /* Các biến CSS nếu cần thiết */
        #accountModal .gradient-bg {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
        }
        #accountModal .custom-card {
          border: none;
          border-radius: 15px;
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
          box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }
        #accountModal .custom-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
        }
        #accountModal .btn-custom {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          border: none;
          color: white;
          padding: 12px 30px;
          border-radius: 30px;
          font-weight: 500;
          letter-spacing: 0.5px;
          transition: all 0.3s ease;
        }
        #accountModal .btn-custom:hover {
          transform: scale(1.05);
          box-shadow: 0 8px 25px rgba(106, 17, 203, 0.4);
        }
        #accountModal .form-control {
          border-radius: 10px;
          padding: 12px 20px;
          border: 2px solid #e9ecef;
          transition: all 0.3s ease;
        }
        #accountModal .form-control:focus {
          border-color: #6a11cb;
          box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }
        #accountModal .instruction-box {
          background: rgba(255, 255, 255, 0.9);
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 25px;
          border: 1px solid rgba(0, 0, 0, 0.05);
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        #accountModal .modal-content {
          border-radius: 20px;
          overflow: hidden;
          border: none;
        }
        #accountModal .error-shake {
          animation: shake 0.5s;
        }
        @keyframes shake {
          0% { transform: translateX(0); }
          25% { transform: translateX(-10px); }
          50% { transform: translateX(10px); }
          75% { transform: translateX(-5px); }
          100% { transform: translateX(0); }
        }
        #accountModal .input-group-text {
          background: white;
          border: 2px solid #e9ecef;
          border-right: none;
          border-radius: 10px 0 0 10px;
        }
        #accountModal .form-text {
          font-size: 0.85rem;
          color: #6c757d !important;
        }
        #accountModal .alert {
          border-radius: 10px;
          padding: 15px 20px;
        }
      `;
      document.head.appendChild(dynamicStyle);
      
      // 2. Các xử lý DOM bên trong modal
      // Khởi tạo modal với backdrop tắt (không có nền đen)
      const modal = new bootstrap.Modal(document.getElementById('accountModal'), { backdrop: false });
      const userIP = document.getElementById('userIP');
      const accountCards = document.getElementById('accountCards');
      const step1Form = document.getElementById('step1Form');
      const step2Form = document.getElementById('step2Form');
      const errorMessage = document.getElementById('errorMessage');
      const responseMessage = document.getElementById('responseMessage');
      
      // Biến chứa danh sách username đã đăng ký (được cập nhật từ API)
      let registeredUsernames = [];
      // Biến toàn cục lưu username hợp lệ đã kiểm tra ở bước 1
      let validatedUsername = "";
      
      // Lấy IP thực tế qua ipify
      fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
          userIP.textContent = data.ip;
          checkIPLimit(data.ip);
        })
        .catch(error => {
          console.error('Lỗi khi lấy IP:', error);
          userIP.textContent = 'Không lấy được IP';
        });
      
      // Hàm format username: ẩn phần giữa (ví dụ: "us****23")
      function formatUsername(username) {
        if (username.length <= 4) return username;
        return username.substr(0, 2) +
               '*'.repeat(username.length - 4) +
               username.substr(-2);
      }
      
      // Kiểm tra IP và hiển thị danh sách tài khoản nếu có
      function checkIPLimit(ip) {
        fetch('/api/accounts_by_ip')
          .then(response => response.json())
          .then(data => {
            registeredUsernames = data.usernames || [];
            if (registeredUsernames.length > 0) {
              document.getElementById('accountList').classList.remove('d-none');
              accountCards.innerHTML = registeredUsernames
                .map(acc => `
                  <div class="col-md-6">
                    <div class="custom-card p-3 bg-light">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-person-circle me-3 fs-4 text-primary"></i>
                        <div>
                          <div class="fw-bold">${formatUsername(acc)}</div>
                          <small class="text-muted">Đã đăng ký</small>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('');
            }
          })
          .catch(error => {
            console.error('Lỗi khi lấy danh sách tài khoản:', error);
          });
      }
      
      // Xử lý form bước 1: Kiểm tra username
      step1Form.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const spinner = btn.querySelector('.spinner-border');
        const text = btn.querySelector('.submit-text');
        const usernameInput = this.querySelector('input[name="username"]');
        const username = usernameInput.value.trim();
        
        // Hiển thị loading
        text.classList.add('d-none');
        spinner.classList.remove('d-none');
        btn.disabled = true;
        errorMessage.classList.add('d-none');
        
        // Kiểm tra username dựa trên danh sách lấy từ API
        setTimeout(() => {
          const isUsernameValid = registeredUsernames.includes(username);
          
          if (isUsernameValid) {
            validatedUsername = username; // lưu username đã được kiểm tra
            step1Form.classList.add('d-none');
            step2Form.classList.remove('d-none');
          } else {
            errorMessage.innerHTML = `
              <i class="bi bi-exclamation-circle-fill me-2"></i>
              Vui lòng nhập đúng username bạn đã đăng ký!
            `;
            errorMessage.classList.remove('d-none');
            usernameInput.classList.add('error-shake');
            setTimeout(() => usernameInput.classList.remove('error-shake'), 500);
            usernameInput.focus();
          }
          
          // Ẩn loading
          text.classList.remove('d-none');
          spinner.classList.add('d-none');
          btn.disabled = false;
        }, 1000);
      });
      
      // Xử lý form bước 2: Gửi yêu cầu cấp lại mật khẩu (lưu email và username)
      step2Form.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const spinner = btn.querySelector('.spinner-border');
        const text = btn.querySelector('.submit-text');
        const emailInput = this.querySelector('input[name="email"]');
        const email = emailInput.value.trim();
        
        // Hiển thị loading
        text.classList.add('d-none');
        spinner.classList.remove('d-none');
        btn.disabled = true;
        responseMessage.classList.add('d-none');
        responseMessage.innerHTML = "";
        
        // Gửi yêu cầu qua API
        fetch('/api/request_password_reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: validatedUsername, email: email })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            responseMessage.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          } else {
            responseMessage.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
          }
          responseMessage.classList.remove('d-none');
        })
        .catch(error => {
          console.error('Lỗi:', error);
          responseMessage.innerHTML = `<div class="alert alert-danger">Đã xảy ra lỗi khi gửi yêu cầu.</div>`;
          responseMessage.classList.remove('d-none');
        })
        .finally(() => {
          text.classList.remove('d-none');
          spinner.classList.add('d-none');
          btn.disabled = false;
          // Ẩn modal sau vài giây (nếu muốn)
          setTimeout(() => modal.hide(), 3000);
        });
      });
      
      // Nếu muốn tự động mở modal khi DOM đã sẵn sàng, bỏ comment dòng sau:
      // modal.show();
    });
  </script>
  <!-- Modal Tìm kiếm Môn học -->
  <div class="modal fade" id="customSearchModal" tabindex="-1" aria-labelledby="customSearchModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
        <!-- Modal Header -->
        <div class="custom-modal-header"
          style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 16px;">
          <h5 class="custom-modal-title" id="customSearchModalLabel"
            style="font-size: 1.25rem; font-weight: 600; color: #0d6efd;">
            <i class="fas fa-book-open me-2"></i>Tìm kiếm Môn học
          </h5>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <!-- Search Input Group -->
          <div class="custom-search-input-group" style="position: relative; margin-bottom: 1rem;">
            <input type="text" id="subjectSearchInput" class="form-control form-control-lg"
              placeholder="Nhập tên môn học..." aria-label="Search input"
              style="border-radius: 8px; padding-right: 50px; border: 1px solid #ced4da;">
            <button type="button"
              style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 8px 8px 0; background-color: #0d6efd; border: none; color: #fff;"
              onmouseover="this.style.backgroundColor='#0b5ed7'" onmouseout="this.style.backgroundColor='#0d6efd'">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <!-- Tip Text (Thông báo chọn trường) -->
          <div id="schoolSelectionNotice" class="custom-tip-text d-none"
            style="display: flex; align-items: center; padding: 10px 15px; background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%); border-radius: 4px; font-size: 0.9em; color: #333; margin-top: 8px; margin-bottom: 16px;">
            <i class="fas fa-lightbulb icon-combined" style="font-size: 1em; margin-right: 10px;"></i>
            Thứ bạn cần là thứ người khác có, cho nên đừng ngần ngại đóng góp dữ liệu để xây dựng cộng đồng nhé!
          </div>

          <!-- Kết quả tìm kiếm -->
          <h6 id="searchResultCount" class="text-muted mb-3">Kết quả tìm kiếm (0)</h6>
          <div id="subjectSearchSuggestions" class="custom-scrollable-results"
            style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
            <!-- Các kết quả tìm kiếm sẽ được chèn vào đây qua JS -->
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="custom-modal-footer"
          style="background-color: #f8f9fa; border-top: 1px solid #e9ecef; padding: 16px; display: flex; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (bao gồm Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- HTML Imports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ==================================================
       PDF.js Worker Configuration
       - Chỉ cần khai báo một lần để cấu hình PDF.js worker
       ================================================== */
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';


    /* ==================================================
       Global Variables
       - Các biến toàn cục dùng trong toàn bộ ứng dụng
       ================================================== */
    let examCurrentPath = [];
    let syllabusCurrentPath = [];
    let currentRotation = 0;
    let adTimer = null;
    let currentFile = null;


    /* ==================================================
       Function: renderDrive
       Mô tả:
         - Hiển thị danh sách file/folder từ backend dựa theo đường dẫn (path)
         - Hiển thị spinner trong khi tải dữ liệu, breadcrumb, thanh tìm kiếm inline và nút tìm kiếm nâng cao
       Tham số:
         @containerId         : ID của phần tử container hiển thị drive
         @path                : Mảng đường dẫn hiện tại
         @updatePathCallback  : Hàm callback cập nhật đường dẫn khi người dùng click chọn folder
       ================================================== */
// Hàm renderFolderItem: Tạo mục folder và hiển thị số đếm nếu count > 0
function renderFolderItem(list, name, currentPath, callback, count, itemId) {
  const li = document.createElement('li');
  li.className = 'file-item';

  // Nếu count > 0 thì hiển thị số đếm, nếu count = 0 thì không hiển thị
  const countHTML = count > 0 ? `<span class="file-count">${count}</span>` : '';

  li.innerHTML = `
    <i class="bi bi-folder-fill file-icon folder"></i>
    <span class="file-name">${name}</span>
    ${countHTML}
  `;

  li.addEventListener('click', () => {
    callback([...currentPath, { id: itemId, name }]);
  });

  list.appendChild(li);
}

// Hàm renderDrive: Hiển thị danh sách file/folder dựa theo đường dẫn (path)
// Cho phép duyệt theo cấu trúc: Trường → Khoa → Môn → Năm → File
async function renderDrive(containerId, path, updatePathCallback) {
  const documentType = containerId.includes('exam') ? 'exam' : 'syllabus';
  const container = document.getElementById(containerId);
  if (!container) {
    console.error(`Không tìm thấy container với ID: ${containerId}`);
    return;
  }
  container.innerHTML = '';

  // Hiển thị spinner khi tải dữ liệu
  const spinner = document.createElement('div');
  spinner.className = 'spinner';
  spinner.textContent = 'Loading...';
  container.appendChild(spinner);

  let data = [];
  try {
    if (path.length === 0) {
      // Khi path rỗng, lấy thông tin trường của user từ API /user/university
      console.log("Path length is 0. Attempting to fetch school info from /user/university");
      let res = await fetch('/user/university', { credentials: 'include' });
      console.log("Response status:", res.status);
      if (res.ok) {
        const userSchool = await res.json();
        console.log("User school data:", userSchool);
        window.userSchoolId = userSchool.university; // Lưu school_id toàn cục
        // Chỉ hiển thị trường của user, không cần count
        data = [{
          id: userSchool.university,
          name: userSchool.school_name
        }];
        console.log("Data array:", data);
      } else {
        // Fallback: Nếu không có thông tin user, lấy tất cả trường nhưng không hiển thị count
        console.log("User info not available, fallback to fetch all schools");
        const allSchoolsRes = await fetch('/api/schools');
        if (allSchoolsRes.ok) {
          data = await allSchoolsRes.json();
          console.log("Data from /api/schools:", data);
        } else {
          throw new Error("Không thể lấy danh sách trường");
        }
      }
    } else if (path.length === 1) {
      // Khi đã chọn trường, lấy danh sách khoa của trường đó
      const schoolId = path[0].id;
      console.log("Path length is 1. Fetching faculties for school:", schoolId);
      data = await (await fetch(`/api/schools/${schoolId}/faculties`)).json();
    } else if (path.length === 2) {
      // Khi đã chọn khoa, lấy danh sách môn của khoa đó
      const facultyId = path[1].id;
      console.log("Path length is 2. Fetching subjects for faculty:", facultyId);
      data = await (await fetch(`/api/faculties/${facultyId}/subjects?type=${documentType}`)).json();
    } else if (path.length === 3) {
      // Khi đã chọn môn, lấy danh sách năm có tài liệu theo môn đó
      const subjectId = path[2].id;
      console.log("Path length is 3. Fetching documents by year for subject:", subjectId);
      const response = await fetch(`/api/subjects/${subjectId}/documents_by_year?type=${documentType}`);
      const groupedData = await response.json();
      data = Object.keys(groupedData)
        .map(year => ({
          id: parseInt(year),
          name: year,
          count: groupedData[year].length,
          documents: groupedData[year]
        }))
        .sort((a, b) => b.id - a.id);
    } else if (path.length === 4) {
      // Khi đã chọn năm, lấy danh sách file (tài liệu) của môn theo năm đó
      const subjectId = path[2].id;
      const year = path[3].id;
      console.log("Path length is 4. Fetching documents for subject:", subjectId, "year:", year);
      data = await (await fetch(`/api/subjects/${subjectId}/documents/${year}?type=${documentType}`)).json();
    }
  } catch (error) {
    console.error('Lỗi khi lấy dữ liệu:', error);
    container.innerHTML = `<div class="alert alert-danger">
      Có lỗi khi tải dữ liệu: ${error.message || error}.<br>
      Vui lòng <a href="#" onclick="window.location.reload()">nhấn vào đây</a> để thử lại (F5).
    </div>`;
    return;
  }

  // Xóa spinner sau khi tải xong
  container.innerHTML = '';

  // Hiển thị breadcrumb dựa trên đường dẫn hiện tại
  renderBreadcrumb(container, path, updatePathCallback);

  // Tạo thanh tìm kiếm inline
  const inlineSearchContainer = document.createElement('div');
  inlineSearchContainer.className = 'input-group mb-3';
  inlineSearchContainer.style.position = 'relative';
  inlineSearchContainer.innerHTML = `
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="search" class="form-control" placeholder="Tìm kiếm trong thư mục...">
  `;
  container.appendChild(inlineSearchContainer);

  const inlineSuggestions = document.createElement('div');
  inlineSuggestions.className = 'suggestions';
  inlineSuggestions.style.display = 'none';
  inlineSearchContainer.appendChild(inlineSuggestions);

  // Nút tìm kiếm nâng cao: mở modal tìm kiếm môn học
  const advancedSearchBtn = document.createElement('button');
  advancedSearchBtn.className = 'btn btn-outline-primary mb-3';
  advancedSearchBtn.textContent = 'Tìm kiếm theo tên môn học';
  advancedSearchBtn.addEventListener('click', () => {
    const subjectSearchModal = new bootstrap.Modal(document.getElementById('customSearchModal'));
    subjectSearchModal.show();
  });
  container.appendChild(advancedSearchBtn);

  // Tạo danh sách file/folder
  const list = document.createElement('ul');
  list.className = 'file-list';
  if (Array.isArray(data)) {
    data.forEach(item => {
      if (path.length === 0) {
        // Khi hiển thị trường học, không hiển thị count
        renderFolderItem(list, item.name, path, updatePathCallback, 0, item.id);
      } else if (path.length < 3) {
        // Các cấp khác (Khoa) vẫn hiển thị count nếu có
        if (typeof item.count !== 'undefined') {
          renderFolderItem(list, item.name, path, updatePathCallback, item.count, item.id);
        } else {
          renderFolderItem(list, item.name, path, updatePathCallback, 0, item.id);
        }
      } else if (path.length === 3) {
        // Cấp năm hiển thị count
        renderFolderItem(list, item.name, path, updatePathCallback, item.count || 0, item.id);
      } else if (path.length === 4) {
        // Cấp file không cần count
        renderFileItem(list, item, documentType);
      }
    });
  }
  container.appendChild(list);

  // Xử lý tìm kiếm inline
  const inlineSearchInput = inlineSearchContainer.querySelector('input');
  inlineSearchInput.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const suggestions = [];
    Array.from(list.children).forEach(item => {
      const text = item.textContent.toLowerCase();
      item.style.display = text.includes(term) ? 'flex' : 'none';
      if (item.style.display !== 'none') {
        const name = item.querySelector('.file-name').textContent;
        if (!suggestions.includes(name)) suggestions.push(name);
      }
    });

    inlineSuggestions.innerHTML = '';
    if (term && suggestions.length > 0) {
      suggestions.forEach(suggestion => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = suggestion;
        div.addEventListener('click', () => {
          inlineSearchInput.value = suggestion;
          inlineSearchInput.dispatchEvent(new Event('input'));
          inlineSuggestions.style.display = 'none';
        });
        inlineSuggestions.appendChild(div);
      });
      inlineSuggestions.style.display = 'block';
    } else {
      inlineSuggestions.style.display = 'none';
    }
  });
}
    /* ==================================================
       Function: renderBreadcrumb
       Mô tả:
         - Tạo breadcrumb dựa trên mảng đường dẫn hiện tại
         - Cho phép quay lại hoặc chuyển đến một phần cụ thể của đường dẫn
       Tham số:
         @container : Phần tử chứa breadcrumb
         @path      : Mảng chứa các phần (segment) của đường dẫn
         @callback  : Hàm callback được gọi khi người dùng chọn quay lại
       ================================================== */
    function renderBreadcrumb(container, path, callback) {
      if (path.length === 0) return;
      const breadcrumb = document.createElement('nav');
      let html = `
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="#" id="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
      </li>
  `;
      path.forEach((segment, index) => {
        html += index === path.length - 1
          ? `<li class="breadcrumb-item active">${segment.name}</li>`
          : `<li class="breadcrumb-item"><a href="#" class="breadcrumb-link" data-index="${index}">${segment.name}</a></li>`;
      });
      breadcrumb.innerHTML = html + '</ol>';

      // Sự kiện "Quay lại" của breadcrumb
      breadcrumb.querySelector('#back-button').addEventListener('click', (e) => {
        e.preventDefault();
        callback(path.slice(0, -1));
      });

      // Sự kiện khi click vào từng đường dẫn trong breadcrumb
      breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const index = parseInt(link.getAttribute('data-index'));
          callback(path.slice(0, index + 1));
        });
      });

      container.prepend(breadcrumb);
    }


    /* ==================================================
       Function: renderFolderItem
       Mô tả:
         - Tạo một mục (item) folder trong danh sách hiển thị drive
         - Khi click vào folder, đường dẫn sẽ được cập nhật qua callback
       Tham số:
         @list        : Phần tử <ul> chứa danh sách
         @name        : Tên folder
         @currentPath : Đường dẫn hiện tại
         @callback    : Hàm callback cập nhật đường dẫn khi chọn folder
         @count       : Số lượng file/folder con
         @itemId      : ID của folder
       ================================================== */
function renderFolderItem(list, name, currentPath, callback, count, itemId) {
  const li = document.createElement('li');
  li.className = 'file-item';

  // Chỉ hiển thị count nếu count > 0 (đối với các cấp khác ngoài trường học)
  const countHTML = count > 0 ? `<span class="file-count">${count}</span>` : '';

  li.innerHTML = `
    <i class="bi bi-folder-fill file-icon folder"></i>
    <span class="file-name">${name}</span>
    ${countHTML}
  `;

  li.addEventListener('click', () => {
    callback([...currentPath, { id: itemId, name }]);
  });

  list.appendChild(li);
}

    /* ==================================================
       Function: renderFileItem
       Mô tả:
         - Tạo một mục (item) file trong danh sách hiển thị drive
         - Xử lý logic mở file (kiểm tra đăng nhập & trạng thái tài khoản)
       Tham số:
         @list         : Phần tử <ul> chứa danh sách
         @file         : Đối tượng file chứa thông tin file
         @documentType : Loại tài liệu ('exam' hoặc 'syllabus')
       ================================================== */
function renderFileItem(list, file, documentType) {
  if (!file.file_path) {
    console.warn('File không có đường dẫn hợp lệ:', file);
    return;
  }

  // Kiểm tra file thuộc trường của user không
  if (file.school_id && window.userSchoolId && file.school_id != window.userSchoolId) {
    console.warn("File không thuộc trường của user! File school_id:", file.school_id, "User's school id:", window.userSchoolId);
    alert("Bạn không được phép mở file của trường khác!");
    return;
  }

  const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
  const ext = filePath.split('.').pop().toLowerCase();
  const iconClass = {
    pdf: 'bi-file-pdf pdf',
    doc: 'bi-file-earmark-word word',
    docx: 'bi-file-earmark-word word',
    jpg: 'bi-file-image',
    jpeg: 'bi-file-image',
    png: 'bi-file-image',
    gif: 'bi-file-image'
  }[ext] || 'bi-file-earmark';

  const li = document.createElement('li');
  li.className = 'file-item';
  const typeLabel = documentType === 'exam' ? 'Đề Thi' : 'Đề Cương';
  li.innerHTML = `
    <i class="bi ${iconClass} file-icon"></i>
    <div>
      <div class="file-name">${typeLabel} ${file.file_name}</div>
      <div class="file-info">${file.file_info || ''}</div>
    </div>
  `;

  li.addEventListener('click', () => {
    // Kiểm tra đăng nhập
    fetch('/api/check-login', {
      method: 'GET',
      credentials: 'include'
    })
      .then(response => response.json())
      .then(data => {
        if (data.loggedIn) {
          // Kiểm tra trạng thái tài khoản
          fetch('/api/account_status', {
            method: 'GET',
            credentials: 'include'
          })
            .then(response => response.json())
            .then(statusData => {
              if (statusData.account_status === 'đã duyệt') {
                // Kiểm tra thời gian mở file trước đó
                fetch('/api/check-file-open-timer', {
                  method: 'GET',
                  credentials: 'include'
                })
                  .then(response => response.json())
                  .then(timerData => {
                    if (timerData.can_open) {
                      // Log file mở và mở file nếu đủ thời gian
                      fetch('/api/log-file-open', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ documentId: file.id })
                      })
                        .then(() => {
                          if (documentType === 'exam') {
                            fetch('/api/log-view-exam', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              credentials: 'include',
                              body: JSON.stringify({ documentId: file.id })
                            })
                              .catch(error => {
                                console.error('Lỗi khi log view exam:', error);
                              });
                          }
                          window.open(filePath, '_blank');
                        })
                        .catch(error => {
                          console.error('Lỗi khi log file:', error);
                          window.open(filePath, '_blank');
                        });
                    } else {
                      // Nếu chưa đủ 15 giây, thông báo và không mở file
triggerNotification('warning', 'Thông báo', `Thao tác quá nhanh, đợi ${Math.ceil(timerData.seconds_left)} giây.`);
                    }
                  })
                  .catch(error => {
                    console.error('Lỗi khi kiểm tra thời gian mở file:', error);
                    // Nếu có lỗi khi kiểm tra, bạn có thể chọn không mở file hoặc mở file
                    // window.open(filePath, '_blank');
                  });
              } else if (statusData.account_status === 'bình thường') {
                const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                modal.show();
              } else if (statusData.account_status === 'đang duyệt') {
                triggerNotification('warning', 'Thông báo', 'Tài khoản của bạn đang được xét duyệt, vui lòng đợi');
              }
            })
            .catch(error => {
              console.error('Lỗi khi kiểm tra trạng thái tài khoản:', error);
              const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
              modal.show();
            });
        } else {
          const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
          modal.show();
        }
      })
      .catch(error => {
        console.error('Lỗi kiểm tra đăng nhập:', error);
        const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
        modal.show();
      });
  });

  list.appendChild(li);
}

    /* ==================================================
       Function: openFile
       Mô tả:
         - Mở file trong trình duyệt.
         - Nếu là in-app browser thì chuyển hướng trong cùng tab.
       Tham số:
         @filePath : Đường dẫn file cần mở
       ================================================== */
    function openFile(filePath) {
      if (isInAppBrowser()) {
        window.location.href = filePath;
      } else {
        window.open(filePath, '_blank');
      }
    }


    /* ==================================================
       Function: isInAppBrowser
       Mô tả:
         - Kiểm tra xem trình duyệt có phải là in-app browser (Facebook, Messenger, Zalo,...) hay không.
       ================================================== */
    function isInAppBrowser() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      return ua.indexOf("FBAN") > -1 ||
        ua.indexOf("FBAV") > -1 ||
        ua.indexOf("Messenger") > -1 ||
        ua.indexOf("Zalo") > -1;
    }


    /* ==================================================
       Function: renderExamDrive
       Mô tả:
         - Cập nhật đường dẫn và hiển thị drive cho "Đề Thi"
       ================================================== */
    function renderExamDrive(newPath) {
      examCurrentPath = newPath;
      localStorage.setItem('examCurrentPath', JSON.stringify(examCurrentPath));
      renderDrive('exam-drive-container', examCurrentPath, renderExamDrive);
    }


    /* ==================================================
       Function: renderSyllabusDrive
       Mô tả:
         - Cập nhật đường dẫn và hiển thị drive cho "Đề Cương"
       ================================================== */
    function renderSyllabusDrive(newPath) {
      syllabusCurrentPath = newPath;
      localStorage.setItem('syllabusCurrentPath', JSON.stringify(syllabusCurrentPath));
      renderDrive('syllabus-drive-container', syllabusCurrentPath, renderSyllabusDrive);
    }


    /* ==================================================
       Initialization: Tab Switching & Resume Modal
       Mô tả:
         - Khởi tạo giao diện chuyển đổi tab (Đề Thi / Đề Cương)
         - Khôi phục modal "Tiếp tục xem" nếu có đường dẫn lưu
       ================================================== */
    document.addEventListener('DOMContentLoaded', () => {
      // Lấy đường dẫn lưu từ localStorage
      const savedExamPath = localStorage.getItem('examCurrentPath');
      const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
      if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
      if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

      // Lấy các phần tử DOM cho tab và nội dung
      const examTab = document.getElementById('de-thi-tab');
      const syllabusTab = document.getElementById('de-cuong-tab');
      const examContent = document.getElementById('de-thi');
      const syllabusContent = document.getElementById('de-cuong');
      let activeTab = localStorage.getItem('activeTab') || 'exam';

      // Hàm chuyển đổi tab
      function switchTab(tab) {
        if (tab === 'exam') {
          examTab.classList.add('active');
          syllabusTab.classList.remove('active');
          examContent.classList.add('show', 'active');
          syllabusContent.classList.remove('show', 'active');
          localStorage.setItem('activeTab', 'exam');
          renderExamDrive(examCurrentPath);
        } else {
          syllabusTab.classList.add('active');
          examTab.classList.remove('active');
          syllabusContent.classList.add('show', 'active');
          examContent.classList.remove('show', 'active');
          localStorage.setItem('activeTab', 'syllabus');
          renderSyllabusDrive(syllabusCurrentPath);
        }
      }

      // Gán sự kiện chuyển tab
      examTab.addEventListener('click', () => switchTab('exam'));
      syllabusTab.addEventListener('click', () => switchTab('syllabus'));
      switchTab(activeTab);

      // Khôi phục modal "Tiếp tục xem" nếu có dữ liệu đường dẫn lưu
      if (activeTab === 'exam' && examCurrentPath.length > 0) {
        const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
        document.getElementById('resumeTabName').textContent = 'Đề Thi';
        document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + examCurrentPath.map(item => item.name).join(' > ');
        resumeModal.show();

        document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
          resumeModal.hide();
        });

        document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
          examCurrentPath = [];
          localStorage.removeItem('examCurrentPath');
          renderExamDrive(examCurrentPath);
          resumeModal.hide();
        });

        document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
          resumeModal.hide();
          showHistoryModal();
        });
      } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
        const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
        document.getElementById('resumeTabName').textContent = 'Đề Cương';
        document.getElementById('resumePathDisplay').textContent = 'Bạn đã dừng tại: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
        resumeModal.show();

        document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
          resumeModal.hide();
        });

        document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
          syllabusCurrentPath = [];
          localStorage.removeItem('syllabusCurrentPath');
          renderSyllabusDrive(syllabusCurrentPath);
          resumeModal.hide();
        });

        document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
          resumeModal.hide();
          showHistoryModal();
        });
      }
    });

async function checkAndResetHistory() {
  try {
    const res = await fetch('/user/university', { credentials: 'include' });
    if (res.ok) {
      const userSchool = await res.json();
      window.userSchoolId = userSchool.university;
      
      // So sánh kiểu dữ liệu nếu cần: chuyển sang string để đảm bảo so sánh đúng
      if (examCurrentPath.length > 0 && String(examCurrentPath[0].id) !== String(window.userSchoolId)) {
        examCurrentPath = [];
        localStorage.removeItem('examCurrentPath');
        // Tùy chọn: chuyển hướng về trang chủ
        window.location.href = '/';
      }
      if (syllabusCurrentPath.length > 0 && String(syllabusCurrentPath[0].id) !== String(window.userSchoolId)) {
        syllabusCurrentPath = [];
        localStorage.removeItem('syllabusCurrentPath');
        // Tùy chọn: chuyển hướng về trang chủ
        window.location.href = '/';
      }
    }
  } catch (error) {
    console.error("Lỗi khi kiểm tra lịch sử trường:", error);
  }
}

    /* ==================================================
       Initialization: Subject Search Modal
       Mô tả:
         - Thiết lập chức năng tìm kiếm môn học trong modal tìm kiếm
         - Xử lý hiển thị kết quả và gợi ý tìm kiếm theo từ khóa nhập vào
       ================================================== */
document.addEventListener("DOMContentLoaded", function () {
  const subjectSearchInput = document.getElementById("subjectSearchInput");
  const subjectSearchSuggestions = document.getElementById("subjectSearchSuggestions");
  const schoolSelectionNotice = document.getElementById("schoolSelectionNotice");
  const searchResultCount = document.getElementById("searchResultCount");
  const modalEl = document.getElementById("customSearchModal");

  if (!modalEl) {
    console.error('Không tìm thấy phần tử modal với id "customSearchModal"');
    return;
  }

  searchResultCount.style.display = "none";
  subjectSearchSuggestions.style.display = "none";

  let modalInstance = bootstrap.Modal.getInstance(modalEl);
  if (!modalInstance) {
    modalInstance = new bootstrap.Modal(modalEl);
  }

  subjectSearchInput?.addEventListener("input", async () => {
    const term = subjectSearchInput.value.trim().toLowerCase();

    if (term.length < 2) {
      subjectSearchSuggestions.style.display = "none";
      searchResultCount.style.display = "none";
      return;
    } else {
      searchResultCount.style.display = "block";
    }

    const activeTab = localStorage.getItem("activeTab") || "exam";
    const currentPath = activeTab === "exam" ? examCurrentPath : syllabusCurrentPath;

    if (!currentPath || currentPath.length === 0) {
      schoolSelectionNotice.classList.remove("d-none");
    } else {
      schoolSelectionNotice.classList.add("d-none");
    }

    // Lấy school_id từ user hoặc từ currentPath[0]
    const schoolId = window.userSchoolId || (currentPath[0]?.id);
    // Lưu ý: bỏ qua faculty_id để tìm kiếm toàn bộ khoa trong cùng trường
    // const facultyId = currentPath[1]?.id || 0;

    try {
      const url = new URL("/api/search/subjects", window.location.origin);
      url.searchParams.append("term", term);
      if (schoolId) url.searchParams.append("school_id", schoolId);
      // Bỏ dòng thêm faculty_id để cho phép tìm kiếm trong toàn bộ các khoa cùng trường
      // if (facultyId) url.searchParams.append("faculty_id", facultyId);

      const response = await fetch(url, { credentials: 'include' });
      if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
      const results = await response.json();

      searchResultCount.textContent = "Kết quả tìm kiếm (" + results.length + ")";

      subjectSearchSuggestions.innerHTML = "";
      if (results.length > 0) {
        results.forEach(subject => {
          const card = document.createElement("div");
          card.className = "card mb-3";
          card.style.border = "none";
          card.style.borderRadius = "12px";
          card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
          card.style.transition = "all 0.3s ease";
          card.style.backgroundColor = "#ffffff";
          card.style.cursor = "pointer";
          card.onmouseover = function () {
            this.style.transform = "translateY(-3px)";
            this.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
            this.style.backgroundColor = "#f8f9fa";
          };
          card.onmouseout = function () {
            this.style.transform = "none";
            this.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
            this.style.backgroundColor = "#ffffff";
          };

          const cardBody = document.createElement("div");
          cardBody.className = "card-body";

          const contentDiv = document.createElement("div");
          contentDiv.className = "d-flex justify-content-between align-items-start";

          const infoDiv = document.createElement("div");

          const h5 = document.createElement("h5");
          h5.className = "custom-card-title";
          h5.style.color = "#0d6efd";
          h5.style.fontWeight = "600";
          h5.style.marginBottom = "8px";
          h5.textContent = subject.name;

          const schoolDiv = document.createElement("div");
          schoolDiv.style.color = "#6c757d";
          schoolDiv.style.marginBottom = "0.5rem";
          schoolDiv.innerHTML = `<i class="fas fa-university me-1"></i> ${subject.school_name}`;

          const facultySpan = document.createElement("span");
          facultySpan.className = "custom-university-label";
          facultySpan.style.fontSize = "0.9em";
          facultySpan.style.backgroundColor = "#e9ecef";
          facultySpan.style.borderRadius = "20px";
          facultySpan.style.padding = "5px 15px";
          facultySpan.style.display = "inline-block";
          facultySpan.style.color = "#495057";
          facultySpan.style.marginTop = "8px";
          facultySpan.innerHTML = `<i class="fas fa-graduation-cap me-1"></i> ${subject.faculty_name}`;

          infoDiv.appendChild(h5);
          infoDiv.appendChild(schoolDiv);
          infoDiv.appendChild(facultySpan);

          const viewButton = document.createElement("button");
          viewButton.type = "button";
          viewButton.style.fontSize = "0.875rem";
          viewButton.style.border = "1px solid #0d6efd";
          viewButton.style.color = "#0d6efd";
          viewButton.style.backgroundColor = "transparent";
          viewButton.style.padding = "0.375rem 0.75rem";
          viewButton.style.borderRadius = "0.25rem";
          viewButton.onmouseover = function () {
            this.style.backgroundColor = "#0d6efd";
            this.style.color = "#fff";
          };
          viewButton.onmouseout = function () {
            this.style.backgroundColor = "transparent";
            this.style.color = "#0d6efd";
          };
          viewButton.innerHTML = `<i class="fas fa-eye me-1"></i> Xem`;

          contentDiv.appendChild(infoDiv);
          contentDiv.appendChild(viewButton);

          cardBody.appendChild(contentDiv);
          card.appendChild(cardBody);

          card.addEventListener("click", () => {
            // Khi click vào kết quả tìm kiếm, thiết lập đường dẫn mới dựa trên thông tin của môn
            const newPath = [
              { id: subject.school_id, name: subject.school_name },
              { id: subject.faculty_id, name: subject.faculty_name },
              { id: subject.id, name: subject.name }
            ];
            const activeTab = localStorage.getItem("activeTab") || "exam";
            if (activeTab === "exam") {
              renderExamDrive(newPath);
            } else {
              renderSyllabusDrive(newPath);
            }
            subjectSearchInput.value = "";
            subjectSearchSuggestions.innerHTML = "";
            subjectSearchSuggestions.style.display = "none";
            searchResultCount.textContent = "Kết quả tìm kiếm (0)";
            const modal = bootstrap.Modal.getInstance(document.getElementById("customSearchModal"));
            if (modal) {
              modal.hide();
            } else {
              new bootstrap.Modal(document.getElementById("customSearchModal")).hide();
            }
          });

          subjectSearchSuggestions.appendChild(card);
        });
        subjectSearchSuggestions.style.display = "block";
      } else {
        subjectSearchSuggestions.style.display = "none";
      }
    } catch (error) {
      console.error("Lỗi tìm kiếm:", error);
      subjectSearchSuggestions.innerHTML = '<div class="error">Lỗi tải kết quả</div>';
      subjectSearchSuggestions.style.display = "block";
    }
  });
});
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>