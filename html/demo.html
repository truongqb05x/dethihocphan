<!DOCTYPE html>
<html lang="vi">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kho H·ªçc Li·ªáu</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- Custom CSS -->
<link rel="shortcut icon" href="../static/logo.png" type="image/x-icon">
<link rel="stylesheet" href="../static/css/index.css">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f4f6f9;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }

    .list-group-item :hover {
      cursor: pointer;
      color: red;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      margin: 0;
      padding-top: 60px;
    }

    .compact-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card-custom {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .nav-tabs .nav-link {
       font-weight: 500;
       color: var(--secondary-color);
       border: none;
       padding: 0.75rem 1rem;
       transition: color 0.3s ease;
     }

     .nav-tabs .nav-link.active {
       color: var(--primary-color);
       font-weight: 600;
       border-bottom: 3px solid var(--primary-color);
     }
     .nav-tabs .nav-link:hover {
       color: var(--primary-color);
     }
    .breadcrumb {
      background: transparent;
      padding: 0.75rem 1rem;
      margin-bottom: 0;
    }

    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: #0056b3;
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
      background: #fff;
    }

    .file-item:hover {
      background-color: #f8f9fa;
      transform: translateX(5px);
    }

    .file-icon {
      font-size: 24px;
      margin-right: 15px;
      width: 30px;
    }

    .file-icon.folder {
      color: #ffc107;
    }

    .file-icon.pdf {
      color: #dc3545;
    }

    .file-icon.word {
      color: #2b579a;
    }

    .file-name {
      flex-grow: 1;
      font-size: 1rem;
    }

    .file-info {
      font-size: 0.8rem;
      color: var(--secondary-color);
    }

    /* CSS cho g·ª£i √Ω t√¨m ki·∫øm (autocomplete) */
    .suggestions {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .suggestions .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions .suggestion-item:hover {
      background-color: #f8f9fa;
      opacity: 1;
    }

    /* Modern Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      background: #ffffff;
      animation: fadeInScale 0.4s ease;
    }

    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: #fff;
      border-bottom: none;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .modal-header .btn-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }

    .modal-header .btn-close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 1.5rem;
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
    }

    .modal-footer {
      background: #f5f5f5;
      border-top: none;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      min-width: 120px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .modal-footer .btn-primary {
      background: #2575fc;
      border: none;
    }

    .modal-footer .btn-primary:hover {
      background: #1a5bb8;
      transform: translateY(-2px);
    }

    .modal-footer .btn-secondary {
      background: #e0e0e0;
      border: none;
      color: #555;
    }

    .modal-footer .btn-secondary:hover {
      background: #cfcfcf;
      transform: translateY(-2px);
    }

    .modal-footer .btn-info {
      background: #17a2b8;
      border: none;
      color: #fff;
    }

    .modal-footer .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    @media (max-width: 576px) {

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      .modal-header .modal-title {
        font-size: 1.5rem;
      }
    }

    /* Modal Resume Header m√†u xanh l√° */
    #resumeModal .modal-header {
      background: linear-gradient(135deg, #28a745, #70db70);
    }

    .about-links {
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }

    .about-links h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 15px;
    }

    .about-links ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }

    .about-links li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .about-links li:last-child {
      border-bottom: none;
    }

    .about-links .label {
      flex: 0 0 150px;
      font-weight: 600;
      color: #007bff;
    }

    .about-links .desc {
      flex: 1;
      font-size: 16px;
      color: #555;
    }

    /* Footer style */
    .custom-footer {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      text-align: center;
    }

    .custom-footer .footer-item {
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }

    .custom-footer .footer-item span {
      display: block;
      line-height: 1.5;
    }

    /* Social links style */
    .social-links {
      margin-top: 10px;
    }

    .social-links a {
      margin: 0 10px;
      font-size: 24px;
      color: #007bff;
      text-decoration: none;
      transition: color 0.3s;
    }

    .social-links a:hover {
      color: #0056b3;
    }

    /* Custom CSS for Modern and Elegant Modal */
    .modal-content {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      border-bottom: none;
      padding: 20px;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .modal-body {
      padding: 20px;
      background-color: #f9f9f9;
    }

    .modal-footer {
      border-top: none;
      padding: 15px 20px;
      background-color: #f9f9f9;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }
    /*th∆∞ m·ª•c r·ªóng*/
.empty-folder {
  margin: 32px auto;
  padding: 24px;
  max-width: 480px;
  background: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
  border-left: 5px solid #0d6efd;
  border-radius: 8px;
  text-align: center;
  color: #6c757d;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
  overflow: hidden;
}

.empty-folder::before {
  content: "üìÅ";
  display: block;
  font-size: 48px;
  margin-bottom: 16px;
  filter: grayscale(100%);
  opacity: 0.6;
  transition: transform 0.3s ease;
}

.empty-folder:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

.empty-folder:hover::before {
  transform: scale(1.1) rotate(-5deg);
  opacity: 0.8;
}

.empty-folder p {
  margin: 12px 0;
  font-size: 15px;
  line-height: 1.6;
  letter-spacing: 0.3px;
}

.empty-folder strong {
  display: block;
  font-weight: 600;
  color: #212529;
  margin-bottom: 8px;
  font-size: 17px;
}

    .btn-close {
      filter: invert(1);
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .list-group-item {
      border: none;
      margin-bottom: 10px;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .list-group-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    /* Animation for modal */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal.fade .modal-dialog {
      animation: fadeIn 0.3s ease-out;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      /* canh gi·ªØa */
      text-indent: -9999px;
      /* ·∫©n text Loading... n·∫øu kh√¥ng mu·ªën hi·ªÉn th·ªã */
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #subjectSearchModal .modal-dialog {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #subjectSearchModal .modal-content {
      height: 70%;
    }

    .suggestions {
      position: absolute;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* ƒê·∫£m b·∫£o hi·ªÉn th·ªã tr√™n modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }

    .suggestions {
      position: absolute;
      top: calc(100% + 2px);
      /* N·∫±m ngay d∆∞·ªõi √¥ input, c√°ch 2px ƒë·ªÉ kh√¥ng d√≠nh li·ªÅn */
      left: 0;
      width: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      /* ƒê·∫£m b·∫£o hi·ªÉn th·ªã tr√™n modal */
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }


    /* Tr√™n mobile (chi·ªÅu r·ªông nh·ªè h∆°n 576px), tƒÉng padding-top ƒë·ªÉ b√π navbar */
    @media (max-width: 576px) {
      body {
        padding-top: 100px;
        /* TƒÉng kho·∫£ng c√°ch ƒë·ªÉ tr√°nh b·ªã ƒë√® n·ªôi dung */
      }
    }

    /*hover content nav*/
    /* CSS cho tooltip: ch·ªâ hi·ªÉn th·ªã khi di chu·ªôt v√†o n√∫t */
    .btn-hover-tooltip {
      position: relative;
    }

    .btn-hover-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -30px;
      /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ theo nhu c·∫ßu */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .btn-hover-tooltip:hover::after {
      opacity: 1;
    }
  </style>

</head>

<body>
  <!-- B·ªçc to√†n b·ªô n·ªôi dung trong 1 container -->
  <!-- Th√™m navbar v√†o tr∆∞·ªõc ph·∫ßn content ch√≠nh -->
  <nav id="navbar" class="navbar navbar-expand-lg navbar-light border-bottom py-3 fixed-top" >
    <div class="container-fluid">
      <!-- T√™n trang web b√™n tr√°i -->
      <a class="navbar-brand me-5" href="/">
        <span class="text-primary fw-bold fs-4">HueHub</span>
      </a>

      <!-- C√°c ch·ª©c nƒÉng b√™n ph·∫£i -->
      <div class="d-flex align-items-center gap-3">
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            // L·∫•y n√∫t theo ID
            var activityBtn = document.getElementById('activityBtn');
            if (activityBtn) {
              // Khi n√∫t ƒë∆∞·ª£c click, hi·ªÉn th·ªã modal
              activityBtn.addEventListener('click', function () {
                var activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
                activityModal.show();
              });
            }
          });

        </script>
<!-- N√∫t ƒëƒÉng nh·∫≠p trong navbar -->
<button class="btn btn-outline-primary rounded-pill px-3" id="loginBtn" style="display: none;">
  <i class="bi bi-box-arrow-in-right me-2"></i>
  ƒêƒÉng nh·∫≠p
</button>

        <!-- N√∫t ƒëƒÉng xu·∫•t -->
        <button class="btn btn-outline-danger rounded-pill px-3 btn-hover-tooltip" id="logoutBtn"
          data-tooltip="ƒêƒÉng xu·∫•t">
          <i class="bi bi-box-arrow-right me-2"></i>
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </nav>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p qua API
    fetch("/api/check-login")
      .then(response => response.json())
      .then(data => {
        if (data.loggedIn) {
          // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã n√∫t ƒêƒÉng xu·∫•t (v√≠ d·ª•)
          document.getElementById("logoutBtn").style.display = "block";
          document.getElementById("loginBtn").style.display = "none";
        } else {
          // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã n√∫t ƒêƒÉng nh·∫≠p v√† ·∫©n n√∫t ƒê√≥ng g√≥p ƒë·ªÅ thi
          document.getElementById("loginBtn").style.display = "block";
          document.getElementById("logoutBtn").style.display = "none";

          var contributeBtn = document.querySelector(".btn.btn-primary.contribute-btn");
          if (contributeBtn) {
            contributeBtn.style.display = "none";
          }
        }
      })
      .catch(error => console.error("L·ªói ki·ªÉm tra ƒëƒÉng nh·∫≠p:", error));

    // Khi nh·∫•n n√∫t ƒêƒÉng nh·∫≠p, m·ªü modal ƒëƒÉng nh·∫≠p
    var loginBtn = document.getElementById("loginBtn");
    if (loginBtn) {
      loginBtn.addEventListener("click", function () {
        var authModalEl = document.getElementById("authModal");
        var authModal = new bootstrap.Modal(authModalEl);
        authModal.show();
      });
    }
  });
</script>
  <style>
  
/* ƒê·ªãnh d·∫°ng cho n√∫t nav */
.nav-link {
  position: relative;
  font-family: 'Roboto', sans-serif;
  color: #777777;
  text-decoration: none;
  padding: 10px 15px;
  transition: all 0.3s ease;
  border: none;
  background: none;
  cursor: pointer;
}
/* Hi·ªáu ·ª©ng underline ·∫©n ban ƒë·∫ßu */
.nav-link::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: 0;
  transform: translateX(-50%);
  width: 0;
  height: 2px;
  background-color: #007bff;
  transition: width 0.3s ease;
}
/* Hi·ªáu ·ª©ng khi hover (√°p d·ª•ng cho c√°c nav-link kh√¥ng active) */
.nav-link:hover {
  color: #007bff;
  transform: translateY(-2px);
}
.nav-link:hover::after {
  width: 100%;
}
/* Style cho n√∫t active */
.nav-link.active {
  color: #007bff;
}
/* Kh√¥ng √°p d·ª•ng hi·ªáu ·ª©ng hover cho nav-link ƒëang active */
.nav-link.active:hover {
  color: #007bff;
  transform: none;
}
.nav-link.active:hover::after {
  width: 0;
}

    
  </style>


  <div class="compact-container my-4">
    <div class="card card-custom">
      <div class="card-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="de-thi-tab" data-bs-toggle="tab" data-bs-target="#de-thi" type="button"
              role="tab" style = "color:#777777">ƒê·ªÅ Thi</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="de-cuong-tab" data-bs-toggle="tab" data-bs-target="#de-cuong" type="button"
              role="tab"  style = "color:#777777">ƒê·ªÅ C∆∞∆°ng</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="ve-chung-toi-tab" data-bs-toggle="tab" data-bs-target="#ve-chung-toi"
              type="button" role="tab"  style = "color:#777777">V·ªÅ Ch√∫ng T√¥i</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <!-- Tab ƒê·ªÅ Thi -->
          <div class="tab-pane fade show active" id="de-thi" role="tabpanel" aria-labelledby="de-thi-tab">
            <div id="exam-drive-container"></div>
          </div>
          <!-- Tab ƒê·ªÅ C∆∞∆°ng -->
          <div class="tab-pane fade" id="de-cuong" role="tabpanel" aria-labelledby="de-cuong-tab">
            <div id="syllabus-drive-container"></div>
          </div>
          <!-- Tab V·ªÅ Ch√∫ng T√¥i -->
          <div class="tab-pane fade" id="ve-chung-toi" role="tabpanel" aria-labelledby="ve-chung-toi-tab">
            <!-- S·ª≠ d·ª•ng position-relative ƒë·ªÉ ƒë·ªãnh v·ªã ph·∫ßn "Phi√™n b·∫£n" -->
            <div class="p-3 position-relative">
              <p>
                C√°c ƒë·ªÅ thi v√† t√†i li·ªáu tr√™n website n√†y ƒë·ªÅu ƒë∆∞·ª£c ƒë√≥ng g√≥p b·ªüi c√°c c·ª±u sinh vi√™n, mang l·∫°i s·ª± g·∫ßn g≈©i v√†
                tr·∫£i nghi·ªám th·ª±c t·∫ø trong h·ªçc t·∫≠p.
              </p>
              <div class="about-links mt-3">
                <footer class="custom-footer mt-4">
                  <div class="footer-item">
                    <span>Design by Nguyen Ngoc Truong</span>
                  </div>
                  <div class="social-links">
                    <a href="https://www.facebook.com/nntruong05" target="_blank" aria-label="Facebook">
                      <i class="bi bi-facebook"></i>
                    </a>
                    <a href="https://github.com/truongqb05x" target="_blank" aria-label="GitHub">
                      <i class="bi bi-github"></i>
                    </a>
                  </div>
                </footer>
              </div>

              <!-- Ch·ªØ "Phi√™n b·∫£n 0" ƒë∆∞·ª£c ƒë·∫∑t ·ªü g√≥c d∆∞·ªõi b√™n ph·∫£i, c√≥ hi·ªáu ·ª©ng nh·∫•n ƒë·ªÉ m·ªü modal l·ªãch s·ª≠ c·∫≠p nh·∫≠t -->
              <div class="version-info"
                style="position: absolute; bottom: 0; right: 0; padding: 5px; font-size: 0.9rem; color: #666;"
                data-bs-toggle="modal" data-bs-target="#updateHistoryModal">
                Version 2.0.5
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- Container ch·ª©a iframe th·∫£o lu·∫≠n (·∫©n ban ƒë·∫ßu) -->
<style>
  #discussion-container {
    display: none; /* ·∫®n ban ƒë·∫ßu */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    margin: 0;
    padding: 0;
    overflow: auto;
  }
  #discussion-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
</style>

<div id="discussion-container">
  <iframe id="discussion-iframe" src="/html/thaoluan.html"></iframe>
</div>

<script>
  // Khi c·∫ßn hi·ªÉn th·ªã, chuy·ªÉn ƒë·ªïi display v√† √©p t√≠nh to√°n l·∫°i layout
  function showDiscussion() {
    var container = document.getElementById("discussion-container");
    container.style.display = "block";
    // √©p reflow: ƒë·ªçc offsetHeight ƒë·ªÉ tr√¨nh duy·ªát t√≠nh l·∫°i layout
    var dummy = container.offsetHeight;
  }
</script>
  <!-- Container ch·ª©a th√¥ng b√°o, s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông n·∫øu ch∆∞a c√≥ -->
  <div class="my-notification-container"></div>


<script>
  /**
   * H√†m triggerNotification: K√≠ch ho·∫°t th√¥ng b√°o b·∫±ng c√°ch t·∫°o CSS, container v√† th√¥ng b√°o m·ªõi.
   * @param {string} type - Lo·∫°i th√¥ng b√°o: 'success', 'warning', 'danger'
   * @param {string} title - Ti√™u ƒë·ªÅ th√¥ng b√°o
   * @param {string} message - N·ªôi dung th√¥ng b√°o
   */
  function triggerNotification(type, title, message) {
    // Ch√®n CSS ƒë·ªông n·∫øu ch∆∞a c√≥
    if (!document.getElementById('my-notification-style')) {
      const css = `
        .my-notification-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 320px;
        }
        
        .my-notification {
          position: relative;
          padding: 15px 20px;
          margin-bottom: 15px;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          opacity: 0;
          transform: translateX(120%);
          animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
          display: flex;
          align-items: center;
          transition: all 0.3s ease;
          border-left: 4px solid;
          background: #fff !important;  /* ƒê·∫∑t background ∆∞u ti√™n */
        }

        /* C√°c m√†u n·ªÅn ri√™ng theo lo·∫°i th√¥ng b√°o */
        .alert-success {
          background: #d4edda !important;
          border-color: #28a745;
        }
        
        .alert-warning {
          background: #fff3cd !important;
          border-color: #ffc107;
        }
        
        .alert-danger {
          background: #f8d7da !important;
          border-color: #dc3545;
        }
    
        .my-notification.hide {
          animation: slideOut 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
        }
    
        .my-notification:hover {
          transform: translateX(-5px);
          box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
    
        .my-notification-icon {
          font-size: 1.5rem;
          margin-right: 15px;
          flex-shrink: 0;
        }
    
        .my-notification-content {
          flex-grow: 1;
        }
    
        .my-notification-close {
          opacity: 0.6;
          margin-left: 15px;
          transition: opacity 0.2s;
        }
    
        .my-notification-close:hover {
          opacity: 1;
        }
    
        .my-progress-bar {
          position: absolute;
          bottom: 0;
          left: 0;
          height: 3px;
          background: rgba(255,255,255,0.3);
          width: 100%;
          overflow: hidden;
          border-radius: 0 0 8px 8px;
        }
    
        .my-progress-bar::after {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          height: 100%;
          width: 100%;
          background: currentColor;
          animation: progress 5s linear forwards;
        }
    
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(120%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
    
        @keyframes slideOut {
          from {
            opacity: 1;
            transform: translateX(0);
          }
          to {
            opacity: 0;
            transform: translateX(120%);
          }
        }
    
        @keyframes progress {
          from { transform: translateX(-100%); }
          to { transform: translateX(0); }
        }
      `;
      const styleEl = document.createElement('style');
      styleEl.type = 'text/css';
      styleEl.id = 'my-notification-style';
      styleEl.appendChild(document.createTextNode(css));
      document.head.appendChild(styleEl);
    }

    // ƒê·∫£m b·∫£o container th√¥ng b√°o t·ªìn t·∫°i
    let container = document.querySelector('.my-notification-container');
    if (!container) {
      container = document.createElement('div');
      container.className = 'my-notification-container';
      document.body.appendChild(container);
    }

    // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o m·ªõi
    const notification = document.createElement('div');
    notification.classList.add('my-notification', `alert-${type}`);

    // Ch·ªçn icon t∆∞∆°ng ·ª©ng theo lo·∫°i th√¥ng b√°o
    let iconClass = '';
    if (type === 'success') {
      iconClass = 'bi-check-circle-fill';
    } else if (type === 'warning') {
      iconClass = 'bi-hourglass-split';
    } else if (type === 'danger') {
      iconClass = 'bi-x-octagon-fill';
    }

    notification.innerHTML = `
      <i class="bi ${iconClass} my-notification-icon"></i>
      <div class="my-notification-content">
        <h6 class="mb-1 fw-semibold">${title}</h6>
        <p class="mb-0 small">${message}</p>
      </div>
      <div class="my-progress-bar"></div>
      <button class="my-notification-close btn btn-link p-0">
        <i class="bi bi-x"></i>
      </button>
    `;

    // S·ª± ki·ªán ƒë√≥ng th√¥ng b√°o khi nh·∫•n n√∫t close
    notification.querySelector('.my-notification-close').addEventListener('click', () => {
      notification.classList.add('hide');
      notification.addEventListener('animationend', () => notification.remove());
    });

    container.appendChild(notification);

    // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 3 gi√¢y
    setTimeout(() => {
      notification.classList.add('hide');
      notification.addEventListener('animationend', () => notification.remove());
    }, 3000);
  }

  // V√≠ d·ª• s·ª≠ d·ª•ng:
  // triggerNotification('warning', 'C·∫£nh b√°o!', 'Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu.');
  // triggerNotification('danger', 'L·ªói!', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.');
</script>

  <!-- N√∫t ƒë√≥ng g√≥p ƒë·ªÅ thi -->
  <button type="button" class="btn btn-primary contribute-btn"
    style="position: fixed; bottom: 0; right: 0; margin: 10px; z-index: 1050;" data-bs-toggle="modal"
    data-bs-target="#contributeExamModal">
    <i class="bi bi-pencil-square"></i> ƒê√≥ng g√≥p ƒë·ªÅ thi
  </button>
  
  <!-- Modal ƒê√≥ng g√≥p ƒê·ªÅ thi -->
  <div class="modal fade" id="contributeExamModal" data-bs-backdrop="false" tabindex="-1"
    aria-labelledby="contributeExamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contributeExamModalLabel">ƒê√≥ng g√≥p ƒë·ªÅ thi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
          <!-- Th√¥ng b√°o th√†nh c√¥ng, ·∫©n m·∫∑c ƒë·ªãnh -->
          <div id="successAlert" class="alert alert-success" role="alert" style="display: none;">
            Upload th√†nh c√¥ng!
          </div>
          <!-- Form upload -->
          <form id="contributeExamForm" action="/api/upload_exam" method="POST" enctype="multipart/form-data">
            <!-- Ch·ªçn tr∆∞·ªùng -->
            <div class="mb-3">
              <label for="fieldSelect" class="form-label">Ch·ªçn tr∆∞·ªùng</label>
              <select class="form-select" id="fieldSelect" name="field">
                <option selected>ƒêang t·∫£i...</option>
              </select>
            </div>
            <!-- T·∫£i file ƒë·ªÅ thi -->
            <div id="fileInputsContainer">
              <div class="file-input-group mb-3">
                <label class="form-label">T·∫£i file</label>
                <input type="file" class="form-control" name="examFile[]" accept="*/*">
                <p class="form-text mt-2">
                  B·∫°n c√≥ th·ªÉ ch·ªçn file ƒë·ªÅ thi ho·∫∑c ƒë·ªÅ c∆∞∆°ng!
                </p>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary" id="addFileInput">
              <i class="bi bi-plus-circle"></i> Th√™m file
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <!-- N√∫t g·ª≠i v√† n√∫t ƒë√≥ng ƒë∆∞·ª£c ƒë·∫∑t trong modal footer nh∆∞ c≈© -->
          <button type="submit" form="contributeExamForm" class="btn btn-primary">G·ª≠i ƒë√≥ng g√≥p</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load danh s√°ch tr∆∞·ªùng t·ª´ API /api/schools
    document.addEventListener('DOMContentLoaded', function () {
      var fieldSelect = document.getElementById('fieldSelect');
      fetch('/api/schools')
        .then(response => response.json())
        .then(data => {
          fieldSelect.innerHTML = '';
          if (data.error) {
            let errorOption = document.createElement('option');
            errorOption.text = 'L·ªói khi t·∫£i tr∆∞·ªùng';
            fieldSelect.appendChild(errorOption);
          } else {
            let defaultOption = document.createElement('option');
            defaultOption.text = 'Ch·ªçn tr∆∞·ªùng c·ªßa b·∫°n';
            defaultOption.selected = true;
            fieldSelect.appendChild(defaultOption);
            data.forEach(function (school) {
              let option = document.createElement('option');
              option.value = school.id;
              option.text = school.name + " (" + school.count + ")";
              fieldSelect.appendChild(option);
            });
          }
        })
        .catch(err => {
          console.error(err);
          fieldSelect.innerHTML = '<option>L·ªói khi t·∫£i tr∆∞·ªùng</option>';
        });
    });

    // Script th√™m file upload m·ªõi kh√¥ng k√®m ghi ch√∫
    document.getElementById('addFileInput').addEventListener('click', function () {
      var fileGroup = document.createElement('div');
      fileGroup.className = 'file-input-group mb-3';

      var fileLabel = document.createElement('label');
      fileLabel.className = 'form-label';
      fileLabel.innerText = 'T·∫£i file ƒë·ªÅ thi';
      fileGroup.appendChild(fileLabel);

      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.className = 'form-control';
      fileInput.name = 'examFile[]';
      fileInput.accept = '*/*';
      fileGroup.appendChild(fileInput);

      document.getElementById('fileInputsContainer').appendChild(fileGroup);
    });

    // X·ª≠ l√Ω submit form b·∫±ng AJAX ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng trong modal
    document.getElementById('contributeExamForm').addEventListener('submit', function (e) {
      e.preventDefault(); // NgƒÉn form submit m·∫∑c ƒë·ªãnh
      let form = this;
      let formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            document.getElementById('successAlert').style.display = 'block';
            // Reset form sau khi upload th√†nh c√¥ng
            form.reset();
            // C·∫≠p nh·∫≠t l·∫°i container file v·ªõi m·ªôt input m·∫∑c ƒë·ªãnh
            document.getElementById('fileInputsContainer').innerHTML = `
            <div class="file-input-group mb-3">
              <label class="form-label">T·∫£i file</label>
              <input type="file" class="form-control" name="examFile[]" accept="*/*">
              <p class="form-text mt-2">
                B·∫°n c√≥ th·ªÉ ch·ªçn file ƒë·ªÅ thi ho·∫∑c ƒë·ªÅ c∆∞∆°ng!
              </p>
            </div>
          `;
          } else if (data.error) {
            // Th√¥ng b√°o l·ªói n·∫øu c√≥
            alert("L·ªói: " + data.error);
          }
        })
        .catch(error => {
          console.error(error);
          alert("C√≥ l·ªói x·∫£y ra khi upload.");
        });
    });
  </script>

  <style>
    .modal-dialog-v3 {
      max-width: 420px;
    }

    .modal-content-v3 {
      background: #f8f9fa;
      /* N·ªÅn modal s√°ng nh·∫π */
      border: 1px solid #e0e0e0;
      /* Vi·ªÅn s√°ng h∆°n */
      border-radius: 15px;
      transform: perspective(1000px) rotateX(5deg);
      transition: transform 0.3s;
      animation: popIn-v3 0.5s ease-out;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      /* B√≥ng nh·∫π */
    }

    .modal-content-v3:hover {
      transform: perspective(1000px) rotateX(0deg);
    }

    .modal-header-v3 {
      border-bottom: none;
      padding: 2rem 2rem 0;
    }

    .modal-title-v3 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: #333;
      /* M√†u ch·ªØ t·ªëi ƒë·ªÉ n·ªïi tr√™n n·ªÅn s√°ng */
    }

    .modal-body-v3 {
      padding: 1.5rem 2rem 2rem;
      text-align: center;
      color: #555;
      /* M√†u ch·ªØ nh·∫°t h∆°n cho n·ªôi dung */
      font-family: 'Montserrat', sans-serif;
    }

    .btn-custom-v3 {
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.3s;
    }

    .btn-login-v3 {
      background: #007bff;
      /* M√†u xanh d∆∞∆°ng t∆∞∆°i s√°ng */
      color: #fff;
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-register-v3 {
      background: #ff4d4d;
      /* M√†u ƒë·ªè nh·∫π nh√†ng */
      color: #fff;
      box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
    }

    .btn-custom-v3:hover {
      transform: translateZ(10px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      /* B√≥ng ƒë·∫≠m h∆°n khi hover */
    }

    @keyframes popIn-v3 {
      from {
        opacity: 0;
        transform: perspective(1000px) rotateX(20deg);
      }

      to {
        opacity: 1;
        transform: perspective(1000px) rotateX(5deg);
      }
    }
  </style>

  <div class="modal fade" id="loginModal-v3" tabindex="-1" aria-labelledby="loginModalLabel-v3" aria-hidden="true">
    <div class="modal-dialog modal-dialog-v3 modal-dialog-centered">
      <div class="modal-content modal-content-v3">
        <div class="modal-header modal-header-v3">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body modal-body-v3">
          <p class="fs-5 mb-3">H√¨nh nh∆∞ b·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!</p>
          <p class="fs-6 mb-4">Vui l√≤ng ƒëƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω ƒë·ªÉ ti·∫øp t·ª•c.</p>
          <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-custom-v3 btn-login-v3" data-bs-dismiss="modal" data-bs-toggle="modal"
              data-bs-target="#authModal" onclick="toggleForm('loginForm')">ƒêƒÉng nh·∫≠p</button>
            <button type="button" class="btn btn-custom-v3 btn-register-v3" data-bs-dismiss="modal"
              data-bs-toggle="modal" data-bs-target="#authModal" onclick="toggleForm('registerForm')">ƒêƒÉng k√Ω</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content"
      style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding-bottom: 1rem;">

      <!-- ƒêƒÉng Nh·∫≠p -->
      <div id="loginForm" style="display: block;">
        <div class="modal-header text-center"
          style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
          <h5 class="modal-title" id="authModalLabel"
            style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">ƒêƒÉng Nh·∫≠p</h5>
        </div>
        <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
          <form id="formLogin">
            <div class="mb-3">
              <label for="loginUsername" class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
              <input type="text" class="form-control" id="loginUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
            </div>
            <div class="mb-4">
              <label for="loginPassword" class="form-label">M·∫≠t kh·∫©u</label>
              <input type="password" class="form-control" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="btn"
              style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
              ƒêƒÉng Nh·∫≠p
            </button>
          </form>
          <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
            <span class="text-muted" style="margin-right: 5px;">Ch∆∞a c√≥ t√†i kho·∫£n?</span>
            <button onclick="toggleForm('registerForm')" class="btn btn-link p-0"
              style="text-decoration: none; color: #007bff; font-weight: 500;">
              ƒêƒÉng k√Ω ngay
            </button>
          </div>
        </div>
      </div>

      <!-- ƒêƒÉng K√Ω -->
      <div id="registerForm" style="display: none;">
        <div class="modal-header text-center" style="background: #fff; padding: 1.5rem; border-bottom: 1px solid #eee;">
          <h5 class="modal-title" style="font-size: 1.5rem; font-weight: bold; color: #333; margin: 0;">ƒêƒÉng K√Ω</h5>
        </div>
        <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
          <form id="formRegister">
            <!-- H·ªç v√† t√™n -->
            <div class="mb-3">
              <label for="registerFullname" class="form-label">H·ªç v√† t√™n</label>
              <input type="text" class="form-control" id="registerFullname" placeholder="Nguy·ªÖn VƒÉn A" required>
            </div>
            <small id="fullnameNote" class="form-note" style="display: none; color: #d9534f; font-size: 0.875rem; font-style: italic;">
              Vui l√≤ng s·ª≠ d·ª•ng t√™n th·∫≠t, ch√∫ng t√¥i s·∫Ω t·ª± ƒë·ªông x√≥a nh·ªØng t√†i kho·∫£n t√™n gi·∫£ v√† ch·∫∑n b·∫°n vƒ©nh vi·ªÖn kh·ªèi h·ªá th·ªëng!
            </small>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const fullnameInput = document.getElementById("registerFullname");
                const fullnameNote = document.getElementById("fullnameNote");
                fullnameInput.addEventListener("input", function () {
                  fullnameNote.style.display = "block";
                });
              });
            </script>

            <!-- T√™n ƒëƒÉng nh·∫≠p -->
            <div class="mb-3">
              <label for="registerUsername" class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
              <input type="text" class="form-control" id="registerUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
            </div>

            <!-- M·∫≠t kh·∫©u v·ªõi toggle icon -->
            <div class="mb-4">
              <label for="registerPassword" class="form-label">M·∫≠t kh·∫©u</label>
              <div class="input-group">
                <input type="password" class="form-control" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <span class="input-group-text" id="togglePassword" style="cursor: pointer;">
                  <i class="fa fa-eye"></i>
                </span>
              </div>
            </div>

            <!-- X√°c nh·∫≠n m·∫≠t kh·∫©u v·ªõi toggle icon -->
            <div class="mb-4">
              <label for="confirmPassword" class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <span class="input-group-text" id="toggleConfirmPassword" style="cursor: pointer;">
                  <i class="fa fa-eye"></i>
                </span>
              </div>
            </div>
            <!-- Th√¥ng b√°o l·ªói n·∫øu m·∫≠t kh·∫©u kh√¥ng kh·ªõp -->
            <div id="passwordError" style="color: #d9534f; font-size: 0.875rem; display: none;">
              M·∫≠t kh·∫©u kh√¥ng kh·ªõp
            </div>

            <!-- Ch·ªçn tr∆∞·ªùng ƒê·∫°i H·ªçc -->
            <div class="mb-3">
              <label for="registerUniversity" class="form-label">Tr∆∞·ªùng ƒê·∫°i H·ªçc</label>
              <select class="form-control" id="registerUniversity" required>
                <option value="" disabled selected>Ch·ªçn tr∆∞·ªùng ƒë·∫°i h·ªçc</option>
              </select>
            </div>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
                // T·∫£i danh s√°ch tr∆∞·ªùng
                fetch("/api/schools")
                  .then(response => response.json())
                  .then(data => {
                    const selectElement = document.getElementById("registerUniversity");
                    data.forEach(school => {
                      const option = document.createElement("option");
                      option.value = school.id;
                      option.textContent = school.name;
                      selectElement.appendChild(option);
                    });
                  })
                  .catch(error => console.error("L·ªói khi t·∫£i danh s√°ch tr∆∞·ªùng:", error));

                // Toggle hi·ªÉn th·ªã m·∫≠t kh·∫©u cho √¥ M·∫≠t kh·∫©u
                const togglePassword = document.getElementById("togglePassword");
                const passwordInput = document.getElementById("registerPassword");
                togglePassword.addEventListener("click", function () {
                  const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
                  passwordInput.setAttribute("type", type);
                  this.innerHTML = type === "password" ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });

                // Toggle hi·ªÉn th·ªã m·∫≠t kh·∫©u cho √¥ X√°c nh·∫≠n m·∫≠t kh·∫©u
                const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");
                const confirmPasswordInput = document.getElementById("confirmPassword");
                toggleConfirmPassword.addEventListener("click", function () {
                  const type = confirmPasswordInput.getAttribute("type") === "password" ? "text" : "password";
                  confirmPasswordInput.setAttribute("type", type);
                  this.innerHTML = type === "password" ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });

                // Ki·ªÉm tra xem m·∫≠t kh·∫©u c√≥ kh·ªõp hay kh√¥ng
                const passwordError = document.getElementById("passwordError");
                confirmPasswordInput.addEventListener("input", function () {
                  if (confirmPasswordInput.value !== passwordInput.value) {
                    passwordError.style.display = "block";
                  } else {
                    passwordError.style.display = "none";
                  }
                });
              });
            </script>

            <!-- N√∫t ƒëƒÉng k√Ω -->
            <button type="submit" class="btn" style="background: #6366f1; color: white; padding: 0.75rem 2rem; border-radius: 8px; width: 100%; transition: 0.3s;">
              ƒêƒÉng K√Ω
            </button>
          </form>
          <div class="text-center mt-3" style="display: flex; justify-content: center; align-items: center;">
            <span class="text-muted" style="margin-right: 5px;">ƒê√£ c√≥ t√†i kho·∫£n?</span>
            <button onclick="toggleForm('loginForm')" class="btn btn-link p-0" style="text-decoration: none; color: #007bff; font-weight: 500;">
              ƒêƒÉng nh·∫≠p ngay
            </button>
          </div>
        </div>
      </div>



      <!-- Footer ch·ª©a n√∫t ƒê√≥ng -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>

    </div>
  </div>
</div>
<!-- Modal b√°o l·ªói -->
<div class="mr-modal-overlay" id="mr-modal" style="display: none;">
  <div class="mr-modal-container">
    <div class="mr-modal-header">
      <h2 class="mr-modal-title">
        <i class="fas fa-bug"></i>
        B√°o c√°o s·ª± c·ªë
      </h2>
      <button class="mr-close-btn" onclick="mr_hideModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="mr-modal-content">
      <form id="mr-reportForm" onsubmit="mr_handleSubmit(event)">
        <!-- Hi·ªÉn th·ªã t√™n ƒë·ªÅ thi (readonly) -->
        <div class="mr-input-group">
          <input 
            type="text" 
            class="mr-form-input" 
            placeholder=" " 
            id="document_name"
            value="ƒê·ªÅ thi m·∫∑c ƒë·ªãnh" 
            readonly>
          <label class="mr-form-label">ƒê·ªÅ thi</label>
        </div>
        <!-- Input ·∫©n cho document_id -->
        <input type="hidden" id="document_id" name="document_id" value="">
        <!-- Input ·∫©n cho user_id (gi·∫£ s·ª≠ l·∫•y t·ª´ bi·∫øn currentUserId) -->
        <input type="hidden" id="user_id" name="user_id" value="">

        <!-- N·ªôi dung b√°o c√°o -->
        <div class="mr-input-group">
          <textarea 
            class="mr-form-input" 
            placeholder=" "
            id="report_content"
            rows="4"
            required
          ></textarea>
          <label class="mr-form-label">M√¥ t·∫£ chi ti·∫øt</label>
        </div>

        <div class="mr-action-buttons">
          <button type="button" class="mr-btn mr-btn-secondary" onclick="mr_hideModal()">
            H·ªßy b·ªè
          </button>
          <button type="submit" class="mr-btn mr-btn-primary">
            <i class="fas fa-paper-plane"></i>
            G·ª≠i b√°o c√°o
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Gi·∫£ s·ª≠ currentUserId ƒë∆∞·ª£c l·∫•y t·ª´ session ho·∫∑c bi·∫øn to√†n c·ª•c
  const currentUserId = 1; // V√≠ d·ª•

  // Ch√®n CSS c·ªßa modal qua DOM v√† prepend v√†o <head> ƒë·ªÉ ∆∞u ti√™n th·ª±c thi
  (function() {
    const style = document.createElement('style');
    style.type = 'text/css';
    style.id = 'mr-modalStyles';
    const css = `
      :root {
        --mr-primary: #6366f1;
        --mr-primary-hover: #4f46e5;
        --mr-background: #ffffff;
        --mr-text: #1e293b;
        --mr-glass: rgba(255, 255, 255, 0.9);
        --mr-border: #e2e8f0;
      }
      
      @media (prefers-color-scheme: dark) {
        :root {
          --mr-background: #0f172a;
          --mr-text: #f8fafc;
          --mr-glass: rgba(15, 23, 42, 0.9);
          --mr-border: #334155;
        }
      }
    
      /* Modal Overlay */
      .mr-modal-overlay {
        position: fixed;
        inset: 0;
        background: transparent;
        backdrop-filter: none;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: mr-fadeIn 0.3s ease;
      }
      
      /* Modal Container */
      .mr-modal-container {
        width: 90%;
        max-width: 480px;
        background: var(--mr-glass);
        border: 1px solid var(--mr-border);
        border-radius: 24px;
        backdrop-filter: blur(16px);
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.1);
        transform: scale(0.95);
        opacity: 0;
        animation: mr-modalEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }
      
      /* Modal Header */
      .mr-modal-header {
        padding: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--mr-border);
      }
      
      .mr-modal-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--mr-text);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .mr-close-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--mr-text);
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      
      .mr-close-btn:hover {
        opacity: 1;
      }
      
      /* Modal Content */
      .mr-modal-content {
        padding: 24px;
      }
      
      /* Form Elements */
      .mr-input-group {
        margin-bottom: 24px;
        position: relative;
      }
      
      .mr-form-input {
        width: 100%;
        padding: 16px;
        border: 2px solid var(--mr-border);
        border-radius: 12px;
        background: transparent;
        color: var(--mr-text);
        font-size: 16px;
        transition: border-color 0.3s;
      }
      
      .mr-form-input:focus {
        outline: none;
        border-color: var(--mr-primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }
      
      .mr-form-label {
        position: absolute;
        left: 16px;
        top: 16px;
        color: #64748b;
        pointer-events: none;
        transition: all 0.3s;
        background: var(--mr-glass);
        padding: 0 4px;
      }
      
      .mr-form-input:focus ~ .mr-form-label,
      .mr-form-input:not(:placeholder-shown) ~ .mr-form-label {
        transform: translateY(-24px);
        font-size: 14px;
        color: var(--mr-primary);
      }
      
      /* Action Buttons */
      .mr-action-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
      }
      
      .mr-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        gap: 8px;
        align-items: center;
        transition: all 0.3s;
      }
      
      .mr-btn-primary {
        background: var(--mr-primary);
        color: white;
      }
      
      .mr-btn-primary:hover {
        background: var(--mr-primary-hover);
        transform: translateY(-1px);
      }
      
      .mr-btn-secondary {
        background: rgba(99, 102, 241, 0.1);
        color: var(--mr-primary);
        border: 1px solid var(--mr-border);
      }
      
      .mr-btn-secondary:hover {
        background: rgba(99, 102, 241, 0.2);
      }
      
      /* Animations */
      @keyframes mr-fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes mr-modalEnter {
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      /* Success Animation */
      .mr-success-check {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--mr-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 24px auto;
        animation: mr-checkBounce 0.6s ease;
      }
      
      @keyframes mr-checkBounce {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      
      /* Responsive Design */
      @media (max-width: 480px) {
        .mr-modal-container {
          border-radius: 16px;
        }
        
        .mr-modal-title {
          font-size: 20px;
        }
        
        .mr-form-input {
          padding: 14px;
        }
      }
    `;
    style.textContent = css;
    document.head.prepend(style);
  })();

  // H√†m m·ªü modal b√°o l·ªói v√† c·∫≠p nh·∫≠t n·ªôi dung "ƒê·ªÅ thi" c≈©ng nh∆∞ document_id
  function openReportModal(file) {
    const modal = document.getElementById('mr-modal');
    // C·∫≠p nh·∫≠t t√™n ƒë·ªÅ thi
    const examInput = document.getElementById('document_name');
    if(examInput) {
      examInput.value = file.file_name;
    }
    // L∆∞u document_id v√†o input ·∫©n
    document.getElementById('document_id').value = file.id;
    // C·∫≠p nh·∫≠t user_id (gi·∫£ s·ª≠ l·∫•y t·ª´ bi·∫øn currentUserId)
    document.getElementById('user_id').value = currentUserId;
    
    mr_showModal();
    console.log("M·ªü modal b√°o l·ªói cho file:", file.file_name);
  }

  // H√†m m·ªü modal
  function mr_showModal() {
    const modal = document.getElementById('mr-modal');
    modal.style.display = 'flex';
    modal.style.opacity = '1';
    document.body.style.overflow = 'hidden';
  }

  // H√†m ƒë√≥ng modal
  function mr_hideModal() {
    const modal = document.getElementById('mr-modal');
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      // Reset form n·∫øu c·∫ßn
      resetReportForm();
    }, 300);
  }

  // Reset form modal v·ªÅ ban ƒë·∫ßu
  function resetReportForm() {
    const form = document.getElementById('mr-reportForm');
    form.reset();
    // N·∫øu b·∫°n c√≥ n·ªôi dung HTML m·∫∑c ƒë·ªãnh c·∫ßn kh√¥i ph·ª•c th√¨ c√≥ th·ªÉ ƒë·∫∑t l·∫°i ·ªü ƒë√¢y.
    // V√≠ d·ª•: reset gi√° tr·ªã c·ªßa document_name n·∫øu c·∫ßn.
  }

  // X·ª≠ l√Ω submit form b√°o l·ªói, g·ª≠i d·ªØ li·ªáu ƒë·∫øn backend
  async function mr_handleSubmit(e) {
    e.preventDefault();
    
    const user_id = document.getElementById('user_id').value;
    const document_id = document.getElementById('document_id').value;
    const report_content = document.getElementById('report_content').value;
    
    if (!user_id || !document_id || !report_content) {
      alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin b√°o c√°o.");
      return;
    }
    
    // G√≥i d·ªØ li·ªáu theo ƒë·ªãnh d·∫°ng JSON
    const payload = {
      user_id: user_id,
      document_id: document_id,
      report_content: report_content
    };

    try {
      // G·ªçi API POST ƒë·∫øn backend
      const response = await fetch('/report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      if(response.ok) {
        // Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi form th√†nh th√¥ng b√°o th√†nh c√¥ng
        const form = document.getElementById('mr-reportForm');
        form.style.opacity = '0';
        setTimeout(() => {
          form.innerHTML = `
            <div class="mr-success-check">
              <i class="fas fa-check" style="color: white; font-size: 24px;"></i>
            </div>
            <h3 style="text-align: center; color: var(--mr-text); margin-bottom: 24px;">
              B√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!
            </h3>
            <button 
              class="mr-btn mr-btn-primary" 
              style="margin: 0 auto;" 
              onclick="mr_hideModal()"
            >
              ƒê√≥ng
            </button>
          `;
          form.style.opacity = '1';
        }, 500);
      } else {
        const errorData = await response.json();
        alert("C√≥ l·ªói x·∫£y ra: " + (errorData.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (error) {
      console.error("L·ªói khi g·ª≠i b√°o c√°o:", error);
      alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
    }
  }

  // ƒê√≥ng modal khi click b√™n ngo√†i container
  document.getElementById('mr-modal').addEventListener('click', function(e) {
    if (e.target === this) mr_hideModal();
  });

  // ƒê√≥ng modal khi nh·∫•n ph√≠m ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') mr_hideModal();
  });
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /*************************************
   * C√°c h√†m h·ªó tr·ª£ chuy·ªÉn ƒë·ªïi gi·ªØa form *
   *************************************/
  // H√†m toggleForm: Chuy·ªÉn ƒë·ªïi hi·ªÉn th·ªã gi·ªØa form ƒëƒÉng nh·∫≠p v√† ƒëƒÉng k√Ω
  function toggleForm(formId) {
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    if (formId === "loginForm") {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
    } else {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
    }
  }

  // Khi modal x√°c th·ª±c (authModal) ƒë√≥ng, reset form v√† hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
  document.getElementById('authModal').addEventListener('hidden.bs.modal', function () {
    toggleForm('loginForm');
    document.getElementById('formLogin').reset();
    document.getElementById('formRegister').reset();
  });

  /*************************************
   * H√†m ki·ªÉm tra v√† reset l·ªãch s·ª≠      *
   *************************************/
  // H√†m checkAndResetHistory: Ki·ªÉm tra th√¥ng tin tr∆∞·ªùng c·ªßa user qua API /user/university,
  // so s√°nh v·ªõi l·ªãch s·ª≠ truy c·∫≠p (examCurrentPath, syllabusCurrentPath) v√† reset n·∫øu kh√¥ng kh·ªõp.
  async function checkAndResetHistory() {
    try {
      const res = await fetch('/user/university', { credentials: 'include' });
      if (res.ok) {
        const userSchool = await res.json();
        window.userSchoolId = userSchool.university;
        console.log("User school id:", window.userSchoolId);
        console.log("Exam history school id:", examCurrentPath.length > 0 ? examCurrentPath[0].id : 'none');
        console.log("Syllabus history school id:", syllabusCurrentPath.length > 0 ? syllabusCurrentPath[0].id : 'none');

        // N·∫øu l·ªãch s·ª≠ c·ªßa ƒê·ªÅ Thi kh√¥ng kh·ªõp, reset n√≥
        if (examCurrentPath.length > 0 && String(examCurrentPath[0].id) !== String(window.userSchoolId)) {
          console.log("Reset exam history");
          examCurrentPath = [];
          localStorage.removeItem('examCurrentPath');
        }
        // N·∫øu l·ªãch s·ª≠ c·ªßa ƒê·ªÅ C∆∞∆°ng kh√¥ng kh·ªõp, reset n√≥
        if (syllabusCurrentPath.length > 0 && String(syllabusCurrentPath[0].id) !== String(window.userSchoolId)) {
          console.log("Reset syllabus history");
          syllabusCurrentPath = [];
          localStorage.removeItem('syllabusCurrentPath');
        }
      } else {
        console.warn("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin tr∆∞·ªùng c·ªßa user");
      }
    } catch (error) {
      console.error("L·ªói khi ki·ªÉm tra l·ªãch s·ª≠ tr∆∞·ªùng:", error);
    }
  }

  /*************************************
   * X·ª≠ l√Ω ƒëƒÉng nh·∫≠p                   *
   *************************************/
document.getElementById('formLogin').addEventListener('submit', function (e) {
  e.preventDefault();

  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  // Ki·ªÉm tra username: ch·ªâ cho ph√©p ch·ªØ (kh√¥ng d·∫•u) v√† s·ªë, kh√¥ng c√≥ kho·∫£ng tr·∫Øng
  const usernameRegex = /^[a-zA-Z0-9]+$/;
  if (!usernameRegex.test(username)) {
    triggerNotification('warning', 'C·∫£nh b√°o', 'Vui l√≤ng tu√¢n th·ªß quy t·∫Øc ƒë·∫∑t user name: kh√¥ng d·∫•u, kh√¥ng c√°ch.');
    return;
  }

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        triggerNotification('danger', 'L·ªói', data.error);
      } else {
        triggerNotification('success', 'Th√†nh c√¥ng', data.message);
        // ƒê√≥ng modal sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
        const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
        authModal.hide();
        // Gi·ªØ nguy√™n logic check l·ªãch s·ª≠, sau ƒë√≥ delay 5s r·ªìi reload trang
        checkAndResetHistory()
          .then(() => new Promise(resolve => setTimeout(resolve, 3000)))
          .then(() => {
            window.parent.location.reload();
          });
      }
    })
    .catch(error => {
      console.error('L·ªói:', error);
      triggerNotification('danger', 'L·ªói', 'ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng nh·∫≠p');
    });
});

/*************************************
 * X·ª≠ l√Ω ƒëƒÉng k√Ω                     *
 *************************************/
document.getElementById('formRegister').addEventListener('submit', function (e) {
  e.preventDefault();

  const fullname = document.getElementById('registerFullname').value;
  const username = document.getElementById('registerUsername').value;
  const password = document.getElementById('registerPassword').value;
  const university = document.getElementById('registerUniversity').value;

  // Ki·ªÉm tra username: ch·ªâ cho ph√©p ch·ªØ (kh√¥ng d·∫•u) v√† s·ªë, kh√¥ng c√≥ kho·∫£ng tr·∫Øng
  const usernameRegex = /^[a-zA-Z0-9]+$/;
  if (!usernameRegex.test(username)) {
    triggerNotification('warning', 'C·∫£nh b√°o', 'Vui l√≤ng tu√¢n th·ªß quy t·∫Øc ƒë·∫∑t user name: kh√¥ng d·∫•u, kh√¥ng c√°ch.');
    return;
  }

  fetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fullname, username, password, university })
  })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        triggerNotification('danger', 'L·ªói', data.error);
        // N·∫øu l·ªói do IP ƒë√£ t·ªìn t·∫°i th√¨ t·ª± m·ªü modal c√≥ id "accountModal"
        if (data.error.includes("IP ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng")) {
          // ƒê√≥ng modal hi·ªán t·∫°i (gi·∫£ s·ª≠ modal ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω c√≥ id "authModal")
          var authModalEl = document.getElementById('authModal');
          var authModalInstance = bootstrap.Modal.getInstance(authModalEl);
          if (authModalInstance) {
            authModalInstance.hide();
          }
          // M·ªü modal m·ªõi c√≥ id "accountModal"
          var accountModal = new bootstrap.Modal(document.getElementById("accountModal"));
          accountModal.show();
        }
      } else {
        triggerNotification('success', 'Th√†nh c√¥ng', data.message);
        // Sau khi ƒëƒÉng k√Ω th√†nh c√¥ng, chuy·ªÉn sang form ƒëƒÉng nh·∫≠p
        toggleForm('loginForm');
        // Reset form ƒëƒÉng k√Ω
        document.getElementById('formRegister').reset();
        // T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin ƒëƒÉng nh·∫≠p v·ª´a ƒëƒÉng k√Ω v√†o form ƒëƒÉng nh·∫≠p
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = password;
      }
    })
    .catch(error => {
      console.error('L·ªói:', error);
      triggerNotification('danger', 'L·ªói', 'ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng k√Ω');
    });
});

  /*************************************
   * X·ª≠ l√Ω ƒëƒÉng xu·∫•t                   *
   *************************************/
  document.getElementById('logoutBtn').addEventListener('click', function () {
    fetch("/api/logout", {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" }
    })
      .then(response => response.json())
      .then(data => {
        // Hi·ªÉn th·ªã th√¥ng b√°o ƒëƒÉng xu·∫•t th√†nh c√¥ng
        triggerNotification('success', 'Th√†nh c√¥ng', data.message);
        // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß sau 2000ms
        setTimeout(() => {
          window.location.href = "/";
        }, 2000);
      })
      .catch(error => {
        triggerNotification('error', 'L·ªói', 'C√≥ l·ªói khi ƒëƒÉng xu·∫•t.');
        console.error("L·ªói:", error);
      });
  });

  /*************************************
   * DOMContentLoaded: C√°c s·ª± ki·ªán b·ªï sung *
   *************************************/
  document.addEventListener("DOMContentLoaded", function () {
    // C√°c s·ª± ki·ªán ho·∫∑c thao t√°c DOM b·ªï sung c√≥ th·ªÉ ƒë·∫∑t t·∫°i ƒë√¢y.
    // V√≠ d·ª•: T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin ƒëƒÉng nh·∫≠p sau ƒëƒÉng k√Ω ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü formRegister.
  });
</script>

<!-- Modal X√°c th·ª±c -->
<div class="modal fade" id="verificationModal-v2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <!-- Header s·ª≠ d·ª•ng Shadow DOM v·ªõi h·∫≠u t·ªë _v2 -->
      <modal-header-v2></modal-header-v2>

      <!-- Body -->
      <div class="modal-body pt-0">
        <p class="text-muted mb-4">
          T√†i kho·∫£n c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c. B·∫°n c·∫ßn ch·ªçn 1 trong 2 c√°ch sau nh√©! üòä
        </p>

        <!-- Ph∆∞∆°ng th·ª©c 1: ƒê√≥ng g√≥p ·∫£nh ƒë·ªÅ thi -->
        <div class="card mb-3 border-primary card-method-v2">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-cloud-upload fs-3 text-primary me-2"></i>
              <div>
                <h6 class="mb-1">ƒê√≥ng g√≥p ·∫£nh ƒë·ªÅ thi</h6>
                <p class="text-muted small mb-0">
                  Chia s·∫ª ·∫£nh ƒë·ªÅ thi b·∫•t k·ª≥ ƒë·ªÉ c·ªông ƒë·ªìng c√πng h·ªçc t·∫≠p
                </p>
              </div>
            </div>
            <div class="position-relative">
              <!-- File input cho ·∫£nh ƒë·ªÅ thi -->
              <input type="file" id="examImageUpload_v2" accept="image/*" class="d-none" multiple
                     data-container="fileNameExamImage_v2" onchange="handleFileUpload_v2(event, 'exam')">
              <label for="examImageUpload_v2" class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                <i class="bi bi-upload me-2"></i>Ch·ªçn ·∫£nh ƒë·ªÅ thi
              </label>
              <div id="fileNameExamImage_v2" class="text-muted small mt-2"></div>
            </div>
            <!-- N√∫t g·ª≠i file -->
            <button class="btn btn-success btn-sm mt-2" onclick="submitExamImage_v2()">
              <i class="bi bi-send me-2"></i>G·ª≠i ·∫£nh ƒë·ªÅ thi
            </button>
          </div>
        </div>

        <!-- Ph∆∞∆°ng th·ª©c 2: Chia s·∫ª v·ªõi b·∫°n b√® -->
        <div class="card border-success card-method-v2">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <i class="bi bi-share fs-3 text-success me-2"></i>
              <div>
                <h6 class="mb-1">Chia s·∫ª v·ªõi b·∫°n b√®</h6>
                <p class="text-muted small mb-0">
                  Share trang web cho 2 ng∆∞·ªùi b·∫°n ƒë·ªÉ x√°c th·ª±c
                </p>
              </div>
            </div>

            <div class="input-group mb-3">
              <div id="copyContent_v2" class="form-control bg-light">
                Kho l∆∞u tr·ªØ ƒë·ªÅ thi v√† ƒë·ªÅ c∆∞∆°ng qua c√°c nƒÉm, t·∫°i: huehub.fun
              </div>
              <button class="btn btn-success btn-copy-v2" onclick="copyText_v2()">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
            <div id="copySuccess_v2" class="text-success small mt-2" style="display:none;">
              <i class="bi bi-check2"></i> ƒê√£ sao ch√©p!
            </div>

            <!-- Ghi ch√∫ h∆∞·ªõng d·∫´n ch·ª•p m√†n h√¨nh -->
            <div class="mt-2">
              <small class="text-muted">
                Ghi ch√∫: Vui l√≤ng coppy r·ªìi g·ª≠i cho b·∫°n b√® ƒë·∫£m b·∫£o c√≥ s·ª± t∆∞∆°ng t√°c c·ªßa h·ªç r·ªìi ch·ª•p l·∫°i m√†n h√¨nh sau khi chia s·∫ª, sau ƒë√≥ ·∫•n "X√°c nh·∫≠n ƒë√£ chia s·∫ª"!
              </small>
            </div>
            <div class="position-relative">
              <!-- File input cho ·∫£nh ch·ª•p m√†n h√¨nh -->
              <input type="file" id="shareScreenshotUpload_v2" accept="image/*" class="d-none"
                     data-container="fileNameShareScreenshot_v2" onchange="handleFileUpload_v2(event, 'share')">
              <label for="shareScreenshotUpload_v2" class="btn btn-primary btn-sm mt-3 btn-contribute-v2 cursor-pointer">
                <i class="bi bi-upload me-2"></i>Ch·ªçn ·∫£nh m√†n h√¨nh
              </label>
              <div id="fileNameShareScreenshot_v2" class="text-muted small mt-2"></div>
            </div>

            <!-- N√∫t x√°c nh·∫≠n ƒë√£ chia s·∫ª -->
            <button class="btn btn-outline-success w-100 btn-confirm-share-v2 mt-2" onclick="confirmShare_v2()">
              <i class="bi bi-check-circle me-2"></i>X√°c nh·∫≠n ƒë√£ chia s·∫ª
            </button>
            <div id="confirmSuccess_v2" class="text-success small mt-2 text-center" style="display:none;">
              <i class="bi bi-check2-circle"></i> ƒê√£ x√°c nh·∫≠n chia s·∫ª!
            </div>
          </div>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã th√¥ng tin x√°c th·ª±c -->
        <div id="verification-alert" class="alert alert-danger mt-3" style="display: none;">
          <p class="mb-1">
            <strong>L·∫ßn x√°c th·ª±c g·∫ßn nh·∫•t:</strong> <span id="last-rejected-time">12/03/2025 09:45</span>
          </p>
          <p class="mb-0">
            <strong>L√Ω do t·ª´ ch·ªëi:</strong> <span id="rejection-note">Th√¥ng tin x√°c th·ª±c kh√¥ng h·ª£p l·ªá, vui l√≤ng ki·ªÉm tra l·∫°i</span>
          </p>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary btn-close-v2" data-bs-dismiss="modal">
          ƒê·ªÉ sau ƒëi
        </button>
      </div>
    </div>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    fetch('https://huehub.fun/get_verification_info', {
        method: 'GET',
        credentials: 'include', // G·ª≠i cookie session ƒë·ªÉ server nh·∫≠n di·ªán ng∆∞·ªùi d√πng
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const alertDiv = document.getElementById('verification-alert');
        const lastRejectedTimeSpan = document.getElementById('last-rejected-time');
        const rejectionNoteSpan = document.getElementById('rejection-note');

        if (data.status === 'rejected') {
            // C·∫≠p nh·∫≠t n·ªôi dung t·ª´ API
            lastRejectedTimeSpan.textContent = data.last_rejected_time || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
            rejectionNoteSpan.textContent = data.note || 'Kh√¥ng c√≥ ghi ch√∫';
            alertDiv.style.display = 'block'; // Hi·ªÉn th·ªã khi c√≥ d·ªØ li·ªáu
        } else {
            alertDiv.style.display = 'none'; // ·∫®n n·∫øu kh√¥ng c√≥ b·∫£n ghi b·ªã t·ª´ ch·ªëi
        }
    })
    .catch(error => {
        console.error('L·ªói khi g·ªçi API:', error);
        document.getElementById('verification-alert').style.display = 'none'; // ·∫®n n·∫øu c√≥ l·ªói
    });
});
</script>
  <!-- ƒê·ªãnh nghƒ©a custom element s·ª≠ d·ª•ng Shadow DOM cho header, v·ªõi t√™n c√≥ h·∫≠u t·ªë _v2 -->
  <script>
    class ModalHeaderV2 extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
        shadow.innerHTML = `
        <style>
          .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 0;
            padding: 1rem;
            padding-bottom: 0;
            background-color: transparent;
          }
          .header h5 {
            color: #0d6efd;
            margin: 0;
            font-size: 1.25rem;
          }
          .header button {
            background: transparent;
            border: none;
            cursor: pointer;
          }
        </style>
        <div class="header">
          <h5 class="modal-title">
            <i class="bi bi-patch-exclamation me-2"></i> X√°c th·ª±c t√†i kho·∫£n
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      `;
      }
    }
    customElements.define('modal-header-v2', ModalHeaderV2);
  </script>

  <script>
// Bi·∫øn l∆∞u file ri√™ng cho t·ª´ng ph∆∞∆°ng th·ª©c
let examFiles_v2 = [];
let shareFile_v2 = null;

// H√†m x·ª≠ l√Ω khi ch·ªçn file (h·∫≠u t·ªë _v2)
function handleFileUpload_v2(event, type) {
  const newFiles = Array.from(event.target.files);
  const containerId = event.target.getAttribute('data-container');
  let fileListHtml = '';

  if (type === 'exam') {
    // V·ªõi ·∫£nh ƒë·ªÅ thi: c·ªông d·ªìn v√†o m·∫£ng examFiles_v2
    examFiles_v2 = examFiles_v2.concat(newFiles);
    examFiles_v2.forEach(file => {
      fileListHtml += `<div><i class="bi bi-file-image"></i> ƒê√£ ch·ªçn: ${file.name}</div>`;
    });
  } else if (type === 'share') {
    // V·ªõi ·∫£nh share: ch·ªâ l∆∞u file ƒë·∫ßu ti√™n ƒë∆∞·ª£c ch·ªçn
    shareFile_v2 = newFiles[0];
    fileListHtml += `<div><i class="bi bi-file-image"></i> ƒê√£ ch·ªçn: ${shareFile_v2.name}</div>`;
  }
  document.getElementById(containerId).innerHTML = fileListHtml;
  // Reset gi√° tr·ªã c·ªßa input ƒë·ªÉ cho ph√©p ch·ªçn l·∫°i file n·∫øu c·∫ßn
  event.target.value = '';
}

// H√†m g·ª≠i ·∫£nh ƒë·ªÅ thi khi nh·∫•n "G·ª≠i ·∫£nh ƒë·ªÅ thi" (kh√¥ng thay ƒë·ªïi)
function submitExamImage_v2() {
    console.log("DEBUG: H√†m submitExamImage_v2 ƒë∆∞·ª£c g·ªçi");

    // Ki·ªÉm tra file ƒë∆∞·ª£c ch·ªçn (·∫£nh ƒë·ªÅ thi)
    if (!examFiles_v2 || examFiles_v2.length === 0) {
        console.error("ERROR: Kh√¥ng c√≥ ·∫£nh ƒë·ªÅ thi ƒë∆∞·ª£c ch·ªçn.", { examFiles_v2 });
        triggerNotification('error', 'L·ªói', 'Vui l√≤ng ch·ªçn ·∫£nh ƒë·ªÅ thi tr∆∞·ªõc khi g·ª≠i.');
        return;
    }
    console.log("DEBUG: S·ªë l∆∞·ª£ng file ƒë∆∞·ª£c ch·ªçn:", examFiles_v2.length);

    // T·∫°o m·∫£ng c√°c promise ƒë·ªÉ upload file
    const uploadPromises = examFiles_v2.map(file => {
        console.log("DEBUG: B·∫Øt ƒë·∫ßu upload file:", file.name);
        return uploadFile_v2(file, 'exam')
            .then(response => {
                console.log("DEBUG: Upload file th√†nh c√¥ng:", response);
                return response;
            })
            .catch(error => {
                console.error("ERROR: L·ªói khi upload file:", error);
                throw error;
            });
    });

    // Th·ª±c hi·ªán upload t·∫•t c·∫£ file
    Promise.all(uploadPromises)
        .then(results => {
            console.log("DEBUG: K·∫øt qu·∫£ upload file:", results);

            // Ki·ªÉm tra k·∫øt qu·∫£ upload
            const uploadedFilePaths = results.map(result => {
                if (!result || !result.filepath) {
                    console.error("ERROR: Upload file kh√¥ng tr·∫£ v·ªÅ filepath h·ª£p l·ªá", result);
                    throw new Error("Upload file kh√¥ng tr·∫£ v·ªÅ filepath h·ª£p l·ªá");
                }
                return result.filepath;
            });
            console.log("DEBUG: Danh s√°ch file path sau upload:", uploadedFilePaths);

            // Reset giao di·ªán sau khi upload th√†nh c√¥ng
            examFiles_v2 = [];
            document.getElementById('fileNameExamImage_v2').innerHTML = "";

            // G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i t√†i kho·∫£n
            console.log("DEBUG: G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i t√†i kho·∫£n...");
            return fetch('/update_account_status_v2', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
        })
        .then(response => {
            console.log("DEBUG: Response status c·ªßa update_account_status_v2:", response.status);
            if (!response.ok) {
                throw new Error(`L·ªói HTTP! status: ${response.status}`);
            }
            return response.json();
        })
        .then(statusData => {
            console.log("DEBUG: Response t·ª´ update_account_status_v2:", statusData);

            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng chung
            triggerNotification('warning', 'Th√¥ng b√°o', 'T√†i kho·∫£n c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x√©t duy·ªát, vui l√≤ng ƒë·ª£i');

            // ƒê√≥ng modal sau 2 gi√¢y
            setTimeout(() => {
                const modalElement = document.getElementById('verificationModal-v2');
                let modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalElement);
                }
                modalInstance.hide();
            }, 2000);
        })
        .catch(error => {
            console.error('ERROR: L·ªói trong qu√° tr√¨nh upload ho·∫∑c c·∫≠p nh·∫≠t:', error);
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói chung
            triggerNotification('error', 'L·ªói', 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
        });
}
function uploadFile_v2(file, type) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('type', type);

  return fetch('/upload_v2', {
    method: 'POST',
    body: formData
  })
    .then(response => {
      console.log(`Response t·ª´ uploadFile_v2 (${type}):`, response);
      return response.json();
    })
    .then(data => {
      console.log('Upload th√†nh c√¥ng:', data);
      return data;
    })
    .catch(error => {
      console.error(`ERROR: L·ªói khi upload file (${type}):`, error);
      throw error;
    });
}

function copyText_v2() {
  const text = document.getElementById('copyContent_v2').innerText;
  navigator.clipboard.writeText(text);

  const successMsg = document.getElementById('copySuccess_v2');
  successMsg.style.display = 'block';
  setTimeout(() => successMsg.style.display = 'none', 2000);
}

// H√†m x√°c nh·∫≠n ƒë√£ chia s·∫ª: ch·ªâ upload ·∫£nh m√†n h√¨nh khi ng∆∞·ªùi d√πng ·∫•n n√∫t x√°c nh·∫≠n
function confirmShare_v2() {
    // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ch·ªçn ·∫£nh ch∆∞a
    if (!shareFile_v2) {
        alert("Vui l√≤ng ch·ªçn ·∫£nh m√†n h√¨nh tr∆∞·ªõc khi x√°c nh·∫≠n.");
        return;
    }

    // Upload ·∫£nh chia s·∫ª
    uploadFile_v2(shareFile_v2, 'share')
        .then(data => {
            console.log("Upload ·∫£nh chia s·∫ª th√†nh c√¥ng:", data);

            // Reset file v√† giao di·ªán sau khi upload th√†nh c√¥ng
            shareFile_v2 = null;
            document.getElementById('fileNameShareScreenshot_v2').innerHTML = "";

            // G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i t√†i kho·∫£n
            console.log("G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i t√†i kho·∫£n...");
            return fetch('/update_account_status_v2', {
                method: 'POST',
                credentials: 'include', // Server s·∫Ω l·∫•y user_id t·ª´ session
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
        })
        .then(response => {
            console.log("Response status c·ªßa update_account_status_v2:", response.status);
            if (!response.ok) {
                throw new Error(`L·ªói HTTP! status: ${response.status}`);
            }
            return response.json();
        })
        .then(statusData => {
            console.log("Response t·ª´ update_account_status_v2:", statusData);

            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            triggerNotification('success', 'Th√†nh c√¥ng', '·∫¢nh chia s·∫ª ƒë√£ ƒë∆∞·ª£c upload v√† tr·∫°ng th√°i t√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.');

            // ƒê√≥ng modal sau 2 gi√¢y
            setTimeout(() => {
                const modalElement = document.getElementById('verificationModal-v2');
                let modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalElement);
                }
                modalInstance.hide();
            }, 2000);
        })
        .catch(error => {
            console.error("L·ªói khi upload ·∫£nh chia s·∫ª ho·∫∑c c·∫≠p nh·∫≠t tr·∫°ng th√°i:", error);
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            triggerNotification('error', 'L·ªói', 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
        });
}
    function copyText_v2() {
      const text = document.getElementById('copyContent_v2').innerText;
      navigator.clipboard.writeText(text);

      const successMsg = document.getElementById('copySuccess_v2');
      successMsg.style.display = 'block';
      setTimeout(() => successMsg.style.display = 'none', 2000);
    }

  </script>

  <style>
    .cursor-pointer {
      cursor: pointer;
    }

    .modal-content {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .card-method-v2 {
      transition: transform 0.2s;
    }

    .btn-success {
      background: #28a745;
      border-color: #28a745;
    }

    .btn-confirm-share-v2 {
      transition: background-color 0.2s, color 0.2s;
    }

    .btn-confirm-share-v2:hover {
      background-color: #28a745;
      color: white;
    }
  </style>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* CSS cho thi·∫øt b·ªã di ƒë·ªông */
    @media (max-width: 576px) {

      /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc modal */
      .modal-dialog {
        max-width: 95%;
        margin: 1rem auto;
      }

      /* ƒêi·ªÅu ch·ªânh padding cho modal */
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }

      /* ƒêi·ªÅu ch·ªânh ti√™u ƒë·ªÅ modal */
      .modal-title {
        font-size: 1.25rem;
      }

      /* S·∫Øp x·∫øp l·∫°i c√°c c·ªôt ho·∫°t ƒë·ªông theo d·∫°ng d·ªçc */
      .activity-container {
        display: flex;
        flex-direction: column;
      }

      /* Cho m·ªói h·ªôp ho·∫°t ƒë·ªông chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
      .activity-box {
        width: 100%;
        margin-bottom: 1rem;
      }
    }
  </style>


  <style>
    /* Container ch·ª©a 2 c·ªôt */
    .activity-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Khung th√¥ng b√°o c·ªßa m·ªói c·ªôt */
    .activity-box {
      flex: 1;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
      animation: fadeIn 0.6s forwards;
    }

    /* Hi·ªáu ·ª©ng fade-in */
    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    /* Ti√™u ƒë·ªÅ m·ªói c·ªôt */
    .activity-box h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      border-bottom: 2px solid;
      padding-bottom: 10px;
    }

    /* Ph√¢n bi·ªát ti√™u ƒë·ªÅ t·ª´ng c·ªôt */
    .user-activity h3 {
      border-color: #007bff;
      color: #007bff;
    }

    .system-activity h3 {
      border-color: #28a745;
      color: #28a745;
    }

    /* C√°c m·ª•c trong danh s√°ch */
    .list-group-item {
      border: none;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      background-color: transparent !important;
    }


    .list-group-item:last-child {
      border-bottom: none;
    }

    .list-group-item {
      background-color: transparent !important;
      backdrop-filter: none !important;
      box-shadow: none !important;
    }

    .list-group-item:hover,
    .list-group-item:focus,
    .list-group-item:active {
      background-color: transparent !important;
    }

    /* N·ªôi dung ho·∫°t ƒë·ªông */
    .activity-text {
      display: block;
      font-size: 1rem;
      color: #555;
    }

    /* Th·ªùi gian ho·∫°t ƒë·ªông */
    .activity-time {
      font-size: 0.9rem;
      color: #888;
      font-style: italic;
      margin-top: 5px;
    }
  </style>
  </div>
  </div>
  </div>
  </div>

  <!-- Modal Resume: G·ª£i √Ω "Ti·∫øp t·ª•c xem" c√≥ n√∫t L·ªãch s·ª≠ xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
          <style>
            /* Container ch·ª©a c·∫£ hai c·ªôt */
            .activity-container {
              display: flex;
              gap: 20px;
              padding: 20px;
              background-color: #f9f9f9;
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            /* C·ªôt ho·∫°t ƒë·ªông c·ªßa ng∆∞·ªùi d√πng v√† h·ªá th·ªëng */
            .user-activity,
            .system-activity {
              flex: 1;
              background: #ffffff;
              border-radius: 12px;
              padding: 20px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            /* Ti√™u ƒë·ªÅ m·ªói c·ªôt */
            .user-activity h3,
            .system-activity h3 {
              font-size: 1.5rem;
              margin-bottom: 20px;
              color: #333;
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              border-bottom: 2px solid #007bff;
              padding-bottom: 10px;
            }

            /* Ph√¢n bi·ªát ti√™u ƒë·ªÅ c·ªôt ng∆∞·ªùi d√πng v√† h·ªá th·ªëng */
            .user-activity h3 {
              color: #007bff;
              /* M√†u xanh d∆∞∆°ng cho ng∆∞·ªùi d√πng */
            }

            .system-activity h3 {
              color: #28a745;
              /* M√†u xanh l√° cho h·ªá th·ªëng */
            }

            /* Khung ho·∫°t ƒë·ªông */
            .activity-box {
              background: #f9f9f9;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .activity-box:hover {
              transform: translateY(-5px);
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            /* N·ªôi dung trong khung ho·∫°t ƒë·ªông */
            .activity-box p {
              margin: 0;
              font-size: 1rem;
              color: #555;
            }

            .activity-box strong {
              color: #333;
            }

            /* Th·ªùi gian ho·∫°t ƒë·ªông */
            .activity-time {
              display: block;
              margin-top: 10px;
              font-size: 0.9rem;
              color: #888;
              font-style: italic;
            }
          </style>
          <p>B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c xem t·ª´ ch·ªó d·ªü dang c·ªßa <strong id="resumeTabName"></strong>?</p>
          <p id="resumePathDisplay"></p>

        </div>
        <div class="modal-footer">

          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">B·∫Øt ƒë·∫ßu
            m·ªõi</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Ti·∫øp t·ª•c</button>

        </div>
      </div>
    </div>
  </div>

  <!-- CSS b·ªï sung -->
  <style>
    /* T√πy ch·ªânh giao di·ªán Modal */
    .modal-content {
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      border: none;
    }

    .modal-header,
    .modal-footer {
      border: none;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.5rem;
    }

    .btn-close {
      font-size: 1.25rem;
    }

    .modal-body p {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #333;
    }

    #resumePathDisplay {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #565e64;
    }
  </style>

  <!-- Modal Resume: G·ª£i √Ω "Ti·∫øp t·ª•c xem" c√≥ n√∫t L·ªãch s·ª≠ xem -->
  <div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="resumeModalLabel">Welcome back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c xem t·ª´ ch·ªó d·ªü dang c·ªßa <strong id="resumeTabName"></strong>?
          </p>
          <p id="resumePathDisplay" class="text-muted"></p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" id="resumeCancelBtn" data-bs-dismiss="modal">B·∫Øt ƒë·∫ßu
            m·ªõi</button>
          <button type="button" class="btn btn-primary" id="resumeContinueBtn">Ti·∫øp t·ª•c</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal -->
  <!-- Modal ƒëƒÉng k√Ω t√†i kho·∫£n & c·∫•p l·∫°i m·∫≠t kh·∫©u -->
  <div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header gradient-bg text-white">
          <h5 class="modal-title">
            <i class="bi bi-shield-lock-fill me-2"></i>
            C·∫•p l·∫°i m·∫≠t kh·∫©u
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          <!-- Th√¥ng b√°o IP -->
          <div class="alert alert-warning small d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
              ƒê·ªãa ch·ªâ IP c·ªßa b·∫°n: <span id="userIP" class="fw-bold">...</span>
              <br>M·ªói IP ch·ªâ ƒë∆∞·ª£c t·∫°o t·ªëi ƒëa 1 t√†i kho·∫£n
            </div>
          </div>

          <!-- Danh s√°ch t√†i kho·∫£n -->
          <div id="accountList" class="mb-4 d-none">
            <h6 class="mb-3 fw-bold text-muted">
              <i class="bi bi-person-lines-fill me-2"></i>
              T√†i kho·∫£n ƒë√£ ƒëƒÉng k√Ω:
            </h6>
            <div class="row g-3" id="accountCards"></div>
          </div>

          <!-- Form b∆∞·ªõc 1: Nh·∫≠p username (ki·ªÉm tra xem ƒë√£ ƒëƒÉng k√Ω hay ch∆∞a) -->
          <form id="step1Form">
            <div class="instruction-box">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-info-circle me-2"></i>
                H∆∞·ªõng d·∫´n nh·∫≠p username:
              </h6>
              <p class="small mb-0">
                Nh·∫≠p username c·ªßa b·∫°n v√†o √¥ b√™n d∆∞·ªõi. Ch√∫ng t√¥i s·∫Ω ki·ªÉm tra v√† cho ph√©p c·∫•p l·∫°i m·∫≠t kh·∫©u n·∫øu t√†i kho·∫£n ƒë√£ ƒëƒÉng k√Ω.
              </p>
            </div>
            
            <div class="mb-4">
              <label class="form-label fw-bold">Nh·∫≠p username:</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-person-fill"></i>
                </span>
                <input type="text" 
                       class="form-control" 
                       name="username" 
                       required
                       placeholder="Nh·∫≠p username..."
                       pattern="[A-Za-z0-9]{4,20}">
              </div>
              <div class="form-text">Username t·ª´ 4-20 k√Ω t·ª±, ch·ªâ ch·ª©a ch·ªØ v√† s·ªë</div>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-custom">
                <span class="submit-text">Ti·∫øp t·ª•c</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>

          <!-- Form b∆∞·ªõc 2: Nh·∫≠p email ƒë·ªÉ nh·∫≠n m·∫≠t kh·∫©u m·ªõi -->
          <form id="step2Form" class="d-none">
            <div class="instruction-box">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-info-circle me-2"></i>
                H∆∞·ªõng d·∫´n nh·∫≠p email:
              </h6>
              <p class="small mb-0">
                Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email c·ªßa b·∫°n. Ch√∫ng t√¥i s·∫Ω g·ª≠i m·∫≠t kh·∫©u m·ªõi nh·∫•t v·ªÅ email n√†y.
                <br>ƒê·∫£m b·∫£o email ch√≠nh x√°c ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c th√¥ng tin t√†i kho·∫£n.
              </p>
            </div>
            
            <div class="mb-4">
              <label class="form-label fw-bold">Nh·∫≠p email nh·∫≠n m·∫≠t kh·∫©u m·ªõi:</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-envelope-fill"></i>
                </span>
                <input type="email" 
                       class="form-control" 
                       name="email" 
                       required
                       placeholder="Nh·∫≠p email...">
              </div>
              <div class="form-text">Vui l√≤ng ki·ªÉm tra c·∫£ h·ªôp th∆∞ spam n·∫øu kh√¥ng th·∫•y email</div>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-custom">
                <span class="submit-text">G·ª≠i m·∫≠t kh·∫©u</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>

          <!-- Th√¥ng b√°o (l·ªói ho·∫∑c th√†nh c√¥ng) -->
          <div id="responseMessage" class="mt-3 d-none"></div>
          <!-- Th√¥ng b√°o l·ªói ri√™ng cho form ki·ªÉm tra username -->
          <div id="errorMessage" class="alert alert-danger mt-3 d-none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Bootstrap JS v√† dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 1. Ch√®n CSS m·ªõi, scope ch·ªâ cho modal #accountModal
      const dynamicStyle = document.createElement('style');
      dynamicStyle.textContent = `
        /* C√°c bi·∫øn CSS n·∫øu c·∫ßn thi·∫øt */
        #accountModal .gradient-bg {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
        }
        #accountModal .custom-card {
          border: none;
          border-radius: 15px;
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
          box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }
        #accountModal .custom-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
        }
        #accountModal .btn-custom {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          border: none;
          color: white;
          padding: 12px 30px;
          border-radius: 30px;
          font-weight: 500;
          letter-spacing: 0.5px;
          transition: all 0.3s ease;
        }
        #accountModal .btn-custom:hover {
          transform: scale(1.05);
          box-shadow: 0 8px 25px rgba(106, 17, 203, 0.4);
        }
        #accountModal .form-control {
          border-radius: 10px;
          padding: 12px 20px;
          border: 2px solid #e9ecef;
          transition: all 0.3s ease;
        }
        #accountModal .form-control:focus {
          border-color: #6a11cb;
          box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }
        #accountModal .instruction-box {
          background: rgba(255, 255, 255, 0.9);
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 25px;
          border: 1px solid rgba(0, 0, 0, 0.05);
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        #accountModal .modal-content {
          border-radius: 20px;
          overflow: hidden;
          border: none;
        }
        #accountModal .error-shake {
          animation: shake 0.5s;
        }
        @keyframes shake {
          0% { transform: translateX(0); }
          25% { transform: translateX(-10px); }
          50% { transform: translateX(10px); }
          75% { transform: translateX(-5px); }
          100% { transform: translateX(0); }
        }
        #accountModal .input-group-text {
          background: white;
          border: 2px solid #e9ecef;
          border-right: none;
          border-radius: 10px 0 0 10px;
        }
        #accountModal .form-text {
          font-size: 0.85rem;
          color: #6c757d !important;
        }
        #accountModal .alert {
          border-radius: 10px;
          padding: 15px 20px;
        }
      `;
      document.head.appendChild(dynamicStyle);
      
      // 2. C√°c x·ª≠ l√Ω DOM b√™n trong modal
      // Kh·ªüi t·∫°o modal v·ªõi backdrop t·∫Øt (kh√¥ng c√≥ n·ªÅn ƒëen)
      const modal = new bootstrap.Modal(document.getElementById('accountModal'), { backdrop: false });
      const userIP = document.getElementById('userIP');
      const accountCards = document.getElementById('accountCards');
      const step1Form = document.getElementById('step1Form');
      const step2Form = document.getElementById('step2Form');
      const errorMessage = document.getElementById('errorMessage');
      const responseMessage = document.getElementById('responseMessage');
      
      // Bi·∫øn ch·ª©a danh s√°ch username ƒë√£ ƒëƒÉng k√Ω (ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ API)
      let registeredUsernames = [];
      // Bi·∫øn to√†n c·ª•c l∆∞u username h·ª£p l·ªá ƒë√£ ki·ªÉm tra ·ªü b∆∞·ªõc 1
      let validatedUsername = "";
      
      // L·∫•y IP th·ª±c t·∫ø qua ipify
      fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
          userIP.textContent = data.ip;
          checkIPLimit(data.ip);
        })
        .catch(error => {
          console.error('L·ªói khi l·∫•y IP:', error);
          userIP.textContent = 'Kh√¥ng l·∫•y ƒë∆∞·ª£c IP';
        });
      
      // H√†m format username: ·∫©n ph·∫ßn gi·ªØa (v√≠ d·ª•: "us****23")
      function formatUsername(username) {
        if (username.length <= 4) return username;
        return username.substr(0, 2) +
               '*'.repeat(username.length - 4) +
               username.substr(-2);
      }
      
      // Ki·ªÉm tra IP v√† hi·ªÉn th·ªã danh s√°ch t√†i kho·∫£n n·∫øu c√≥
      function checkIPLimit(ip) {
        fetch('/api/accounts_by_ip')
          .then(response => response.json())
          .then(data => {
            registeredUsernames = data.usernames || [];
            if (registeredUsernames.length > 0) {
              document.getElementById('accountList').classList.remove('d-none');
              accountCards.innerHTML = registeredUsernames
                .map(acc => `
                  <div class="col-md-6">
                    <div class="custom-card p-3 bg-light">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-person-circle me-3 fs-4 text-primary"></i>
                        <div>
                          <div class="fw-bold">${formatUsername(acc)}</div>
                          <small class="text-muted">ƒê√£ ƒëƒÉng k√Ω</small>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('');
            }
          })
          .catch(error => {
            console.error('L·ªói khi l·∫•y danh s√°ch t√†i kho·∫£n:', error);
          });
      }
      
      // X·ª≠ l√Ω form b∆∞·ªõc 1: Ki·ªÉm tra username
      step1Form.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const spinner = btn.querySelector('.spinner-border');
        const text = btn.querySelector('.submit-text');
        const usernameInput = this.querySelector('input[name="username"]');
        const username = usernameInput.value.trim();
        
        // Hi·ªÉn th·ªã loading
        text.classList.add('d-none');
        spinner.classList.remove('d-none');
        btn.disabled = true;
        errorMessage.classList.add('d-none');
        
        // Ki·ªÉm tra username d·ª±a tr√™n danh s√°ch l·∫•y t·ª´ API
        setTimeout(() => {
          const isUsernameValid = registeredUsernames.includes(username);
          
          if (isUsernameValid) {
            validatedUsername = username; // l∆∞u username ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra
            step1Form.classList.add('d-none');
            step2Form.classList.remove('d-none');
          } else {
            errorMessage.innerHTML = `
              <i class="bi bi-exclamation-circle-fill me-2"></i>
              Vui l√≤ng nh·∫≠p ƒë√∫ng username b·∫°n ƒë√£ ƒëƒÉng k√Ω!
            `;
            errorMessage.classList.remove('d-none');
            usernameInput.classList.add('error-shake');
            setTimeout(() => usernameInput.classList.remove('error-shake'), 500);
            usernameInput.focus();
          }
          
          // ·∫®n loading
          text.classList.remove('d-none');
          spinner.classList.add('d-none');
          btn.disabled = false;
        }, 1000);
      });
      
      // X·ª≠ l√Ω form b∆∞·ªõc 2: G·ª≠i y√™u c·∫ßu c·∫•p l·∫°i m·∫≠t kh·∫©u (l∆∞u email v√† username)
      step2Form.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const spinner = btn.querySelector('.spinner-border');
        const text = btn.querySelector('.submit-text');
        const emailInput = this.querySelector('input[name="email"]');
        const email = emailInput.value.trim();
        
        // Hi·ªÉn th·ªã loading
        text.classList.add('d-none');
        spinner.classList.remove('d-none');
        btn.disabled = true;
        responseMessage.classList.add('d-none');
        responseMessage.innerHTML = "";
        
        // G·ª≠i y√™u c·∫ßu qua API
        fetch('/api/request_password_reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: validatedUsername, email: email })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            responseMessage.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          } else {
            responseMessage.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
          }
          responseMessage.classList.remove('d-none');
        })
        .catch(error => {
          console.error('L·ªói:', error);
          responseMessage.innerHTML = `<div class="alert alert-danger">ƒê√£ x·∫£y ra l·ªói khi g·ª≠i y√™u c·∫ßu.</div>`;
          responseMessage.classList.remove('d-none');
        })
        .finally(() => {
          text.classList.remove('d-none');
          spinner.classList.add('d-none');
          btn.disabled = false;
          // ·∫®n modal sau v√†i gi√¢y (n·∫øu mu·ªën)
          setTimeout(() => modal.hide(), 3000);
        });
      });
    });
  </script>
  <!-- Modal T√¨m ki·∫øm M√¥n h·ªçc -->
  <div class="modal fade" id="customSearchModal" tabindex="-1" aria-labelledby="customSearchModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
        <!-- Modal Header -->
        <div class="custom-modal-header"
          style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 16px;">
          <h5 class="custom-modal-title" id="customSearchModalLabel"
            style="font-size: 1.25rem; font-weight: 600; color: #0d6efd;">
            <i class="fas fa-book-open me-2"></i>T√¨m ki·∫øm M√¥n h·ªçc
          </h5>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <!-- Search Input Group -->
          <div class="custom-search-input-group" style="position: relative; margin-bottom: 1rem;">
            <input type="text" id="subjectSearchInput" class="form-control form-control-lg"
              placeholder="Nh·∫≠p t√™n m√¥n h·ªçc..." aria-label="Search input"
              style="border-radius: 8px; padding-right: 50px; border: 1px solid #ced4da;">
            <button type="button"
              style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 8px 8px 0; background-color: #0d6efd; border: none; color: #fff;"
              onmouseover="this.style.backgroundColor='#0b5ed7'" onmouseout="this.style.backgroundColor='#0d6efd'">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <!-- Tip Text (Th√¥ng b√°o ch·ªçn tr∆∞·ªùng) -->
          <div id="schoolSelectionNotice" class="custom-tip-text d-none"
            style="display: flex; align-items: center; padding: 10px 15px; background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%); border-radius: 4px; font-size: 0.9em; color: #333; margin-top: 8px; margin-bottom: 16px;">
            <i class="fas fa-lightbulb icon-combined" style="font-size: 1em; margin-right: 10px;"></i>
            Th·ª© b·∫°n c·∫ßn l√† th·ª© ng∆∞·ªùi kh√°c c√≥, cho n√™n ƒë·ª´ng ng·∫ßn ng·∫°i ƒë√≥ng g√≥p d·ªØ li·ªáu ƒë·ªÉ x√¢y d·ª±ng c·ªông ƒë·ªìng nh√©!
          </div>

          <!-- K·∫øt qu·∫£ t√¨m ki·∫øm -->
          <h6 id="searchResultCount" class="text-muted mb-3">K·∫øt qu·∫£ t√¨m ki·∫øm (0)</h6>
          <div id="subjectSearchSuggestions" class="custom-scrollable-results"
            style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
            <!-- C√°c k·∫øt qu·∫£ t√¨m ki·∫øm s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y qua JS -->
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="custom-modal-footer"
          style="background-color: #f8f9fa; border-top: 1px solid #e9ecef; padding: 16px; display: flex; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (bao g·ªìm Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- HTML Imports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
    /* Khi modal ƒëang ho·∫°t ƒë·ªông, ·∫©n c√°c ph·∫ßn t·ª≠ kh√°c ngo√†i #modalContainer */
    body.modal-active > :not(#modalContainer) {
      display: none !important;
    }
  </style>

  <!-- Bao b·ªçc to√†n b·ªô HTML c·ªßa modal trong container c√≥ ID ri√™ng -->
  <!-- Modal Container -->
  <div id="modalContainer">
    <div class="modal" id="welcomeModal">
      <div class="modal-content" id="welcomeCard">
        <i class="fas fa-star badge" id="badgeIcon"></i>
        <h1 class="title" id="titleText">Ch√†o m·ª´ng th√†nh vi√™n!</h1>
        <p class="message" id="messageText">C·∫£m ∆°n b·∫°n ƒë√£ tham gia c·ªông ƒë·ªìng c·ªßa ch√∫ng t√¥i!</p>
        <button class="continue-btn" id="continueBtn">Ti·∫øp t·ª•c</button>
      </div>
    </div>
  </div>

  <script>
    // T·∫°o th·∫ª style v√† ch√®n CSS v√†o container #modalContainer
    const style = document.createElement('style');
    style.textContent = `
      /* Modal */
      #modalContainer .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          backdrop-filter: blur(5px);
          justify-content: center;
          align-items: center;
          opacity: 0;
          animation: fadeIn 1s ease-in forwards;
      }
      #modalContainer .modal-content {
          background: white;
          padding: 2.5rem;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          text-align: center;
          max-width: 500px;
          width: 90%;
          position: relative;
          overflow: hidden;
          transform: scale(0);
          animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      }
      @keyframes fadeIn {
          to { opacity: 1; }
      }
      @keyframes fadeOut {
          to { opacity: 0; }
      }
      #modalContainer .badge {
          font-size: 3rem;
          margin-bottom: 1.5rem;
          animation: float 3s ease-in-out infinite, twinkle 1.5s infinite;
          display: block !important;
      }
      #modalContainer .title {
          color: #333;
          font-size: 1.8rem;
          margin-bottom: 1rem;
          font-weight: 700;
          animation: slideIn 1s ease-in-out;
      }
      #modalContainer .message {
          color: #666;
          line-height: 1.6;
          margin-bottom: 1.5rem;
          animation: slideIn 1.5s ease-in-out;
      }
      #modalContainer .highlight {
          color: #e91e63;
          font-weight: 700;
      }
      #modalContainer .continue-btn {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          color: white;
          border: none;
          padding: 0.8rem 2rem;
          border-radius: 25px;
          font-size: 1rem;
          cursor: pointer;
          transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
          margin-top: 1rem;
          animation: slideIn 2s ease-in-out;
      }
      #modalContainer .continue-btn:hover {
          background: linear-gradient(135deg, #2575fc, #6a11cb);
          transform: translateY(-2px) scale(1.05);
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }
      #modalContainer .continue-btn:active {
          transform: translateY(0);
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      /* C√°c l·ªõp t√πy bi·∫øn cho t·ª´ng lo·∫°i th√†nh vi√™n */
      #modalContainer .first-member {
          background: linear-gradient(135deg, #fff9c4, #ffecb3);
          border: 2px solid #ffd54f;
      }
      #modalContainer .first-member .badge {
          color: #ffd54f;
      }
      #modalContainer .milestone {
          background: linear-gradient(135deg, #b3e5fc, #81d4fa);
          border: 2px solid #29b6f6;
      }
      #modalContainer .milestone .badge {
          color: #29b6f6;
      }
      #modalContainer .regular-member {
          background: linear-gradient(135deg, #f3e5f5, #e1bee7);
          border: 2px solid #ba68c8;
      }
      #modalContainer .regular-member .badge {
          color: #9c27b0;
      }
      /* Confetti */
      #modalContainer .confetti {
          position: absolute;
          width: 10px;
          height: 10px;
          background: #ffeb3b;
          border-radius: 50%;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          animation: confetti 3s linear;
      }
      @keyframes popIn {
          to { transform: scale(1); }
      }
      @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-15px); }
      }
      @keyframes confetti {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(-500px) rotate(720deg); opacity: 0; }
      }
      @keyframes slideIn {
          0% { transform: translateY(-20px); opacity: 0; }
          100% { transform: translateY(0); opacity: 1; }
      }
      @keyframes twinkle {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
      }
      @media (max-width: 600px) {
          #modalContainer .modal-content {
              padding: 1.5rem;
          }
          #modalContainer .title {
              font-size: 1.5rem;
          }
          #modalContainer .message {
              font-size: 0.9rem;
          }
          #modalContainer .continue-btn {
              padding: 0.6rem 1.5rem;
              font-size: 0.9rem;
          }
      }
    `;
    document.getElementById('modalContainer').appendChild(style);

    // H√†m hi·ªÉn th·ªã modal v√† ·∫©n c√°c giao di·ªán kh√°c b·∫±ng c√°ch th√™m class "modal-active" v√†o body
    function showWelcomeModal() {
      document.body.classList.add("modal-active");
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'flex';
    }

    // H√†m ·∫©n modal, x√≥a hi·ªáu ·ª©ng v√† hi·ªÉn th·ªã l·∫°i c√°c giao di·ªán kh√°c
    function hideWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.animation = 'fadeOut 0.6s ease-in forwards';
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.classList.remove("modal-active");
      }, 600);
    }

    // H√†m c·∫≠p nh·∫≠t th√¥ng ƒëi·ªáp modal d·ª±a tr√™n d·ªØ li·ªáu th√†nh vi√™n t·ª´ backend
    function updateWelcomeMessage(memberNumber, universityName) {
      const container = document.getElementById('welcomeCard');
      const message = document.getElementById('messageText');
      const icon = document.getElementById('badgeIcon');
      const title = document.getElementById('titleText');

      // Reset c√°c class c≈©
      container.className = 'modal-content';
      icon.className = 'badge';
      // Th√™m class m·∫∑c ƒë·ªãnh cho icon
      icon.classList.add('fas', 'fa-star');

      if (memberNumber === 1) {
        container.classList.add('first-member');
        icon.classList.add('fas', 'fa-crown');
        title.textContent = 'Kh·ªüi ƒë·∫ßu vƒ© ƒë·∫°i!';
        message.innerHTML = `üëë Ch√†o m·ª´ng <span class="highlight">th√†nh vi√™n ƒë·∫ßu ti√™n</span> c·ªßa ${universityName}!<br>
          B·∫°n l√† ng∆∞·ªùi ti√™n phong, m·ªü ra m·ªôt ch∆∞∆°ng m·ªõi ƒë·∫ßy h·ª©a h·∫πn cho c·ªông ƒë·ªìng c·ªßa ch√∫ng t√¥i. H√£y c√πng nhau t·∫°o n√™n nh·ªØng ƒëi·ªÅu k·ª≥ di·ªáu!`;
      } else if (memberNumber % 100 === 0) {
        container.classList.add('milestone');
        icon.classList.add('fas', 'fa-trophy');
        title.textContent = 'C·ªôt m·ªëc ƒë√°ng nh·ªõ!';
        message.innerHTML = `üéâ Ch√†o m·ª´ng <span class="highlight">th√†nh vi√™n th·ª© ${memberNumber}</span> c·ªßa ${universityName}!<br>
          C·ªôt m·ªëc n√†y kh√¥ng ch·ªâ l√† con s·ªë m√† c√≤n l√† minh ch·ª©ng cho s·ª± ph√°t tri·ªÉn m·∫°nh m·∫Ω c·ªßa c·ªông ƒë·ªìng ch√∫ng ta. H√£y ti·∫øp t·ª•c lan t·ªèa nƒÉng l∆∞·ª£ng t√≠ch c·ª±c!`;
        createConfetti();
      } else {
        container.classList.add('regular-member');
        icon.classList.add('fas', 'fa-user-plus');
        title.textContent = 'Th√†nh vi√™n m·ªõi!';
        message.innerHTML = `ü§ù Ch√†o m·ª´ng <span class="highlight">th√†nh vi√™n th·ª© ${memberNumber}</span> c·ªßa ${universityName}!<br>
          S·ª± hi·ªán di·ªán c·ªßa b·∫°n l√† m·ªôt ph·∫ßn quan tr·ªçng gi√∫p c·ªông ƒë·ªìng ch√∫ng ta ng√†y c√†ng ph√°t tri·ªÉn. H√£y c√πng nhau x√¢y d·ª±ng nh·ªØng gi√° tr·ªã tuy·ªát v·ªùi!`;
      }

      container.style.animation = 'none';
      void container.offsetWidth; // Reset animation
      container.style.animation = 'popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
      showWelcomeModal();
    }

    // H√†m t·∫°o hi·ªáu ·ª©ng confetti
    function createConfetti() {
      const colors = ['#ffeb3b', '#e91e63', '#4caf50', '#2196f3', '#ff9800'];
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.animationDelay = Math.random() * 1 + 's';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        document.getElementById('modalContainer').appendChild(confetti);

        setTimeout(() => {
          confetti.remove();
        }, 3000);
      }
    }

    // H√†m g·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i welcome_checked (chuy·ªÉn t·ª´ 0 th√†nh 1)
    function updateWelcomeStatus() {
      fetch('/api/update_welcome', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ welcome_checked: 1 })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error('Error updating welcome status:', data.error);
        } else {
          console.log('Welcome status updated:', data);
        }
      })
      .catch(error => console.error('Error:', error));
    }

    // X·ª≠ l√Ω s·ª± ki·ªán n√∫t "Ti·∫øp t·ª•c"
    const continueBtn = document.getElementById('continueBtn');
    continueBtn.addEventListener('click', () => {
      // G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i th√¥ng b√°o (chuy·ªÉn t·ª´ 0 th√†nh 1)
      updateWelcomeStatus();
      // ·∫®n modal v√† hi·ªÉn th·ªã l·∫°i c√°c giao di·ªán kh√°c
      hideWelcomeModal();
    });

    // H√†m l·∫•y d·ªØ li·ªáu t·ª´ backend v√† c·∫≠p nh·∫≠t modal ch√†o m·ª´ng
    function fetchMembershipData() {
      fetch('/membership_number') // ƒê·∫£m b·∫£o endpoint n√†y kh·ªõp v·ªõi backend c·ªßa b·∫°n
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error(data.error);
          } else {
            updateWelcomeMessage(data.membership_number, data.university);
          }
        })
        .catch(error => console.error('Error fetching membership data:', error));
    }
  </script>
<script>
  (function() {
    const css = `
      :root {
        --custom-primary-color: #4a90e2;
        --custom-accent-color: #6c5ce7;
        --custom-progress-color: #00cec9;
        --custom-glass-bg: rgba(255, 255, 255, 0.95);
      }

      @keyframes customFloatIn {
        0% {
            transform: translateY(100%) scale(0.9);
            opacity: 0;
        }
        80% {
            transform: translateY(-10px) scale(1.02);
        }
        100% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
      }

      .custom-notification-wrapper {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        animation: customFloatIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }

      /* S·ª≠ d·ª•ng flex cho container c·ªßa notification ƒë·ªÉ header v√† actions lu√¥n hi·ªÉn th·ªã,
         ph·∫ßn n·ªôi dung (grid) s·∫Ω cu·ªôn khi v∆∞·ª£t qu√° chi·ªÅu cao t·ªëi ƒëa */
      .custom-study-notification {
        width: 380px;
        background: var(--custom-glass-bg);
        border-radius: 16px;
        padding: 20px;
        backdrop-filter: blur(12px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        max-height: 80vh;
      }

      .custom-study-notification:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .custom-header-section {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-shrink: 0;
      }

      .custom-subject-badge {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--custom-primary-color), var(--custom-accent-color));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
      }

      .custom-subject-info {
        flex: 1;
      }

      .custom-subject-title {
        font: 600 18px/1.2 'Segoe UI', sans-serif;
        color: #2d3436;
        margin-bottom: 4px;
      }

      .custom-subject-progress {
        font: 500 12px/1.4 'Segoe UI', sans-serif;
        color: #636e72;
      }

      .custom-progress-bar {
        height: 4px;
        background: rgba(108, 92, 231, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 12px;
      }

      .custom-progress-fill {
        height: 100%;
        width: 65%;
        background: var(--custom-progress-color);
        border-radius: 2px;
        transition: width 0.5s ease;
      }

      /* Container grid ƒë∆∞·ª£c ƒë·∫∑t l√†m flex-grow ƒë·ªÉ chi·∫øm ph·∫ßn kh√¥ng gian c√≤n l·∫°i,
         n·∫øu d·ªØ li·ªáu nhi·ªÅu th√¨ s·∫Ω cu·ªôn theo chi·ªÅu d·ªçc */
      .custom-doc-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
        flex: 1 1 auto;
        overflow-y: auto;
      }

      /* CSS cho thanh cu·ªôn (scrollbar) tr√™n tr√¨nh duy·ªát Webkit */
      .custom-doc-grid::-webkit-scrollbar {
        width: 6px;
      }
      .custom-doc-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-doc-grid::-webkit-scrollbar-thumb {
        background: var(--custom-accent-color);
        border-radius: 3px;
      }
      
      /* Firefox scrollbar width */
      .custom-doc-grid {
        scrollbar-width: thin;
        scrollbar-color: var(--custom-accent-color) #f1f1f1;
      }

      .custom-doc-card {
        background: white;
        padding: 14px;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .custom-doc-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .custom-doc-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--custom-progress-color);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .custom-doc-card:hover::after {
        transform: scaleX(1);
      }

      .custom-doc-type {
        font: 600 10px/1 'Segoe UI', sans-serif;
        color: var(--custom-primary-color);
        text-transform: uppercase;
        margin-bottom: 6px;
      }

      .custom-doc-name {
        font: 500 14px/1.3 'Segoe UI', sans-serif;
        color: #2d3436;
      }

      .custom-actions-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .custom-view-all-btn {
        background: linear-gradient(to right, var(--custom-primary-color), var(--custom-accent-color));
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font: 500 12px/1 'Segoe UI', sans-serif;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s ease;
      }

      .custom-view-all-btn svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
        transition: transform 0.2s ease;
      }

      .custom-view-all-btn:hover {
        transform: translateY(-1px);
      }

      .custom-view-all-btn:hover svg {
        transform: translateX(3px);
      }

      .custom-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .custom-close-btn:hover {
        background: rgba(0, 0, 0, 0.08);
        transform: rotate(90deg);
      }

      /* Hi·ªáu ·ª©ng notification indicator */
      @keyframes customPing {
        0% {
            transform: scale(0.9);
            opacity: 1;
        }
        100% {
            transform: scale(2);
            opacity: 0;
        }
      }

      .custom-notification-indicator {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 16px;
        height: 16px;
        background: #ff4757;
        border-radius: 50%;
        animation: customPing 1.5s infinite;
      }

      /* Mobile view: ch·ªânh s·ª≠a v·ªã tr√≠ v√† k√≠ch th∆∞·ªõc */
      @media (max-width: 480px) {
        .custom-notification-wrapper {
          bottom: 20px;
          right: 10px;
        }
        .custom-study-notification {
          width: 90vw;
          max-width: 320px;
        }
        .custom-doc-grid {
          grid-template-columns: 1fr;
        }
      }
    `;
    const styleTag = document.createElement('style');
    styleTag.textContent = css;
    document.head.appendChild(styleTag);
  })();
</script>
<!-- Ph·∫ßn th√¥ng b√°o custom -->
<div class="custom-notification-wrapper" style="display:block;">
  <div class="custom-study-notification">
    <div class="custom-notification-indicator"></div>
    <button class="custom-close-btn">√ó</button>

    <div class="custom-header-section">
      <div class="custom-subject-badge">üìê</div>
      <div class="custom-subject-info">
        <div class="custom-subject-title">To√°n n√¢ng cao 10</div>
        <div class="custom-subject-progress">ƒêang xem: ƒê·∫°i s·ªë - Ch∆∞∆°ng 2</div>
        <div class="custom-progress-bar">
          <div class="custom-progress-fill"></div>
        </div>
      </div>
    </div>

    <div class="custom-doc-grid">
      <div class="custom-doc-card">
        <div class="custom-doc-type">B√†i gi·∫£ng</div>
        <div class="custom-doc-name">H√†m s·ªë b·∫≠c nh·∫•t</div>
      </div>
      <div class="custom-doc-card">
        <div class="custom-doc-type">B√†i t·∫≠p</div>
        <div class="custom-doc-name">50 b√†i t·∫≠p v·∫≠n d·ª•ng</div>
      </div>
      <div class="custom-doc-card">
        <div class="custom-doc-type">Video</div>
        <div class="custom-doc-name">Gi·∫£i ƒë·ªÅ gi·ªØa k·ª≥</div>
      </div>
      <div class="custom-doc-card">
        <div class="custom-doc-type">T√†i li·ªáu</div>
        <div class="custom-doc-name">C√¥ng th·ª©c c·∫ßn nh·ªõ</div>
      </div>
    </div>

    <div class="custom-actions-section">
      <a href="#" class="custom-view-all-btn">
        <span>Xem chi ti·∫øt</span>
        <svg viewBox="0 0 24 24">
          <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
        </svg>
      </a>
    </div>
  </div>
</div>

<script>
  // X·ª≠ l√Ω n√∫t ƒë√≥ng th√¥ng b√°o (ch·ªâ ·∫©n ƒëi, kh√¥ng remove)
  document.querySelector('.custom-close-btn').addEventListener('click', () => {
    const notification = document.querySelector('.custom-notification-wrapper');
    notification.style.transform = 'translateY(100%)';
    notification.style.opacity = 0;
    setTimeout(() => {
      notification.style.display = 'none';
    }, 500);
  });

  // Logic thay ƒë·ªïi n·ªôi dung d·ª±a theo m√¥n h·ªçc (m√†u s·∫Øc, bi·ªÉu t∆∞·ª£ng,‚Ä¶)
  const docTypes = {
    math: { badge: 'üßÆ', color: '#e55039' },
    physics: { badge: '‚öõÔ∏è', color: '#0984e3' },
    chemistry: { badge: '‚öóÔ∏è', color: '#6c5ce7' }
  };

  function updateNotification(subject) {
    const typeConfig = docTypes[subject];
    document.querySelector('.custom-subject-badge').textContent = typeConfig.badge;
    document.documentElement.style.setProperty('--custom-primary-color', typeConfig.color);
  }

  // X·ª≠ l√Ω t∆∞∆°ng t√°c cho c√°c th·∫ª t√†i li·ªáu
  document.querySelectorAll('.custom-doc-card').forEach(card => {
    card.addEventListener('click', () => {
      card.style.transform = 'scale(0.98)';
      setTimeout(() => card.style.transform = '', 100);
    });
  });

  // T·ª± ƒë·ªông ·∫©n sau m·ªôt kho·∫£ng th·ªùi gian nh·∫•t ƒë·ªãnh
  let timeout;
  function resetTimer() {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      const notif = document.querySelector('.custom-notification-wrapper');
      if(notif) {
        notif.style.transform = 'translateY(100%)';
        notif.style.opacity = 0;
      }
    }, 10000);
  }
  document.querySelector('.custom-study-notification').addEventListener('mouseenter', () => clearTimeout(timeout));
  document.querySelector('.custom-study-notification').addEventListener('mouseleave', resetTimer);
  resetTimer();
</script>
<!-- Ch√®n CSS b·∫±ng JS DOM -->
<script>
  function loadCSS(url) {
    var link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = url;
    document.head.appendChild(link);
  }

</script>


<script>
  /* PDF.js Worker Configuration */
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';

  /* Global Variables */
  let examCurrentPath = [];
  let syllabusCurrentPath = [];
  let currentRotation = 0;
  let adTimer = null;
  let currentFile = null;

  /* H√†m renderFolderItem: T·∫°o m·ª•c folder d·ª±a theo d·ªØ li·ªáu */
/* H√†m renderFolderItem d√πng cho c√°c c·∫•p folder kh√¥ng ph·∫£i tr∆∞·ªùng */
function renderFolderItem(list, name, currentPath, callback, count, itemId) {
  const li = document.createElement('li');
  li.className = 'file-item';
  // Logic ban ƒë·∫ßu: n·∫øu c√≥ count th√¨ hi·ªÉn th·ªã s·ªë (kh√¥ng th√™m icon c·ªông ƒë·ªìng)
  const countHTML = count > 0 ? `<span class="file-count">${count}</span>` : '';
  li.innerHTML = `
    <i class="bi bi-folder-fill file-icon folder"></i>
    <span class="file-name">${name}</span>
    ${countHTML}
  `;
  li.addEventListener('click', () => {
    callback([...currentPath, { id: itemId, name }]);
  });
  list.appendChild(li);
}

/* H√†m renderSchoolFolderItem: d√πng cho folder tr∆∞·ªùng (path.length === 0),
   ch√®n th√™m icon c·ªông ƒë·ªìng k√®m s·ªë th√†nh vi√™n */
function renderSchoolFolderItem(list, name, currentPath, callback, count, itemId) {
  const li = document.createElement('li');
  li.className = 'file-item';
  // N·∫øu c√≥ s·ªë th√†nh vi√™n, ch√®n icon c·ªông ƒë·ªìng (bi-people) c√πng s·ªë l∆∞·ª£ng
  const countHTML = count > 0 ? `<span class="file-count"><i class="bi bi-people"></i> ${count}</span>` : '';
  li.innerHTML = `
    <i class="bi bi-folder-fill file-icon folder"></i>
    <span class="file-name">${name}</span>
    ${countHTML}
  `;
  li.addEventListener('click', () => {
    callback([...currentPath, { id: itemId, name }]);
  });
  list.appendChild(li);
}

/* H√†m renderFileItem: T·∫°o file item (gi·ªØ nguy√™n logic ban ƒë·∫ßu) */
function renderFileItem(list, file, documentType) {
  // N·∫øu CSS ƒë·ªông cho ph·∫ßn t·ª≠ file m·ªõi ch∆∞a ƒë∆∞·ª£c th√™m v√†o, t·∫°o v√† ch√®n th·∫ª <style>
  if (!document.getElementById('dynamic-new-file-item-css')) {
    const style = document.createElement('style');
    style.id = 'dynamic-new-file-item-css';
    style.textContent = `
      /* CSS cho ph·∫ßn t·ª≠ file m·ªõi v·ªõi l·ªõp "new-file-item" */
      .new-file-item {
        padding: 12px 15px;
        border-radius: 8px;
        transition: background-color 0.2s;
        margin-bottom: 8px;
        background-color: #ffffff;
        position: relative;
      }
      .new-file-info-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        flex: 1;
      }
      .new-file-text-info {
        flex: 1;
      }
      .new-file-views {
        font-size: 0.75em;
        color: #666;
        margin-top: 2px;
      }
      .new-file-actions {
        display: flex;
        gap: 8px;
      }
      .new-btn-menu {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
        border: none;
        background-color: transparent;
        color: #555;
        transition: all 0.2s;
        cursor: pointer;
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
      }
      .new-btn-menu:hover {
        background-color: #f0f0f0;
      }
      .new-action-menu {
        position: absolute;
        right: 15px;
        top: 50px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 10;
        display: none;
        min-width: 120px;
        overflow: hidden;
      }
      .new-action-menu.show {
        display: block;
      }
      .new-menu-item {
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #333;
        text-decoration: none;
        white-space: nowrap;
      }
      .new-menu-item:hover {
        background-color: #f5f5f5;
      }
      .new-menu-item i {
        font-size: 1rem;
      }
      .new-file-icon {
        font-size: 1.8rem;
        color: #5f6368;
      }
      .new-file-icon.pdf {
        color: #d93025;
      }
      .new-file-icon.word {
        color: #2a5699;
      }
      
    `;
    document.head.appendChild(style);
  }

  // Ki·ªÉm tra file c√≥ ƒë∆∞·ªùng d·∫´n h·ª£p l·ªá; n·∫øu kh√¥ng c√≥ th√¨ d·ª´ng h√†m v√† in c·∫£nh b√°o
  if (!file.file_path) {
    console.warn('File kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n h·ª£p l·ªá:', file);
    return;
  }
  
  // Ki·ªÉm tra quy·ªÅn truy c·∫≠p file theo tr∆∞·ªùng (school_id)
  if (file.school_id && window.userSchoolId && file.school_id != window.userSchoolId) {
    console.warn("File kh√¥ng thu·ªôc tr∆∞·ªùng c·ªßa user! File school_id:", file.school_id, "User's school id:", window.userSchoolId);
    triggerNotification('danger', 'L·ªói', "B·∫°n kh√¥ng ƒë∆∞·ª£c ph√©p m·ªü file c·ªßa tr∆∞·ªùng kh√°c!");
    return;
  }
  
  // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n file c√≥ d·∫•u "/" ƒë·∫ßu ti√™n
  const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
  // L·∫•y ph·∫ßn m·ªü r·ªông c·ªßa file v√† ch·ªçn icon t∆∞∆°ng ·ª©ng d·ª±a tr√™n m·ªôt mapping
  const ext = filePath.split('.').pop().toLowerCase();
  const iconClass = {
    pdf: 'bi-file-pdf pdf',
    doc: 'bi-file-earmark-word word',
    docx: 'bi-file-earmark-word word',
    jpg: 'bi-file-image',
    jpeg: 'bi-file-image',
    png: 'bi-file-image',
    gif: 'bi-file-image'
  }[ext] || 'bi-file-earmark';
  
  // T·∫°o ph·∫ßn t·ª≠ list item <li> cho file
  const li = document.createElement('li');
  li.className = 'file-item new-file-item';
  // Ch·ªçn nh√£n cho file d·ª±a tr√™n documentType: 'exam' ho·∫∑c 'other'
  const typeLabel = documentType === 'exam' ? 'ƒê·ªÅ Thi' : 'ƒê·ªÅ C∆∞∆°ng';
  
  console.log('File object:', file);
  console.log('View count:', file.view_count);
  
  // X√¢y d·ª±ng n·ªôi dung HTML cho file item
  li.innerHTML = `
    <div class="file-item-container new-file-item-container">
      <div class="file-info-section new-file-info-section">
        <i class="bi ${iconClass} file-icon new-file-icon"></i>
        <div class="file-text-info new-file-text-info">
          <div class="file-name new-file-name">${typeLabel} ${file.file_name}</div>
          <div class="file-info new-file-info">${file.file_info || ''}</div>
          <div class="file-views new-file-views">Ng∆∞·ªùi xem: ${file.view_count || 0}</div>
        </div>
      </div>
      <div class="file-actions new-file-actions">
        <button class="btn btn-menu new-btn-menu" title="Menu">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="action-menu new-action-menu">
          <a class="menu-item btn-download new-menu-item">
            <i class="bi bi-download"></i>
            <span>T·∫£i xu·ªëng</span>
          </a>
          <a href="#" class="menu-item btn-share new-menu-item">
            <i class="bi bi-exclamation-triangle"></i>
            <span>B√°o l·ªói</span>
          </a>
          <a class="menu-item btn-discuss new-menu-item">
            <i class="bi bi-chat"></i>
            <span>Th·∫£o lu·∫≠n</span>
          </a>
        </div>
      </div>
    </div>
  `;
  
  // L·∫•y c√°c n√∫t t∆∞∆°ng t√°c t·ª´ ph·∫ßn t·ª≠ HTML v·ª´a t·∫°o
  const menuBtn = li.querySelector('.new-btn-menu');
  const actionMenu = li.querySelector('.new-action-menu');
  const downloadBtn = li.querySelector('.btn-download');
  const shareBtn = li.querySelector('.btn-share');
  const discussBtn = li.querySelector('.btn-discuss');

  // S·ª± ki·ªán click n√∫t menu: hi·ªÉn th·ªã/·∫©n menu h√†nh ƒë·ªông
  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    actionMenu.classList.toggle('show');
  });

  // S·ª± ki·ªán click n√∫t download
  downloadBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    actionMenu.classList.remove('show');
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi cho ph√©p t·∫£i file
    try {
      const res = await fetch('/api/check-login');
      const data = await res.json();
      if (!data.loggedIn) {
        triggerNotification('danger', 'L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!');
        return;
      }
    } catch (error) {
      console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
      triggerNotification('danger', 'L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p l√∫c n√†y!');
      return;
    }
    
    console.log('Download button clicked for file:', file.file_name);
    // X·ª≠ l√Ω file khi nh·∫•n download (v√≠ d·ª•: tƒÉng l∆∞·ª£t xem,...)
    handleFileClick(file, documentType, filePath);
    // T·∫°o link t·∫£i v√† k√≠ch ho·∫°t s·ª± ki·ªán click ƒë·ªÉ t·∫£i file
    const downloadLink = document.createElement('a');
    downloadLink.href = filePath;
    downloadLink.download = file.file_name;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  });

  // S·ª± ki·ªán click n√∫t b√°o l·ªói (share)
  shareBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    actionMenu.classList.remove('show');
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi b√°o l·ªói
    try {
      const res = await fetch('/api/check-login');
      const data = await res.json();
      if (!data.loggedIn) {
        triggerNotification('danger', 'L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!');
        return;
      }
    } catch (error) {
      console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
      triggerNotification('danger', 'L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p l√∫c n√†y!');
      return;
    }
    // G·ªçi h√†m m·ªü modal b√°o l·ªói cho file
    openReportModal(file);
  });

  // S·ª± ki·ªán click n√∫t th·∫£o lu·∫≠n
  discussBtn.addEventListener('click', async function(e) {
    e.stopPropagation();
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi chuy·ªÉn sang trang th·∫£o lu·∫≠n
    try {
      const res = await fetch('/api/check-login');
      const data = await res.json();
      if (!data.loggedIn) {
        triggerNotification('danger', 'L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!');
        return;
      }
    } catch (error) {
      console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
      triggerNotification('danger', 'L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p l√∫c n√†y!');
      return;
    }
    
    // ·∫®n container compact-container tr√™n trang hi·ªán t·∫°i
    const compactContainer = document.querySelector('.compact-container.my-4');
    if (compactContainer) {
      compactContainer.style.display = 'none';
    } else {
      console.warn('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ compact-container.');
    }
    // Hi·ªÉn th·ªã container ch·ª©a th·∫£o lu·∫≠n v√† t·∫£i trang th·∫£o lu·∫≠n v√†o iframe
    const discussionContainer = document.getElementById('discussion-container');
    if (discussionContainer) {
      discussionContainer.style.display = 'block';
      const iframe = document.getElementById('discussion-iframe');
      if (iframe) {
        // G√°n trang th·∫£o lu·∫≠n v√†o iframe (c√≥ th·ªÉ chuy·ªÉn ƒë·ªïi URL n·∫øu c·∫ßn)
        iframe.src = '/html/thaoluan.html';
      }
    } else {
      console.warn('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ discussion-container.');
    }
  });
    
  // Khi click b√™n ngo√†i ph·∫ßn t·ª≠ li, ·∫©n action menu
  document.addEventListener('click', (e) => {
    if (!li.contains(e.target)) {
      actionMenu.classList.remove('show');
    }
  });

  // N·∫øu nh·∫•n v√†o li (ngo·∫°i tr·ª´ c√°c n√∫t menu) th√¨ g·ªçi h√†m x·ª≠ l√Ω file
  li.addEventListener('click', (e) => {
    if (e.target.closest('.new-btn-menu') || e.target.closest('.new-action-menu')) {
      return;
    }
    handleFileClick(file, documentType, filePath);
  });

  // Th√™m ph·∫ßn t·ª≠ li v·ª´a t·∫°o v√†o danh s√°ch
  list.appendChild(li);
}

/* H√†m renderDrive: Hi·ªÉn th·ªã danh s√°ch file/folder theo ƒë∆∞·ªùng d·∫´n */
async function renderDrive(containerId, path, updatePathCallback) {
  const documentType = containerId.includes('exam') ? 'exam' : 'syllabus';
  const container = document.getElementById(containerId);
  if (!container) {
    console.error(`Kh√¥ng t√¨m th·∫•y container v·ªõi ID: ${containerId}`);
    return;
  }
  container.innerHTML = '';

  // ·∫®n th√¥ng b√°o g·ª£i √Ω n·∫øu kh√¥ng ·ªü c·∫•p m√¥n
  if (path.length !== 3) {
    const notif = document.querySelector('.custom-notification-wrapper');
    if (notif) notif.style.display = 'none';
  }

  // Hi·ªÉn th·ªã spinner khi ƒëang t·∫£i d·ªØ li·ªáu
  const spinner = document.createElement('div');
  spinner.className = 'spinner';
  spinner.textContent = 'Loading...';
  container.appendChild(spinner);

  let data = [];
  try {
    if (path.length === 0) {
      // L·∫•y th√¥ng tin tr∆∞·ªùng c·ªßa user n·∫øu c√≥ ƒëƒÉng nh·∫≠p
      let res = await fetch('/user/university', { credentials: 'include' });
      if (res.ok) {
        const userSchool = await res.json();
        window.userSchoolId = userSchool.university;
        data = [{ id: userSchool.university, name: userSchool.school_name }];
      } else {
        const allSchoolsRes = await fetch('/api/schools');
        if (allSchoolsRes.ok) {
          data = await allSchoolsRes.json();
        } else {
          throw new Error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch tr∆∞·ªùng");
        }
      }
      // L·∫•y s·ªë li·ªáu th·ªëng k√™ s·ªë th√†nh vi√™n theo tr∆∞·ªùng
      try {
        const statsRes = await fetch('/api/users/statistics');
        if (statsRes.ok) {
          const stats = await statsRes.json();
          const statsMap = {};
          stats.forEach(stat => {
            statsMap[stat.school] = stat.user_count;
          });
          data = data.map(item => {
            const count = statsMap[item.name] || 0;
            return { ...item, count };
          });
        }
      } catch (error) {
        console.error("L·ªói khi l·∫•y th·ªëng k√™ ng∆∞·ªùi d√πng:", error);
      }
    } else if (path.length === 1) {
      const schoolId = path[0].id;
      data = await (await fetch(`/api/schools/${schoolId}/faculties`)).json();
    } else if (path.length === 2) {
      const facultyId = path[1].id;
      data = await (await fetch(`/api/faculties/${facultyId}/subjects?type=${documentType}`)).json();
    } else if (path.length === 3) {
      const subjectId = path[2].id;
      const response = await fetch(`/api/subjects/${subjectId}/documents_by_year?type=${documentType}`);
      const groupedData = await response.json();
      data = Object.keys(groupedData)
        .map(year => ({
          id: parseInt(year),
          name: year,
          count: groupedData[year].length,
          documents: groupedData[year]
        }))
        .sort((a, b) => b.id - a.id);
    } else if (path.length === 4) {
      const subjectId = path[2].id;
      const year = path[3].id;
      data = await (await fetch(`/api/subjects/${subjectId}/documents/${year}?type=${documentType}`)).json();
    }
  } catch (error) {
    console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', error);
    container.innerHTML = `<div class="alert alert-danger">
      C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message || error}.<br>
      Vui l√≤ng <a href="#" onclick="window.location.reload()">nh·∫•n v√†o ƒë√¢y</a> ƒë·ªÉ th·ª≠ l·∫°i (F5).
    </div>`;
    return;
  }
  
  // X√≥a spinner
  container.innerHTML = '';

  if (path.length > 0) {
    renderBreadcrumb(container, path, updatePathCallback);
  }
    // >>>>> CH·ªàNH S·ª¨A: G·ªçi modal ch√†o m·ª´ng khi ·ªü trang ch·ªß <<<<<
 if (path.length === 0) {
   // N·∫øu c√≥ user ƒë√£ ƒëƒÉng nh·∫≠p, ki·ªÉm tra tr·∫°ng th√°i welcome_checked
   fetch('/api/welcome_checked')
     .then(response => response.json())
     .then(data => {
       // N·∫øu kh√¥ng c√≥ l·ªói v√† welcome_checked b·∫±ng 0 (ch∆∞a xem th√¥ng b√°o)
       if (!data.error && data.welcome_checked === 0) {
         fetchMembershipData();
       }
     })
     .catch(error => console.error('Error checking welcome status:', error));
 }
   // <<< END CH·ªàNH S·ª¨A
  
  // Ph·∫ßn g·ª£i √Ω cho c·∫•p m√¥n (path.length === 3) gi·ªØ nguy√™n nh∆∞ c≈©
  if (path.length === 3) {
    const subjectId = path[2].id;
    const alternateType = documentType === 'exam' ? 'syllabus' : 'exam';
    console.log(`ƒêang g·ªçi API g·ª£i √Ω cho subject_id: ${subjectId} v·ªõi type: ${alternateType}`);
    fetch(`/api/subjects/${subjectId}/documents_by_year?type=${alternateType}`)
      .then(response => response.json())
      .then(alternateData => {
        console.log("D·ªØ li·ªáu g·ª£i √Ω tr·∫£ v·ªÅ:", alternateData);
        const wrapper = document.querySelector('.custom-notification-wrapper');
        if (Object.keys(alternateData).length > 0) {
          wrapper.style.display = 'block';
          const years = Object.keys(alternateData).sort((a, b) => parseInt(b) - parseInt(a));
          const totalItems = years.length;
          const collapsedLimit = 4;
          let isCollapsed = totalItems > collapsedLimit;
          let displayedYears = isCollapsed ? years.slice(0, collapsedLimit) : years;
          function renderGrid(yearList) {
            let gridHtml = '';
            yearList.forEach(year => {
              const group = alternateData[year];
              gridHtml += `
                <div class="custom-doc-card alternate-suggestion-item" data-year="${year}" style="cursor:pointer;">
                  <div class="custom-doc-type">NƒÉm ${year}</div>
                  <div class="custom-doc-name">(${group.length} t√†i li·ªáu)</div>
                </div>
              `;
            });
            return gridHtml;
          }
          let newContent = `
            <div class="custom-study-notification">
              <div class="custom-notification-indicator"></div>
              <button class="custom-close-btn">√ó</button>
              <div class="custom-header-section">
                <div class="custom-subject-badge">${documentType === 'exam' ? 'üìê' : 'üìò'}</div>
                <div class="custom-subject-info">
                  <div class="custom-subject-title">G·ª£i √Ω ${alternateType === 'exam' ? 'ƒê·ªÅ Thi' : 'ƒê·ªÅ C∆∞∆°ng'}</div>
                  <div class="custom-subject-progress">Cho m√¥n ${path[2].name}</div>
                  <div class="custom-progress-bar">
                    <div class="custom-progress-fill"></div>
                  </div>
                </div>
              </div>
              <div class="custom-doc-grid" id="alternateGrid">
                ${renderGrid(displayedYears)}
              </div>
          `;
          if (isCollapsed) {
            newContent += `
              <div class="custom-actions-section">
                <a href="#" class="custom-view-all-btn">
                  <span>Xem th√™m</span>
                  <svg viewBox="0 0 24 24">
                    <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                  </svg>
                </a>
              </div>
            `;
          }
          newContent += `</div>`;
          wrapper.innerHTML = newContent;
          wrapper.querySelector('.custom-close-btn').addEventListener('click', () => {
            wrapper.style.transform = 'translateY(100%)';
            wrapper.style.opacity = 0;
            setTimeout(() => {
              wrapper.style.display = 'none';
            }, 500);
          });
          function addItemEvents() {
            wrapper.querySelectorAll('.alternate-suggestion-item').forEach(item => {
              item.addEventListener('click', (e) => {
                const selectedYear = e.currentTarget.getAttribute('data-year');
                console.log(`Ng∆∞·ªùi d√πng ch·ªçn nƒÉm ${selectedYear}`);
                const newPath = [...path, { id: parseInt(selectedYear), name: selectedYear }];
                if (documentType === 'exam') {
                  document.getElementById('de-thi-tab').classList.remove('active');
                  document.getElementById('de-cuong-tab').classList.add('active');
                  document.getElementById('de-thi').classList.remove('show', 'active');
                  document.getElementById('de-cuong').classList.add('show', 'active');
                  renderSyllabusDrive(newPath);
                } else {
                  document.getElementById('de-cuong-tab').classList.remove('active');
                  document.getElementById('de-thi-tab').classList.add('active');
                  document.getElementById('de-cuong').classList.remove('show', 'active');
                  document.getElementById('de-thi').classList.add('show', 'active');
                  renderExamDrive(newPath);
                }
              });
            });
          }
          addItemEvents();
          const viewAllBtn = wrapper.querySelector('.custom-view-all-btn');
          if (viewAllBtn) {
            viewAllBtn.addEventListener('click', (e) => {
              e.preventDefault();
              const fullGridHtml = renderGrid(years);
              const gridContainer = document.getElementById('alternateGrid');
              if (gridContainer) {
                gridContainer.innerHTML = fullGridHtml;
                viewAllBtn.parentElement.remove();
                addItemEvents();
              }
            });
          }
        } else {
          console.log("Kh√¥ng c√≥ d·ªØ li·ªáu g·ª£i √Ω; ·∫©n th√¥ng b√°o g·ª£i √Ω.");
          const wrapper = document.querySelector('.custom-notification-wrapper');
          if (wrapper) wrapper.style.display = 'none';
        }
      })
      .catch(err => console.error("Error fetching alternate suggestions", err));
  }
  
  // Thanh t√¨m ki·∫øm inline
  const inlineSearchContainer = document.createElement('div');
  inlineSearchContainer.className = 'input-group mb-3';
  inlineSearchContainer.style.position = 'relative';
  inlineSearchContainer.innerHTML = `
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="search" class="form-control" placeholder="T√¨m ki·∫øm trong th∆∞ m·ª•c...">
  `;
  container.appendChild(inlineSearchContainer);

  const inlineSuggestions = document.createElement('div');
  inlineSuggestions.className = 'suggestions';
  inlineSuggestions.style.display = 'none';
  inlineSearchContainer.appendChild(inlineSuggestions);

  const advancedSearchBtn = document.createElement('button');
  advancedSearchBtn.className = 'btn btn-outline-primary mb-3';
  advancedSearchBtn.textContent = 'T√¨m ki·∫øm theo t√™n m√¥n h·ªçc';
  advancedSearchBtn.addEventListener('click', () => {
    const subjectSearchModal = new bootstrap.Modal(document.getElementById('customSearchModal'));
    subjectSearchModal.show();
  });
  container.appendChild(advancedSearchBtn);

  // T·∫°o danh s√°ch file/folder
  const list = document.createElement('ul');
  list.className = 'file-list';
  if (Array.isArray(data)) {
    data.forEach(item => {
      if (path.length === 0) {
        // ·ªû c·∫•p tr∆∞·ªùng: s·ª≠ d·ª•ng h√†m renderSchoolFolderItem ƒë·ªÉ ch√®n icon c·ªông ƒë·ªìng
        renderSchoolFolderItem(list, item.name, path, updatePathCallback, item.count || 0, item.id);
      } else if (path.length < 3) {
        if (typeof item.count !== 'undefined') {
          renderFolderItem(list, item.name, path, updatePathCallback, item.count, item.id);
        } else {
          renderFolderItem(list, item.name, path, updatePathCallback, 0, item.id);
        }
      } else if (path.length === 3) {
        renderFolderItem(list, item.name, path, updatePathCallback, item.count || 0, item.id);
      } else if (path.length === 4) {
        renderFileItem(list, item, documentType);
      }
    });
  }
  container.appendChild(list);

  // N·∫øu danh s√°ch folder tr·ªëng th√¨ hi·ªÉn th·ªã th√¥ng b√°o "Th∆∞ m·ª•c r·ªóng"
if (!list.hasChildNodes()) {
  const emptyMsg = document.createElement('p');
  emptyMsg.className = 'empty-folder';
  emptyMsg.textContent = 'Th∆∞ m·ª•c r·ªóng';
  container.appendChild(emptyMsg);
}

  // X·ª≠ l√Ω t√¨m ki·∫øm inline
 // Th√™m CSS tr·ª±c ti·∫øp v√†o trang
const style = document.createElement('style');
style.textContent = `
  /* Container g·ª£i √Ω t√¨m ki·∫øm */
  .inline-suggestions {
    position: absolute;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    display: none;
  }

  /* M·ªói item g·ª£i √Ω */
  .suggestion-item {
    padding: 10px 16px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .suggestion-item:hover {
    background-color: #f5f5f5;
  }

  /* Th√¥ng b√°o kh√¥ng c√≥ k·∫øt qu·∫£ */
  .no-results-message {
    color: #dc3545;
    padding: 12px 16px;
    margin: 0;
    font-size: 0.9em;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .no-results-message::before {
    content: "‚ö†Ô∏è";
    font-style: normal;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .inline-suggestions {
      max-height: 200px;
    }
    
    .suggestion-item, .no-results-message {
      padding: 8px 12px;
    }
  }
`;
document.head.appendChild(style);

// X·ª≠ l√Ω t√¨m ki·∫øm inline
const inlineSearchInput = inlineSearchContainer.querySelector('input');
inlineSearchInput.addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase().trim();
  const suggestions = [];
  
  // L·ªçc v√† hi·ªÉn th·ªã c√°c item ph√π h·ª£p
  Array.from(list.children).forEach(item => {
    const text = item.textContent.toLowerCase();
    const isVisible = text.includes(term);
    item.style.display = isVisible ? 'flex' : 'none';
    
    if (isVisible) {
      const name = item.querySelector('.file-name').textContent;
      if (!suggestions.includes(name)) suggestions.push(name);
    }
  });

  // X√≥a g·ª£i √Ω c≈©
  inlineSuggestions.innerHTML = '';
  
  if (term) {
    if (suggestions.length > 0) {
      // Hi·ªÉn th·ªã g·ª£i √Ω
      suggestions.forEach(suggestion => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = suggestion;
        
        div.addEventListener('click', () => {
          inlineSearchInput.value = suggestion;
          inlineSearchInput.dispatchEvent(new Event('input'));
          inlineSuggestions.style.display = 'none';
        });
        
        inlineSuggestions.appendChild(div);
      });
    } else {
      // Hi·ªÉn th·ªã th√¥ng b√°o kh√¥ng c√≥ k·∫øt qu·∫£
      const p = document.createElement('p');
      p.className = 'no-results-message';
      p.textContent = 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p';
      inlineSuggestions.appendChild(p);
    }
    
    inlineSuggestions.style.display = 'block';
  } else {
    inlineSuggestions.style.display = 'none';
  }
});

// ·∫®n g·ª£i √Ω khi click ra ngo√†i
document.addEventListener('click', (e) => {
  if (!inlineSearchContainer.contains(e.target)) {
    inlineSuggestions.style.display = 'none';
  }
});
}
  function renderBreadcrumb(container, path, callback) {
    if (path.length === 0) return;
    const breadcrumb = document.createElement('nav');
    let html = `
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#" id="back-button"><i class="bi bi-arrow-left"></i> Quay l·∫°i</a>
        </li>
    `;
    path.forEach((segment, index) => {
      html += index === path.length - 1
        ? `<li class="breadcrumb-item active">${segment.name}</li>`
        : `<li class="breadcrumb-item"><a href="#" class="breadcrumb-link" data-index="${index}">${segment.name}</a></li>`;
    });
    breadcrumb.innerHTML = html + '</ol>';
    breadcrumb.querySelector('#back-button').addEventListener('click', (e) => {
      e.preventDefault();
      callback(path.slice(0, -1));
    });
    breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const index = parseInt(link.getAttribute('data-index'));
        callback(path.slice(0, index + 1));
      });
    });
    container.prepend(breadcrumb);
  }
  
  // H√†m t·∫°o file item (renderFileItem)
function renderFileItem(list, file, documentType) {
  // Th√™m CSS ƒë·ªông cho ph·∫ßn t·ª≠ file m·ªõi (n·∫øu ch∆∞a c√≥)
  if (!document.getElementById('dynamic-new-file-item-css')) {
    const style = document.createElement('style');
    style.id = 'dynamic-new-file-item-css';
    style.textContent = `
      /* CSS cho ph·∫ßn t·ª≠ file m·ªõi v·ªõi l·ªõp "new-file-item" */
      .new-file-item {
        padding: 12px 15px;
        border-radius: 8px;
        transition: background-color 0.2s;
        margin-bottom: 8px;
        background-color: #ffffff;
        position: relative;
          overflow: visible;  /* N·∫øu menu v∆∞·ª£t ra ngo√†i ph·∫°m vi, tr√°nh b·ªã ·∫©n */

      }
      .new-file-info-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        flex: 1;
      }
      .new-file-text-info {
        flex: 1;
      }
      .new-file-views {
        font-size: 0.75em;
        color: #666;
        margin-top: 2px;
      }
      .new-file-actions {
        display: flex;
        gap: 8px;
      }
      .new-btn-menu {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
        border: none;
        background-color: transparent;
        color: #555;
        transition: all 0.2s;
        cursor: pointer;
        position: absolute;
        right: 0;
        top: 50%;
        z-index: 9999;
        transform: translateY(-50%);
      }
      .new-btn-menu:hover {
        background-color: #f0f0f0;
        z-index: 9999;
      }
      .new-action-menu {
        position: absolute;
        right: 15px;
        top: 50px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 10;
        display: none;
        min-width: 120px;
        z-index: 9999;

        overflow: hidden;
      }
      .new-action-menu.show {
      z-index: 9999;
        display: block;
      }
      .new-menu-item {
        padding: 8px 16px;
        display: flex;
        z-index: 9999;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #333;
        text-decoration: none;
        white-space: nowrap;
      }
      .new-menu-item:hover {
        background-color: #f5f5f5;
        z-index: 9999;
      }
      .new-menu-item i {
        font-size: 1rem;
      }
      .new-file-icon {
        font-size: 1.8rem;
        color: #5f6368;
      }
      .new-file-icon.pdf {
        color: #d93025;
      }
      .new-file-icon.word {
        color: #2a5699;
      }
    `;
    document.head.appendChild(style);
  }

  if (!file.file_path) {
    console.warn('File kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n h·ª£p l·ªá:', file);
    return;
  }
  
  if (file.school_id && window.userSchoolId && file.school_id != window.userSchoolId) {
    console.warn("File kh√¥ng thu·ªôc tr∆∞·ªùng c·ªßa user! File school_id:", file.school_id, "User's school id:", window.userSchoolId);
    triggerNotification('danger', 'L·ªói', "B·∫°n kh√¥ng ƒë∆∞·ª£c ph√©p m·ªü file c·ªßa tr∆∞·ªùng kh√°c!");
    return;
  }
  
  const filePath = file.file_path.startsWith('/') ? file.file_path : `/${file.file_path}`;
  const ext = filePath.split('.').pop().toLowerCase();
  const iconClass = {
    pdf: 'bi-file-pdf pdf',
    doc: 'bi-file-earmark-word word',
    docx: 'bi-file-earmark-word word',
    jpg: 'bi-file-image',
    jpeg: 'bi-file-image',
    png: 'bi-file-image',
    gif: 'bi-file-image'
  }[ext] || 'bi-file-earmark';
  
  // T·∫°o ph·∫ßn t·ª≠ li cho file item
  const li = document.createElement('li');
  li.className = 'file-item new-file-item';
  const typeLabel = documentType === 'exam' ? 'ƒê·ªÅ Thi' : 'ƒê·ªÅ C∆∞∆°ng';
  
  li.innerHTML = `
    <div class="file-item-container new-file-item-container">
      <div class="file-info-section new-file-info-section">
        <i class="bi ${iconClass} file-icon new-file-icon"></i>
        <div class="file-text-info new-file-text-info">
          <div class="file-name new-file-name">${typeLabel} ${file.file_name}</div>
          <div class="file-info new-file-info">${file.file_info || ''}</div>
          <div class="file-views new-file-views">Ng∆∞·ªùi xem: ${file.view_count  || 0}</div>
        </div>
      </div>
      <div class="file-actions new-file-actions">
        <button class="btn btn-menu new-btn-menu" title="Menu">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="action-menu new-action-menu">
          <a class="menu-item btn-download new-menu-item">
            <i class="bi bi-download"></i>
            <span>T·∫£i xu·ªëng</span>
          </a>
          <!-- Menu b√°o l·ªói -->
          <a href="#" class="menu-item btn-share new-menu-item">
            <i class="bi bi-exclamation-triangle"></i>
            <span>B√°o l·ªói</span>
          </a>
          <a class="menu-item btn-discuss new-menu-item">
            <i class="bi bi-chat"></i>
            <span>Th·∫£o lu·∫≠n</span>
          </a>
        </div>
      </div>
    </div>
  `;

  // L·∫•y c√°c ph·∫ßn t·ª≠ c·∫ßn x·ª≠ l√Ω s·ª± ki·ªán
  const menuBtn = li.querySelector('.new-btn-menu');
  const actionMenu = li.querySelector('.new-action-menu');
  const downloadBtn = li.querySelector('.btn-download');
  const shareBtn = li.querySelector('.btn-share');
  const discussBtn = li.querySelector('.btn-discuss');

  // X·ª≠ l√Ω click v√†o n√∫t menu
  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    actionMenu.classList.toggle('show');
  });

// X·ª≠ l√Ω click n√∫t download
// X·ª≠ l√Ω click n√∫t download
downloadBtn.addEventListener('click', async (e) => {
  e.stopPropagation();
  actionMenu.classList.remove('show');

  // Ki·ªÉm tra ƒëƒÉng nh·∫≠p qua API
  try {
    const res = await fetch('/api/check-login');
    const data = await res.json();
    if (!data.loggedIn) {
      triggerNotification('danger', 'L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!');
      return;
    }
  } catch (error) {
    console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
    triggerNotification('danger', 'L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p l√∫c n√†y!');
    return;
  }
  
  console.log('Download button clicked for file:', file.file_name);
  // Th·ª±c hi·ªán logic m·ªü file (v√≠ d·ª•: c·∫≠p nh·∫≠t l∆∞·ª£t xem, ghi log, v.v.)
  handleFileClick(file, documentType, filePath);

  // T·∫°o th·∫ª a ·∫©n v√† thi·∫øt l·∫≠p thu·ªôc t√≠nh download ƒë·ªÉ t·∫£i file xu·ªëng t·∫°i tab hi·ªán t·∫°i
  const downloadLink = document.createElement('a');
  downloadLink.href = filePath;
  downloadLink.download = file.file_name;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
});

// X·ª≠ l√Ω click "B√°o l·ªói": m·ªü modal v√† c·∫≠p nh·∫≠t t√™n ƒë·ªÅ thi theo file ƒë∆∞·ª£c click
shareBtn.addEventListener('click', async (e) => {
  e.stopPropagation();
  actionMenu.classList.remove('show');

  // Ki·ªÉm tra ƒëƒÉng nh·∫≠p qua API
  try {
    const res = await fetch('/api/check-login');
    const data = await res.json();
    if (!data.loggedIn) {
      triggerNotification('danger', 'L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!');
      return;
    }
  } catch (error) {
    console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
    triggerNotification('danger', 'L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p l√∫c n√†y!');
    return;
  }

  openReportModal(file);
});

  // X·ª≠ l√Ω s·ª± ki·ªán "Th·∫£o lu·∫≠n": chuy·ªÉn h∆∞·ªõng sang trang thaoluan.html v√† truy·ªÅn document_id
// X·ª≠ l√Ω khi nh·∫•n n√∫t th·∫£o lu·∫≠n
discussBtn.addEventListener('click', async function(e) {
  e.stopPropagation();
  try {
    const res = await fetch('/api/check-login');
    const data = await res.json();
    if (!data.loggedIn) {
      triggerNotification('danger', 'L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y!');
      return;
    }
  } catch (error) {
    console.error('L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
    triggerNotification('danger', 'L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p l√∫c n√†y!');
    return;
  }
  
  // ·∫®n container compact-container
  const compactContainer = document.querySelector('.compact-container.my-4');
  if (compactContainer) {
    compactContainer.style.display = 'none';
  } else {
    console.warn('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ compact-container.');
  }

  // ·∫®n n√∫t ƒë√≥ng g√≥p ƒë·ªÅ thi
  const contributeButton = document.querySelector('.btn.btn-primary.contribute-btn');
  if (contributeButton) {
    contributeButton.style.display = 'none';
  } else {
    console.warn('Kh√¥ng t√¨m th·∫•y n√∫t ƒë√≥ng g√≥p ƒë·ªÅ thi.');
  }
  
  // ·∫®n thanh cu·ªôn c·ªßa trang g·ªëc
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';

  // ƒê·∫£m b·∫£o iframe v·∫´n c√≥ thanh cu·ªôn
  const iframe = document.getElementById('discussion-iframe');
  if (iframe) {
    iframe.style.overflow = 'auto';
    iframe.style.scrollbarWidth = 'auto'; // Firefox
    iframe.style.webkitScrollbar = 'auto'; // Chrome, Safari
  }

  // Hi·ªÉn th·ªã container ch·ª©a iframe th·∫£o lu·∫≠n v√† chuy·ªÉn document_id qua URL
  const discussionContainer = document.getElementById('discussion-container');
  if (discussionContainer) {
    discussionContainer.style.display = 'block';
    const iframe = document.getElementById('discussion-iframe');
    if (iframe) {
      // S·ª≠ d·ª•ng file.document_id n·∫øu c√≥, n·∫øu kh√¥ng th√¨ s·ª≠ d·ª•ng file.id
      const docId = file.document_id || file.id;
      if (!docId) {
        console.error('Kh√¥ng t√¨m th·∫•y document_id h·ª£p l·ªá trong file:', file);
        triggerNotification('danger', 'L·ªói', 'File kh√¥ng c√≥ document_id h·ª£p l·ªá!');
        return;
      }
      // Truy·ªÅn document_id qua query string
      iframe.src = '/html/thaoluan.html?document_id=' + docId;
    }
  } else {
    console.warn('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ discussion-container.');
  }
});

// H√†m ƒë√≥ng container th·∫£o lu·∫≠n v√† kh√¥i ph·ª•c l·∫°i c√°c tr·∫°ng th√°i c·ªßa trang ch√≠nh
function closeDiscussion() {
  const discussionContainer = document.getElementById('discussion-container');
  if (discussionContainer) {
    discussionContainer.style.display = 'none';
  }
  // Kh√¥i ph·ª•c thanh cu·ªôn c·ªßa trang ch√≠nh
  document.documentElement.style.overflow = 'auto';
  document.body.style.overflow = 'auto';

  // Kh√¥i ph·ª•c l·∫°i c√°c ph·∫ßn t·ª≠ ƒë√£ ·∫©n (n·∫øu c·∫ßn)
  const compactContainer = document.querySelector('.compact-container.my-4');
  if (compactContainer) {
    compactContainer.style.display = '';
  }
  const contributeButton = document.querySelector('.btn.btn-primary.contribute-btn');
  if (contributeButton) {
    contributeButton.style.display = '';
  }
}

// L·∫Øng nghe s·ª± ki·ªán t·ª´ iframe
window.addEventListener('message', function(event) {
  // C√≥ th·ªÉ ki·ªÉm tra origin c·ªßa event n·∫øu c·∫ßn b·∫£o m·∫≠t
  if (event.data === 'closeDiscussion') {
    closeDiscussion();
  }
});

// C√°c ƒëo·∫°n code kh√°c (ƒë√≥ng menu, x·ª≠ l√Ω s·ª± ki·ªán click c·ªßa li, ...)
document.addEventListener('click', (e) => {
  if (!li.contains(e.target)) {
    actionMenu.classList.remove('show');
  }
});

li.addEventListener('click', (e) => {
  if (e.target.closest('.new-btn-menu') || e.target.closest('.new-action-menu')) {
    return;
  }
  handleFileClick(file, documentType, filePath);
});

list.appendChild(li);
}
// H√†m x·ª≠ l√Ω click file (gi·ªØ nguy√™n)
function handleFileClick(file, documentType, filePath) {
    fetch('/api/check-login', { method: 'GET', credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            if (data.loggedIn) {
                fetch('/api/account_status', { method: 'GET', credentials: 'include' })
                    .then(response => response.json())
                    .then(statusData => {
                        if (statusData.account_status === 'ƒë√£ duy·ªát') {
                            fetch('/api/check-file-open-timer', { method: 'GET', credentials: 'include' })
                                .then(response => response.json())
                                .then(timerData => {
                                    if (timerData.can_open) {
                                        fetch('/api/log-file-open', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            credentials: 'include',
                                            body: JSON.stringify({ documentId: file.id })
                                        })
                                            .then(() => {
                                                if (documentType === 'exam') {
                                                    fetch('/api/log-view-exam-v2', {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        credentials: 'include',
                                                        body: JSON.stringify({ documentId: file.id })
                                                    })
                                                        .then(response => {
                                                            if (!response.ok) {
                                                                return response.json().then(data => {
                                                                    triggerNotification('danger', 'L·ªói', data.error);
                                                                    throw new Error(data.error);
                                                                });
                                                            }
                                                            return response.json();
                                                        })
                                                        .then(() => {
                                                            window.open(filePath, '_blank');
                                                        })
                                                        .catch(error => {
                                                            console.error('L·ªói khi log view exam:', error);
                                                        });
                                                } else {
                                                    window.open(filePath, '_blank');
                                                }
                                            })
                                            .catch(error => {
                                                console.error('L·ªói khi log file:', error);
                                                window.open(filePath, '_blank');
                                            });
                                    } else {
                                        triggerNotification('warning', 'Th√¥ng b√°o', `Thao t√°c qu√° nhanh, ƒë·ª£i ${Math.ceil(timerData.seconds_left)} gi√¢y.`);
                                    }
                                })
                                .catch(error => {
                                    console.error('L·ªói khi ki·ªÉm tra th·ªùi gian m·ªü file:', error);
                                });
                        } else if (statusData.account_status === 'b√¨nh th∆∞·ªùng') {
                            const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                            modal.show();
                        } else if (statusData.account_status === 'ƒëang duy·ªát') {
                            triggerNotification('danger', 'L·ªói', 'T√†i kho·∫£n c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x√©t duy·ªát, vui l√≤ng ƒë·ª£i');
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i t√†i kho·∫£n:', error);
                        const modal = new bootstrap.Modal(document.getElementById('verificationModal-v2'));
                        modal.show();
                    });
            } else {
                const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
                modal.show();
            }
        })
        .catch(error => {
            console.error('L·ªói ki·ªÉm tra ƒëƒÉng nh·∫≠p:', error);
            const modal = new bootstrap.Modal(document.getElementById('loginModal-v3'));
            modal.show();
        });
}

  function openFile(filePath) {
    if (isInAppBrowser()) {
      window.location.href = filePath;
    } else {
      window.open(filePath, '_blank');
    }
  }

  function isInAppBrowser() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    return ua.indexOf("FBAN") > -1 ||
      ua.indexOf("FBAV") > -1 ||
      ua.indexOf("Messenger") > -1 ||
      ua.indexOf("Zalo") > -1;
  }

  function renderExamDrive(newPath) {
    examCurrentPath = newPath;
    localStorage.setItem('examCurrentPath', JSON.stringify(examCurrentPath));
    renderDrive('exam-drive-container', examCurrentPath, renderExamDrive);
  }

  function renderSyllabusDrive(newPath) {
    syllabusCurrentPath = newPath;
    localStorage.setItem('syllabusCurrentPath', JSON.stringify(syllabusCurrentPath));
    renderDrive('syllabus-drive-container', syllabusCurrentPath, renderSyllabusDrive);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const savedExamPath = localStorage.getItem('examCurrentPath');
    const savedSyllabusPath = localStorage.getItem('syllabusCurrentPath');
    if (savedExamPath) examCurrentPath = JSON.parse(savedExamPath);
    if (savedSyllabusPath) syllabusCurrentPath = JSON.parse(savedSyllabusPath);

    const examTab = document.getElementById('de-thi-tab');
    const syllabusTab = document.getElementById('de-cuong-tab');
    const examContent = document.getElementById('de-thi');
    const syllabusContent = document.getElementById('de-cuong');
    let activeTab = localStorage.getItem('activeTab') || 'exam';

    function switchTab(tab) {
      if (tab === 'exam') {
        examTab.classList.add('active');
        syllabusTab.classList.remove('active');
        examContent.classList.add('show', 'active');
        syllabusContent.classList.remove('show', 'active');
        localStorage.setItem('activeTab', 'exam');
        renderExamDrive(examCurrentPath);
      } else {
        syllabusTab.classList.add('active');
        examTab.classList.remove('active');
        syllabusContent.classList.add('show', 'active');
        examContent.classList.remove('show', 'active');
        localStorage.setItem('activeTab', 'syllabus');
        renderSyllabusDrive(syllabusCurrentPath);
      }
    }

    examTab.addEventListener('click', () => switchTab('exam'));
    syllabusTab.addEventListener('click', () => switchTab('syllabus'));
    switchTab(activeTab);

    if (activeTab === 'exam' && examCurrentPath.length > 0) {
      const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
      document.getElementById('resumeTabName').textContent = 'ƒê·ªÅ Thi';
      document.getElementById('resumePathDisplay').textContent = 'B·∫°n ƒë√£ d·ª´ng t·∫°i: ' + examCurrentPath.map(item => item.name).join(' > ');
      resumeModal.show();

      document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
        resumeModal.hide();
      });
      document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
        examCurrentPath = [];
        localStorage.removeItem('examCurrentPath');
        renderExamDrive(examCurrentPath);
        resumeModal.hide();
      });
      document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
        resumeModal.hide();
        showHistoryModal();
      });
    } else if (activeTab === 'syllabus' && syllabusCurrentPath.length > 0) {
      const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
      document.getElementById('resumeTabName').textContent = 'ƒê·ªÅ C∆∞∆°ng';
      document.getElementById('resumePathDisplay').textContent = 'B·∫°n ƒë√£ d·ª´ng t·∫°i: ' + syllabusCurrentPath.map(item => item.name).join(' > ');
      resumeModal.show();

      document.getElementById('resumeContinueBtn')?.addEventListener('click', () => {
        resumeModal.hide();
      });
      document.getElementById('resumeCancelBtn')?.addEventListener('click', () => {
        syllabusCurrentPath = [];
        localStorage.removeItem('syllabusCurrentPath');
        renderSyllabusDrive(syllabusCurrentPath);
        resumeModal.hide();
      });
      document.getElementById('viewHistoryBtn')?.addEventListener('click', () => {
        resumeModal.hide();
        showHistoryModal();
      });
    }
  });

  async function checkAndResetHistory() {
    try {
      const res = await fetch('/user/university', { credentials: 'include' });
      if (res.ok) {
        const userSchool = await res.json();
        window.userSchoolId = userSchool.university;
        if (examCurrentPath.length > 0 && String(examCurrentPath[0].id) !== String(window.userSchoolId)) {
          examCurrentPath = [];
          localStorage.removeItem('examCurrentPath');
          window.location.href = '/';
        }
        if (syllabusCurrentPath.length > 0 && String(syllabusCurrentPath[0].id) !== String(window.userSchoolId)) {
          syllabusCurrentPath = [];
          localStorage.removeItem('syllabusCurrentPath');
          window.location.href = '/';
        }
      }
    } catch (error) {
      console.error("L·ªói khi ki·ªÉm tra l·ªãch s·ª≠ tr∆∞·ªùng:", error);
    }
  }

    /* ==================================================
       Initialization: Subject Search Modal
       M√¥ t·∫£:
         - Thi·∫øt l·∫≠p ch·ª©c nƒÉng t√¨m ki·∫øm m√¥n h·ªçc trong modal t√¨m ki·∫øm
         - X·ª≠ l√Ω hi·ªÉn th·ªã k·∫øt qu·∫£ v√† g·ª£i √Ω t√¨m ki·∫øm theo t·ª´ kh√≥a nh·∫≠p v√†o
       ================================================== */
document.addEventListener("DOMContentLoaded", function () {
  // Th√™m CSS hi·ªán ƒë·∫°i tr·ª±c ti·∫øp v√†o trang
  const style = document.createElement('style');
  style.textContent = `
    /* Modern Empty State Styles */
    .empty-search-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin: 1rem 0;
      animation: fadeIn 0.3s ease-out;
    }

    .empty-search-icon {
      font-size: 3rem;
      color: #adb5bd;
      margin-bottom: 1rem;
    }

    .empty-search-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #212529;
      margin-bottom: 0.5rem;
    }

    .empty-search-description {
      color: #6c757d;
      margin-bottom: 1.5rem;
      max-width: 400px;
    }

    .empty-search-action {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0.5rem 1.25rem;
      color: #495057;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .empty-search-action:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .empty-search-action i {
      font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Error State Styles */
    .error-search-container {
      background: #fff3f3;
      border-left: 4px solid #ff6b6b;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .error-search-title {
      color: #dc3545;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .error-search-message {
      color: #6c757d;
      font-size: 0.9rem;
    }
  `;
  document.head.appendChild(style);

  const subjectSearchInput = document.getElementById("subjectSearchInput");
  const subjectSearchSuggestions = document.getElementById("subjectSearchSuggestions");
  const schoolSelectionNotice = document.getElementById("schoolSelectionNotice");
  const searchResultCount = document.getElementById("searchResultCount");
  const modalEl = document.getElementById("customSearchModal");

  if (!modalEl) {
    console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ modal v·ªõi id "customSearchModal"');
    return;
  }

  searchResultCount.style.display = "none";
  subjectSearchSuggestions.style.display = "none";

  let modalInstance = bootstrap.Modal.getInstance(modalEl);
  if (!modalInstance) {
    modalInstance = new bootstrap.Modal(modalEl);
  }

  subjectSearchInput?.addEventListener("input", async function() {
    const term = subjectSearchInput.value.trim().toLowerCase();

    if (term.length < 2) {
      subjectSearchSuggestions.style.display = "none";
      searchResultCount.style.display = "none";
      return;
    } else {
      searchResultCount.style.display = "block";
    }

    const activeTab = localStorage.getItem("activeTab") || "exam";
    const currentPath = activeTab === "exam" ? examCurrentPath : syllabusCurrentPath;

    if (!currentPath || currentPath.length === 0) {
      schoolSelectionNotice.classList.remove("d-none");
    } else {
      schoolSelectionNotice.classList.add("d-none");
    }

    // L·∫•y school_id t·ª´ user ho·∫∑c t·ª´ currentPath[0]
    const schoolId = window.userSchoolId || (currentPath[0]?.id);
    // L∆∞u √Ω: b·ªè qua faculty_id ƒë·ªÉ t√¨m ki·∫øm to√†n b·ªô khoa trong c√πng tr∆∞·ªùng
    // const facultyId = currentPath[1]?.id || 0;

    try {
      const url = new URL("/api/search/subjects", window.location.origin);
      url.searchParams.append("term", term);
      if (schoolId) url.searchParams.append("school_id", schoolId);
      // B·ªè d√≤ng th√™m faculty_id ƒë·ªÉ cho ph√©p t√¨m ki·∫øm trong to√†n b·ªô c√°c khoa c√πng tr∆∞·ªùng
      // if (facultyId) url.searchParams.append("faculty_id", facultyId);

      const response = await fetch(url, { credentials: 'include' });
      if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
      const results = await response.json();

      searchResultCount.textContent = "K·∫øt qu·∫£ t√¨m ki·∫øm (" + results.length + ")";

      subjectSearchSuggestions.innerHTML = "";
      if (results.length > 0) {
        results.forEach(subject => {
          const card = document.createElement("div");
          card.className = "card mb-3";
          card.style.border = "none";
          card.style.borderRadius = "12px";
          card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
          card.style.transition = "all 0.3s ease";
          card.style.backgroundColor = "#ffffff";
          card.style.cursor = "pointer";
          card.onmouseover = function () {
            this.style.transform = "translateY(-3px)";
            this.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
            this.style.backgroundColor = "#f8f9fa";
          };
          card.onmouseout = function () {
            this.style.transform = "none";
            this.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
            this.style.backgroundColor = "#ffffff";
          };

          const cardBody = document.createElement("div");
          cardBody.className = "card-body";

          const contentDiv = document.createElement("div");
          contentDiv.className = "d-flex justify-content-between align-items-start";

          const infoDiv = document.createElement("div");

          const h5 = document.createElement("h5");
          h5.className = "custom-card-title";
          h5.style.color = "#0d6efd";
          h5.style.fontWeight = "600";
          h5.style.marginBottom = "8px";
          h5.textContent = subject.name;

          const schoolDiv = document.createElement("div");
          schoolDiv.style.color = "#6c757d";
          schoolDiv.style.marginBottom = "0.5rem";
          schoolDiv.innerHTML = `<i class="fas fa-university me-1"></i> ${subject.school_name}`;

          const facultySpan = document.createElement("span");
          facultySpan.className = "custom-university-label";
          facultySpan.style.fontSize = "0.9em";
          facultySpan.style.backgroundColor = "#e9ecef";
          facultySpan.style.borderRadius = "20px";
          facultySpan.style.padding = "5px 15px";
          facultySpan.style.display = "inline-block";
          facultySpan.style.color = "#495057";
          facultySpan.style.marginTop = "8px";
          facultySpan.innerHTML = `<i class="fas fa-graduation-cap me-1"></i> ${subject.faculty_name}`;

          infoDiv.appendChild(h5);
          infoDiv.appendChild(schoolDiv);
          infoDiv.appendChild(facultySpan);

          const viewButton = document.createElement("button");
          viewButton.type = "button";
          viewButton.style.fontSize = "0.875rem";
          viewButton.style.border = "1px solid #0d6efd";
          viewButton.style.color = "#0d6efd";
          viewButton.style.backgroundColor = "transparent";
          viewButton.style.padding = "0.375rem 0.75rem";
          viewButton.style.borderRadius = "0.25rem";
          viewButton.onmouseover = function () {
            this.style.backgroundColor = "#0d6efd";
            this.style.color = "#fff";
          };
          viewButton.onmouseout = function () {
            this.style.backgroundColor = "transparent";
            this.style.color = "#0d6efd";
          };
          viewButton.innerHTML = `<i class="fas fa-eye me-1"></i> Xem`;

          contentDiv.appendChild(infoDiv);
          contentDiv.appendChild(viewButton);

          cardBody.appendChild(contentDiv);
          card.appendChild(cardBody);

          card.addEventListener("click", () => {
            // Khi click v√†o k·∫øt qu·∫£ t√¨m ki·∫øm, thi·∫øt l·∫≠p ƒë∆∞·ªùng d·∫´n m·ªõi d·ª±a tr√™n th√¥ng tin c·ªßa m√¥n
            const newPath = [
              { id: subject.school_id, name: subject.school_name },
              { id: subject.faculty_id, name: subject.faculty_name },
              { id: subject.id, name: subject.name }
            ];
            const activeTab = localStorage.getItem("activeTab") || "exam";
            if (activeTab === "exam") {
              renderExamDrive(newPath);
            } else {
              renderSyllabusDrive(newPath);
            }
            subjectSearchInput.value = "";
            subjectSearchSuggestions.innerHTML = "";
            subjectSearchSuggestions.style.display = "none";
            searchResultCount.textContent = "K·∫øt qu·∫£ t√¨m ki·∫øm (0)";
            const modal = bootstrap.Modal.getInstance(document.getElementById("customSearchModal"));
            if (modal) {
              modal.hide();
            } else {
              new bootstrap.Modal(document.getElementById("customSearchModal")).hide();
            }
          });

          subjectSearchSuggestions.appendChild(card);
        });
        subjectSearchSuggestions.style.display = "block";
      } else {
        // Hi·ªÉn th·ªã empty state hi·ªán ƒë·∫°i khi kh√¥ng c√≥ k·∫øt qu·∫£
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-search-container';
        emptyState.innerHTML = `
          <div class="empty-search-icon">
            <i class="fas fa-search-minus"></i>
          </div>
          <h3 class="empty-search-title">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h3>
          <p class="empty-search-description">Kh√¥ng c√≥ m√¥n h·ªçc n√†o ph√π h·ª£p v·ªõi t·ª´ kh√≥a "${term}". Vui l√≤ng th·ª≠ l·∫°i v·ªõi t·ª´ kh√≥a kh√°c.</p>
<button class="empty-search-action" onclick="
  document.getElementById('subjectSearchInput').value = '';
  document.getElementById('subjectSearchInput').focus();
  document.getElementById('subjectSearchSuggestions').style.display = 'none';
">
  <i class="fas fa-redo"></i> Th·ª≠ t√¨m ki·∫øm kh√°c
</button>
        `;
        subjectSearchSuggestions.appendChild(emptyState);
        subjectSearchSuggestions.style.display = "block";
      }
    } catch (error) {
      console.error("L·ªói t√¨m ki·∫øm:", error);
      // Hi·ªÉn th·ªã error state hi·ªán ƒë·∫°i
      subjectSearchSuggestions.innerHTML = `
        <div class="error-search-container">
          <h4 class="error-search-title"><i class="fas fa-exclamation-triangle me-2"></i>ƒê√£ x·∫£y ra l·ªói</h4>
          <p class="error-search-message">Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£ t√¨m ki·∫øm. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.</p>
        </div>
      `;
      subjectSearchSuggestions.style.display = "block";
    }
  });
});  
</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>